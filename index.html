<!DOCTYPE html>
<html lang="vi" data-theme="light">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Edunova NƒêK</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root{
  --bg-page:#eef2ff;--bg-card:#fff;--bg-input:#f8f9ff;
  --bg-subj:#f8f9ff;--bg-hist:#f8f9ff;--bg-histrow:#fff;
  --bg-soft:#ede9fe;--bg-prog:rgba(255,255,255,.55);
  --bg-desc:rgba(255,255,255,.5);--bg-rdtip:rgba(0,0,0,.06);
  --bg-tblhov:rgba(0,0,0,.03);--bg-chart:#fff;
  --bg-glass:rgba(255,255,255,0.45);--bd-glass:rgba(255,255,255,0.6);
  --bd-base:#e0e7ff;--bd-input:#e0e7ff;
  --tx-1:#1e1b4b;--tx-2:#4b5563;--tx-3:#9ca3af;
  --c-p1:#4f46e5;--c-p2:#7c3aed;--c-acc:#a78bfa;
  --dot-clr:#c7d2fe;--scale-op:.22;
  --g-bg:#d1fae5;--g-bd:#6ee7b7;--g-tx:#065f46;--g-pill:#34d399;
  --k-bg:#dbeafe;--k-bd:#93c5fd;--k-tx:#1e40af;--k-pill:#60a5fa;
  --t-bg:#fef9c3;--t-bd:#fde68a;--t-tx:#854d0e;--t-pill:#fbbf24;
  --y-bg:#fee2e2;--y-bd:#fca5a5;--y-tx:#991b1b;--y-pill:#f87171;
  --sh-sm:0 2px 8px rgba(99,102,241,.10);
  --sh-md:0 8px 32px rgba(99,102,241,.16);
  --sh-lg:0 20px 56px rgba(99,102,241,.22);
  --td:.3s;
  --chart-grid:rgba(99,102,241,.15);
  --chart-tick:#9ca3af;--chart-pt-label:#4b5563;
  --shimmer-1:#f0f0ff;--shimmer-2:#e0e0ff;
}
[data-theme="dark"]{
  --bg-page:#0f0e1a;--bg-card:#1a1830;--bg-input:#231f3a;
  --bg-subj:#201d35;--bg-hist:#1e1b30;--bg-histrow:#27243f;
  --bg-soft:#2d2852;--bg-prog:rgba(255,255,255,.04);
  --bg-desc:rgba(255,255,255,.04);--bg-rdtip:rgba(255,255,255,.08);
  --bg-tblhov:rgba(255,255,255,.04);--bg-chart:#1a1830;
  --bg-glass:rgba(30,24,48,0.55);--bd-glass:rgba(100,80,180,0.25);
  --bd-base:#312e57;--bd-input:#3a3666;
  --tx-1:#e8e6ff;--tx-2:#a09ec0;--tx-3:#5c597e;
  --c-p1:#818cf8;--c-p2:#a78bfa;--c-acc:#c4b5fd;
  --dot-clr:#1e1b35;--scale-op:.35;
  --g-bg:#052e16;--g-bd:#065f46;--g-tx:#6ee7b7;--g-pill:#059669;
  --k-bg:#0c1f4a;--k-bd:#1e3a8a;--k-tx:#93c5fd;--k-pill:#1d4ed8;
  --t-bg:#2d1f00;--t-bd:#78350f;--t-tx:#fde68a;--t-pill:#d97706;
  --y-bg:#2d0a0a;--y-bd:#7f1d1d;--y-tx:#fca5a5;--y-pill:#dc2626;
  --sh-sm:0 2px 8px rgba(0,0,0,.4);--sh-md:0 8px 32px rgba(0,0,0,.5);
  --sh-lg:0 20px 56px rgba(0,0,0,.65);
  --chart-grid:rgba(200,200,255,.10);--chart-tick:#5c597e;--chart-pt-label:#a09ec0;
  --shimmer-1:#1a1830;--shimmer-2:#231f3a;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;
  transition:background-color var(--td) ease,border-color var(--td) ease,
  color var(--td) ease,box-shadow var(--td) ease;}
.btn,.spin,.mon-card,.hist-row{transition:background-color var(--td) ease,
  border-color var(--td) ease,color var(--td) ease,box-shadow var(--td) ease,transform .15s ease;}
body{font-family:'Inter',system-ui,sans-serif;background-color:var(--bg-page);
  background-image:radial-gradient(circle,var(--dot-clr) 1px,transparent 1px);
  background-size:28px 28px;min-height:100vh;
  display:flex;flex-direction:column;align-items:center;
  padding:36px 16px 60px;color:var(--tx-1);}
.dm-toggle{position:fixed;top:18px;right:18px;z-index:200;
  width:48px;height:48px;border-radius:50%;border:2px solid var(--bd-base);
  background:var(--bg-card);box-shadow:var(--sh-md);cursor:pointer;
  display:flex;align-items:center;justify-content:center;font-size:1.3rem;}
.dm-toggle:hover{transform:scale(1.1) rotate(15deg);box-shadow:var(--sh-lg);}
.dm-toggle::after{content:attr(data-ico);}
.pg-head{text-align:center;margin-bottom:28px;}
.pg-head .crown{font-size:3.2rem;display:block;margin-bottom:8px;
  animation:float 3s ease-in-out infinite;
  filter:drop-shadow(0 6px 12px rgba(124,58,237,.35));}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
.pg-head h1{font-size:clamp(1.4rem,4vw,2rem);font-weight:900;letter-spacing:-.03em;
  background:linear-gradient(135deg,var(--c-p1),var(--c-p2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.pg-head p{color:var(--tx-2);font-size:.88rem;margin-top:5px;font-weight:500;}
.pro-badge{display:inline-block;font-size:.65rem;font-weight:800;
  background:linear-gradient(135deg,#f59e0b,#f97316);color:#fff;
  padding:2px 8px;border-radius:99px;margin-left:6px;
  vertical-align:middle;letter-spacing:.06em;box-shadow:0 2px 8px rgba(245,158,11,.4);}
.tab-bar{display:flex;gap:0;width:100%;max-width:900px;margin-bottom:-2px;
  position:relative;z-index:10;overflow-x:auto;}
.tab-btn{flex:1;min-width:0;padding:11px 10px;border:2px solid var(--bd-base);
  background:var(--bg-page);border-bottom:none;border-radius:18px 18px 0 0;
  cursor:pointer;font-family:inherit;font-size:.82rem;font-weight:700;
  color:var(--tx-3);display:flex;align-items:center;justify-content:center;
  gap:6px;white-space:nowrap;
  transition:background var(--td),color var(--td),border-color var(--td);}
.tab-btn:not(:last-child){margin-right:4px;}
.tab-btn:hover{background:var(--bg-soft);color:var(--c-p1);}
.tab-btn.active{background:var(--bg-card);color:var(--c-p1);border-color:var(--bd-base);
  box-shadow:0 -4px 16px rgba(99,102,241,.10);}
.card{background:var(--bg-card);border-radius:0 28px 28px 28px;box-shadow:var(--sh-lg);
  width:100%;max-width:900px;overflow:hidden;
  animation:slideUp .5s cubic-bezier(.22,1,.36,1) both;}
@keyframes slideUp{from{opacity:0;transform:translateY(28px)}to{opacity:1;transform:translateY(0)}}
.card-stripe{height:5px;
  background:linear-gradient(90deg,#6366f1,#a78bfa,#7c3aed,#818cf8,#4f46e5);
  background-size:200%;animation:shimmer 3s linear infinite;}
@keyframes shimmer{0%{background-position:0%}100%{background-position:200%}}
.card-body{padding:28px 28px 32px;}
.sec-lbl{display:flex;align-items:center;gap:8px;font-size:.71rem;font-weight:700;
  text-transform:uppercase;letter-spacing:.08em;color:var(--c-p1);margin-bottom:14px;}
.sec-lbl::after{content:'';flex:1;height:1.5px;
  background:linear-gradient(90deg,var(--bd-base),transparent);border-radius:99px;}
.name-field{margin-bottom:24px;}
.fi{position:relative;display:flex;align-items:center;}
.fi .fi-ico{position:absolute;left:13px;font-size:1.05rem;pointer-events:none;}
.fi input{width:100%;padding:11px 13px 11px 40px;border:2px solid var(--bd-input);
  border-radius:14px;font-family:inherit;font-size:.96rem;font-weight:500;
  color:var(--tx-1);background:var(--bg-input);outline:none;}
.fi input:focus{border-color:var(--c-p1);background:var(--bg-card);
  box-shadow:0 0 0 4px rgba(99,102,241,.14);}
.fi input::placeholder{color:var(--tx-3);font-weight:400;}
.mon-list{display:flex;flex-direction:column;gap:14px;margin-bottom:10px;}
.mon-card{background:var(--bg-subj);border:2px solid var(--bd-base);
  border-radius:20px;overflow:hidden;box-shadow:var(--sh-sm);
  transition:box-shadow var(--td) ease,border-color var(--td) ease;}
.mon-card:focus-within{border-color:var(--c-p1);box-shadow:var(--sh-md);}
.mon-card.has-error{border-color:#f87171;}
.mon-header{display:flex;align-items:center;gap:12px;
  padding:13px 16px;cursor:pointer;user-select:none;background:var(--bg-subj);}
.mon-header:hover{background:var(--bg-soft);}
.mon-ico-chip{width:32px;height:32px;border-radius:10px;background:var(--bg-soft);
  display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;}
.mon-title-wrap{flex:1;}
.mon-title{font-size:.9rem;font-weight:800;color:var(--tx-1);}
.mon-subtitle{font-size:.72rem;color:var(--tx-3);margin-top:1px;font-weight:500;}
.mon-tbm-display{font-size:1.1rem;font-weight:900;min-width:48px;text-align:right;}
.mon-tbm-display.sc-g{color:#059669}.mon-tbm-display.sc-k{color:#2563eb}
.mon-tbm-display.sc-t{color:#d97706}.mon-tbm-display.sc-y{color:#dc2626}
[data-theme="dark"] .mon-tbm-display.sc-g{color:#34d399}
[data-theme="dark"] .mon-tbm-display.sc-k{color:#60a5fa}
[data-theme="dark"] .mon-tbm-display.sc-t{color:#fbbf24}
[data-theme="dark"] .mon-tbm-display.sc-y{color:#f87171}
.mon-del-btn{background:none;border:none;cursor:pointer;font-size:.85rem;
  color:var(--tx-3);padding:3px 7px;border-radius:8px;flex-shrink:0;margin-left:4px;
  transition:color .15s,background .15s,transform .1s;}
.mon-del-btn:hover{color:#f87171;background:var(--y-bg);transform:scale(1.1);}
.mon-chevron{font-size:.8rem;color:var(--tx-3);margin-left:4px;
  transition:transform .25s ease;flex-shrink:0;}
.mon-card.open .mon-chevron{transform:rotate(180deg);}
.mon-body{display:none;padding:0 16px 16px;border-top:1.5px solid var(--bd-base);animation:fadeIn .2s ease;}
.mon-card.open .mon-body{display:block;}
.semesters{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px;}
@media(max-width:600px){.semesters{grid-template-columns:1fr;}}
.sem-block{background:var(--bg-prog);border:1px solid rgba(128,128,128,.12);
  border-radius:14px;padding:12px 14px;}
.sem-title{font-size:.72rem;font-weight:800;text-transform:uppercase;letter-spacing:.07em;
  color:var(--c-p1);margin-bottom:10px;display:flex;align-items:center;justify-content:space-between;}
.sem-result{font-size:.82rem;font-weight:700;color:var(--tx-2);
  background:var(--bg-soft);padding:2px 8px;border-radius:99px;}
.inp-row{display:flex;align-items:center;gap:8px;margin-bottom:7px;}
.inp-row:last-child{margin-bottom:0;}
.inp-lbl{font-size:.73rem;font-weight:600;color:var(--tx-2);min-width:72px;flex-shrink:0;}
.tx-row{display:flex;align-items:center;gap:6px;flex:1;flex-wrap:wrap;}
.d-inp{width:52px;padding:6px 8px;border:1.5px solid var(--bd-base);border-radius:9px;
  font-family:inherit;font-size:.88rem;font-weight:700;color:var(--tx-1);
  background:var(--bg-card);outline:none;text-align:center;transition:border-color .2s,box-shadow .2s;}
.d-inp:focus{border-color:var(--c-p1);box-shadow:0 0 0 3px rgba(99,102,241,.13);}
.d-inp.err{border-color:#f87171;background:#fff5f5;}
[data-theme="dark"] .d-inp.err{background:#2d1010;}
.d-inp::placeholder{color:var(--tx-3);font-weight:400;font-size:.8rem;}
.btn-tx-del,.btn-tx-add{width:22px;height:22px;border-radius:6px;border:1.5px solid var(--bd-base);
  background:var(--bg-card);cursor:pointer;font-size:.85rem;font-weight:700;
  display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:background .15s,transform .1s;}
.btn-tx-del{color:#ef4444;}.btn-tx-del:hover{background:#fee2e2;}
.btn-tx-add{color:#059669;}.btn-tx-add:hover{background:#d1fae5;}
.btn-tx-del:active,.btn-tx-add:active{transform:scale(.88);}
.hk-display{margin-top:8px;padding:6px 12px;border-radius:10px;background:var(--bg-rdtip);
  font-size:.78rem;font-weight:700;color:var(--tx-2);display:flex;align-items:center;justify-content:space-between;}
.hk-val{font-size:.92rem;font-weight:900;color:var(--tx-1);}
.year-bar{margin-top:10px;padding:10px 14px;border-radius:12px;background:var(--bg-prog);
  border:1px solid rgba(128,128,128,.1);display:flex;align-items:center;
  justify-content:space-between;gap:8px;flex-wrap:wrap;}
.year-bar .yb-label{font-size:.73rem;font-weight:700;color:var(--tx-2);}
.year-bar .yb-formula{font-size:.68rem;color:var(--tx-3);margin-top:1px;}
.year-bar .yb-val{font-size:1.2rem;font-weight:900;}
.g-err{background:var(--y-bg);border:1.5px solid var(--y-bd);border-radius:11px;
  padding:10px 14px;font-size:.83rem;font-weight:500;color:var(--y-tx);
  margin-top:5px;margin-bottom:2px;display:none;animation:fadeIn .25s ease;}
.actions{display:grid;grid-template-columns:1fr auto auto auto;gap:10px;margin-top:22px;}
.btn{border:none;border-radius:13px;font-family:inherit;font-size:.93rem;font-weight:700;
  cursor:pointer;outline:none;display:flex;align-items:center;
  justify-content:center;gap:7px;padding:13px 16px;}
.btn:active{transform:scale(.96);}
.btn-calc{background:linear-gradient(135deg,var(--c-p1),var(--c-p2));
  color:#fff;box-shadow:0 4px 18px rgba(79,70,229,.38);position:relative;overflow:hidden;}
.btn-calc::after{content:'';position:absolute;inset:0;background:rgba(255,255,255,0);
  transition:background .2s;}
.btn-calc:hover::after{background:rgba(255,255,255,.12);}
.btn-calc:hover{transform:translateY(-2px);box-shadow:0 8px 28px rgba(79,70,229,.45);}
.btn-save{background:linear-gradient(135deg,#059669,#10b981);
  color:#fff;box-shadow:0 4px 14px rgba(5,150,105,.30);white-space:nowrap;}
.btn-save:hover{opacity:.9;transform:translateY(-2px);box-shadow:0 8px 24px rgba(5,150,105,.4);}
.btn-save:disabled{opacity:.35;cursor:not-allowed;transform:none;}
.btn-pdf{background:linear-gradient(135deg,#dc2626,#ef4444);
  color:#fff;box-shadow:0 4px 14px rgba(220,38,38,.30);white-space:nowrap;}
.btn-pdf:hover{opacity:.9;transform:translateY(-2px);}
.btn-pdf:disabled{opacity:.35;cursor:not-allowed;transform:none;}
.btn-reset{background:var(--bg-soft);color:var(--c-p1);}
.btn-reset:hover{background:var(--bd-input);transform:translateY(-1px);}
.btn-add-subj{
  display:flex;align-items:center;justify-content:center;gap:8px;
  width:100%;padding:11px 16px;margin-top:14px;margin-bottom:2px;
  border:2px dashed var(--bd-base);border-radius:16px;
  background:transparent;font-family:inherit;font-size:.88rem;font-weight:700;
  color:var(--c-p1);cursor:pointer;
  transition:background .2s,border-color .2s,transform .15s,box-shadow .2s;}
.btn-add-subj:hover{
  background:var(--bg-soft);border-color:var(--c-p1);
  transform:translateY(-1px);box-shadow:var(--sh-sm);}
.btn-add-subj:active{transform:scale(.97);}
.asModal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);
  z-index:600;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
.asModal-overlay.open{display:flex;}
.asModal{background:var(--bg-card);border-radius:22px;padding:26px;width:340px;
  max-width:calc(100vw - 32px);box-shadow:var(--sh-lg);
  animation:slideUp .3s cubic-bezier(.22,1,.36,1);}
.asModal h3{font-size:.98rem;font-weight:800;color:var(--c-p1);margin-bottom:16px;}
.asModal label{font-size:.72rem;font-weight:700;color:var(--tx-2);
  text-transform:uppercase;letter-spacing:.06em;display:block;margin-bottom:6px;}
.asModal input{width:100%;padding:10px 13px;border:2px solid var(--bd-input);
  border-radius:12px;font-family:inherit;font-size:.94rem;font-weight:600;
  color:var(--tx-1);background:var(--bg-input);outline:none;margin-bottom:6px;}
.asModal input:focus{border-color:var(--c-p1);box-shadow:0 0 0 3px rgba(99,102,241,.13);}
.asModal-err{font-size:.78rem;font-weight:600;color:#f87171;
  min-height:18px;display:block;margin-bottom:10px;}
.asModal-btns{display:flex;gap:10px;justify-content:flex-end;margin-top:4px;}
.asModal-btns .btn-sp-add{padding:10px 20px;font-size:.88rem;}
.asModal-cancel{padding:10px 16px;border-radius:12px;border:1.5px solid var(--bd-base);
  background:var(--bg-soft);color:var(--c-p1);font-family:inherit;font-size:.88rem;
  font-weight:700;cursor:pointer;transition:background .15s;}
.asModal-cancel:hover{background:var(--bd-base);}
.toast{position:fixed;bottom:28px;right:24px;z-index:999;
  background:var(--tx-1);color:var(--bg-card);
  padding:12px 20px;border-radius:14px;font-size:.85rem;font-weight:600;
  box-shadow:0 8px 32px rgba(0,0,0,.3);display:flex;align-items:center;gap:8px;
  opacity:0;pointer-events:none;transform:translateY(12px);transition:opacity .3s,transform .3s;}
.toast.show{opacity:1;pointer-events:auto;transform:translateY(0);}
.result-wrap{display:none;margin-top:26px;}
.result-wrap.visible{display:block !important;animation:fadeSlide .45s cubic-bezier(.22,1,.36,1) both;}
@keyframes fadeSlide{from{opacity:0;transform:translateY(22px) scale(.98)}to{opacity:1;transform:translateY(0) scale(1)}}
.res-card{border-radius:22px;border:2px solid transparent;overflow:hidden;box-shadow:var(--sh-md);}
.res-card:hover{box-shadow:var(--sh-lg);}
.res-card.gioi{background:var(--g-bg);border-color:var(--g-bd)}
.res-card.kha {background:var(--k-bg);border-color:var(--k-bd)}
.res-card.tb  {background:var(--t-bg);border-color:var(--t-bd)}
.res-card.yeu {background:var(--y-bg);border-color:var(--y-bd)}
.res-inner{padding:22px 22px 20px;}
.res-top{display:flex;align-items:flex-start;justify-content:space-between;
  flex-wrap:wrap;gap:10px;margin-bottom:18px;}
.res-student{display:flex;align-items:center;gap:10px;}
.res-avatar{width:42px;height:42px;border-radius:11px;
  display:flex;align-items:center;justify-content:center;font-size:1.3rem;box-shadow:var(--sh-sm);flex-shrink:0;}
.gioi .res-avatar{background:var(--g-pill)}.kha .res-avatar{background:var(--k-pill)}
.tb   .res-avatar{background:var(--t-pill)}.yeu .res-avatar{background:var(--y-pill)}
.r-name{font-size:1.02rem;font-weight:800;color:var(--tx-1);}
.r-sub{font-size:.76rem;font-weight:500;color:var(--tx-2);margin-top:1px;}
.rank-pill{display:flex;align-items:center;gap:5px;padding:6px 14px;
  border-radius:999px;font-size:.86rem;font-weight:800;box-shadow:var(--sh-sm);white-space:nowrap;}
.gioi .rank-pill{background:var(--g-pill);color:#022c22}
.kha  .rank-pill{background:var(--k-pill);color:#1e3a8a}
.tb   .rank-pill{background:var(--t-pill);color:#451a03}
.yeu  .rank-pill{background:var(--y-pill);color:#fff}
.prog-section{margin-bottom:18px;padding:16px 18px 14px;
  border-radius:16px;background:var(--bg-prog);border:1px solid rgba(128,128,128,.12);}
.prog-header{display:flex;align-items:baseline;justify-content:space-between;margin-bottom:10px;}
.p-label{font-size:.76rem;font-weight:700;color:var(--tx-2);
  text-transform:uppercase;letter-spacing:.06em;}
.p-val{font-size:2rem;font-weight:900;line-height:1;}
.gioi .p-val{color:var(--g-tx)}.kha .p-val{color:var(--k-tx)}
.tb   .p-val{color:var(--t-tx)}.yeu .p-val{color:var(--y-tx)}
.scale-bar{position:relative;height:14px;border-radius:99px;margin-bottom:6px;}
.scale-track{position:absolute;inset:0;border-radius:99px;overflow:hidden;
  background:linear-gradient(90deg,#f87171 0%,#fbbf24 32%,#60a5fa 50%,#34d399 70%,#059669 100%);
  opacity:var(--scale-op);}
.scale-fill{position:absolute;top:0;left:0;height:100%;border-radius:99px;
  transition:width .7s cubic-bezier(.22,1,.36,1);box-shadow:0 2px 8px rgba(0,0,0,.18);}
.gioi .scale-fill{background:linear-gradient(90deg,#34d399,#6ee7b7)}
.kha  .scale-fill{background:linear-gradient(90deg,#60a5fa,#93c5fd)}
.tb   .scale-fill{background:linear-gradient(90deg,#fbbf24,#fde68a)}
.yeu  .scale-fill{background:linear-gradient(90deg,#f87171,#fca5a5)}
.scale-needle{position:absolute;top:-4px;width:4px;height:22px;border-radius:2px;
  background:var(--tx-1);box-shadow:0 2px 6px rgba(0,0,0,.25);transform:translateX(-50%);
  transition:left .7s cubic-bezier(.22,1,.36,1);}
.scale-ticks{display:flex;justify-content:space-between;font-size:.66rem;
  font-weight:600;color:var(--tx-3);padding:0 2px;}
.chart-section{margin-bottom:18px;padding:18px 18px 14px;border-radius:16px;
  background:var(--bg-prog);border:1px solid rgba(128,128,128,.12);animation:fadeIn .5s ease;}
.ch-label{font-size:.76rem;font-weight:700;color:var(--tx-2);
  text-transform:uppercase;letter-spacing:.06em;}
.chart-legend{display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin-bottom:12px;}
.leg-chip{display:flex;align-items:center;gap:5px;font-size:.7rem;font-weight:600;
  color:var(--tx-2);padding:3px 9px;border-radius:99px;background:var(--bg-rdtip);}
.leg-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.chart-wrap{position:relative;width:100%;max-width:380px;margin:0 auto;aspect-ratio:1/1;}
.chart-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:14px;}
.cstat{background:var(--bg-rdtip);border-radius:12px;padding:9px 10px;text-align:center;}
.cs-val{font-size:1.15rem;font-weight:900;color:var(--tx-1);}
.cs-lbl{font-size:.68rem;font-weight:600;color:var(--tx-3);margin-top:2px;}
.cs-hi{color:#059669!important;}.cs-lo{color:#dc2626!important;}
[data-theme="dark"] .cs-hi{color:#34d399!important;}
[data-theme="dark"] .cs-lo{color:#f87171!important;}
.rank-desc{border-radius:13px;padding:13px 15px;margin-bottom:16px;
  border:1px solid rgba(128,128,128,.12);background:var(--bg-desc);}
.rd-title{font-size:.76rem;font-weight:700;color:var(--tx-2);
  text-transform:uppercase;letter-spacing:.07em;margin-bottom:5px;}
.rd-text{font-size:.84rem;font-weight:500;line-height:1.55;color:var(--tx-1);}
.rd-tips{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px;}
.rd-tip{font-size:.73rem;font-weight:600;padding:4px 10px;border-radius:99px;
  background:var(--bg-rdtip);color:var(--tx-2);}
.score-tbl{width:100%;border-collapse:collapse;font-size:.84rem;}
.score-tbl th{padding:6px 10px;text-align:left;font-size:.71rem;font-weight:700;
  text-transform:uppercase;letter-spacing:.07em;color:var(--tx-2);
  border-bottom:1.5px solid rgba(128,128,128,.15);}
.score-tbl td{padding:8px 10px;border-bottom:1px solid rgba(128,128,128,.08);
  color:var(--tx-1);font-weight:500;}
.score-tbl td:last-child{text-align:right;font-weight:800;}
.score-tbl tbody tr:hover{background:var(--bg-tblhov);}
.score-tbl tr.ttl-row td{border-bottom:none;font-weight:900;font-size:.98rem;padding-top:11px;}
.sc-g{color:#059669}.sc-k{color:#2563eb}.sc-t{color:#d97706}.sc-y{color:#dc2626}
[data-theme="dark"] .sc-g{color:#34d399}[data-theme="dark"] .sc-k{color:#60a5fa}
[data-theme="dark"] .sc-t{color:#fbbf24}[data-theme="dark"] .sc-y{color:#f87171}
.tbl-ico{display:inline-flex;align-items:center;justify-content:center;
  width:20px;height:20px;border-radius:6px;background:rgba(128,128,128,.12);
  font-size:.72rem;margin-right:5px;}
.history-wrap{background:var(--bg-hist);border:2px solid var(--bd-base);
  border-radius:20px;padding:18px 18px 14px;margin-top:24px;display:none;animation:fadeIn .3s ease;}
.history-wrap.visible{display:block;}
.history-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:13px;}
.history-header h3{font-size:.85rem;font-weight:800;color:var(--c-p1);}
.btn-clear-hist{font-size:.72rem;font-weight:600;color:#f87171;
  background:none;border:none;cursor:pointer;padding:3px 8px;border-radius:7px;}
.btn-clear-hist:hover{background:var(--y-bg);}
.hist-row{display:flex;align-items:center;gap:10px;padding:9px 10px;
  border-radius:11px;background:var(--bg-histrow);border:1.5px solid var(--bd-base);
  margin-bottom:8px;cursor:pointer;}
.hist-row:hover{border-color:var(--c-p1);box-shadow:var(--sh-sm);transform:translateY(-1px);}
.hist-row:last-child{margin-bottom:0;}
.hist-rank-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.dot-gioi{background:#34d399}.dot-kha{background:#60a5fa}
.dot-tb{background:#fbbf24}.dot-yeu{background:#f87171}
.hist-name{font-size:.87rem;font-weight:700;flex:1;color:var(--tx-1);
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.hist-avg{font-size:.87rem;font-weight:800;margin-left:auto;margin-right:4px;}
.hist-lbl{font-size:.72rem;font-weight:700;padding:3px 10px;border-radius:99px;}
.hist-lbl.gioi{background:var(--g-bg);color:var(--g-tx)}
.hist-lbl.kha {background:var(--k-bg);color:var(--k-tx)}
.hist-lbl.tb  {background:var(--t-bg);color:var(--t-tx)}
.hist-lbl.yeu {background:var(--y-bg);color:var(--y-tx)}
.hist-del{background:none;border:none;cursor:pointer;font-size:.85rem;
  color:var(--tx-3);padding:3px 5px;border-radius:6px;flex-shrink:0;}
.hist-del:hover{color:#f87171;background:var(--y-bg);}
.hist-date{font-size:.68rem;color:var(--tx-3);font-weight:500;white-space:nowrap;}
.pg-foot{margin-top:30px;font-size:.72rem;color:var(--tx-3);text-align:center;font-weight:500;}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.sp-section{display:none;animation:fadeIn .3s ease;}
.sp-section.active{display:block;}
.sp-form{
  background:var(--bg-glass);
  backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
  border:1.5px solid var(--bd-glass);
  border-radius:20px;padding:20px;margin-bottom:22px;
  box-shadow:0 4px 24px rgba(99,102,241,.08);}
.sp-form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px;}
@media(max-width:580px){.sp-form-grid{grid-template-columns:1fr;}}
.sp-field{display:flex;flex-direction:column;gap:5px;}
.sp-field label{font-size:.72rem;font-weight:700;color:var(--tx-2);
  text-transform:uppercase;letter-spacing:.06em;}
.sp-inp{width:100%;padding:9px 13px;border:1.5px solid var(--bd-input);
  border-radius:11px;font-family:inherit;font-size:.9rem;font-weight:500;
  color:var(--tx-1);background:var(--bg-card);outline:none;
  transition:border-color .2s,box-shadow .2s;}
.sp-inp:focus{border-color:var(--c-p1);box-shadow:0 0 0 3px rgba(99,102,241,.12);}
.sp-inp::placeholder{color:var(--tx-3);}
.sp-inp option{background:var(--bg-card);color:var(--tx-1);}
.btn-sp-add{
  background:linear-gradient(135deg,var(--c-p1),var(--c-p2));
  color:#fff;border:none;border-radius:12px;padding:11px 22px;
  font-family:inherit;font-size:.9rem;font-weight:700;cursor:pointer;
  display:flex;align-items:center;gap:7px;
  box-shadow:0 4px 14px rgba(79,70,229,.32);
  transition:opacity .2s,transform .15s,box-shadow .2s;}
.btn-sp-add:hover{opacity:.92;transform:translateY(-2px);box-shadow:0 8px 22px rgba(79,70,229,.42);}
.btn-sp-add:active{transform:scale(.96);}
.sp-stats{display:flex;gap:10px;margin-bottom:18px;flex-wrap:wrap;}
.sp-stat{flex:1;min-width:90px;background:var(--bg-subj);border:1.5px solid var(--bd-base);
  border-radius:14px;padding:12px 14px;text-align:center;
  transition:transform .2s,box-shadow .2s;}
.sp-stat:hover{transform:translateY(-2px);box-shadow:var(--sh-sm);}
.sp-stat-val{font-size:1.5rem;font-weight:900;color:var(--c-p1);}
.sp-stat-lbl{font-size:.68rem;font-weight:600;color:var(--tx-3);margin-top:2px;}
.sp-filter{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;}
.sp-filter-btn{padding:5px 14px;border-radius:99px;border:1.5px solid var(--bd-base);
  background:var(--bg-card);font-family:inherit;font-size:.75rem;font-weight:700;
  color:var(--tx-3);cursor:pointer;transition:background .15s,color .15s,border-color .15s,transform .1s;}
.sp-filter-btn:hover{border-color:var(--c-p1);color:var(--c-p1);transform:translateY(-1px);}
.sp-filter-btn.active{background:var(--c-p1);color:#fff;border-color:var(--c-p1);}
.sp-task-list{display:flex;flex-direction:column;gap:10px;}
.sp-empty{text-align:center;padding:36px 20px;color:var(--tx-3);font-size:.88rem;font-weight:500;}
.sp-empty .sp-empty-ico{font-size:2.5rem;display:block;margin-bottom:10px;}
.sp-task{display:flex;align-items:flex-start;gap:12px;padding:14px 16px;
  background:var(--bg-histrow);border:1.5px solid var(--bd-base);
  border-radius:16px;transition:border-color .2s,box-shadow .2s,opacity .25s,transform .2s;}
.sp-task:hover{border-color:var(--c-p1);box-shadow:var(--sh-sm);transform:translateY(-1px);}
.sp-task.done{opacity:.48;}
.sp-task.done .sp-task-title{text-decoration:line-through;color:var(--tx-3);}
.sp-task.task-enter{animation:taskSlideIn .3s cubic-bezier(.22,1,.36,1) both;}
@keyframes taskSlideIn{from{opacity:0;transform:translateY(-10px) scale(.97)}to{opacity:1;transform:none}}
.sp-task.task-exit{animation:taskSlideOut .25s ease both;}
@keyframes taskSlideOut{to{opacity:0;transform:translateX(20px) scale(.95)}}
.sp-cb{width:20px;height:20px;border-radius:6px;border:2px solid var(--bd-base);
  background:var(--bg-card);cursor:pointer;flex-shrink:0;margin-top:1px;
  display:flex;align-items:center;justify-content:center;font-size:.8rem;
  transition:background .15s,border-color .15s,transform .15s;}
.sp-cb:hover{border-color:var(--c-p1);transform:scale(1.1);}
.sp-cb.checked{background:var(--c-p1);border-color:var(--c-p1);color:#fff;
  animation:checkPop .25s cubic-bezier(.22,1,.36,1);}
@keyframes checkPop{0%{transform:scale(0.7)}60%{transform:scale(1.2)}100%{transform:scale(1)}}
.sp-task-body{flex:1;min-width:0;}
.sp-task-top{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:4px;}
.sp-task-subj{font-size:.72rem;font-weight:800;padding:2px 9px;border-radius:99px;
  background:var(--bg-soft);color:var(--c-p1);}
.sp-task-title{font-size:.9rem;font-weight:700;color:var(--tx-1);}
.sp-task-meta{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.sp-deadline{font-size:.72rem;font-weight:600;color:var(--tx-3);display:flex;align-items:center;gap:4px;}
.sp-deadline.overdue{color:#f87171;}
.sp-deadline.today{color:#f59e0b;}
.sp-task-del{background:none;border:none;cursor:pointer;font-size:.85rem;
  color:var(--tx-3);padding:4px 6px;border-radius:7px;flex-shrink:0;transition:color .15s,background .15s,transform .1s;}
.sp-task-del:hover{color:#f87171;background:var(--y-bg);transform:scale(1.1);}
.sp-streak-box{display:flex;align-items:center;justify-content:space-between;
  gap:12px;flex-wrap:wrap;
  background:linear-gradient(135deg,rgba(79,70,229,.10),rgba(124,58,237,.10));
  border:1.5px solid var(--bd-base);border-radius:18px;
  padding:14px 18px;margin-bottom:16px;}
.streak-left{display:flex;align-items:center;gap:10px;}
.streak-flame{font-size:2rem;line-height:1;
  filter:drop-shadow(0 2px 6px rgba(249,115,22,.5));
  animation:pulse-flame 1.8s ease-in-out infinite;}
@keyframes pulse-flame{0%,100%{transform:scale(1)}50%{transform:scale(1.12)}}
.streak-info{}
.streak-label{font-size:.68rem;font-weight:700;text-transform:uppercase;
  letter-spacing:.07em;color:var(--tx-3);margin-bottom:2px;}
.streak-count{font-size:1.6rem;font-weight:900;color:var(--c-p1);line-height:1;}
.streak-count span{font-size:.85rem;font-weight:600;color:var(--tx-2);margin-left:3px;}
.streak-badge{font-size:.73rem;font-weight:700;padding:4px 12px;border-radius:99px;
  background:linear-gradient(135deg,#f97316,#ef4444);color:#fff;
  box-shadow:0 2px 8px rgba(249,115,22,.4);white-space:nowrap;align-self:center;}
.sp-heatmap{background:var(--bg-subj);border:1.5px solid var(--bd-base);
  border-radius:18px;padding:14px 18px;margin-bottom:18px;}
.heatmap-title{font-size:.68rem;font-weight:700;text-transform:uppercase;
  letter-spacing:.07em;color:var(--tx-3);margin-bottom:10px;}
.heatmap-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;}
.hm-day{display:flex;flex-direction:column;align-items:center;gap:4px;}
.hm-label{font-size:.62rem;font-weight:700;color:var(--tx-3);text-transform:uppercase;}
.hm-cell{width:100%;aspect-ratio:1/1;border-radius:8px;
  display:flex;align-items:center;justify-content:center;
  font-size:.65rem;font-weight:800;transition:transform .15s;}
.hm-cell:hover{transform:scale(1.15);}
.hm-cell.hm-empty{background:var(--bg-rdtip);color:var(--tx-3);}
.hm-cell.hm-done{background:linear-gradient(135deg,#34d399,#059669);
  color:#fff;box-shadow:0 2px 6px rgba(5,150,105,.35);}
.hm-cell.hm-today{outline:2px solid var(--c-p1);outline-offset:2px;}
.tt-list{display:flex;flex-direction:column;gap:8px;margin-bottom:10px;}
.tt-item{display:flex;align-items:center;gap:10px;padding:11px 14px;
  background:var(--bg-histrow);border:1.5px solid var(--bd-base);
  border-radius:14px;transition:border-color .2s,box-shadow .2s,transform .2s;}
.tt-item:hover{border-color:var(--c-p1);box-shadow:var(--sh-sm);}
.tt-item.tt-enter{animation:taskSlideIn .3s cubic-bezier(.22,1,.36,1) both;}
.tt-item.tt-exit {animation:taskSlideOut .25s ease both;}
.tt-item.tt-today-item{border-color:var(--c-p1);background:var(--bg-soft);}
.tt-day-badge{font-size:.72rem;font-weight:800;padding:3px 10px;border-radius:99px;
  background:var(--bg-soft);color:var(--c-p1);white-space:nowrap;flex-shrink:0;}
.tt-day-badge.tt-today{background:var(--c-p1);color:#fff;}
.tt-subj{font-size:.88rem;font-weight:700;flex:1;color:var(--tx-1);}
.tt-time{font-size:.78rem;font-weight:600;color:var(--tx-2);white-space:nowrap;}
.tt-conflict{font-size:.65rem;font-weight:700;color:#f87171;
  background:var(--y-bg);border-radius:6px;padding:1px 6px;margin-left:4px;}
.tt-actions-row{display:flex;gap:6px;flex-shrink:0;}
.tt-btn{background:none;border:1.5px solid var(--bd-base);cursor:pointer;
  font-size:.78rem;padding:4px 9px;border-radius:8px;font-family:inherit;
  font-weight:600;color:var(--tx-2);transition:background .15s,color .15s,transform .1s;}
.tt-btn:hover{transform:scale(1.05);}
.tt-btn.edit{color:var(--c-p1);border-color:var(--c-p1);}
.tt-btn.edit:hover{background:var(--bg-soft);}
.tt-btn.del{color:#f87171;border-color:#f87171;}
.tt-btn.del:hover{background:var(--y-bg);}
.tt-empty{text-align:center;padding:20px;color:var(--tx-3);font-size:.85rem;font-weight:500;}
.tt-time-group{display:flex;gap:6px;align-items:center;}
.tt-time-inp{
  width:88px;padding:9px 10px;border:1.5px solid var(--bd-input);
  border-radius:11px;font-family:inherit;font-size:.9rem;font-weight:700;
  color:var(--tx-1);background:var(--bg-card);outline:none;
  text-align:center;letter-spacing:.07em;
  transition:border-color .2s,box-shadow .2s;}
.tt-time-inp:focus{border-color:var(--c-p1);box-shadow:0 0 0 3px rgba(99,102,241,.12);}
.tt-time-inp.err{border-color:#f87171;background:#fff5f5;}
[data-theme="dark"] .tt-time-inp.err{background:#2d1010;}
.tt-time-inp::placeholder{color:var(--tx-3);font-weight:400;}
.tt-modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);
  z-index:500;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
.tt-modal-overlay.open{display:flex;}
.tt-modal{background:var(--bg-card);border-radius:22px;padding:24px;width:360px;
  max-width:calc(100vw - 32px);box-shadow:var(--sh-lg);animation:slideUp .3s cubic-bezier(.22,1,.36,1);}
.tt-modal h3{font-size:.95rem;font-weight:800;color:var(--c-p1);margin-bottom:16px;}
.tt-modal .sp-form-grid{margin-bottom:16px;}
.tt-modal-btns{display:flex;gap:10px;justify-content:flex-end;}
.tt-modal-btns .btn-sp-add{padding:9px 18px;font-size:.85rem;}
.btn-modal-cancel{padding:9px 16px;border-radius:12px;border:1.5px solid var(--bd-base);
  background:var(--bg-soft);color:var(--c-p1);font-family:inherit;font-size:.85rem;
  font-weight:700;cursor:pointer;transition:background .15s;}
.btn-modal-cancel:hover{background:var(--bd-base);}
.pomo-wrap{background:var(--bg-subj);border:2px solid var(--bd-base);
  border-radius:20px;padding:20px;margin-bottom:22px;}
.pomo-config{display:grid;grid-template-columns:2fr 1fr 1fr;gap:12px;margin-bottom:18px;}
@media(max-width:580px){.pomo-config{grid-template-columns:1fr 1fr;}}
.pomo-display{
  display:flex;flex-direction:column;align-items:center;gap:0;
  margin-bottom:18px;position:relative;min-height:180px;}
.pomo-ring-wrap{position:absolute;top:50%;left:50%;
  transform:translate(-50%,-50%);width:140px;height:140px;pointer-events:none;z-index:0;}
.pomo-ring{width:140px;height:140px;transform:rotate(-90deg);}
.pomo-ring-bg{fill:none;stroke:var(--bd-base);stroke-width:6;}
.pomo-ring-fill{fill:none;stroke:var(--c-p1);stroke-width:6;
  stroke-linecap:round;transition:stroke-dashoffset .9s linear,stroke .4s;}
.pomo-phase{font-size:.72rem;font-weight:800;text-transform:uppercase;letter-spacing:.1em;
  color:var(--tx-3);margin-bottom:0;margin-top:8px;z-index:1;position:relative;}
.pomo-clock{font-size:3rem;font-weight:900;color:var(--tx-1);letter-spacing:-.03em;
  font-variant-numeric:tabular-nums;line-height:1;z-index:1;position:relative;
  width:140px;height:140px;display:flex;align-items:center;justify-content:center;margin-top:4px;}
.pomo-btns{display:flex;gap:10px;margin-top:8px;z-index:1;position:relative;}
.pomo-btn{border:none;border-radius:12px;font-family:inherit;font-size:.88rem;font-weight:700;
  cursor:pointer;padding:10px 20px;transition:opacity .2s,transform .15s,box-shadow .2s;}
.pomo-btn:active{transform:scale(.95);}
.pomo-start{background:linear-gradient(135deg,var(--c-p1),var(--c-p2));color:#fff;
  box-shadow:0 4px 14px rgba(79,70,229,.35);}
.pomo-start:hover{box-shadow:0 8px 22px rgba(79,70,229,.5);transform:translateY(-2px);}
.pomo-pause{background:linear-gradient(135deg,#f59e0b,#f97316);color:#fff;
  box-shadow:0 4px 14px rgba(245,158,11,.35);}
.pomo-reset{background:var(--bg-soft);color:var(--c-p1);}
.pomo-btn:hover{opacity:.88;}
.pomo-ring-fill.phase-break{stroke:#34d399;}
.pomo-ring-fill.phase-ready{stroke:var(--c-p1);}
.pomo-sound-bar{display:flex;align-items:center;gap:10px;flex-wrap:wrap;
  margin-bottom:16px;padding:10px 14px;border-radius:12px;
  background:var(--bg-prog);border:1px solid rgba(128,128,128,.1);}
.sound-toggle{display:flex;align-items:center;gap:6px;cursor:pointer;
  font-size:.8rem;font-weight:700;color:var(--tx-2);user-select:none;}
.sound-icon{font-size:1.1rem;}
.sound-select{padding:5px 10px;border:1.5px solid var(--bd-input);
  border-radius:9px;font-family:inherit;font-size:.78rem;font-weight:600;
  color:var(--tx-1);background:var(--bg-card);cursor:pointer;outline:none;}
.sound-select:focus{border-color:var(--c-p1);}
.sound-vol{-webkit-appearance:none;width:90px;height:4px;border-radius:2px;
  background:var(--bd-base);outline:none;cursor:pointer;}
.sound-vol::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;
  border-radius:50%;background:var(--c-p1);cursor:pointer;}
.pomo-stats{display:flex;gap:10px;flex-wrap:wrap;}
.analytics-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;margin-bottom:22px;}
@media(max-width:580px){.analytics-grid{grid-template-columns:1fr;}}
.an-card{background:var(--bg-glass);backdrop-filter:blur(10px);
  border:1.5px solid var(--bd-glass);border-radius:18px;padding:16px 18px;
  box-shadow:var(--sh-sm);transition:transform .2s,box-shadow .2s;}
.an-card:hover{transform:translateY(-2px);box-shadow:var(--sh-md);}
.an-card-wide{grid-column:1/-1;}
.an-title{font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;
  color:var(--tx-3);margin-bottom:10px;}
.an-val{font-size:2rem;font-weight:900;color:var(--c-p1);line-height:1;}
.an-sub{font-size:.75rem;color:var(--tx-2);margin-top:4px;font-weight:500;}
.an-compare{display:flex;align-items:center;gap:5px;font-size:.72rem;font-weight:700;margin-top:6px;}
.an-compare.up{color:#059669;}.an-compare.down{color:#dc2626;}.an-compare.same{color:var(--tx-3);}
.prog-circle-wrap{display:flex;flex-direction:column;align-items:center;gap:8px;}
.prog-circle-svg{transform:rotate(-90deg);}
.prog-circle-bg{fill:none;stroke:var(--bd-base);stroke-width:8;}
.prog-circle-fill{fill:none;stroke:var(--c-p1);stroke-width:8;stroke-linecap:round;
  transition:stroke-dashoffset 1s cubic-bezier(.22,1,.36,1);}
.hm30-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;}
.hm30-cell{width:100%;aspect-ratio:1/1;border-radius:5px;
  background:var(--bg-rdtip);transition:transform .15s;}
.hm30-cell:hover{transform:scale(1.2);}
.hm30-cell.l1{background:rgba(99,102,241,.25);}
.hm30-cell.l2{background:rgba(99,102,241,.50);}
.hm30-cell.l3{background:rgba(99,102,241,.75);}
.hm30-cell.l4{background:rgba(99,102,241,1);}
.hm30-cell.hm-today{outline:2px solid var(--c-acc);outline-offset:1px;}
.an-chart-wrap{position:relative;width:100%;height:160px;}
.shimmer{background:linear-gradient(90deg,var(--shimmer-1) 25%,var(--shimmer-2) 50%,var(--shimmer-1) 75%);
  background-size:200% 100%;animation:shimmerAnim 1.4s infinite;}
@keyframes shimmerAnim{0%{background-position:200% 0}100%{background-position:-200% 0}}
@media(max-width:600px){
  .card-body{padding:18px 14px 24px;}
  .actions{grid-template-columns:1fr 1fr;grid-template-rows:auto auto;}
  .btn-calc{grid-column:1/-1;}
  .dm-toggle{top:12px;right:12px;width:42px;height:42px;font-size:1.1rem;}
  .tab-btn{font-size:.73rem;padding:9px 6px;gap:4px;}
  .analytics-grid{grid-template-columns:1fr;}
  .pomo-config{grid-template-columns:1fr 1fr;}
  .pomo-sound-bar{flex-direction:column;align-items:flex-start;}
}
.ai-block{
  background:var(--bg-glass);
  backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
  border:1.5px solid var(--bd-glass);
  border-radius:20px;padding:20px 22px;margin-bottom:20px;
  box-shadow:0 4px 24px rgba(99,102,241,.08);
  animation:fadeIn .35s ease;}
.ai-block-title{
  display:flex;align-items:center;gap:9px;
  font-size:.88rem;font-weight:800;color:var(--c-p1);
  margin-bottom:16px;padding-bottom:12px;
  border-bottom:1.5px solid var(--bd-base);}
.ai-block-title .ai-ico{font-size:1.3rem;}
.ai-no-data{
  text-align:center;padding:24px 16px;
  background:var(--bg-rdtip);border-radius:14px;
  font-size:.85rem;color:var(--tx-3);font-weight:500;}
.ai-no-data .ai-nd-ico{font-size:2rem;display:block;margin-bottom:8px;}
.ai-stat-row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px;}
@media(max-width:560px){.ai-stat-row{grid-template-columns:1fr 1fr;}}
.ai-stat{
  background:var(--bg-subj);border:1.5px solid var(--bd-base);
  border-radius:14px;padding:11px 13px;text-align:center;
  transition:transform .2s,box-shadow .2s;}
.ai-stat:hover{transform:translateY(-2px);box-shadow:var(--sh-sm);}
.ai-stat-val{font-size:1.3rem;font-weight:900;color:var(--c-p1);}
.ai-stat-lbl{font-size:.66rem;font-weight:600;color:var(--tx-3);margin-top:3px;}
.ai-summary{
  background:var(--bg-prog);border:1px solid rgba(128,128,128,.12);
  border-radius:14px;padding:13px 15px;margin-bottom:14px;
  font-size:.85rem;line-height:1.6;color:var(--tx-1);font-weight:500;}
.ai-tips-list{display:flex;flex-direction:column;gap:9px;}
.ai-tip{
  display:flex;align-items:flex-start;gap:10px;
  background:var(--bg-histrow);border:1.5px solid var(--bd-base);
  border-radius:13px;padding:11px 14px;
  font-size:.84rem;color:var(--tx-1);font-weight:500;line-height:1.5;}
.ai-tip-num{
  width:22px;height:22px;border-radius:7px;flex-shrink:0;
  background:linear-gradient(135deg,var(--c-p1),var(--c-p2));
  color:#fff;font-size:.72rem;font-weight:900;
  display:flex;align-items:center;justify-content:center;margin-top:1px;}
.ai-plan-grid{display:flex;flex-direction:column;gap:8px;margin-bottom:14px;}
.ai-plan-item{
  display:flex;align-items:center;gap:10px;
  padding:10px 14px;background:var(--bg-histrow);
  border:1.5px solid var(--bd-base);border-radius:13px;
  font-size:.84rem;color:var(--tx-1);font-weight:500;
  animation:taskSlideIn .25s ease both;}
.ai-plan-day{
  min-width:52px;font-size:.7rem;font-weight:800;
  color:var(--c-p1);background:var(--bg-soft);
  padding:2px 8px;border-radius:99px;text-align:center;flex-shrink:0;}
.ai-plan-subj{
  font-size:.7rem;font-weight:700;padding:2px 8px;border-radius:99px;
  background:rgba(99,102,241,.12);color:var(--c-p2);flex-shrink:0;}
.ai-plan-title{flex:1;}
.btn-ai-push{
  display:flex;align-items:center;gap:7px;justify-content:center;
  background:linear-gradient(135deg,#059669,#10b981);
  color:#fff;border:none;border-radius:12px;
  padding:11px 22px;font-family:inherit;font-size:.9rem;font-weight:700;
  cursor:pointer;box-shadow:0 4px 14px rgba(5,150,105,.30);
  transition:opacity .2s,transform .15s,box-shadow .2s;}
.btn-ai-push:hover{opacity:.92;transform:translateY(-2px);box-shadow:0 8px 22px rgba(5,150,105,.4);}
.btn-ai-push:disabled{opacity:.35;cursor:not-allowed;transform:none;}
.btn-ai-gen{
  background:linear-gradient(135deg,var(--c-p1),var(--c-p2));
  color:#fff;border:none;border-radius:12px;padding:10px 20px;
  font-family:inherit;font-size:.88rem;font-weight:700;cursor:pointer;
  box-shadow:0 4px 14px rgba(79,70,229,.32);white-space:nowrap;
  transition:opacity .2s,transform .15s;}
.btn-ai-gen:hover{opacity:.92;transform:translateY(-2px);}
.btn-ai-gen:disabled{opacity:.4;cursor:not-allowed;transform:none;}
.ai-loading{
  display:flex;align-items:center;gap:10px;padding:14px 16px;
  background:var(--bg-soft);border-radius:13px;
  font-size:.85rem;font-weight:600;color:var(--c-p1);}
.ai-loading-dots{display:flex;gap:4px;}
.ai-loading-dots span{width:7px;height:7px;border-radius:50%;background:var(--c-p1);
  animation:dotBounce 1.2s infinite ease-in-out;}
.ai-loading-dots span:nth-child(2){animation-delay:.2s;}
.ai-loading-dots span:nth-child(3){animation-delay:.4s;}
@keyframes dotBounce{0%,80%,100%{transform:scale(.6);opacity:.5}40%{transform:scale(1);opacity:1}}
.ai-gemini-resp{
  background:var(--bg-prog);border:1px solid rgba(128,128,128,.12);
  border-radius:14px;padding:14px 16px;
  font-size:.85rem;line-height:1.7;color:var(--tx-1);font-weight:500;
  white-space:pre-wrap;word-break:break-word;}
.ai-profile-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:4px;}
@media(max-width:560px){.ai-profile-grid{grid-template-columns:1fr;}}
.ai-chat-wrap{display:flex;flex-direction:column;gap:0;}
.ai-chat-box{
  min-height:200px;max-height:340px;overflow-y:auto;
  background:var(--bg-subj);border:1.5px solid var(--bd-base);
  border-radius:14px;padding:14px;margin-bottom:10px;
  display:flex;flex-direction:column;gap:10px;}
.chat-msg{display:flex;gap:8px;align-items:flex-start;animation:fadeIn .25s ease;}
.chat-msg.user{flex-direction:row-reverse;}
.chat-bubble{
  max-width:78%;padding:9px 13px;border-radius:14px;
  font-size:.84rem;line-height:1.55;font-weight:500;
  white-space:pre-wrap;word-break:break-word;}
.chat-msg.user .chat-bubble{
  background:linear-gradient(135deg,var(--c-p1),var(--c-p2));
  color:#fff;border-radius:14px 14px 4px 14px;}
.chat-msg.ai .chat-bubble{
  background:var(--bg-prog);color:var(--tx-1);
  border:1px solid var(--bd-base);border-radius:14px 14px 14px 4px;}
.chat-avatar{width:28px;height:28px;border-radius:8px;flex-shrink:0;
  display:flex;align-items:center;justify-content:center;font-size:.9rem;
  background:var(--bg-soft);}
.chat-input-row{display:flex;gap:8px;align-items:flex-end;}
.chat-textarea{
  flex:1;padding:10px 13px;border:1.5px solid var(--bd-input);
  border-radius:12px;font-family:inherit;font-size:.88rem;
  color:var(--tx-1);background:var(--bg-card);outline:none;
  resize:none;min-height:44px;max-height:120px;
  transition:border-color .2s,box-shadow .2s;line-height:1.5;}
.chat-textarea:focus{border-color:var(--c-p1);box-shadow:0 0 0 3px rgba(99,102,241,.12);}
.btn-chat-send{
  background:linear-gradient(135deg,var(--c-p1),var(--c-p2));
  color:#fff;border:none;border-radius:12px;padding:11px 18px;
  font-family:inherit;font-size:.9rem;font-weight:700;cursor:pointer;
  white-space:nowrap;box-shadow:0 4px 14px rgba(79,70,229,.32);
  transition:opacity .2s,transform .15s;}
.btn-chat-send:hover{opacity:.9;transform:translateY(-1px);}
.btn-chat-send:disabled{opacity:.4;cursor:not-allowed;transform:none;}
.btn-chat-clear{
  background:var(--bg-soft);color:var(--tx-3);border:1.5px solid var(--bd-base);
  border-radius:10px;padding:8px 12px;font-family:inherit;font-size:.75rem;
  font-weight:700;cursor:pointer;margin-top:7px;align-self:flex-start;
  transition:background .15s,color .15s;}
.btn-chat-clear:hover{background:var(--y-bg);color:#f87171;}
.chat-limit-banner{
  display:flex;align-items:center;gap:8px;
  padding:10px 14px;border-radius:12px;
  background:var(--y-bg);border:1.5px solid var(--y-bd);
  font-size:.8rem;font-weight:600;color:var(--y-tx);
  margin-bottom:8px;}
.chat-cooldown-bar{
  height:3px;border-radius:99px;background:var(--bd-base);
  margin-top:6px;overflow:hidden;}
.chat-cooldown-fill{
  height:100%;border-radius:99px;
  background:linear-gradient(90deg,var(--c-p1),var(--c-p2));
  transition:width .5s linear;}
.fc-stats-row{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;}
.fc-stat{flex:1;min-width:80px;background:var(--bg-subj);border:1.5px solid var(--bd-base);
  border-radius:14px;padding:10px 12px;text-align:center;transition:transform .2s,box-shadow .2s;}
.fc-stat:hover{transform:translateY(-2px);box-shadow:var(--sh-sm);}
.fc-stat-val{font-size:1.4rem;font-weight:900;color:var(--c-p1);}
.fc-stat-lbl{font-size:.66rem;font-weight:600;color:var(--tx-3);margin-top:2px;}
.fc-progress-bar{height:7px;border-radius:99px;background:var(--bd-base);
  margin-bottom:18px;overflow:hidden;}
.fc-progress-fill{height:100%;border-radius:99px;
  background:linear-gradient(90deg,var(--c-p1),#34d399);
  transition:width .6s cubic-bezier(.22,1,.36,1);}
.fc-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px;}
@media(max-width:520px){.fc-grid{grid-template-columns:1fr;}}
.fc-card-wrap{perspective:900px;}
.fc-card{position:relative;width:100%;min-height:140px;cursor:pointer;
  transform-style:preserve-3d;transition:transform .45s cubic-bezier(.22,1,.36,1);}
.fc-card.flipped{transform:rotateY(180deg);}
.fc-face{position:absolute;inset:0;backface-visibility:hidden;-webkit-backface-visibility:hidden;
  border-radius:16px;padding:16px;display:flex;flex-direction:column;
  border:1.5px solid var(--bd-base);box-shadow:var(--sh-sm);}
.fc-face-front{background:var(--bg-histrow);}
.fc-face-back{background:var(--bg-soft);transform:rotateY(180deg);}
.fc-card-subj{font-size:.68rem;font-weight:800;padding:2px 8px;border-radius:99px;
  background:rgba(99,102,241,.12);color:var(--c-p1);align-self:flex-start;margin-bottom:8px;}
.fc-card-text{font-size:.9rem;font-weight:700;color:var(--tx-1);flex:1;
  display:flex;align-items:center;line-height:1.5;word-break:break-word;}
.fc-card-hint{font-size:.65rem;font-weight:600;color:var(--tx-3);margin-top:8px;text-align:center;}
.fc-card-actions{display:flex;align-items:center;justify-content:space-between;margin-top:10px;}
.fc-remember-btn{display:flex;align-items:center;gap:5px;cursor:pointer;
  font-size:.72rem;font-weight:700;color:var(--tx-3);background:none;border:none;
  padding:4px 8px;border-radius:8px;font-family:inherit;
  transition:color .15s,background .15s,transform .1s;}
.fc-remember-btn:hover{transform:scale(1.05);}
.fc-remember-btn.remembered{color:#059669;background:var(--g-bg);}
[data-theme="dark"] .fc-remember-btn.remembered{color:#34d399;}
.fc-del-btn{background:none;border:none;cursor:pointer;font-size:.8rem;
  color:var(--tx-3);padding:3px 6px;border-radius:6px;
  transition:color .15s,background .15s,transform .1s;}
.fc-del-btn:hover{color:#f87171;background:var(--y-bg);transform:scale(1.1);}
.fc-empty{text-align:center;padding:32px 20px;color:var(--tx-3);font-size:.88rem;font-weight:500;}
.fc-empty-ico{font-size:2.5rem;display:block;margin-bottom:10px;}
.fc-form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;}
@media(max-width:520px){.fc-form-grid{grid-template-columns:1fr;}}
.fc-textarea{width:100%;padding:9px 12px;border:1.5px solid var(--bd-input);
  border-radius:11px;font-family:inherit;font-size:.88rem;font-weight:500;
  color:var(--tx-1);background:var(--bg-card);outline:none;resize:vertical;min-height:60px;
  transition:border-color .2s,box-shadow .2s;}
.fc-textarea:focus{border-color:var(--c-p1);box-shadow:0 0 0 3px rgba(99,102,241,.12);}
.fc-textarea::placeholder{color:var(--tx-3);}
.fc-card.fc-enter{animation:taskSlideIn .3s cubic-bezier(.22,1,.36,1) both;}
.fc-card.fc-exit{animation:taskSlideOut .25s ease both;}
</style>
</head>
<body>

<button class="dm-toggle" id="dmBtn" data-ico="üåô" onclick="toggleDark()"></button>

<header class="pg-head">
  <span class="crown">üéì</span>
  <h1>Edunova NƒêK <span class="pro-badge">PRO</span></h1>
  <p>B·∫£ng ƒëi·ªÉm ¬∑ K·∫ø ho·∫°ch h·ªçc t·∫≠p ¬∑ Ph√¢n t√≠ch ¬∑ Pomodoro Pro ¬∑ H·ªó tr·ª£ AI</p>
</header>

<div class="tab-bar">
  <button class="tab-btn active" id="tab-grade"     onclick="switchTab('grade')">üéì H·ªçc l·ª±c</button>
  <button class="tab-btn"        id="tab-planner"   onclick="switchTab('planner')">üìÖ K·∫ø ho·∫°ch</button>
  <button class="tab-btn"        id="tab-analytics" onclick="switchTab('analytics')">üìä Th·ªëng k√™</button>
  <button class="tab-btn"        id="tab-ai"        onclick="switchTab('ai')">ü§ñ Tr·ª£ l√Ω AI</button>
</div>

<div class="card">
  <div class="card-stripe"></div>
  <div class="card-body">

    <!-- TAB: GRADE -->
    <div id="sec-grade">
      <p class="sec-lbl">üë§ Th√¥ng tin h·ªçc sinh</p>
      <div class="name-field">
        <div class="fi">
          <span class="fi-ico">üßë‚Äçüéì</span>
          <input type="text" id="tenHS" placeholder="Nh·∫≠p h·ªç v√† t√™n h·ªçc sinh‚Ä¶" maxlength="60"/>
        </div>
      </div>
      <p class="sec-lbl">üìö ƒêi·ªÉm c√°c m√¥n h·ªçc</p>
      <div class="mon-list" id="monList"></div>
      <button class="btn-add-subj" onclick="openAddSubjModal()">‚ûï Th√™m m√¥n h·ªçc kh√°c</button>
      <div class="g-err" id="gErr"></div>
      <div class="actions">
        <button class="btn btn-calc"  onclick="tinhKQ()">‚ú® T√≠nh k·∫øt qu·∫£</button>
        <button class="btn btn-save"  id="btnSave" onclick="luuKQ()"   disabled>üíæ L∆∞u</button>
        <button class="btn btn-pdf"   id="btnPdf"  onclick="xuatPDF()" disabled>üìÑ PDF</button>
        <button class="btn btn-reset" onclick="nhapLai()">üîÑ Nh·∫≠p l·∫°i</button>
      </div>
      <div class="result-wrap" id="resWrap">
        <div class="res-card" id="resCard">
          <div class="res-inner">
            <div class="res-top">
              <div class="res-student">
                <div class="res-avatar" id="rAvatar">üèÜ</div>
                <div>
                  <div class="r-name" id="rName">‚Äî</div>
                  <div class="r-sub">K·∫øt qu·∫£ h·ªçc k·ª≥</div>
                </div>
              </div>
              <div class="rank-pill" id="rPill">‚Äî</div>
            </div>
            <div class="prog-section">
              <div class="prog-header">
                <span class="p-label">üìä ƒêi·ªÉm trung b√¨nh c·∫£ nƒÉm</span>
                <span class="p-val" id="rAvg">‚Äî</span>
              </div>
              <div class="scale-bar">
                <div class="scale-track"></div>
                <div class="scale-fill"   id="rScaleFill" style="width:0%"></div>
                <div class="scale-needle" id="rNeedle"    style="left:0%"></div>
              </div>
              <div class="scale-ticks">
                <span>0</span><span>2.5</span><span>5</span>
                <span>6.5</span><span>8</span><span>10</span>
              </div>
            </div>
            <div class="chart-section">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
                <span class="ch-label">üì° Bi·ªÉu ƒë·ªì Radar TBM c√°c m√¥n</span>
              </div>
              <div class="chart-legend" id="chartLegend"></div>
              <div class="chart-wrap"><canvas id="radarChart"></canvas></div>
              <div class="chart-stats">
                <div class="cstat"><div class="cs-val cs-hi" id="csMax">‚Äî</div><div class="cs-lbl">M√¥n cao nh·∫•t</div></div>
                <div class="cstat"><div class="cs-val cs-lo" id="csMin">‚Äî</div><div class="cs-lbl">M√¥n th·∫•p nh·∫•t</div></div>
                <div class="cstat"><div class="cs-val" id="csAvg">‚Äî</div><div class="cs-lbl">TBM c·∫£ nƒÉm</div></div>
              </div>
            </div>
            <div class="rank-desc">
              <div class="rd-title">üìå √ù nghƒ©a x·∫øp lo·∫°i</div>
              <div class="rd-text" id="rDescText">‚Äî</div>
              <div class="rd-tips" id="rDescTips"></div>
            </div>
            <table class="score-tbl">
              <thead>
                <tr>
                  <th>M√¥n h·ªçc</th>
                  <th style="text-align:right">TBM HK1</th>
                  <th style="text-align:right">TBM HK2</th>
                  <th style="text-align:right">TBM c·∫£ nƒÉm</th>
                </tr>
              </thead>
              <tbody id="rTbody"></tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="history-wrap" id="histWrap">
        <div class="history-header">
          <h3>üìã K·∫øt qu·∫£ ƒë√£ l∆∞u</h3>
          <button class="btn-clear-hist" onclick="xoaTatCa()">üóë Xo√° t·∫•t c·∫£</button>
        </div>
        <div id="histList"></div>
      </div>
    </div>

    <!-- TAB: PLANNER -->
    <div id="sec-planner" class="sp-section">
      <p class="sec-lbl">üìÖ T·∫°o k·∫ø ho·∫°ch h·ªçc t·∫≠p</p>
      <div class="sp-form">
        <div class="sp-form-grid">
          <div class="sp-field">
            <label>M√¥n h·ªçc</label>
            <select class="sp-inp" id="sp-subj"></select>
          </div>
          <div class="sp-field">
            <label>Deadline</label>
            <input type="date" class="sp-inp" id="sp-date"/>
          </div>
          <div class="sp-field" style="grid-column:1/-1;">
            <label>N·ªôi dung h·ªçc</label>
            <input type="text" class="sp-inp" id="sp-title" placeholder="VD: Luy·ªán ƒë·ªÅ t√≠ch ph√¢n, √în t·ª´ v·ª±ng Unit 5‚Ä¶" maxlength="120"/>
          </div>
        </div>
        <button class="btn-sp-add" onclick="spAddTask()">‚ûï Th√™m k·∫ø ho·∫°ch</button>
      </div>

      <div class="sp-streak-box" id="sp-streak-box">
        <div class="streak-left">
          <div class="streak-flame">üî•</div>
          <div class="streak-info">
            <div class="streak-label">Chu·ªói h·ªçc t·∫≠p</div>
            <div class="streak-count" id="streak-count">0 <span>ng√†y</span></div>
          </div>
        </div>
        <div class="streak-badge" id="streak-badge" style="display:none">üåü ƒêang h·ªçc r·∫•t ƒë·ªÅu ƒë·∫∑n!</div>
      </div>

      <div class="sp-heatmap">
        <div class="heatmap-title">üìÖ L·ªãch h·ªçc 7 ng√†y g·∫ßn nh·∫•t</div>
        <div class="heatmap-grid" id="heatmap-grid"></div>
      </div>

      <div class="sp-stats">
        <div class="sp-stat"><div class="sp-stat-val" id="sp-total">0</div><div class="sp-stat-lbl">T·ªïng task</div></div>
        <div class="sp-stat"><div class="sp-stat-val" id="sp-done-cnt">0</div><div class="sp-stat-lbl">Ho√†n th√†nh</div></div>
        <div class="sp-stat"><div class="sp-stat-val" id="sp-pending">0</div><div class="sp-stat-lbl">C√≤n l·∫°i</div></div>
        <div class="sp-stat"><div class="sp-stat-val" id="sp-overdue">0</div><div class="sp-stat-lbl" style="color:#f87171">Qu√° h·∫°n</div></div>
      </div>

      <div class="sp-filter">
        <button class="sp-filter-btn active" data-f="all"     onclick="spSetFilter('all',this)">T·∫•t c·∫£</button>
        <button class="sp-filter-btn"        data-f="pending" onclick="spSetFilter('pending',this)">Ch∆∞a xong</button>
        <button class="sp-filter-btn"        data-f="done"    onclick="spSetFilter('done',this)">Ho√†n th√†nh</button>
        <button class="sp-filter-btn"        data-f="overdue" onclick="spSetFilter('overdue',this)">Qu√° h·∫°n</button>
      </div>
      <div class="sp-task-list" id="sp-list"></div>

      <p class="sec-lbl" style="margin-top:24px;">‚è±Ô∏è Pomodoro Pro</p>
      <div class="pomo-wrap">
        <div class="pomo-config">
          <div class="sp-field">
            <label>M√¥n h·ªçc</label>
            <select class="sp-inp" id="pomo-subj"></select>
          </div>
          <div class="sp-field">
            <label>Ph√∫t h·ªçc</label>
            <input type="number" class="sp-inp" id="pomo-study" value="25" min="1" max="120"/>
          </div>
          <div class="sp-field">
            <label>Ph√∫t ngh·ªâ</label>
            <input type="number" class="sp-inp" id="pomo-break" value="5" min="1" max="60"/>
          </div>
        </div>
        <div class="pomo-sound-bar">
          <label class="sound-toggle" id="sound-toggle-lbl">
            <span class="sound-icon" id="sound-icon">üîî</span>
            <span id="sound-toggle-txt">√Çm thanh b·∫≠t</span>
            <input type="checkbox" id="sound-enabled" checked style="display:none" onchange="pomoSoundToggle()"/>
          </label>
          <select class="sound-select" id="sound-type">
            <option value="bell">üîî Chu√¥ng</option>
            <option value="chime">üéµ Giai ƒëi·ªáu</option>
            <option value="digital">üìü Digital</option>
          </select>
          <span style="font-size:.72rem;color:var(--tx-3);font-weight:600;">Vol:</span>
          <input type="range" class="sound-vol" id="sound-vol" min="0" max="1" step="0.1" value="0.7"/>
        </div>
        <div class="pomo-display">
          <div class="pomo-phase" id="pomo-phase">S·∫µn s√†ng</div>
          <div class="pomo-clock" id="pomo-clock">25:00</div>
          <div class="pomo-ring-wrap">
            <svg class="pomo-ring" viewBox="0 0 120 120">
              <circle class="pomo-ring-bg" cx="60" cy="60" r="52"/>
              <circle class="pomo-ring-fill" id="pomo-ring-fill" cx="60" cy="60" r="52"
                stroke-dasharray="326.7" stroke-dashoffset="326.7"/>
            </svg>
          </div>
          <div class="pomo-btns">
            <button class="pomo-btn pomo-start" id="pomo-btn-start" onclick="pomoStart()">‚ñ∂ B·∫Øt ƒë·∫ßu</button>
            <button class="pomo-btn pomo-pause" id="pomo-btn-pause" onclick="pomoPause()" style="display:none">‚è∏ T·∫°m d·ª´ng</button>
            <button class="pomo-btn pomo-reset" onclick="pomoReset()">‚Ü∫ ƒê·∫∑t l·∫°i</button>
          </div>
        </div>
        <div class="pomo-stats">
          <div class="sp-stat"><div class="sp-stat-val" id="ps-total-min">0</div><div class="sp-stat-lbl">T·ªïng ph√∫t h·ªçc</div></div>
          <div class="sp-stat"><div class="sp-stat-val" id="ps-sessions">0</div><div class="sp-stat-lbl">Phi√™n ho√†n th√†nh</div></div>
          <div class="sp-stat" style="flex:2;min-width:140px;">
            <div class="sp-stat-val" style="font-size:1rem" id="ps-top-subj">‚Äî</div>
            <div class="sp-stat-lbl">M√¥n h·ªçc nhi·ªÅu nh·∫•t</div>
          </div>
        </div>
      </div>

      <p class="sec-lbl" style="margin-top:24px;">üóìÔ∏è Th·ªùi kh√≥a bi·ªÉu (24h)</p>
      <div class="sp-form" id="tt-form">
        <div class="sp-form-grid">
          <div class="sp-field">
            <label>M√¥n h·ªçc</label>
            <select class="sp-inp" id="tt-subj"></select>
          </div>
          <div class="sp-field">
            <label>Th·ª© trong tu·∫ßn</label>
            <select class="sp-inp" id="tt-day">
              <option value="0">Ch·ªß nh·∫≠t</option>
              <option value="1">Th·ª© 2</option>
              <option value="2">Th·ª© 3</option>
              <option value="3">Th·ª© 4</option>
              <option value="4">Th·ª© 5</option>
              <option value="5">Th·ª© 6</option>
              <option value="6">Th·ª© 7</option>
            </select>
          </div>
          <div class="sp-field">
            <label>Gi·ªù b·∫Øt ƒë·∫ßu (24h)</label>
            <div class="tt-time-group">
              <input class="tt-time-inp" type="text" id="tt-start"
                placeholder="07:30" maxlength="5" oninput="ttAutoColon(this)"/>
            </div>
          </div>
          <div class="sp-field">
            <label>Gi·ªù k·∫øt th√∫c (24h)</label>
            <div class="tt-time-group">
              <input class="tt-time-inp" type="text" id="tt-end"
                placeholder="09:00" maxlength="5" oninput="ttAutoColon(this)"/>
            </div>
          </div>
        </div>
        <button class="btn-sp-add" onclick="ttAdd()">‚ûï Th√™m l·ªãch h·ªçc</button>
      </div>
      <div class="tt-list" id="tt-list"></div>
    </div>

    <!-- TAB: ANALYTICS -->
    <div id="sec-analytics" class="sp-section">
      <p class="sec-lbl">üìä Ph√¢n t√≠ch h·ªçc t·∫≠p</p>
      <div class="analytics-grid">
        <div class="an-card">
          <div class="an-title">‚è± T·ªïng gi·ªù tu·∫ßn n√†y</div>
          <div class="an-val" id="an-week-hrs">0h</div>
          <div class="an-sub" id="an-week-min">0 ph√∫t</div>
          <div class="an-compare" id="an-week-compare">‚Äî Ch∆∞a c√≥ d·ªØ li·ªáu tu·∫ßn tr∆∞·ªõc</div>
        </div>
        <div class="an-card">
          <div class="an-title">üèÜ M√¥n h·ªçc nhi·ªÅu nh·∫•t</div>
          <div class="an-val" id="an-top-subj" style="font-size:1.3rem">‚Äî</div>
          <div class="an-sub" id="an-top-min">0 ph√∫t</div>
        </div>
        <div class="an-card">
          <div class="an-title">‚úÖ % Ho√†n th√†nh task</div>
          <div class="prog-circle-wrap">
            <svg class="prog-circle-svg" width="80" height="80" viewBox="0 0 80 80">
              <circle class="prog-circle-bg" cx="40" cy="40" r="32"/>
              <circle class="prog-circle-fill" id="an-prog-fill" cx="40" cy="40" r="32"
                stroke-dasharray="201" stroke-dashoffset="201"/>
            </svg>
            <div style="font-size:1.4rem;font-weight:900;color:var(--c-p1)" id="an-prog-pct">0%</div>
          </div>
        </div>
        <div class="an-card">
          <div class="an-title">üî• Chu·ªói Pomodoro</div>
          <div class="an-val" id="an-pomo-streak">0</div>
          <div class="an-sub">ng√†y li√™n ti·∫øp</div>
        </div>
        <div class="an-card an-card-wide">
          <div class="an-title">üìÖ Heatmap 30 ng√†y g·∫ßn nh·∫•t</div>
          <div class="hm30-grid" id="hm30-grid"></div>
        </div>
        <div class="an-card an-card-wide">
          <div class="an-title">üìà Ph√∫t h·ªçc theo ng√†y (7 ng√†y)</div>
          <div class="an-chart-wrap"><canvas id="an-bar-chart"></canvas></div>
        </div>
        <div class="an-card an-card-wide">
          <div class="an-title">ü•ß Ph√¢n b·ªï th·ªùi gian theo m√¥n</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:center;">
            <div style="position:relative;height:180px;"><canvas id="an-doughnut-chart"></canvas></div>
            <div id="an-legend" style="display:flex;flex-direction:column;gap:6px;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- TAB: AI MODULE -->
    <div id="sec-ai" class="sp-section">
      <p class="sec-lbl">ü§ñ Tr·ª£ l√Ω AI h·ªçc t·∫≠p ‚Äî H·ªó tr·ª£ b·ªüi Gemini</p>

      <div class="ai-block">
        <div class="ai-block-title">
          <span class="ai-ico">üéí</span>
          <span>H·ªì s∆° h·ªçc t·∫≠p</span>
        </div>
        <div class="ai-profile-grid">
          <div class="sp-field">
            <label>L·ªõp</label>
            <select class="sp-inp" id="profile-grade" onchange="aiSaveProfile()">
              <option value="">-- Ch·ªçn l·ªõp --</option>
              <option value="9">L·ªõp 9</option>
              <option value="10">L·ªõp 10</option>
              <option value="11">L·ªõp 11</option>
              <option value="12">L·ªõp 12</option>
            </select>
          </div>
          <div class="sp-field">
            <label>B·ªô s√°ch</label>
            <select class="sp-inp" id="profile-textbook" onchange="aiSaveProfile()">
              <option value="">-- Ch·ªçn s√°ch --</option>
              <option value="C√°nh Di·ªÅu">C√°nh Di·ªÅu</option>
              <option value="K·∫øt n·ªëi tri th·ª©c">K·∫øt n·ªëi tri th·ª©c</option>
              <option value="Ch√¢n tr·ªùi s√°ng t·∫°o">Ch√¢n tr·ªùi s√°ng t·∫°o</option>
            </select>
          </div>
          <div class="sp-field">
            <label>Ban h·ªçc</label>
            <select class="sp-inp" id="profile-track" onchange="aiSaveProfile()">
              <option value="">-- Ch·ªçn ban --</option>
              <option value="T·ª± nhi√™n">T·ª± nhi√™n</option>
              <option value="X√£ h·ªôi">X√£ h·ªôi</option>
              <option value="C∆° b·∫£n">C∆° b·∫£n</option>
            </select>
          </div>
        </div>
        <div style="margin-top:8px;font-size:.72rem;font-weight:600;color:var(--tx-3)" id="profile-status">Ch∆∞a l∆∞u h·ªì s∆°</div>
      </div>

      <div class="ai-block" id="ai-block-analysis">
        <div class="ai-block-title">
          <span class="ai-ico">üß†</span>
          <span>AI Ph√¢n t√≠ch h·ªçc l·ª±c</span>
        </div>
        <div id="ai-analysis-content">
          <div class="ai-no-data">
            <span class="ai-nd-ico">üìä</span>
            H√£y t√≠nh k·∫øt qu·∫£ ·ªü tab <strong>H·ªçc l·ª±c</strong> tr∆∞·ªõc, r·ªìi b·∫•m Ph√¢n t√≠ch ƒë·ªÉ AI Gemini nh·∫≠n x√©t.
          </div>
        </div>
        <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;">
          <button class="btn-ai-gen" id="btn-ai-analysis" onclick="aiRunAnalysis()">üîç Ph√¢n t√≠ch ngay</button>
        </div>
      </div>

      <div class="ai-block" id="ai-block-plan">
        <div class="ai-block-title">
          <span class="ai-ico">üìÖ</span>
          <span>AI T·∫°o k·∫ø ho·∫°ch 14 ng√†y</span>
        </div>
        <div id="ai-plan-content">
          <div class="ai-no-data">
            <span class="ai-nd-ico">üìã</span>
            C·∫ßn c√≥ k·∫øt qu·∫£ ƒëi·ªÉm tr∆∞·ªõc. B·∫•m <strong>"T·∫°o k·∫ø ho·∫°ch"</strong> ƒë·ªÉ AI t·ª± ƒë·ªông t·∫°o 14 ng√†y √¥n t·∫≠p d·ª±a tr√™n c√°c m√¥n y·∫øu nh·∫•t.
          </div>
        </div>
        <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
          <button class="btn-ai-gen" id="btn-ai-plan" onclick="aiGenPlan()">‚ú® T·∫°o k·∫ø ho·∫°ch</button>
          <button class="btn-ai-push" id="ai-push-btn" onclick="aiPushToPlanner()" disabled>‚ûï Th√™m v√†o K·∫ø ho·∫°ch</button>
        </div>
      </div>

      <div class="ai-block" id="ai-block-flashcard">
        <div class="ai-block-title">
          <span class="ai-ico">üÉè</span>
          <span>Flashcard ghi nh·ªõ</span>
        </div>
        <div class="sp-form" style="margin-bottom:16px;">
          <div class="fc-form-grid">
            <div class="sp-field">
              <label>M√¥n h·ªçc</label>
              <select class="sp-inp" id="fc-subj"></select>
            </div>
            <div class="sp-field">
              <label>M·∫∑t tr∆∞·ªõc (c√¢u h·ªèi / kh√°i ni·ªám)</label>
              <textarea class="fc-textarea" id="fc-front" placeholder="VD: ƒê·ªãnh l√Ω Pytago‚Ä¶" maxlength="300"></textarea>
            </div>
            <div class="sp-field">
              <label>M·∫∑t sau (ƒë√°p √°n / gi·∫£i th√≠ch)</label>
              <textarea class="fc-textarea" id="fc-back" placeholder="VD: a¬≤ + b¬≤ = c¬≤" maxlength="600"></textarea>
            </div>
          </div>
          <button class="btn-sp-add" onclick="fcAdd()">‚ûï Th√™m th·∫ª</button>
        </div>
        <div class="fc-stats-row">
          <div class="fc-stat"><div class="fc-stat-val" id="fc-total">0</div><div class="fc-stat-lbl">T·ªïng th·∫ª</div></div>
          <div class="fc-stat"><div class="fc-stat-val" id="fc-remembered-count" style="color:#059669">0</div><div class="fc-stat-lbl">ƒê√£ nh·ªõ</div></div>
          <div class="fc-stat"><div class="fc-stat-val" id="fc-pending-count" style="color:#f87171">0</div><div class="fc-stat-lbl">Ch∆∞a nh·ªõ</div></div>
          <div class="fc-stat"><div class="fc-stat-val" id="fc-pct">0%</div><div class="fc-stat-lbl">% Ghi nh·ªõ</div></div>
        </div>
        <div class="fc-progress-bar"><div class="fc-progress-fill" id="fc-progress-fill" style="width:0%"></div></div>
        <div class="sp-filter" style="margin-bottom:16px;">
          <button class="sp-filter-btn active" onclick="fcSetFilter('all',this)">T·∫•t c·∫£</button>
          <button class="sp-filter-btn" onclick="fcSetFilter('pending',this)">Ch∆∞a nh·ªõ</button>
          <button class="sp-filter-btn" onclick="fcSetFilter('remembered',this)">ƒê√£ nh·ªõ</button>
        </div>
        <div class="fc-grid" id="fc-grid"></div>
      </div>

      <div class="ai-block" id="ai-block-chat">
        <div class="ai-block-title">
          <span class="ai-ico">üí¨</span>
          <span>Tr·ª£ l√Ω AI h·ªó tr·ª£ h·ªçc t·∫≠p</span>
        </div>
        <div class="ai-chat-wrap">
          <div id="chat-status-bar" style="display:none;margin-bottom:6px;"></div>
          <div class="ai-chat-box" id="ai-chat-box">
            <div class="chat-msg ai">
              <div class="chat-avatar">ü§ñ</div>
              <div class="chat-bubble">Xin ch√†o! T√¥i l√† tr·ª£ l√Ω h·ªçc t·∫≠p AI. H√£y h·ªèi t√¥i b·∫•t c·ª© ƒëi·ªÅu g√¨ v·ªÅ m√¥n h·ªçc, b√†i t·∫≠p, hay ph∆∞∆°ng ph√°p h·ªçc t·∫≠p nh√©! üìö</div>
            </div>
          </div>
          <div class="chat-input-row">
            <textarea class="chat-textarea" id="chat-input" rows="1"
              placeholder="H·ªèi v·ªÅ b√†i h·ªçc, gi·∫£i th√≠ch kh√°i ni·ªám, luy·ªán t·∫≠p‚Ä¶"
              onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();aiChatSend();}"></textarea>
            <button class="btn-chat-send" id="btn-chat-send" onclick="aiChatSend()">üì§ G·ª≠i</button>
          </div>
          <button class="btn-chat-clear" onclick="aiChatClear()">üóë Xo√° l·ªãch s·ª≠ chat</button>
        </div>
      </div>

    </div>

  </div>
</div>

<!-- Timetable Edit Modal -->
<div class="tt-modal-overlay" id="tt-modal-overlay">
  <div class="tt-modal">
    <h3>‚úèÔ∏è Ch·ªânh s·ª≠a l·ªãch h·ªçc</h3>
    <input type="hidden" id="tt-edit-id"/>
    <div class="sp-form-grid">
      <div class="sp-field">
        <label>M√¥n h·ªçc</label>
        <select class="sp-inp" id="tt-edit-subj"></select>
      </div>
      <div class="sp-field">
        <label>Th·ª©</label>
        <select class="sp-inp" id="tt-edit-day">
          <option value="0">Ch·ªß nh·∫≠t</option>
          <option value="1">Th·ª© 2</option>
          <option value="2">Th·ª© 3</option>
          <option value="3">Th·ª© 4</option>
          <option value="4">Th·ª© 5</option>
          <option value="5">Th·ª© 6</option>
          <option value="6">Th·ª© 7</option>
        </select>
      </div>
      <div class="sp-field">
        <label>Gi·ªù b·∫Øt ƒë·∫ßu (24h)</label>
        <input class="tt-time-inp" type="text" id="tt-edit-start" placeholder="07:30" maxlength="5" oninput="ttAutoColon(this)"/>
      </div>
      <div class="sp-field">
        <label>Gi·ªù k·∫øt th√∫c (24h)</label>
        <input class="tt-time-inp" type="text" id="tt-edit-end" placeholder="09:00" maxlength="5" oninput="ttAutoColon(this)"/>
      </div>
    </div>
    <div class="tt-modal-btns">
      <button class="btn-modal-cancel" onclick="ttCloseModal()">Hu·ª∑</button>
      <button class="btn-sp-add" onclick="ttSaveEdit()">üíæ L∆∞u ch·ªânh s·ª≠a</button>
    </div>
  </div>
</div>

<!-- Add Subject Modal -->
<div class="asModal-overlay" id="asModal-overlay">
  <div class="asModal">
    <h3>‚ûï Th√™m m√¥n h·ªçc m·ªõi</h3>
    <label for="asModal-name">T√™n m√¥n h·ªçc</label>
    <input type="text" id="asModal-name" placeholder="VD: √Çm nh·∫°c, M·ªπ thu·∫≠t‚Ä¶" maxlength="50"
      onkeydown="if(event.key==='Enter')confirmAddSubj()"/>
    <span class="asModal-err" id="asModal-err"></span>
    <div class="asModal-btns">
      <button class="asModal-cancel" onclick="closeAddSubjModal()">Hu·ª∑</button>
      <button class="btn-sp-add" onclick="confirmAddSubj()">‚úÖ Th√™m m√¥n</button>
    </div>
  </div>
</div>

<footer class="pg-foot">¬© 2025 ¬∑ Edunova NƒêK ¬∑ Chu·∫©n h·ªçc b·∫° Vi·ªát Nam</footer>
<div class="toast" id="toast"></div>

<script>
const MON = [
  {id:'toan', ten:'To√°n',             ico:'‚ûï'},
  {id:'van',  ten:'Ng·ªØ vƒÉn',          ico:'üìñ'},
  {id:'anh',  ten:'Ti·∫øng Anh',        ico:'üî§'},
  {id:'ly',   ten:'V·∫≠t l√Ω',           ico:'‚ö°'},
  {id:'hoa',  ten:'H√≥a h·ªçc',          ico:'üß™'},
  {id:'sinh', ten:'Sinh h·ªçc',         ico:'üåø'},
  {id:'su',   ten:'L·ªãch s·ª≠',          ico:'üèõÔ∏è'},
  {id:'dia',  ten:'ƒê·ªãa l√Ω',           ico:'üåç'},
  {id:'gdcd', ten:'GDKT & Ph√°p lu·∫≠t', ico:'‚öñÔ∏è'},
  {id:'tin',  ten:'Tin h·ªçc',          ico:'üíª'},
  {id:'gdqp', ten:'GD Qu·ªëc ph√≤ng',    ico:'üõ°Ô∏è'},
  {id:'cn',   ten:'C√¥ng ngh·ªá',        ico:'üõ†Ô∏è'},
];

const RANK = [
  {min:8.0,lbl:'Gi·ªèi',      cls:'gioi',ico:'üèÜ',scCls:'sc-g',
   rgb:'52,211,153',pdfColor:[5,150,105],pdfBg:[209,250,229],
   desc:'H·ªçc sinh ƒë·∫°t th√†nh t√≠ch xu·∫•t s·∫Øc, n·∫Øm v·ªØng ki·∫øn th·ª©c to√†n di·ªán, c√≥ kh·∫£ nƒÉng t∆∞ duy ƒë·ªôc l·∫≠p v√† s√°ng t·∫°o.',
   tips:['N·∫Øm v·ªØng l√Ω thuy·∫øt','L√†m t·ªët b√†i t·∫≠p n√¢ng cao','T·ª± h·ªçc hi·ªáu qu·∫£','T∆∞ duy s√°ng t·∫°o']},
  {min:6.5,lbl:'Kh√°',       cls:'kha', ico:'ü•à',scCls:'sc-k',
   rgb:'96,165,250',pdfColor:[29,78,216],pdfBg:[219,234,254],
   desc:'H·ªçc sinh c√≥ k·∫øt qu·∫£ t·ªët, hi·ªÉu b√†i v√† v·∫≠n d·ª•ng ki·∫øn th·ª©c ·ªü m·ª©c kh√°. C·∫ßn c·ªë g·∫Øng th√™m ƒë·ªÉ ƒë·∫°t m·ª©c Gi·ªèi.',
   tips:['Hi·ªÉu b√†i ·ªü m·ª©c kh√°','C·∫ßn √¥n luy·ªán th√™m','C√≥ n·ªÅn t·∫£ng v·ªØng','Ti·∫øp t·ª•c ph√°t huy']},
  {min:5.0,lbl:'Trung b√¨nh',cls:'tb',  ico:'üìò',scCls:'sc-t',
   rgb:'251,191,36',pdfColor:[133,77,14],pdfBg:[254,249,195],
   desc:'H·ªçc sinh ƒë·∫°t m·ª©c c∆° b·∫£n, c·∫ßn c·∫£i thi·ªán c√°c m√¥n c√≤n y·∫øu v√† tƒÉng c∆∞·ªùng √¥n luy·ªán ƒë·ªÅu ƒë·∫∑n h∆°n.',
   tips:['N·∫Øm ki·∫øn th·ª©c c∆° b·∫£n','C·∫ßn luy·ªán t·∫≠p th√™m','Ch√∫ √Ω m√¥n y·∫øu','TƒÉng th·ªùi gian √¥n b√†i']},
  {min:0,  lbl:'Y·∫øu',       cls:'yeu', ico:'‚ö†Ô∏è',scCls:'sc-y',
   rgb:'248,113,113',pdfColor:[153,27,27],pdfBg:[254,226,226],
   desc:'H·ªçc sinh c·∫ßn n·ªó l·ª±c nhi·ªÅu h∆°n, n√™n t√¨m s·ª± h·ªó tr·ª£ t·ª´ th·∫ßy c√¥ v√† gia ƒë√¨nh ƒë·ªÉ c·∫£i thi·ªán k·ªãp th·ªùi.',
   tips:['B·ªï sung ki·∫øn th·ª©c','T√¨m h·ªó tr·ª£ th·∫ßy c√¥','L·∫≠p k·∫ø ho·∫°ch h·ªçc','Kh√¥ng b·ªè cu·ªôc!']},
];

let currentResult  = null;
let radarChartInst = null;
let anBarChart     = null;
let anDoughnut     = null;
const txCount = {};
MON.forEach(m => { txCount[m.id] = {1: 4, 2: 4}; });

/* ‚ïê‚ïê‚ïê‚ïê STUDY ACTIVITY KEY (for flashcard streak) ‚ïê‚ïê‚ïê‚ïê */
const STUDY_ACTIVITY_KEY = 'studyActivity';
function studyActivityLoad() {
  try { return JSON.parse(localStorage.getItem(STUDY_ACTIVITY_KEY)) || {lastDate: null}; } catch(e) { return {lastDate: null}; }
}
function studyActivitySave(a) {
  try { localStorage.setItem(STUDY_ACTIVITY_KEY, JSON.stringify(a)); } catch(e) {}
}
function studyActivityMarkToday() {
  const today = todayStr();
  const act = studyActivityLoad();
  if (act.lastDate === today) return false;
  studyActivitySave({lastDate: today});
  return true;
}

function switchTab(tab) {
  ['grade','planner','analytics','ai'].forEach(t => {
    const s = document.getElementById('sec-'+t);
    const b = document.getElementById('tab-'+t);
    if (s) s.style.display = 'none';
    if (b) b.classList.remove('active');
  });
  const sec = document.getElementById('sec-'+tab);
  const btn = document.getElementById('tab-'+tab);
  if (sec) { sec.style.display = ''; sec.classList.add('active'); }
  if (btn) btn.classList.add('active');
  if (tab === 'planner')   spRender();
  if (tab === 'analytics') anRender();
  if (tab === 'ai')        { aiLoadProfile(); chatRenderStatusBar(); fcRender(); }
}

const DM_KEY = 'hocLucDarkMode';
function applyTheme(dark) {
  document.documentElement.setAttribute('data-theme', dark ? 'dark' : 'light');
  document.getElementById('dmBtn').setAttribute('data-ico', dark ? '‚òÄÔ∏è' : 'üåô');
  if (radarChartInst) updateRadarTheme();
}
function toggleDark() {
  const d = document.documentElement.getAttribute('data-theme') === 'dark';
  applyTheme(!d);
  try { localStorage.setItem(DM_KEY, !d ? '1' : '0'); } catch(e){}
  showToast(!d ? 'üåô Ch·∫ø ƒë·ªô t·ªëi ƒë√£ b·∫≠t' : '‚òÄÔ∏è Ch·∫ø ƒë·ªô s√°ng ƒë√£ b·∫≠t');
}
(function initTheme() {
  let s = null;
  try { s = localStorage.getItem(DM_KEY); } catch(e){}
  if (s !== null) { applyTheme(s === '1'); return; }
  if (window.matchMedia?.('(prefers-color-scheme: dark)').matches) applyTheme(true);
})();

function buildMonUI() {
  const list = document.getElementById('monList');
  list.innerHTML = '';
  MON.forEach(m => {
    if (!txCount[m.id]) txCount[m.id] = {1: 4, 2: 4};
    const card = document.createElement('div');
    card.className = 'mon-card';
    card.id = 'card_' + m.id;
    const isCustom = m._custom === true;
    const delBtn = isCustom
      ? `<button class="mon-del-btn" title="Xo√° m√¥n n√†y" onclick="deleteCustomSubj('${m.id}',event)">‚úï</button>`
      : '';
    card.innerHTML = `
      <div class="mon-header" onclick="toggleMon('${m.id}')">
        <div class="mon-ico-chip">${m.ico}</div>
        <div class="mon-title-wrap">
          <div class="mon-title">${m.ten}</div>
          <div class="mon-subtitle" id="sub_${m.id}">Ch∆∞a nh·∫≠p ƒëi·ªÉm</div>
        </div>
        <div class="mon-tbm-display" id="tbm_${m.id}">‚Äî</div>
        ${delBtn}
        <div class="mon-chevron">‚ñº</div>
      </div>
      <div class="mon-body">
        <div class="semesters">
          <div class="sem-block">
            <div class="sem-title">üìò H·ªçc k·ª≥ 1
              <span class="sem-result" id="hk1r_${m.id}">HK1: ‚Äî</span>
            </div>
            <div class="inp-row">
              <span class="inp-lbl">TX (HK1)</span>
              <div class="tx-row" id="tx1_${m.id}"></div>
              <button class="btn-tx-del" onclick="delTX('${m.id}',1)">‚àí</button>
              <button class="btn-tx-add" onclick="addTX('${m.id}',1)">+</button>
            </div>
            <div class="inp-row">
              <span class="inp-lbl">Gi·ªØa k·ª≥ 1</span>
              <input class="d-inp" type="number" id="gk1_${m.id}" min="0" max="10" step="0.1" placeholder="‚Äî" oninput="recalcMon('${m.id}')"/>
            </div>
            <div class="inp-row">
              <span class="inp-lbl">Cu·ªëi k·ª≥ 1</span>
              <input class="d-inp" type="number" id="ck1_${m.id}" min="0" max="10" step="0.1" placeholder="‚Äî" oninput="recalcMon('${m.id}')"/>
            </div>
            <div class="hk-display"><span>ƒêi·ªÉm HK1</span><span class="hk-val" id="hk1v_${m.id}">‚Äî</span></div>
          </div>
          <div class="sem-block">
            <div class="sem-title">üìó H·ªçc k·ª≥ 2
              <span class="sem-result" id="hk2r_${m.id}">HK2: ‚Äî</span>
            </div>
            <div class="inp-row">
              <span class="inp-lbl">TX (HK2)</span>
              <div class="tx-row" id="tx2_${m.id}"></div>
              <button class="btn-tx-del" onclick="delTX('${m.id}',2)">‚àí</button>
              <button class="btn-tx-add" onclick="addTX('${m.id}',2)">+</button>
            </div>
            <div class="inp-row">
              <span class="inp-lbl">Gi·ªØa k·ª≥ 2</span>
              <input class="d-inp" type="number" id="gk2_${m.id}" min="0" max="10" step="0.1" placeholder="‚Äî" oninput="recalcMon('${m.id}')"/>
            </div>
            <div class="inp-row">
              <span class="inp-lbl">Cu·ªëi k·ª≥ 2</span>
              <input class="d-inp" type="number" id="ck2_${m.id}" min="0" max="10" step="0.1" placeholder="‚Äî" oninput="recalcMon('${m.id}')"/>
            </div>
            <div class="hk-display"><span>ƒêi·ªÉm HK2</span><span class="hk-val" id="hk2v_${m.id}">‚Äî</span></div>
          </div>
        </div>
        <div class="year-bar" id="yearbar_${m.id}">
          <div>
            <div class="yb-label">üìä TBM c·∫£ nƒÉm</div>
            <div class="yb-formula" id="formula_${m.id}">Ch∆∞a c√≥ d·ªØ li·ªáu</div>
          </div>
          <div class="yb-val" id="tbmYear_${m.id}">‚Äî</div>
        </div>
      </div>`;
    list.appendChild(card);
    buildTX(m.id, 1);
    buildTX(m.id, 2);
  });
}

function buildTX(mid, hk) {
  const wrap = document.getElementById(`tx${hk}_${mid}`);
  if (!wrap) return;
  const oldVals = Array.from(wrap.querySelectorAll('input')).map(i => i.value);
  wrap.innerHTML = '';
  const n = txCount[mid][hk];
  for (let i = 0; i < n; i++) {
    const inp = document.createElement('input');
    inp.className = 'd-inp'; inp.type = 'number';
    inp.min = '0'; inp.max = '10'; inp.step = '0.1';
    inp.placeholder = `TX${i+1}`;
    inp.id = `tx${hk}_${mid}_${i}`;
    if (oldVals[i] !== undefined) inp.value = oldVals[i];
    inp.setAttribute('oninput', `recalcMon('${mid}')`);
    wrap.appendChild(inp);
  }
}

function toggleMon(mid) { document.getElementById('card_'+mid).classList.toggle('open'); }
function addTX(mid, hk) { if (txCount[mid][hk] >= 6) return; txCount[mid][hk]++; buildTX(mid, hk); recalcMon(mid); }
function delTX(mid, hk) { if (txCount[mid][hk] <= 1) return; txCount[mid][hk]--; buildTX(mid, hk); recalcMon(mid); }

function getVal(id) {
  const el = document.getElementById(id);
  if (!el) return null;
  const v = parseFloat(el.value);
  return (!el.value.trim() || isNaN(v) || v < 0 || v > 10) ? null : v;
}
function isInvalid(id) {
  const el = document.getElementById(id);
  if (!el || !el.value.trim()) return false;
  const v = parseFloat(el.value);
  return isNaN(v) || v < 0 || v > 10;
}
function avg(arr) {
  const v = arr.filter(x => x !== null);
  return v.length ? v.reduce((a,b)=>a+b,0)/v.length : null;
}
function tinhHK(txVals, gk, ck) {
  const tbTX = avg(txVals);
  const parts = [];
  if (tbTX !== null) parts.push({v:tbTX, w:2});
  if (gk   !== null) parts.push({v:gk,   w:3});
  if (ck   !== null) parts.push({v:ck,   w:5});
  if (!parts.length) return null;
  const sumW = parts.reduce((s,p)=>s+p.w,0);
  const sumV = parts.reduce((s,p)=>s+p.v*p.w,0);
  return sumV/sumW;
}
function tinhTBMNam(hk1, hk2) {
  if (hk1 !== null && hk2 !== null) return (hk1 + hk2*2)/3;
  if (hk1 !== null) return hk1;
  if (hk2 !== null) return hk2;
  return null;
}
function recalcMon(mid) {
  const n1 = txCount[mid][1], n2 = txCount[mid][2];
  const tx1 = Array.from({length:n1},(_,i)=>getVal(`tx1_${mid}_${i}`));
  const tx2 = Array.from({length:n2},(_,i)=>getVal(`tx2_${mid}_${i}`));
  const hk1 = tinhHK(tx1, getVal(`gk1_${mid}`), getVal(`ck1_${mid}`));
  const hk2 = tinhHK(tx2, getVal(`gk2_${mid}`), getVal(`ck2_${mid}`));
  const tbm = tinhTBMNam(hk1, hk2);
  const fmt = v => v!==null ? v.toFixed(2) : '‚Äî';
  document.getElementById(`hk1v_${mid}`).textContent = fmt(hk1);
  document.getElementById(`hk2v_${mid}`).textContent = fmt(hk2);
  document.getElementById(`hk1r_${mid}`).textContent = `HK1: ${fmt(hk1)}`;
  document.getElementById(`hk2r_${mid}`).textContent = `HK2: ${fmt(hk2)}`;
  const tbmEl=document.getElementById(`tbmYear_${mid}`);
  const subEl=document.getElementById(`sub_${mid}`);
  const hdrEl=document.getElementById(`tbm_${mid}`);
  const fmlEl=document.getElementById(`formula_${mid}`);
  if (tbm !== null) {
    const r = Math.round(tbm*100)/100, cl = scColor(r);
    tbmEl.textContent = r.toFixed(2); hdrEl.textContent = r.toFixed(2);
    hdrEl.className = 'mon-tbm-display '+cl;
    const pts=[];
    if (hk1!==null) pts.push(`HK1: ${hk1.toFixed(2)}`);
    if (hk2!==null) pts.push(`HK2: ${hk2.toFixed(2)}`);
    subEl.textContent = pts.join(' | ')+` | TBM: ${r.toFixed(2)}`;
    fmlEl.textContent = (hk1!==null&&hk2!==null)
      ? `(HK1 + HK2√ó2) / 3 = ${r.toFixed(2)}`
      : hk1!==null ? `Ch·ªâ c√≥ HK1 = ${r.toFixed(2)}` : `Ch·ªâ c√≥ HK2 = ${r.toFixed(2)}`;
  } else {
    tbmEl.textContent='‚Äî'; hdrEl.textContent='‚Äî'; hdrEl.className='mon-tbm-display';
    subEl.textContent='Ch∆∞a nh·∫≠p ƒëi·ªÉm'; fmlEl.textContent='Ch∆∞a c√≥ d·ªØ li·ªáu';
  }
}

function rankOf(d)  { return RANK.find(r=>d>=r.min)||RANK[RANK.length-1]; }
function scColor(d) { return d>=8?'sc-g':d>=6.5?'sc-k':d>=5?'sc-t':'sc-y'; }
let toastTimer;
function showToast(msg, ok=true) {
  const t = document.getElementById('toast');
  t.innerHTML = (ok?'‚úÖ ':'‚ùå ')+msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>t.classList.remove('show'), 2800);
}
function hasInputError(mid) {
  const n1 = txCount[mid][1], n2 = txCount[mid][2];
  const ids = [
    ...Array.from({length:n1},(_,i)=>`tx1_${mid}_${i}`),
    ...Array.from({length:n2},(_,i)=>`tx2_${mid}_${i}`),
    `gk1_${mid}`,`ck1_${mid}`,`gk2_${mid}`,`ck2_${mid}`
  ];
  return ids.some(id=>isInvalid(id));
}
function collectRows() {
  const rows=[];
  MON.forEach(m=>{
    const n1=txCount[m.id][1], n2=txCount[m.id][2];
    const tx1=Array.from({length:n1},(_,i)=>getVal(`tx1_${m.id}_${i}`));
    const tx2=Array.from({length:n2},(_,i)=>getVal(`tx2_${m.id}_${i}`));
    const hk1=tinhHK(tx1,getVal(`gk1_${m.id}`),getVal(`ck1_${m.id}`));
    const hk2=tinhHK(tx2,getVal(`gk2_${m.id}`),getVal(`ck2_${m.id}`));
    const tbmRaw=tinhTBMNam(hk1,hk2);
    const tbm=tbmRaw!==null?Math.round(tbmRaw*100)/100:null;
    if (hk1!==null||hk2!==null) rows.push({m,hk1,hk2,tbm});
  });
  return rows;
}
function todayStr() {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

function openAddSubjModal() {
  document.getElementById('asModal-name').value = '';
  document.getElementById('asModal-err').textContent = '';
  document.getElementById('asModal-overlay').classList.add('open');
  setTimeout(() => document.getElementById('asModal-name').focus(), 80);
}
function closeAddSubjModal() {
  document.getElementById('asModal-overlay').classList.remove('open');
}
function confirmAddSubj() {
  const nameInp = document.getElementById('asModal-name');
  const errEl   = document.getElementById('asModal-err');
  const name    = nameInp.value.trim();
  if (!name) { errEl.textContent = '‚ö†Ô∏è Vui l√≤ng nh·∫≠p t√™n m√¥n h·ªçc.'; nameInp.focus(); return; }
  const dup = MON.some(m => m.ten.toLowerCase() === name.toLowerCase());
  if (dup) { errEl.textContent = '‚ö†Ô∏è M√¥n "' + name + '" ƒë√£ t·ªìn t·∫°i!'; nameInp.select(); return; }
  const slug = name.normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .toLowerCase().replace(/\s+/g,'_').replace(/[^a-z0-9_]/g,'') || 'mon_' + Date.now();
  const id = slug + '_' + Date.now();
  MON.push({ id, ten: name, ico: 'üìò', _custom: true });
  txCount[id] = { 1: 4, 2: 4 };
  buildMonUI();
  spBuildSubjSelect();
  closeAddSubjModal();
  showToast('ƒê√£ th√™m m√¥n: ' + name);
  requestAnimationFrame(() => {
    const newCard = document.getElementById('card_' + id);
    if (newCard) { newCard.scrollIntoView({ behavior: 'smooth', block: 'center' }); newCard.classList.add('open'); }
  });
}
function deleteCustomSubj(mid, e) {
  e.stopPropagation();
  const m = MON.find(x => x.id === mid);
  if (!m || !m._custom) return;
  if (!confirm(`Xo√° m√¥n "${m.ten}" kh·ªèi danh s√°ch?`)) return;
  const idx = MON.findIndex(x => x.id === mid);
  if (idx >= 0) MON.splice(idx, 1);
  delete txCount[mid];
  buildMonUI();
  spBuildSubjSelect();
  showToast('ƒê√£ xo√° m√¥n ' + m.ten, false);
}

function tinhKQ() {
  const gErr=document.getElementById('gErr');
  gErr.style.display='none';
  const errMons=MON.filter(m=>hasInputError(m.id)).map(m=>m.ten);
  if (errMons.length) {
    gErr.innerHTML=`‚ö†Ô∏è ƒêi·ªÉm kh√¥ng h·ª£p l·ªá (ngo√†i 0‚Äì10) t·∫°i: <strong>${errMons.join(', ')}</strong>`;
    gErr.style.display='block'; hideResult(); return;
  }
  const allRows=collectRows();
  if (!allRows.length) {
    gErr.innerHTML='‚ö†Ô∏è H√£y nh·∫≠p √≠t nh·∫•t <strong>1 m√¥n</strong> ƒë·ªÉ t√≠nh k·∫øt qu·∫£.';
    gErr.style.display='block'; hideResult(); return;
  }
  const tbmChung=Math.round(allRows.reduce((s,r)=>s+r.tbm,0)/allRows.length*100)/100;
  const rnk=rankOf(tbmChung);
  const ten=document.getElementById('tenHS').value.trim()||'H·ªçc sinh';
  currentResult={ten,dtb:tbmChung,rnk:rnk.cls,rows:allRows,ts:Date.now()};
  const card=document.getElementById('resCard');
  ['gioi','kha','tb','yeu'].forEach(c=>card.classList.remove(c));
  card.classList.add(rnk.cls);
  document.getElementById('rAvatar').textContent=rnk.ico;
  document.getElementById('rName').textContent=ten;
  document.getElementById('rPill').textContent=rnk.ico+' '+rnk.lbl;
  document.getElementById('rAvg').textContent=tbmChung.toFixed(2);
  const pct=(tbmChung/10*100).toFixed(1)+'%';
  document.getElementById('rScaleFill').style.width='0%';
  document.getElementById('rNeedle').style.left='0%';
  setTimeout(()=>{
    document.getElementById('rScaleFill').style.width=pct;
    document.getElementById('rNeedle').style.left=pct;
  },120);
  document.getElementById('rDescText').textContent=rnk.desc;
  document.getElementById('rDescTips').innerHTML=rnk.tips.map(t=>`<span class="rd-tip">${t}</span>`).join('');
  const tbody=document.getElementById('rTbody'); tbody.innerHTML='';
  allRows.forEach(({m,hk1,hk2,tbm})=>{
    const tr=document.createElement('tr');
    const cl=tbm!==null?scColor(tbm):'';
    tr.innerHTML=`<td><span class="tbl-ico">${m.ico}</span>${m.ten}</td>
      <td style="text-align:right;color:var(--tx-2)">${hk1!==null?hk1.toFixed(2):'‚Äî'}</td>
      <td style="text-align:right;color:var(--tx-2)">${hk2!==null?hk2.toFixed(2):'‚Äî'}</td>
      <td class="${cl}" style="text-align:right">${tbm!==null?tbm.toFixed(2):'‚Äî'}</td>`;
    tbody.appendChild(tr);
  });
  const tr=document.createElement('tr'); tr.className='ttl-row';
  tr.innerHTML=`<td colspan="3"><span class="tbl-ico">üìä</span>TBM c·∫£ nƒÉm</td>
    <td class="${rnk.scCls}" style="text-align:right">${tbmChung.toFixed(2)}</td>`;
  tbody.appendChild(tr);
  const wrap=document.getElementById('resWrap');
  wrap.style.display=''; wrap.classList.remove('visible');
  void wrap.offsetWidth; wrap.classList.add('visible');
  wrap.scrollIntoView({behavior:'smooth',block:'nearest'});
  setTimeout(()=>drawRadar(allRows,rnk),200);
  document.getElementById('btnSave').disabled=false;
  document.getElementById('btnPdf').disabled=false;
}

function hideResult() {
  const w=document.getElementById('resWrap');
  w.classList.remove('visible'); w.style.display='';
  document.getElementById('rScaleFill').style.width='0%';
  document.getElementById('rNeedle').style.left='0%';
  document.getElementById('btnSave').disabled=true;
  document.getElementById('btnPdf').disabled=true;
  if (radarChartInst){radarChartInst.destroy();radarChartInst=null;}
  currentResult=null;
}

function getChartTheme() {
  const cs=getComputedStyle(document.documentElement);
  return {grid:cs.getPropertyValue('--chart-grid').trim(),
    tick:cs.getPropertyValue('--chart-tick').trim(),
    label:cs.getPropertyValue('--chart-pt-label').trim()};
}
function drawRadar(rows, rnk) {
  const canvas=document.getElementById('radarChart');
  if (radarChartInst){radarChartInst.destroy();radarChartInst=null;}
  const th=getChartTheme(), rgb=rnk.rgb;
  radarChartInst=new Chart(canvas,{
    type:'radar',
    data:{labels:rows.map(r=>r.m.ten),datasets:[{
      label:'TBM',data:rows.map(r=>r.tbm),
      backgroundColor:`rgba(${rgb},.18)`,borderColor:`rgba(${rgb},.95)`,
      pointBackgroundColor:`rgba(${rgb},1)`,pointBorderColor:'#fff',
      pointHoverBackgroundColor:'#fff',pointHoverBorderColor:`rgba(${rgb},1)`,
      pointRadius:5,pointHoverRadius:7,borderWidth:2.5,fill:true}]},
    options:{responsive:true,maintainAspectRatio:true,
      animation:{duration:700,easing:'easeInOutQuart'},
      scales:{r:{min:0,max:10,
        ticks:{stepSize:2,color:th.tick,font:{size:10,family:'Inter'},backdropColor:'transparent'},
        grid:{color:th.grid},angleLines:{color:th.grid},
        pointLabels:{color:th.label,font:{size:10,weight:'700',family:'Inter'}}}},
      plugins:{legend:{display:false},tooltip:{
        backgroundColor:'rgba(15,14,26,.85)',titleColor:'#e8e6ff',bodyColor:'#a09ec0',
        padding:10,cornerRadius:10,callbacks:{label:ctx=>` TBM: ${ctx.raw.toFixed(2)}`}}}}
  });
  document.getElementById('chartLegend').innerHTML=`
    <div class="leg-chip"><span class="leg-dot" style="background:rgba(${rgb},1)"></span>TBM m√¥n</div>
    <div class="leg-chip"><span class="leg-dot" style="background:rgba(${rgb},.3);border:1.5px solid rgba(${rgb},1)"></span>V√πng ƒëi·ªÉm</div>`;
  const vals=rows.map(r=>r.tbm);
  document.getElementById('csMax').textContent=Math.max(...vals).toFixed(2);
  document.getElementById('csMin').textContent=Math.min(...vals).toFixed(2);
  document.getElementById('csAvg').textContent=(vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(2);
}
function updateRadarTheme() {
  if (!radarChartInst) return;
  const th=getChartTheme(), sc=radarChartInst.options.scales.r;
  sc.ticks.color=th.tick; sc.grid.color=th.grid;
  sc.angleLines.color=th.grid; sc.pointLabels.color=th.label;
  radarChartInst.update();
}

function xuatPDF() {
  if (!currentResult) return;
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF({unit:'mm',format:'a4',orientation:'portrait'});
  const W=doc.internal.pageSize.getWidth();
  const rnkObj=rankOf(currentResult.dtb);
  const WHITE=[255,255,255],DARK=[30,27,75],GREY=[100,100,120],LGREY=[230,230,240];
  const sf=(sz,w='normal',c=DARK)=>{doc.setFontSize(sz);doc.setFont('helvetica',w);doc.setTextColor(...c);};
  const rc=(x,y,w,h,c,r=0)=>{doc.setFillColor(...c);r>0?doc.roundedRect(x,y,w,h,r,r,'F'):doc.rect(x,y,w,h,'F');};
  rc(0,0,W,36,[79,70,229]);rc(W*.55,0,W*.45,36,[124,58,237]);
  doc.setFillColor(255,255,255);doc.circle(23,18,9,'F');
  sf(13,'bold',DARK);doc.text('EN',23,21.5,{align:'center'});
  sf(15,'bold',WHITE);doc.text('PHIEU XEP LOAI HOC LUC',38,13);
  sf(8,'normal',[200,200,255]);doc.text('Edunova NDK - Chuan VN',38,20);
  const now=new Date();
  const ds=`${now.getDate().toString().padStart(2,'0')}/${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getFullYear()}`;
  sf(7,'normal',[180,180,230]);doc.text(`Ngay: ${ds}`,38,27);
  let y=42;
  rc(10,y,W-20,20,[245,245,255],4);
  doc.setDrawColor(...LGREY);doc.setLineWidth(.3);doc.roundedRect(10,y,W-20,20,4,4,'S');
  sf(7,'bold',GREY);doc.text('HOC SINH',16,y+6);
  sf(11,'bold',DARK);doc.text(currentResult.ten||'Hoc sinh',16,y+14);
  rc(W-58,y+3,46,14,rnkObj.pdfBg,6);
  doc.setDrawColor(...rnkObj.pdfColor);doc.roundedRect(W-58,y+3,46,14,6,6,'S');
  sf(9,'bold',rnkObj.pdfColor);doc.text(rnkObj.lbl.toUpperCase(),W-35,y+12,{align:'center'});
  y+=26;
  rc(10,y,W-20,26,rnkObj.pdfBg,5);
  doc.setDrawColor(...rnkObj.pdfColor);doc.setLineWidth(.4);doc.roundedRect(10,y,W-20,26,5,5,'S');
  sf(7,'bold',rnkObj.pdfColor);doc.text('DIEM TRUNG BINH CA NAM',18,y+9);
  sf(20,'bold',rnkObj.pdfColor);doc.text(currentResult.dtb.toFixed(2),W-20,y+20,{align:'right'});
  sf(7,'normal',GREY);doc.text('/ 10.00',W-20,y+25,{align:'right'});
  const bW2=W-72,bX2=18,bY2=y+20,bH2=3;
  rc(bX2,bY2,bW2,bH2,[215,215,235],2);
  doc.setFillColor(...rnkObj.pdfColor);
  doc.roundedRect(bX2,bY2,bW2*currentResult.dtb/10,bH2,1.5,1.5,'F');
  if (radarChartInst) {
    y+=32;
    const img=radarChartInst.toBase64Image('image/png',1);
    rc(10,y,W-20,86,[248,248,255],4);
    doc.setDrawColor(...LGREY);doc.setLineWidth(.3);doc.roundedRect(10,y,W-20,86,4,4,'S');
    sf(7,'bold',[79,70,229]);doc.text('BIEU DO RADAR TBM CAC MON',W/2,y+7,{align:'center'});
    const cs=68,cx=(W-cs)/2;doc.addImage(img,'PNG',cx,y+9,cs,cs);
    y+=90;
  } else { y+=32; }
  rc(10,y,W-20,8,[79,70,229]);
  sf(7.5,'bold',WHITE);doc.text('BANG DIEM CHI TIET TUNG MON',W/2,y+5.5,{align:'center'});
  y+=8;
  rc(10,y,W-20,7,[235,235,250]);
  sf(7,'bold',DARK);doc.text('MON HOC',16,y+5);
  doc.text('TBM HK1',W-60,y+5,{align:'right'});
  doc.text('TBM HK2',W-38,y+5,{align:'right'});
  doc.text('TBM NAM',W-14,y+5,{align:'right'});
  y+=7;
  currentResult.rows.forEach(({m,hk1,hk2,tbm},i)=>{
    rc(10,y,W-20,8,i%2===0?WHITE:[248,248,255]);
    sf(8,'normal',DARK);doc.text(m.ten,16,y+5.5);
    sf(7.5,'normal',GREY);
    doc.text(hk1!==null?Number(hk1).toFixed(2):'‚Äî',W-60,y+5.5,{align:'right'});
    doc.text(hk2!==null?Number(hk2).toFixed(2):'‚Äî',W-38,y+5.5,{align:'right'});
    if (tbm!==null) {
      const sc2=tbm>=8?[5,150,105]:tbm>=6.5?[29,78,216]:tbm>=5?[180,100,10]:[185,28,28];
      sf(8.5,'bold',sc2);doc.text(Number(tbm).toFixed(2),W-14,y+5.5,{align:'right'});
    } else { sf(8.5,'normal',GREY);doc.text('‚Äî',W-14,y+5.5,{align:'right'}); }
    doc.setDrawColor(...LGREY);doc.setLineWidth(.2);doc.line(10,y+8,W-10,y+8);
    y+=8;
  });
  rc(10,y,W-20,9,rnkObj.pdfBg);
  doc.setDrawColor(...rnkObj.pdfColor);doc.setLineWidth(.4);doc.rect(10,y,W-20,9,'S');
  sf(8.5,'bold',rnkObj.pdfColor);doc.text('DIEM TB CA NAM',16,y+6.3);
  sf(10,'bold',rnkObj.pdfColor);doc.text(currentResult.dtb.toFixed(2),W-14,y+6.5,{align:'right'});
  const fY=doc.internal.pageSize.getHeight()-10;
  doc.setDrawColor(...LGREY);doc.setLineWidth(.3);doc.line(10,fY-4,W-10,fY-4);
  sf(6.5,'normal',GREY);doc.text('Edunova NDK ¬∑ Chuan hoc ba Viet Nam',W/2,fY,{align:'center'});
  const safe=(currentResult.ten||'hocsinh').replace(/\s+/g,'-').replace(/[^a-zA-Z0-9\-]/g,'');
  doc.save(`BangDiem_${safe}_${ds.replace(/\//g,'')}.pdf`);
  showToast('ƒê√£ xu·∫•t PDF b·∫£ng ƒëi·ªÉm chi ti·∫øt!');
}

const SK='hocLucHistoryV2';
function docLS()  { try{return JSON.parse(localStorage.getItem(SK))||[];}catch(e){return[];} }
function ghiLS(a) { try{localStorage.setItem(SK,JSON.stringify(a));}catch(e){} }

function luuKQ() {
  if (!currentResult) return;
  const arr=docLS();
  arr.unshift({...currentResult,id:currentResult.ts});
  if (arr.length>20) arr.splice(20);
  ghiLS(arr);
  document.getElementById('btnSave').disabled=true;
  showToast('ƒê√£ l∆∞u k·∫øt qu·∫£ c·ªßa '+currentResult.ten);
  renderLichSu();
}
function renderLichSu() {
  const arr=docLS(),wrap=document.getElementById('histWrap'),list=document.getElementById('histList');
  if (!arr.length){wrap.classList.remove('visible');return;}
  wrap.classList.add('visible'); list.innerHTML='';
  arr.forEach((rec,idx)=>{
    const ro=RANK.find(r=>rec.rnk===r.cls)||RANK[RANK.length-1];
    const d=new Date(rec.ts);
    const ds=`${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    const row=document.createElement('div');
    row.className='hist-row';row.title='Nh·∫•n ƒë·ªÉ xem';
    row.innerHTML=`<div class="hist-rank-dot dot-${rec.rnk}"></div>
      <span class="hist-name">${rec.ten}</span>
      <span class="hist-avg ${ro.scCls}">${Number(rec.dtb).toFixed(2)}</span>
      <span class="hist-lbl ${rec.rnk}">${ro.lbl}</span>
      <span class="hist-date">${ds}</span>
      <button class="hist-del" onclick="xoaRec(${idx},event)">‚úï</button>`;
    row.addEventListener('click',()=>napLai(rec));
    list.appendChild(row);
  });
}
function napLai(rec) {
  document.getElementById('tenHS').value=rec.ten;
  currentResult=rec;
  if (rec.rows&&rec.rows.length) {
    const rnk=rankOf(rec.dtb);
    const wrap=document.getElementById('resWrap'),card=document.getElementById('resCard');
    ['gioi','kha','tb','yeu'].forEach(c=>card.classList.remove(c));
    card.classList.add(rnk.cls);
    document.getElementById('rAvatar').textContent=rnk.ico;
    document.getElementById('rName').textContent=rec.ten;
    document.getElementById('rPill').textContent=rnk.ico+' '+rnk.lbl;
    document.getElementById('rAvg').textContent=Number(rec.dtb).toFixed(2);
    document.getElementById('rDescText').textContent=rnk.desc;
    document.getElementById('rDescTips').innerHTML=rnk.tips.map(t=>`<span class="rd-tip">${t}</span>`).join('');
    const tbody=document.getElementById('rTbody'); tbody.innerHTML='';
    rec.rows.forEach(({m,hk1,hk2,tbm})=>{
      const tr=document.createElement('tr');
      const cl=tbm!=null?scColor(Number(tbm)):'';
      tr.innerHTML=`<td><span class="tbl-ico">${m.ico}</span>${m.ten}</td>
        <td style="text-align:right;color:var(--tx-2)">${hk1!=null?Number(hk1).toFixed(2):'‚Äî'}</td>
        <td style="text-align:right;color:var(--tx-2)">${hk2!=null?Number(hk2).toFixed(2):'‚Äî'}</td>
        <td class="${cl}" style="text-align:right">${tbm!=null?Number(tbm).toFixed(2):'‚Äî'}</td>`;
      tbody.appendChild(tr);
    });
    const tr=document.createElement('tr'); tr.className='ttl-row';
    const rnkO=rankOf(rec.dtb);
    tr.innerHTML=`<td colspan="3"><span class="tbl-ico">üìä</span>TBM c·∫£ nƒÉm</td>
      <td class="${rnkO.scCls}" style="text-align:right">${Number(rec.dtb).toFixed(2)}</td>`;
    tbody.appendChild(tr);
    const pct=(rec.dtb/10*100).toFixed(1)+'%';
    wrap.style.display=''; wrap.classList.remove('visible'); void wrap.offsetWidth; wrap.classList.add('visible');
    setTimeout(()=>{
      document.getElementById('rScaleFill').style.width=pct;
      document.getElementById('rNeedle').style.left=pct;
    },120);
    const radarRows=rec.rows.filter(r=>r.tbm!=null);
    if (radarRows.length) setTimeout(()=>drawRadar(radarRows,rnk),200);
    document.getElementById('btnPdf').disabled=false;
  }
  window.scrollTo({top:0,behavior:'smooth'});
  showToast('ƒê√£ n·∫°p k·∫øt qu·∫£ c·ªßa '+rec.ten);
}
function xoaRec(idx,e) {
  e.stopPropagation();
  const arr=docLS(); arr.splice(idx,1); ghiLS(arr); renderLichSu(); showToast('ƒê√£ xo√° b·∫£n ghi',false);
}
function xoaTatCa() {
  if (!confirm('Xo√° to√†n b·ªô l·ªãch s·ª≠?')) return;
  ghiLS([]); renderLichSu(); showToast('ƒê√£ xo√° t·∫•t c·∫£',false);
}

function nhapLai() {
  document.getElementById('tenHS').value='';
  MON.forEach(m=>{
    for (let hk=1;hk<=2;hk++) {
      const n=txCount[m.id][hk];
      for (let i=0;i<n;i++) { const el=document.getElementById(`tx${hk}_${m.id}_${i}`); if(el) el.value=''; }
      ['gk','ck'].forEach(p=>{ const el=document.getElementById(`${p}${hk}_${m.id}`); if(el) el.value=''; });
    }
    recalcMon(m.id);
    document.getElementById('card_'+m.id).classList.remove('open','has-error');
  });
  document.getElementById('gErr').style.display='none';
  hideResult();
  window.scrollTo({top:0,behavior:'smooth'});
}

const SP_KEY = 'studyPlannerV1';
let spFilter  = 'all';
function spLoad()  { try{return JSON.parse(localStorage.getItem(SP_KEY))||[];}catch(e){return[];} }
function spSave(a) { try{localStorage.setItem(SP_KEY,JSON.stringify(a));}catch(e){} }

function spBuildSubjSelect() {
  ['sp-subj','pomo-subj','tt-subj','tt-edit-subj','fc-subj'].forEach(id=>{
    const sel=document.getElementById(id);
    if (sel) sel.innerHTML=MON.map(m=>`<option value="${m.id}">${m.ico} ${m.ten}</option>`).join('');
  });
}

function spSetFilter(f, btn) {
  spFilter=f;
  document.querySelectorAll('.sp-filter-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  spRender();
}

function spAddTask() {
  const subj  = document.getElementById('sp-subj').value;
  const title = document.getElementById('sp-title').value.trim();
  const date  = document.getElementById('sp-date').value;
  if (!title) { showToast('Nh·∫≠p n·ªôi dung h·ªçc tr∆∞·ªõc nh√©!',false); return; }
  const tasks=spLoad();
  tasks.unshift({id:Date.now(),subject:subj,title,deadline:date,done:false,createdAt:Date.now()});
  spSave(tasks);
  document.getElementById('sp-title').value='';
  document.getElementById('sp-date').value='';
  spRender();
  showToast('ƒê√£ th√™m k·∫ø ho·∫°ch!');
}

function spToggleDone(id) {
  const tasks=spLoad();
  const t=tasks.find(x=>x.id===id);
  if (t) {
    t.done=!t.done;
    t.doneAt=t.done?Date.now():null;
    spSave(tasks);
    spUpdateStreak();
    spRender();
  }
}

function spDelete(id) {
  const el=document.querySelector(`[data-id="${id}"]`);
  if (el) {
    el.classList.add('task-exit');
    setTimeout(()=>{
      spSave(spLoad().filter(x=>x.id!==id));
      spUpdateStreak();
      spRender();
    }, 240);
  } else {
    spSave(spLoad().filter(x=>x.id!==id));
    spRender();
  }
  showToast('ƒê√£ xo√° task',false);
}

function spDeadlineLabel(dl) {
  if (!dl) return '';
  const today=new Date(); today.setHours(0,0,0,0);
  const d=new Date(dl+'T00:00:00');
  const diff=Math.round((d-today)/(1000*60*60*24));
  if (diff<0)   return {txt:`Qu√° h·∫°n ${-diff} ng√†y`,cls:'overdue'};
  if (diff===0) return {txt:'H√¥m nay!',cls:'today'};
  if (diff===1) return {txt:'Ng√†y mai',cls:''};
  return {txt:`C√≤n ${diff} ng√†y`,cls:''};
}

const STREAK_KEY='studyPlannerStreakV1';
function streakLoad() {
  try{return JSON.parse(localStorage.getItem(STREAK_KEY))||{current:0,lastDate:null};}
  catch(e){return{current:0,lastDate:null};}
}
function streakSave(s){try{localStorage.setItem(STREAK_KEY,JSON.stringify(s));}catch(e){}}
function dayDiff(a,b){return Math.round((new Date(b)-new Date(a))/86400000);}

function spUpdateStreak() {
  const tasks=spLoad();
  const today=todayStr();
  const doneDays=new Set(tasks.filter(t=>t.done).map(t=>{
    const ts=t.doneAt||t.createdAt;
    const d=new Date(ts);
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }));
  const actDate = studyActivityLoad().lastDate;
  if (actDate) doneDays.add(actDate);
  let streak=streakLoad();
  if (doneDays.has(today)) {
    if (!streak.lastDate) streak={current:1,lastDate:today};
    else if (streak.lastDate!==today) {
      const diff=dayDiff(streak.lastDate,today);
      streak={current:diff===1?streak.current+1:1,lastDate:today};
    }
  } else if (streak.lastDate && dayDiff(streak.lastDate,today)>1) {
    streak={current:0,lastDate:null};
  }
  streakSave(streak);
  spRenderStreak(streak);
}

function spRenderStreak(streak) {
  if (!streak) streak=streakLoad();
  document.getElementById('streak-count').innerHTML=`${streak.current} <span>ng√†y</span>`;
  document.getElementById('streak-badge').style.display=streak.current>=7?'':'none';
}

const DAY_LABELS=['CN','T2','T3','T4','T5','T6','T7'];
function spRenderHeatmap() {
  const tasks=spLoad();
  const today=new Date(); today.setHours(0,0,0,0);
  const days=[];
  for (let i=6;i>=0;i--){const d=new Date(today);d.setDate(d.getDate()-i);days.push(d);}
  const doneDaySet=new Set(tasks.filter(t=>t.done).map(t=>{
    const d=new Date(t.doneAt||t.createdAt); d.setHours(0,0,0,0); return d.getTime();
  }));
  const actDate = studyActivityLoad().lastDate;
  if (actDate) {
    const ad = new Date(actDate+'T00:00:00'); ad.setHours(0,0,0,0);
    doneDaySet.add(ad.getTime());
  }
  const todayTime=today.getTime();
  document.getElementById('heatmap-grid').innerHTML=days.map(d=>{
    const isToday=d.getTime()===todayTime;
    const hasDone=doneDaySet.has(d.getTime());
    const cnt=tasks.filter(t=>{
      if(!t.done)return false;
      const dd=new Date(t.doneAt||t.createdAt);dd.setHours(0,0,0,0);
      return dd.getTime()===d.getTime();
    }).length;
    return `<div class="hm-day">
      <span class="hm-label">${DAY_LABELS[d.getDay()]}</span>
      <div class="hm-cell ${hasDone?'hm-done':'hm-empty'}${isToday?' hm-today':''}"
        title="${d.getDate()}/${d.getMonth()+1}${hasDone?' ¬∑ '+(cnt||'FC')+' ho·∫°t ƒë·ªông':''}">${hasDone?(cnt||'‚úì'):''}</div>
    </div>`;
  }).join('');
}

function spRender() {
  const all=spLoad();
  const today=new Date(); today.setHours(0,0,0,0);
  document.getElementById('sp-total').textContent    = all.length;
  document.getElementById('sp-done-cnt').textContent = all.filter(t=>t.done).length;
  document.getElementById('sp-pending').textContent  = all.filter(t=>!t.done).length;
  document.getElementById('sp-overdue').textContent  = all.filter(t=>!t.done&&t.deadline&&new Date(t.deadline+'T00:00:00')<today).length;
  spUpdateStreak();
  spRenderHeatmap();

  let tasks=all;
  if (spFilter==='done')    tasks=all.filter(t=>t.done);
  if (spFilter==='pending') tasks=all.filter(t=>!t.done);
  if (spFilter==='overdue') tasks=all.filter(t=>!t.done&&t.deadline&&new Date(t.deadline+'T00:00:00')<today);

  const list=document.getElementById('sp-list');
  if (!tasks.length) {
    list.innerHTML=`<div class="sp-empty"><span class="sp-empty-ico">üì≠</span>Ch∆∞a c√≥ k·∫ø ho·∫°ch n√†o${spFilter!=='all'?' trong m·ª•c n√†y':''}</div>`;
    return;
  }
  list.innerHTML=tasks.map(t=>{
    const mon=MON.find(m=>m.id===t.subject)||MON[0];
    const dl=spDeadlineLabel(t.deadline);
    const dlHtml=t.deadline
      ?`<span class="sp-deadline ${dl.cls}">üìÖ ${t.deadline.split('-').reverse().join('/')} ¬∑ ${dl.txt}</span>`:'';
    return `<div class="sp-task${t.done?' done':''} task-enter" data-id="${t.id}">
      <div class="sp-cb${t.done?' checked':''}" onclick="spToggleDone(${t.id})">${t.done?'‚úì':''}</div>
      <div class="sp-task-body">
        <div class="sp-task-top">
          <span class="sp-task-subj">${mon.ico} ${mon.ten}</span>
          <span class="sp-task-title">${t.title}</span>
        </div>
        <div class="sp-task-meta">${dlHtml}</div>
      </div>
      <button class="sp-task-del" onclick="spDelete(${t.id})">üóë</button>
    </div>`;
  }).join('');
}

let audioCtx = null;
function getAudioCtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  return audioCtx;
}
function pomoPlaySound(type) {
  const enabled = document.getElementById('sound-enabled').checked;
  if (!enabled) return;
  const vol = parseFloat(document.getElementById('sound-vol').value);
  try {
    const ctx = getAudioCtx();
    if (ctx.state === 'suspended') ctx.resume();
    const gain = ctx.createGain();
    gain.gain.setValueAtTime(vol, ctx.currentTime);
    gain.connect(ctx.destination);
    if (type === 'bell') {
      const osc = ctx.createOscillator();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(880, ctx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(440, ctx.currentTime+0.8);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+1.2);
      osc.connect(gain); osc.start(); osc.stop(ctx.currentTime+1.2);
    } else if (type === 'chime') {
      [523,659,784].forEach((freq,i)=>{
        const o=ctx.createOscillator(), g=ctx.createGain();
        o.type='triangle'; o.frequency.value=freq;
        g.gain.setValueAtTime(0,ctx.currentTime+i*0.18);
        g.gain.linearRampToValueAtTime(vol,ctx.currentTime+i*0.18+0.05);
        g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+i*0.18+0.5);
        o.connect(g); g.connect(ctx.destination);
        o.start(ctx.currentTime+i*0.18); o.stop(ctx.currentTime+i*0.18+0.5);
      });
    } else {
      const o=ctx.createOscillator();
      o.type='square'; o.frequency.value=1000;
      gain.gain.setValueAtTime(vol*0.4,ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.2);
      o.connect(gain); o.start(); o.stop(ctx.currentTime+0.22);
    }
  } catch(e){ console.warn('Audio error:',e); }
}
function pomoSoundToggle() {
  const on = document.getElementById('sound-enabled').checked;
  document.getElementById('sound-icon').textContent = on ? 'üîî' : 'üîï';
  document.getElementById('sound-toggle-txt').textContent = on ? '√Çm thanh b·∫≠t' : '√Çm thanh t·∫Øt';
}
function pomoNotify(msg) {
  if (document.visibilityState === 'visible') return;
  if (!('Notification' in window)) return;
  if (Notification.permission === 'granted') {
    new Notification('‚è± Edunova NƒêK', {body: msg, icon: ''});
  } else if (Notification.permission !== 'denied') {
    Notification.requestPermission().then(p=>{ if(p==='granted') new Notification('‚è± Edunova NƒêK',{body:msg}); });
  }
}

const TIMER_LOG_KEY='studyTimerLogsV1';
const CIRC=2*Math.PI*52;
let pomoState={running:false,phase:'ready',remaining:0,total:0,interval:null,subject:'toan'};
let pomoHiddenAt = null;
const MAX_HIDDEN_SEC = 300;

function timerLogLoad(){try{return JSON.parse(localStorage.getItem(TIMER_LOG_KEY))||[];}catch(e){return[];}}
function timerLogSave(a){try{localStorage.setItem(TIMER_LOG_KEY,JSON.stringify(a));}catch(e){}}

function pomoFmt(s){
  return `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
}
function pomoUpdateRing(remaining,total,phase){
  const fill=document.getElementById('pomo-ring-fill'); if(!fill)return;
  fill.style.strokeDashoffset=CIRC*(total>0?remaining/total:1);
  fill.className='pomo-ring-fill'+(phase==='break'?' phase-break':' phase-ready');
}
function pomoSetDisplay(remaining,total,phase){
  const clock=document.getElementById('pomo-clock');
  const phaseEl=document.getElementById('pomo-phase');
  if(clock)clock.textContent=pomoFmt(remaining);
  if(phaseEl)phaseEl.textContent=phase==='study'?'üî¥ ƒêang h·ªçc':phase==='break'?'üü¢ ƒêang ngh·ªâ':'‚è±Ô∏è S·∫µn s√†ng';
  pomoUpdateRing(remaining,total,phase);
}
function pomoLogSession(subject,minutes){
  const logs=timerLogLoad();
  logs.push({subject,minutes,date:todayStr(),timestamp:Date.now()});
  timerLogSave(logs);
  const today=todayStr();
  const todayMins=logs.filter(l=>l.date===today).reduce((s,l)=>s+l.minutes,0);
  if (todayMins>=30) {
    const tasks=spLoad();
    const already=tasks.some(t=>{
      if(!t.done)return false;
      const d=new Date(t.doneAt||t.createdAt);d.setHours(0,0,0,0);
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`===today;
    });
    if(!already){
      tasks.push({id:Date.now(),subject,title:`[Timer] ${minutes} ph√∫t`,deadline:'',
        done:true,createdAt:Date.now(),doneAt:Date.now(),_timerGenerated:true});
      spSave(tasks);spUpdateStreak();spRenderHeatmap();
    }
  }
  pomoRenderStats();
}
function pomoRenderStats(){
  const logs=timerLogLoad();
  document.getElementById('ps-total-min').textContent=logs.reduce((s,l)=>s+l.minutes,0);
  document.getElementById('ps-sessions').textContent=logs.length;
  if(logs.length){
    const bySubj={};
    logs.forEach(l=>{bySubj[l.subject]=(bySubj[l.subject]||0)+l.minutes;});
    const topId=Object.entries(bySubj).sort((a,b)=>b[1]-a[1])[0][0];
    const topMon=MON.find(m=>m.id===topId);
    document.getElementById('ps-top-subj').textContent=topMon?`${topMon.ico} ${topMon.ten}`:'‚Äî';
  }
}
function pomoStart(){
  if(pomoState.running)return;
  const studyMin=parseInt(document.getElementById('pomo-study').value)||25;
  const subj=document.getElementById('pomo-subj').value;
  if(pomoState.phase==='ready'){
    pomoState.phase='study';
    pomoState.remaining=studyMin*60;
    pomoState.total=studyMin*60;
    pomoState.subject=subj;
  }
  pomoState.running=true;
  document.getElementById('pomo-btn-start').style.display='none';
  document.getElementById('pomo-btn-pause').style.display='';
  pomoSetDisplay(pomoState.remaining,pomoState.total,pomoState.phase);
  pomoState.interval=setInterval(()=>{
    pomoState.remaining--;
    pomoSetDisplay(pomoState.remaining,pomoState.total,pomoState.phase);
    if(pomoState.remaining<=0){
      clearInterval(pomoState.interval);
      pomoState.running=false;
      const soundType=document.getElementById('sound-type').value;
      if(pomoState.phase==='study'){
        pomoPlaySound(soundType);
        pomoNotify('H·∫øt gi·ªù h·ªçc! Ngh·ªâ ng∆°i ƒëi n√†o üéâ');
        pomoLogSession(pomoState.subject,Math.round(pomoState.total/60));
        const breakMin=parseInt(document.getElementById('pomo-break').value)||5;
        pomoState.phase='break'; pomoState.remaining=breakMin*60; pomoState.total=breakMin*60;
        pomoSetDisplay(pomoState.remaining,pomoState.total,'break');
        setTimeout(pomoStart,300);
      } else {
        pomoPlaySound(soundType);
        pomoNotify('H·∫øt gi·ªù ngh·ªâ! B·∫Øt ƒë·∫ßu h·ªçc th√¥i üí™');
        const sm=parseInt(document.getElementById('pomo-study').value)||25;
        pomoState.phase='study'; pomoState.remaining=sm*60; pomoState.total=sm*60;
        pomoSetDisplay(pomoState.remaining,pomoState.total,'study');
        setTimeout(pomoStart,300);
      }
    }
  },1000);
}
function pomoPause(){
  if(!pomoState.running)return;
  clearInterval(pomoState.interval);
  pomoState.running=false;
  const btn=document.getElementById('pomo-btn-start');
  btn.style.display=''; btn.textContent='‚ñ∂ Ti·∫øp t·ª•c';
  document.getElementById('pomo-btn-pause').style.display='none';
}
function pomoReset(){
  clearInterval(pomoState.interval);
  pomoState={running:false,phase:'ready',remaining:0,total:0,interval:null,subject:'toan'};
  const studyMin=parseInt(document.getElementById('pomo-study').value)||25;
  document.getElementById('pomo-clock').textContent=pomoFmt(studyMin*60);
  document.getElementById('pomo-phase').textContent='‚è±Ô∏è S·∫µn s√†ng';
  const btn=document.getElementById('pomo-btn-start');
  btn.style.display=''; btn.textContent='‚ñ∂ B·∫Øt ƒë·∫ßu';
  document.getElementById('pomo-btn-pause').style.display='none';
  const fill=document.getElementById('pomo-ring-fill');
  if(fill){fill.style.strokeDashoffset=CIRC;fill.className='pomo-ring-fill phase-ready';}
}
document.addEventListener('visibilitychange',()=>{
  if(document.hidden){
    pomoHiddenAt=Date.now();
  } else {
    if(pomoHiddenAt&&pomoState.running){
      const elapsed=Math.floor((Date.now()-pomoHiddenAt)/1000);
      if(elapsed>MAX_HIDDEN_SEC){
        pomoPause();
        showToast('‚è∏ T·ª± ƒë·ªông t·∫°m d·ª´ng do chuy·ªÉn tab qu√° l√¢u',false);
      } else {
        pomoState.remaining=Math.max(0,pomoState.remaining-elapsed);
        pomoSetDisplay(pomoState.remaining,pomoState.total,pomoState.phase);
      }
    }
    pomoHiddenAt=null;
  }
});
document.addEventListener('DOMContentLoaded',()=>{
  const inp=document.getElementById('pomo-study');
  if(inp) inp.addEventListener('input',()=>{
    if(pomoState.phase==='ready'){
      document.getElementById('pomo-clock').textContent=pomoFmt((parseInt(inp.value)||25)*60);
    }
  });
  if('Notification' in window && Notification.permission==='default'){
    Notification.requestPermission();
  }
});

const TT_KEY='studyTimetableV1';
const DAY_NAMES=['CN','T2','T3','T4','T5','T6','T7'];
function ttLoad(){try{return JSON.parse(localStorage.getItem(TT_KEY))||[];}catch(e){return[];}}
function ttSave(a){try{localStorage.setItem(TT_KEY,JSON.stringify(a));}catch(e){}}
function ttAutoColon(inp){
  let v=inp.value.replace(/[^0-9]/g,'');
  if(v.length>4)v=v.slice(0,4);
  if(v.length>=3)v=v.slice(0,2)+':'+v.slice(2);
  inp.value=v;
  inp.classList.remove('err');
}
function ttValidate24h(str){
  if(!str||!/^\d{2}:\d{2}$/.test(str))return false;
  const[hh,mm]=str.split(':').map(Number);
  return hh>=0&&hh<=23&&mm>=0&&mm<=59;
}
function ttHasConflict(items,day,start,end,excludeId=null){
  return items.some(it=>{
    if(it.id===excludeId)return false;
    if(it.day!==day)return false;
    return !(end<=it.start||start>=it.end);
  });
}
function ttAdd(){
  const subj=document.getElementById('tt-subj').value;
  const day=parseInt(document.getElementById('tt-day').value);
  const start=document.getElementById('tt-start').value.trim();
  const end=document.getElementById('tt-end').value.trim();
  let ok=true;
  if(!ttValidate24h(start)){document.getElementById('tt-start').classList.add('err');ok=false;}
  if(!ttValidate24h(end)){document.getElementById('tt-end').classList.add('err');ok=false;}
  if(!ok){showToast('Gi·ªù ph·∫£i ƒë√∫ng ƒë·ªãnh d·∫°ng HH:MM (00:00‚Äì23:59)!',false);return;}
  if(start>=end){showToast('Gi·ªù k·∫øt th√∫c ph·∫£i sau gi·ªù b·∫Øt ƒë·∫ßu!',false);return;}
  const items=ttLoad();
  if(ttHasConflict(items,day,start,end)){
    showToast('‚ö†Ô∏è Tr√πng gi·ªù v·ªõi l·ªãch h·ªçc kh√°c trong ng√†y!',false);return;
  }
  const newItem={id:Date.now(),subject:subj,day,start,end};
  items.push(newItem);
  items.sort((a,b)=>a.day!==b.day?a.day-b.day:a.start.localeCompare(b.start));
  ttSave(items);
  document.getElementById('tt-start').value='';
  document.getElementById('tt-end').value='';
  ttRender(newItem.id);
  showToast('ƒê√£ th√™m l·ªãch h·ªçc!');
}
function ttDelete(id){
  const el=document.querySelector(`.tt-item[data-id="${id}"]`);
  if(el){
    el.classList.add('tt-exit');
    setTimeout(()=>{ttSave(ttLoad().filter(x=>x.id!==id));ttRender();},240);
  } else {
    ttSave(ttLoad().filter(x=>x.id!==id));ttRender();
  }
  showToast('ƒê√£ xo√° l·ªãch h·ªçc',false);
}
function ttEdit(id){
  const items=ttLoad();
  const it=items.find(x=>x.id===id); if(!it)return;
  document.getElementById('tt-edit-id').value=id;
  document.getElementById('tt-edit-subj').value=it.subject;
  document.getElementById('tt-edit-day').value=it.day;
  document.getElementById('tt-edit-start').value=it.start;
  document.getElementById('tt-edit-end').value=it.end;
  document.getElementById('tt-modal-overlay').classList.add('open');
}
function ttCloseModal(){document.getElementById('tt-modal-overlay').classList.remove('open');}
function ttSaveEdit(){
  const id=parseInt(document.getElementById('tt-edit-id').value);
  const subj=document.getElementById('tt-edit-subj').value;
  const day=parseInt(document.getElementById('tt-edit-day').value);
  const start=document.getElementById('tt-edit-start').value.trim();
  const end=document.getElementById('tt-edit-end').value.trim();
  let ok=true;
  if(!ttValidate24h(start)){document.getElementById('tt-edit-start').classList.add('err');ok=false;}
  if(!ttValidate24h(end)){document.getElementById('tt-edit-end').classList.add('err');ok=false;}
  if(!ok){showToast('Gi·ªù kh√¥ng h·ª£p l·ªá!',false);return;}
  if(start>=end){showToast('Gi·ªù k·∫øt th√∫c ph·∫£i sau b·∫Øt ƒë·∫ßu!',false);return;}
  const items=ttLoad();
  if(ttHasConflict(items,day,start,end,id)){showToast('‚ö†Ô∏è Tr√πng gi·ªù!',false);return;}
  const idx=items.findIndex(x=>x.id===id);
  if(idx>=0){items[idx]={id,subject:subj,day,start,end};}
  items.sort((a,b)=>a.day!==b.day?a.day-b.day:a.start.localeCompare(b.start));
  ttSave(items);ttCloseModal();ttRender();showToast('ƒê√£ c·∫≠p nh·∫≠t l·ªãch h·ªçc!');
}
function ttRender(newId=null){
  const items=ttLoad();
  const list=document.getElementById('tt-list'); if(!list)return;
  const todayDay=new Date().getDay();
  if(!items.length){list.innerHTML='<div class="tt-empty">üì≠ Ch∆∞a c√≥ l·ªãch h·ªçc n√†o</div>';return;}
  list.innerHTML=items.map(it=>{
    const mon=MON.find(m=>m.id===it.subject)||MON[0];
    const isToday=it.day===todayDay;
    const animate=it.id===newId?' tt-enter':'';
    return `<div class="tt-item${isToday?' tt-today-item':''}${animate}" data-id="${it.id}">
      <span class="tt-day-badge${isToday?' tt-today':''}">${DAY_NAMES[it.day]}</span>
      <span class="tt-subj">${mon.ico} ${mon.ten}</span>
      <span class="tt-time">üïê ${it.start} ‚Äì ${it.end}</span>
      <div class="tt-actions-row">
        <button class="tt-btn edit" onclick="ttEdit(${it.id})">‚úèÔ∏è S·ª≠a</button>
        <button class="tt-btn del"  onclick="ttDelete(${it.id})">üóë</button>
      </div>
    </div>`;
  }).join('');
}

function anWeekRange(offset=0){
  const now=new Date(); now.setHours(0,0,0,0);
  const day=now.getDay();
  const monday=new Date(now); monday.setDate(now.getDate()-((day+6)%7)+offset*7);
  const sunday=new Date(monday); sunday.setDate(monday.getDate()+6);
  return{start:monday,end:sunday};
}
function anDateKey(d){
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function anRender(){
  const logs=timerLogLoad();
  const tasks=spLoad();
  const thisWeek=anWeekRange(0);
  const lastWeek=anWeekRange(-1);
  const thisWeekMins=logs.filter(l=>{
    const d=new Date(l.timestamp); d.setHours(0,0,0,0);
    return d>=thisWeek.start&&d<=thisWeek.end;
  }).reduce((s,l)=>s+l.minutes,0);
  const lastWeekMins=logs.filter(l=>{
    const d=new Date(l.timestamp); d.setHours(0,0,0,0);
    return d>=lastWeek.start&&d<=lastWeek.end;
  }).reduce((s,l)=>s+l.minutes,0);
  document.getElementById('an-week-hrs').textContent=`${Math.floor(thisWeekMins/60)}h ${thisWeekMins%60}p`;
  document.getElementById('an-week-min').textContent=`${thisWeekMins} ph√∫t h·ªçc`;
  const compareEl=document.getElementById('an-week-compare');
  if(lastWeekMins===0){
    compareEl.textContent='‚Äî Ch∆∞a c√≥ d·ªØ li·ªáu tu·∫ßn tr∆∞·ªõc';
    compareEl.className='an-compare same';
  } else {
    const diff=thisWeekMins-lastWeekMins;
    const pct=Math.abs(Math.round(diff/lastWeekMins*100));
    compareEl.className='an-compare '+(diff>=0?'up':'down');
    compareEl.textContent=(diff>=0?'‚Üë TƒÉng ':'‚Üì Gi·∫£m ')+pct+'% so v·ªõi tu·∫ßn tr∆∞·ªõc';
  }
  const bySubj={};
  logs.forEach(l=>{bySubj[l.subject]=(bySubj[l.subject]||0)+l.minutes;});
  if(Object.keys(bySubj).length){
    const topId=Object.entries(bySubj).sort((a,b)=>b[1]-a[1])[0][0];
    const topMon=MON.find(m=>m.id===topId);
    document.getElementById('an-top-subj').textContent=topMon?`${topMon.ico} ${topMon.ten}`:'‚Äî';
    document.getElementById('an-top-min').textContent=`${bySubj[topId]} ph√∫t t·ªïng c·ªông`;
  } else {
    document.getElementById('an-top-subj').textContent='‚Äî';
    document.getElementById('an-top-min').textContent='Ch∆∞a c√≥ d·ªØ li·ªáu';
  }
  const total=tasks.length, done=tasks.filter(t=>t.done).length;
  const pct=total?Math.round(done/total*100):0;
  const PROG_CIRC=201;
  document.getElementById('an-prog-fill').style.strokeDashoffset=PROG_CIRC*(1-pct/100);
  document.getElementById('an-prog-pct').textContent=pct+'%';
  const streak=streakLoad();
  document.getElementById('an-pomo-streak').textContent=streak.current;
  anRender30Heatmap(logs);
  anRenderBarChart(logs);
  anRenderDoughnut(bySubj);
}
function anRender30Heatmap(logs){
  const grid=document.getElementById('hm30-grid'); if(!grid)return;
  const today=new Date(); today.setHours(0,0,0,0);
  const dayMins={};
  logs.forEach(l=>{dayMins[l.date]=(dayMins[l.date]||0)+l.minutes;});
  const actDate = studyActivityLoad().lastDate;
  if (actDate && !dayMins[actDate]) dayMins[actDate] = 1;
  const all30=[];
  for(let i=29;i>=0;i--){const d=new Date(today);d.setDate(d.getDate()-i);all30.push(d);}
  const maxMins=Math.max(1,...Object.values(dayMins));
  const todayKey=anDateKey(today);
  grid.innerHTML=all30.map(d=>{
    const key=anDateKey(d);
    const mins=dayMins[key]||0;
    let lvl='';
    if(mins>0) lvl=mins<maxMins*0.25?'l1':mins<maxMins*0.5?'l2':mins<maxMins*0.75?'l3':'l4';
    const isToday=key===todayKey;
    return `<div class="hm30-cell ${lvl}${isToday?' hm-today':''}"
      title="${d.getDate()}/${d.getMonth()+1}: ${mins} ph√∫t"></div>`;
  }).join('');
}
function anRenderBarChart(logs){
  const canvas=document.getElementById('an-bar-chart'); if(!canvas)return;
  const today=new Date(); today.setHours(0,0,0,0);
  const labels=[],data=[];
  for(let i=6;i>=0;i--){
    const d=new Date(today);d.setDate(d.getDate()-i);
    labels.push(`${d.getDate()}/${d.getMonth()+1}`);
    const key=anDateKey(d);
    data.push(logs.filter(l=>l.date===key).reduce((s,l)=>s+l.minutes,0));
  }
  if(anBarChart){anBarChart.destroy();anBarChart=null;}
  const isDark=document.documentElement.getAttribute('data-theme')==='dark';
  const gridCol=isDark?'rgba(200,200,255,.1)':'rgba(99,102,241,.12)';
  const tickCol=isDark?'#5c597e':'#9ca3af';
  anBarChart=new Chart(canvas,{
    type:'bar',
    data:{labels,datasets:[{
      label:'Ph√∫t h·ªçc',data,
      backgroundColor:'rgba(99,102,241,0.65)',
      borderColor:'rgba(99,102,241,1)',
      borderRadius:6,borderWidth:1.5}]},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{display:false},tooltip:{
        backgroundColor:'rgba(15,14,26,.85)',titleColor:'#e8e6ff',bodyColor:'#a09ec0',
        padding:10,cornerRadius:10}},
      scales:{
        y:{grid:{color:gridCol},ticks:{color:tickCol,font:{size:10,family:'Inter'}},
          title:{display:true,text:'Ph√∫t',color:tickCol,font:{size:10}}},
        x:{grid:{display:false},ticks:{color:tickCol,font:{size:10,family:'Inter'}}}
      }}
  });
}
function anRenderDoughnut(bySubj){
  const canvas=document.getElementById('an-doughnut-chart'); if(!canvas)return;
  if(anDoughnut){anDoughnut.destroy();anDoughnut=null;}
  const entries=Object.entries(bySubj).sort((a,b)=>b[1]-a[1]).slice(0,6);
  if(!entries.length){
    document.getElementById('an-legend').innerHTML='<span style="font-size:.8rem;color:var(--tx-3)">Ch∆∞a c√≥ d·ªØ li·ªáu</span>';
    return;
  }
  const COLORS=['#6366f1','#34d399','#f59e0b','#f87171','#60a5fa','#a78bfa'];
  const labels=entries.map(([id])=>{const m=MON.find(x=>x.id===id);return m?m.ten:id;});
  const data=entries.map(([,v])=>v);
  anDoughnut=new Chart(canvas,{
    type:'doughnut',
    data:{labels,datasets:[{data,backgroundColor:COLORS.slice(0,entries.length),
      borderColor:'transparent',borderWidth:0,hoverOffset:6}]},
    options:{responsive:true,maintainAspectRatio:false,cutout:'68%',
      plugins:{legend:{display:false},tooltip:{
        backgroundColor:'rgba(15,14,26,.85)',titleColor:'#e8e6ff',bodyColor:'#a09ec0',
        padding:10,cornerRadius:10,callbacks:{
          label:ctx=>`${ctx.label}: ${ctx.raw} ph√∫t`}}}}
  });
  document.getElementById('an-legend').innerHTML=entries.map(([id,mins],i)=>{
    const m=MON.find(x=>x.id===id);
    return `<div style="display:flex;align-items:center;gap:7px;">
      <span style="width:10px;height:10px;border-radius:50%;background:${COLORS[i]};flex-shrink:0;display:inline-block;"></span>
      <span style="font-size:.75rem;font-weight:600;color:var(--tx-1)">${m?m.ico+' '+m.ten:id}</span>
      <span style="font-size:.72rem;color:var(--tx-3);margin-left:auto">${mins}p</span>
    </div>`;
  }).join('');
}

function checkReminder(){
  const items=ttLoad();
  const now=new Date();
  const todayDay=now.getDay();
  const nowMin=now.getHours()*60+now.getMinutes();
  const upcoming=items.filter(it=>{
    if(it.day!==todayDay)return false;
    const[h,m]=it.start.split(':').map(Number);
    return(h*60+m)>nowMin;
  });
  if(!upcoming.length)return;
  const next=upcoming[0];
  const mon=MON.find(m=>m.id===next.subject)||MON[0];
  setTimeout(()=>showToast(`üìö H√¥m nay c√≥ l·ªãch h·ªçc ${mon.ten} l√∫c ${next.start}`),800);
}

/* ‚ïê‚ïê‚ïê‚ïê FLASHCARD MODULE ‚ïê‚ïê‚ïê‚ïê */
const FC_KEY = 'flashcards';
let fcFilter  = 'all';
const fcFlipped = new Set();

function fcLoad()  { try{return JSON.parse(localStorage.getItem(FC_KEY))||[];}catch(e){return[];} }
function fcSave(a) { try{localStorage.setItem(FC_KEY,JSON.stringify(a));}catch(e){} }

function fcAdd() {
  const subj  = document.getElementById('fc-subj').value;
  const front = document.getElementById('fc-front').value.trim();
  const back  = document.getElementById('fc-back').value.trim();
  if (!front) { showToast('Nh·∫≠p m·∫∑t tr∆∞·ªõc (c√¢u h·ªèi) tr∆∞·ªõc nh√©!', false); return; }
  if (!back)  { showToast('Nh·∫≠p m·∫∑t sau (ƒë√°p √°n) tr∆∞·ªõc nh√©!', false); return; }
  const cards = fcLoad();
  const newCard = { id: Date.now(), subject: subj, front, back, remembered: false, createdAt: Date.now() };
  cards.unshift(newCard);
  fcSave(cards);
  document.getElementById('fc-front').value = '';
  document.getElementById('fc-back').value  = '';
  fcRender();
  showToast('ƒê√£ th√™m flashcard!');
}

function fcToggleRemember(id) {
  const cards = fcLoad();
  const c = cards.find(x => x.id === id);
  if (c) {
    const wasRemembered = c.remembered;
    c.remembered = !c.remembered;
    fcSave(cards);
    if (!wasRemembered && c.remembered) {
      const isNew = studyActivityMarkToday();
      if (isNew) {
        spUpdateStreak();
        spRenderHeatmap();
      }
    }
    fcRender();
  }
}

function fcDelete(id) {
  fcFlipped.delete(id);
  fcSave(fcLoad().filter(x => x.id !== id));
  fcRender();
  showToast('ƒê√£ xo√° th·∫ª', false);
}

function fcFlip(id) {
  if (fcFlipped.has(id)) fcFlipped.delete(id);
  else fcFlipped.add(id);
  const el = document.getElementById('fc-card-' + id);
  if (el) el.classList.toggle('flipped', fcFlipped.has(id));
}

function fcSetFilter(f, btn) {
  fcFilter = f;
  const block = document.getElementById('ai-block-flashcard');
  block.querySelectorAll('.sp-filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  fcRender();
}

function fcRender() {
  const all = fcLoad();
  const tot = all.length;
  const rem = all.filter(c => c.remembered).length;
  const pend = tot - rem;
  const pct  = tot ? Math.round(rem / tot * 100) : 0;

  document.getElementById('fc-total').textContent           = tot;
  document.getElementById('fc-remembered-count').textContent = rem;
  document.getElementById('fc-pending-count').textContent    = pend;
  document.getElementById('fc-pct').textContent              = pct + '%';
  document.getElementById('fc-progress-fill').style.width    = pct + '%';

  let cards = all;
  if (fcFilter === 'pending')    cards = all.filter(c => !c.remembered);
  if (fcFilter === 'remembered') cards = all.filter(c => c.remembered);

  const grid = document.getElementById('fc-grid');
  if (!cards.length) {
    grid.innerHTML = `<div class="fc-empty" style="grid-column:1/-1;">
      <span class="fc-empty-ico">üÉè</span>
      ${tot === 0 ? 'Ch∆∞a c√≥ th·∫ª n√†o. Th√™m th·∫ª ƒë·∫ßu ti√™n c·ªßa b·∫°n!' : 'Kh√¥ng c√≥ th·∫ª n√†o trong m·ª•c n√†y.'}
    </div>`;
    return;
  }

  grid.innerHTML = cards.map(c => {
    const mon = MON.find(m => m.id === c.subject) || MON[0];
    const isFlipped = fcFlipped.has(c.id);
    const isRem = c.remembered;
    return `<div class="fc-card-wrap">
      <div class="fc-card${isFlipped?' flipped':''} fc-enter" id="fc-card-${c.id}" onclick="fcFlip(${c.id})">
        <div class="fc-face fc-face-front">
          <span class="fc-card-subj">${mon.ico} ${mon.ten}</span>
          <div class="fc-card-text">${escHtml(c.front)}</div>
          <div class="fc-card-hint">üëÜ Nh·∫•n ƒë·ªÉ xem ƒë√°p √°n</div>
          <div class="fc-card-actions" onclick="event.stopPropagation()">
            <button class="fc-remember-btn${isRem?' remembered':''}"
              onclick="fcToggleRemember(${c.id})">
              ${isRem?'‚úÖ ƒê√£ nh·ªõ':'‚¨ú Ch∆∞a nh·ªõ'}
            </button>
            <button class="fc-del-btn" onclick="fcDelete(${c.id})">üóë</button>
          </div>
        </div>
        <div class="fc-face fc-face-back">
          <span class="fc-card-subj">${mon.ico} ${mon.ten}</span>
          <div class="fc-card-text">${escHtml(c.back)}</div>
          <div class="fc-card-hint">üëÜ Nh·∫•n ƒë·ªÉ xem c√¢u h·ªèi</div>
          <div class="fc-card-actions" onclick="event.stopPropagation()">
            <button class="fc-remember-btn${isRem?' remembered':''}"
              onclick="fcToggleRemember(${c.id})">
              ${isRem?'‚úÖ ƒê√£ nh·ªõ':'‚¨ú Ch∆∞a nh·ªõ'}
            </button>
            <button class="fc-del-btn" onclick="fcDelete(${c.id})">üóë</button>
          </div>
        </div>
      </div>
    </div>`;
  }).join('');
}

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

/* ‚ïê‚ïê‚ïê‚ïê AI RATE LIMITING ‚ïê‚ïê‚ïê‚ïê */
const AI_USAGE_KEY   = 'aiUsage';
const AI_DAILY_LIMIT = 20;
const CHAT_COOLDOWN  = 5000;
const CHAT_WIN_MS    = 10 * 60 * 1000;
const CHAT_WIN_LIMIT = 15;

let _chatMsgTimestamps = [];
let _chatCooldownEnd   = 0;
let _chatIsLoading     = false;
let _cooldownTimer     = null;

function aiUsageLoad() {
  try {
    const raw = JSON.parse(localStorage.getItem(AI_USAGE_KEY));
    if (raw && raw.date === todayStr()) return raw;
  } catch(e){}
  return { date: todayStr(), count: 0 };
}
function aiUsageSave(u) {
  try { localStorage.setItem(AI_USAGE_KEY, JSON.stringify(u)); } catch(e){}
}
function aiUsageIncrement() {
  const u = aiUsageLoad(); u.count++; aiUsageSave(u); return u.count;
}
function aiUsageRemaining() {
  return Math.max(0, AI_DAILY_LIMIT - aiUsageLoad().count);
}
function aiDailyLimitReached() {
  return aiUsageLoad().count >= AI_DAILY_LIMIT;
}

function chatValidateMsg(msg) {
  if (!msg || msg.length < 3) return 'Tin nh·∫Øn qu√° ng·∫Øn (t·ªëi thi·ªÉu 3 k√Ω t·ª±).';
  if (_chatHistory.length > 0) {
    const last = _chatHistory[_chatHistory.length - 1];
    if (last.role === 'user' && last.text === msg) return 'Tin nh·∫Øn tr√πng v·ªõi tin tr∆∞·ªõc.';
  }
  if (/^(.)\1{4,}$/.test(msg.trim())) return 'Tin nh·∫Øn kh√¥ng h·ª£p l·ªá (k√Ω t·ª± l·∫∑p).';
  return null;
}

function chatCheckLimits() {
  const now = Date.now();
  if (aiDailyLimitReached()) return 'B·∫°n ƒë√£ ƒë·∫°t gi·ªõi h·∫°n AI h√¥m nay. Vui l√≤ng quay l·∫°i v√†o ng√†y mai.';
  if (_chatIsLoading) return 'ƒêang x·ª≠ l√Ω tin nh·∫Øn tr∆∞·ªõc, vui l√≤ng ch·ªù‚Ä¶';
  if (now < _chatCooldownEnd) {
    const sLeft = Math.ceil((_chatCooldownEnd - now) / 1000);
    return `Vui l√≤ng ƒë·ª£i ${sLeft}s tr∆∞·ªõc khi g·ª≠i ti·∫øp.`;
  }
  _chatMsgTimestamps = _chatMsgTimestamps.filter(t => now - t < CHAT_WIN_MS);
  if (_chatMsgTimestamps.length >= CHAT_WIN_LIMIT) {
    const oldest = _chatMsgTimestamps[0];
    const waitMs = CHAT_WIN_MS - (now - oldest);
    const waitMin = Math.ceil(waitMs / 60000);
    return `B·∫°n ƒë√£ g·ª≠i ${CHAT_WIN_LIMIT} tin trong 10 ph√∫t. ƒê·ª£i ${waitMin} ph√∫t n·ªØa.`;
  }
  return null;
}

function chatRenderStatusBar() {
  const bar = document.getElementById('chat-status-bar'); if (!bar) return;
  const now = Date.now();
  const remaining = aiUsageRemaining();
  const inCooldown = now < _chatCooldownEnd;
  const cdLeft = inCooldown ? Math.ceil((_chatCooldownEnd - now) / 1000) : 0;
  _chatMsgTimestamps = _chatMsgTimestamps.filter(t => now - t < CHAT_WIN_MS);
  const winUsed = _chatMsgTimestamps.length;
  if (aiDailyLimitReached()) {
    bar.style.display = '';
    bar.innerHTML = `<div class="chat-limit-banner">‚õî ƒê√£ ƒë·∫°t gi·ªõi h·∫°n 20 l∆∞·ª£t AI h√¥m nay. Quay l·∫°i v√†o ng√†y mai.</div>`;
    return;
  }
  const parts = [];
  parts.push(`ü§ñ C√≤n ${remaining}/${AI_DAILY_LIMIT} l∆∞·ª£t h√¥m nay`);
  parts.push(`üí¨ ${winUsed}/${CHAT_WIN_LIMIT} tin / 10 ph√∫t`);
  if (inCooldown) parts.push(`‚è≥ Cooldown: ${cdLeft}s`);
  bar.style.display = '';
  bar.innerHTML = `<div style="font-size:.72rem;font-weight:600;color:var(--tx-3);
    display:flex;gap:12px;flex-wrap:wrap;padding:6px 4px;">
    ${parts.map(p=>`<span>${p}</span>`).join('')}
  </div>${inCooldown ? `<div class="chat-cooldown-bar"><div class="chat-cooldown-fill" id="cd-fill"
    style="width:${Math.round((1-((_chatCooldownEnd-now)/CHAT_COOLDOWN))*100)}%"></div></div>` : ''}`;
}

function chatStartCooldown() {
  _chatCooldownEnd = Date.now() + CHAT_COOLDOWN;
  chatRenderStatusBar();
  clearInterval(_cooldownTimer);
  _cooldownTimer = setInterval(() => {
    chatRenderStatusBar();
    if (Date.now() >= _chatCooldownEnd) {
      clearInterval(_cooldownTimer);
      _cooldownTimer = null;
      chatRenderStatusBar();
    }
  }, 500);
}

/* ‚ïê‚ïê‚ïê‚ïê AI MODULE ‚ïê‚ïê‚ïê‚ïê */
const WORKER_URL = 'https://dark-wind-64fc.manhdat120609.workers.dev';
const GEMINI_PROFILE_KEY = 'studentProfile_v1';

let _studentProfile = { grade: '', textbook: '', track: '' };
let _aiPlanPreview  = [];
let _chatHistory    = [];

async function callGemini(prompt) {
  let resp;
  try {
    resp = await fetch(WORKER_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt })
    });
  } catch(netErr) {
    throw new Error('Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c m√°y ch·ªß. Ki·ªÉm tra m·∫°ng v√† th·ª≠ l·∫°i.');
  }
  let data;
  try { data = await resp.json(); } catch(_) { throw new Error(`L·ªói HTTP ${resp.status} ‚Äî ph·∫£n h·ªìi kh√¥ng h·ª£p l·ªá`); }
  if (data && data.error) throw new Error(data.error);
  if (!resp.ok) throw new Error(`L·ªói HTTP ${resp.status}`);
  const text = data.text || (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0] && data.candidates[0].content.parts[0].text) || '';
  if (!text) throw new Error('M√°y ch·ªß kh√¥ng tr·∫£ v·ªÅ n·ªôi dung');
  return text;
}

function extractJSON(raw) {
  const clean = raw.replace(/```json\s*/gi, '').replace(/```\s*/g, '').trim();
  try { return JSON.parse(clean); } catch(_) {}
  const arrMatch = clean.match(/\[[\s\S]*\]/);
  if (arrMatch) { try { return JSON.parse(arrMatch[0]); } catch(_) {} }
  const objMatch = clean.match(/\{[\s\S]*\}/);
  if (objMatch) { try { return JSON.parse(objMatch[0]); } catch(_) {} }
  throw new Error('Kh√¥ng th·ªÉ ƒë·ªçc ƒë·ªãnh d·∫°ng JSON t·ª´ ph·∫£n h·ªìi AI');
}

function _geminiErrMsg(e) {
  return `‚ùå Kh√¥ng th·ªÉ t·∫°o k·∫ø ho·∫°ch. Vui l√≤ng th·ª≠ l·∫°i. (${e.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'})`;
}

function _addDays(base, n) {
  const d = new Date(base); d.setDate(d.getDate() + n);
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

function aiLoadProfile() {
  try {
    const p = JSON.parse(localStorage.getItem(GEMINI_PROFILE_KEY));
    if (p) {
      _studentProfile = p;
      const gEl = document.getElementById('profile-grade');
      const tEl = document.getElementById('profile-textbook');
      const kEl = document.getElementById('profile-track');
      if (gEl && p.grade)    gEl.value    = p.grade;
      if (tEl && p.textbook) tEl.value    = p.textbook;
      if (kEl && p.track)    kEl.value    = p.track;
      _renderProfileStatus();
    }
  } catch(e) {}
}
function aiSaveProfile() {
  _studentProfile = {
    grade:    (document.getElementById('profile-grade')    || {}).value || '',
    textbook: (document.getElementById('profile-textbook') || {}).value || '',
    track:    (document.getElementById('profile-track')    || {}).value || '',
  };
  try { localStorage.setItem(GEMINI_PROFILE_KEY, JSON.stringify(_studentProfile)); } catch(e) {}
  _renderProfileStatus();
}
function _renderProfileStatus() {
  const el = document.getElementById('profile-status'); if (!el) return;
  const { grade, textbook, track } = _studentProfile;
  if (grade && textbook && track) {
    el.textContent = `‚úÖ L·ªõp ${grade} ¬∑ ${textbook} ¬∑ Ban ${track}`;
    el.style.color = '#059669';
  } else {
    el.textContent = '‚ö†Ô∏è H√£y ch·ªçn ƒë·∫ßy ƒë·ªß l·ªõp, b·ªô s√°ch v√† ban h·ªçc';
    el.style.color = '#f87171';
  }
}

function _aiLoading(html='ƒêang k·∫øt n·ªëi AI Gemini‚Ä¶') {
  return `<div class="ai-loading">
    <div class="ai-loading-dots"><span></span><span></span><span></span></div>
    <span>${html}</span>
  </div>`;
}

function _setAiBtnsDisabled(flag) {
  ['btn-ai-analysis','btn-ai-plan','btn-chat-send'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.disabled=flag;
  });
}

async function aiRunAnalysis() {
  const el = document.getElementById('ai-analysis-content');
  if (!currentResult || !currentResult.rows || !currentResult.rows.length) {
    el.innerHTML = `<div class="ai-no-data"><span class="ai-nd-ico">‚ö†Ô∏è</span>H√£y t√≠nh k·∫øt qu·∫£ ·ªü tab <strong>H·ªçc l·ª±c</strong> tr∆∞·ªõc.</div>`;
    return;
  }
  if (aiDailyLimitReached()) {
    el.innerHTML = `<div class="ai-no-data"><span class="ai-nd-ico">‚õî</span>B·∫°n ƒë√£ ƒë·∫°t gi·ªõi h·∫°n AI h√¥m nay. Vui l√≤ng quay l·∫°i v√†o ng√†y mai.</div>`;
    return;
  }
  const rows = currentResult.rows.filter(r => r.tbm !== null);
  if (!rows.length) return;
  el.innerHTML = _aiLoading('ƒêang ph√¢n t√≠ch h·ªçc l·ª±c‚Ä¶');
  _setAiBtnsDisabled(true);
  const { grade, textbook, track } = _studentProfile;
  const scoreLines = rows.map(r => `- ${r.m.ten}: ${r.tbm.toFixed(2)}`).join('\n');
  const rnkLbl = rankOf(currentResult.dtb).lbl;
  const prompt = `B·∫°n l√† gi√°o vi√™n ch·ªß nhi·ªám Vi·ªát Nam, chuy√™n t∆∞ v·∫•n h·ªçc sinh THCS/THPT.
H·ªçc sinh: ${currentResult.ten || 'H·ªçc sinh'}
L·ªõp: ${grade || 'Ch∆∞a x√°c ƒë·ªãnh'} | B·ªô s√°ch: ${textbook || 'Ch∆∞a x√°c ƒë·ªãnh'} | Ban: ${track || 'Ch∆∞a x√°c ƒë·ªãnh'}
ƒêi·ªÉm trung b√¨nh c·∫£ nƒÉm c√°c m√¥n:
${scoreLines}
TBM chung: ${currentResult.dtb.toFixed(2)} ‚Äî X·∫øp lo·∫°i: ${rnkLbl}

Y√äU C·∫¶U: H√£y nh·∫≠n x√©t v√† ph√¢n t√≠ch h·ªçc l·ª±c theo 3 ph·∫ßn r√µ r√†ng:
1. NH·∫¨N X√âT T·ªîNG QUAN (2-3 c√¢u, th·ª±c t·∫ø, kh√¥ng ng·∫°i n√≥i th·∫≥ng n·∫øu k·∫øt qu·∫£ k√©m)
2. PH√ÇN T√çCH C√ÅC M√îN Y·∫æU (li·ªát k√™ v√† gi·∫£i th√≠ch t·∫°i sao c·∫ßn c·∫£i thi·ªán)
3. 3 H√ÄNH ƒê·ªòNG C·ª§ TH·ªÇ (th·ª±c t·∫ø, ƒë√∫ng ch∆∞∆°ng tr√¨nh l·ªõp ${grade||''}, kh√¥ng n√≥i chung chung)

L∆∞u √Ω:
- N·∫øu TBM <5: c·∫£nh b√°o nghi√™m t√∫c, kh√¥ng an ·ªßi h√£o
- N·∫øu TBM <6.5: kh√¥ng ƒë∆∞·ª£c n√≥i "ti·∫øp t·ª•c ph√°t huy" hay "duy tr√¨ phong ƒë·ªô"
- Tr·∫£ l·ªùi b·∫±ng ti·∫øng Vi·ªát, ng·∫Øn g·ªçn, th√¢n thi·ªán nh∆∞ng th·ª±c t·∫ø
- KH√îNG d√πng markdown (**) hay bullet (-)`;
  try {
    aiUsageIncrement();
    const resp = await callGemini(prompt);
    el.innerHTML = `<div class="ai-gemini-resp">${resp.trim()}</div>`;
    showToast('AI Gemini ƒë√£ ph√¢n t√≠ch xong!');
  } catch(e) {
    el.innerHTML = `<div class="ai-no-data"><span class="ai-nd-ico">‚ùå</span>${_geminiErrMsg(e)}</div>`;
  } finally {
    _setAiBtnsDisabled(false);
    chatRenderStatusBar();
  }
}

async function aiGenPlan() {
  const el = document.getElementById('ai-plan-content');
  const pushBtn = document.getElementById('ai-push-btn');
  if (pushBtn) pushBtn.disabled = true;
  _aiPlanPreview = [];

  if (aiDailyLimitReached()) {
    el.innerHTML = `<div class="ai-no-data"><span class="ai-nd-ico">‚õî</span>B·∫°n ƒë√£ ƒë·∫°t gi·ªõi h·∫°n AI h√¥m nay. Vui l√≤ng quay l·∫°i v√†o ng√†y mai.</div>`;
    return;
  }
  if (!currentResult || !currentResult.rows || !currentResult.rows.length) {
    el.innerHTML = `<div class="ai-no-data"><span class="ai-nd-ico">‚ö†Ô∏è</span>C·∫ßn c√≥ k·∫øt qu·∫£ ƒëi·ªÉm tr∆∞·ªõc. H√£y t√≠nh k·∫øt qu·∫£ ·ªü tab <strong>H·ªçc l·ª±c</strong>.</div>`;
    return;
  }

  const rows = currentResult.rows.filter(r => r.tbm !== null);
  if (!rows.length) {
    el.innerHTML = `<div class="ai-no-data"><span class="ai-nd-ico">‚ö†Ô∏è</span>Kh√¥ng c√≥ d·ªØ li·ªáu ƒëi·ªÉm h·ª£p l·ªá.</div>`;
    return;
  }

  const sorted = [...rows].sort((a,b) => a.tbm - b.tbm);
  const weak = sorted.slice(0, Math.min(3, sorted.length));

  el.innerHTML = _aiLoading('ƒêang t·∫°o k·∫ø ho·∫°ch 14 ng√†y‚Ä¶');
  _setAiBtnsDisabled(true);

  const { grade, textbook, track } = _studentProfile;
  const weakLines = weak.map(w => `${w.m.ten} (${w.tbm.toFixed(2)})`).join(', ');

  const prompt = `B·∫°n l√† gi√°o vi√™n l·∫≠p k·∫ø ho·∫°ch h·ªçc t·∫≠p cho h·ªçc sinh Vi·ªát Nam.
L·ªõp: ${grade||'THPT'} | S√°ch: ${textbook||'ch∆∞∆°ng tr√¨nh chu·∫©n'} | Ban: ${track||'c∆° b·∫£n'}
C√°c m√¥n y·∫øu c·∫ßn √¥n: ${weakLines}

T·∫°o k·∫ø ho·∫°ch h·ªçc 14 ng√†y li√™n ti·∫øp, m·ªói ng√†y 1 nhi·ªám v·ª•, xen k·∫Ω c√°c m√¥n y·∫øu.
Tr·∫£ l·ªùi CH√çNH X√ÅC theo ƒë·ªãnh d·∫°ng JSON m·∫£ng (kh√¥ng c√≥ markdown, kh√¥ng gi·∫£i th√≠ch th√™m):
[{"day":1,"subject":"t√™n m√¥n","task":"n·ªôi dung nhi·ªám v·ª• c·ª• th·ªÉ (15-40 t·ª´)"},{"day":2,"subject":"t√™n m√¥n","task":"..."},{"day":3,"subject":"t√™n m√¥n","task":"..."},{"day":4,"subject":"t√™n m√¥n","task":"..."},{"day":5,"subject":"t√™n m√¥n","task":"..."},{"day":6,"subject":"t√™n m√¥n","task":"..."},{"day":7,"subject":"t√™n m√¥n","task":"..."},{"day":8,"subject":"t√™n m√¥n","task":"..."},{"day":9,"subject":"t√™n m√¥n","task":"..."},{"day":10,"subject":"t√™n m√¥n","task":"..."},{"day":11,"subject":"t√™n m√¥n","task":"..."},{"day":12,"subject":"t√™n m√¥n","task":"..."},{"day":13,"subject":"t√™n m√¥n","task":"..."},{"day":14,"subject":"t√™n m√¥n","task":"..."}]
Ch·ªâ tr·∫£ v·ªÅ JSON array, kh√¥ng th√™m b·∫•t k·ª≥ text n√†o kh√°c.`;

  try {
    aiUsageIncrement();
    const rawResp = await callGemini(prompt);

    let plan;
    try {
      plan = extractJSON(rawResp);
    } catch(pe) {
      const lines = rawResp.split('\n').map(l => l.trim()).filter(Boolean);
      plan = [];
      let dayNum = 1;
      for (const line of lines) {
        if (dayNum > 14) break;
        const taskText = line.replace(/^\d+[\.\)]\s*/, '').replace(/^\-\s*/, '').trim();
        if (taskText.length > 5) {
          plan.push({ day: dayNum, subject: weak[(dayNum-1) % weak.length].m.ten, task: taskText });
          dayNum++;
        }
      }
      if (!plan.length) throw new Error('Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c k·∫ø ho·∫°ch. Vui l√≤ng th·ª≠ l·∫°i.');
    }

    if (!Array.isArray(plan)) {
      plan = plan.plan || plan.tasks || plan.data || plan.schedule || [];
    }
    if (!plan.length) throw new Error('K·∫ø ho·∫°ch tr·ªëng, vui l√≤ng th·ª≠ l·∫°i.');

    while (plan.length < 14) {
      const i = plan.length;
      const w = weak[i % weak.length];
      plan.push({ day: i+1, subject: w.m.ten, task: `√în t·∫≠p v√† luy·ªán ƒë·ªÅ ${w.m.ten}` });
    }
    plan = plan.slice(0, 14);

    const today = new Date(); today.setHours(0,0,0,0);

    _aiPlanPreview = plan.map((p, i) => {
      const subjName = (p.subject || '').toLowerCase().trim();
      const matchMon = MON.find(m =>
        m.ten.toLowerCase() === subjName ||
        m.ten.toLowerCase().includes(subjName) ||
        subjName.includes(m.ten.toLowerCase())
      ) || weak[i % weak.length].m;

      return {
        subject:    matchMon.id,
        title:      `[AI] ${(p.task || '').trim()}`,
        deadline:   _addDays(today, (p.day || i+1)),
        day:        p.day || i+1,
        subjLabel:  `${matchMon.ico} ${matchMon.ten}`,
      };
    });

    el.innerHTML = `
      <div style="font-size:.8rem;color:var(--tx-2);font-weight:600;margin-bottom:10px;
        padding:8px 12px;background:var(--bg-rdtip);border-radius:10px;">
        üìå T·∫≠p trung: ${weak.map(w=>`<strong>${w.m.ico} ${w.m.ten}</strong>`).join(' ¬∑ ')}
      </div>
      <div class="ai-plan-grid">
        ${_aiPlanPreview.map((t,i)=>`
          <div class="ai-plan-item" style="--i:${i}">
            <span class="ai-plan-day">Ng√†y ${t.day}</span>
            <span class="ai-plan-subj">${t.subjLabel}</span>
            <span class="ai-plan-title">${escHtml(t.title.replace('[AI] ',''))}</span>
            <span style="font-size:.68rem;color:var(--tx-3);white-space:nowrap">üìÖ ${t.deadline.split('-').reverse().join('/')}</span>
          </div>`).join('')}
      </div>`;

    if (pushBtn) pushBtn.disabled = false;
    showToast('AI ƒë√£ t·∫°o k·∫ø ho·∫°ch 14 ng√†y!');

  } catch(e) {
    el.innerHTML = `<div class="ai-no-data"><span class="ai-nd-ico">‚ùå</span>Kh√¥ng th·ªÉ t·∫°o k·∫ø ho·∫°ch. Vui l√≤ng th·ª≠ l·∫°i.<br><small style="opacity:.6">${e.message||''}</small></div>`;
    showToast('Kh√¥ng t·∫°o ƒë∆∞·ª£c k·∫ø ho·∫°ch, th·ª≠ l·∫°i nh√©!', false);
  } finally {
    _setAiBtnsDisabled(false);
    chatRenderStatusBar();
  }
}

function aiPushToPlanner() {
  if (!_aiPlanPreview.length) { showToast('Ch∆∞a c√≥ k·∫ø ho·∫°ch ƒë·ªÉ th√™m!', false); return; }
  const tasks = spLoad();
  const now = Date.now();
  _aiPlanPreview.forEach((t, i) => {
    tasks.push({ id: now+i, subject: t.subject, title: t.title,
      deadline: t.deadline, done: false, createdAt: now+i });
  });
  spSave(tasks);
  const pb = document.getElementById('ai-push-btn');
  if (pb) pb.disabled = true;
  _aiPlanPreview = [];
  showToast('ƒê√£ th√™m 14 nhi·ªám v·ª• v√†o K·∫ø ho·∫°ch!');
}

async function aiChatSend() {
  const inp = document.getElementById('chat-input');
  if (!inp) return;
  const msg = inp.value.trim();
  const msgErr = chatValidateMsg(msg);
  if (msgErr) { showToast(msgErr, false); return; }
  const limitErr = chatCheckLimits();
  if (limitErr) { showToast(limitErr, false); chatRenderStatusBar(); return; }
  inp.value = '';
  _chatMsgTimestamps.push(Date.now());
  chatStartCooldown();
  _chatAppendMsg('user', msg);
  _chatHistory.push({ role: 'user', text: msg });
  const sendBtn = document.getElementById('btn-chat-send');
  if (sendBtn) sendBtn.disabled = true;
  _chatIsLoading = true;
  const { grade, textbook, track } = _studentProfile;
  const profileCtx = grade ? `H·ªçc sinh l·ªõp ${grade}, s√°ch ${textbook||'chu·∫©n'}, ban ${track||'c∆° b·∫£n'}.` : '';
  const scoreCtx = currentResult
    ? `TBM chung: ${currentResult.dtb.toFixed(2)} (${rankOf(currentResult.dtb).lbl}).` : '';
  const historyCtx = _chatHistory.slice(-6).map(h=>`${h.role==='user'?'H·ªçc sinh':'AI'}: ${h.text}`).join('\n');
  const prompt = `B·∫°n l√† tr·ª£ l√Ω h·ªçc t·∫≠p AI th√¥ng minh, th√¢n thi·ªán cho h·ªçc sinh Vi·ªát Nam.
${profileCtx} ${scoreCtx}
Quy t·∫Øc:
- Tr·∫£ l·ªùi ph√π h·ª£p c·∫•p l·ªõp${grade?' '+grade:''}
- Kh√¥ng gi·∫£ng d·∫°y v∆∞·ª£t qu√° ch∆∞∆°ng tr√¨nh ph·ªï th√¥ng
- Gi·∫£i th√≠ch r√µ r√†ng, d√πng v√≠ d·ª• th·ª±c t·∫ø Vi·ªát Nam
- Khuy·∫øn kh√≠ch t·ª± h·ªçc v√† t∆∞ duy ƒë·ªôc l·∫≠p
- Ng·∫Øn g·ªçn, th·ª±c d·ª•ng (d∆∞·ªõi 200 t·ª´ tr·ª´ khi c·∫ßn gi·∫£i th√≠ch k·ªπ)

L·ªãch s·ª≠ h·ªôi tho·∫°i:
${historyCtx}

C√¢u h·ªèi m·ªõi: ${msg}`;
  const thinkEl = _chatAppendLoading();
  try {
    aiUsageIncrement();
    const resp = await callGemini(prompt);
    thinkEl.remove();
    _chatAppendMsg('ai', resp.trim());
    _chatHistory.push({ role: 'ai', text: resp.trim() });
    if (_chatHistory.length > 20) _chatHistory.splice(0, 2);
  } catch(e) {
    thinkEl.remove();
    _chatAppendMsg('ai', `‚ùå L·ªói: ${e.message || 'Kh√¥ng x√°c ƒë·ªãnh. Vui l√≤ng th·ª≠ l·∫°i.'}`);
  } finally {
    _chatIsLoading = false;
    if (sendBtn) sendBtn.disabled = false;
    inp.focus();
    chatRenderStatusBar();
  }
}

function _chatAppendMsg(role, text) {
  const box = document.getElementById('ai-chat-box'); if (!box) return;
  const div = document.createElement('div');
  div.className = `chat-msg ${role}`;
  div.innerHTML = `
    <div class="chat-avatar">${role==='user'?'üßë':'ü§ñ'}</div>
    <div class="chat-bubble">${text}</div>`;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
  return div;
}

function _chatAppendLoading() {
  const box = document.getElementById('ai-chat-box'); if (!box) return document.createElement('div');
  const div = document.createElement('div');
  div.className = 'chat-msg ai';
  div.innerHTML = `
    <div class="chat-avatar">ü§ñ</div>
    <div class="chat-bubble">
      <div style="display:flex;gap:4px;padding:2px 0;">
        <span style="width:7px;height:7px;border-radius:50%;background:var(--c-p1);animation:dotBounce 1.2s infinite ease-in-out;display:inline-block;"></span>
        <span style="width:7px;height:7px;border-radius:50%;background:var(--c-p1);animation:dotBounce 1.2s infinite ease-in-out .2s;display:inline-block;"></span>
        <span style="width:7px;height:7px;border-radius:50%;background:var(--c-p1);animation:dotBounce 1.2s infinite ease-in-out .4s;display:inline-block;"></span>
      </div>
    </div>`;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
  return div;
}

function aiChatClear() {
  _chatHistory = [];
  _chatMsgTimestamps = [];
  const box = document.getElementById('ai-chat-box'); if (!box) return;
  box.innerHTML = `<div class="chat-msg ai">
    <div class="chat-avatar">ü§ñ</div>
    <div class="chat-bubble">Xin ch√†o! T√¥i l√† tr·ª£ l√Ω h·ªçc t·∫≠p AI. H√£y h·ªèi t√¥i b·∫•t c·ª© ƒëi·ªÅu g√¨ v·ªÅ m√¥n h·ªçc, b√†i t·∫≠p, hay ph∆∞∆°ng ph√°p h·ªçc t·∫≠p nh√©! üìö</div>
  </div>`;
  chatRenderStatusBar();
  showToast('ƒê√£ xo√° l·ªãch s·ª≠ chat', false);
}

/* ‚ïê‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê */
buildMonUI();
renderLichSu();
spBuildSubjSelect();
pomoRenderStats();
spRender();
ttRender();
checkReminder();
fcRender();
switchTab('grade');
</script>
</body>
</html>
