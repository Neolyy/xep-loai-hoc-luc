<!DOCTYPE html>
<html lang="vi" data-theme="light">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Study System PRO</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root{
  --bg-page:#eef2ff;--bg-card:#fff;--bg-input:#f8f9ff;
  --bg-subj:#f8f9ff;--bg-hist:#f8f9ff;--bg-histrow:#fff;
  --bg-soft:#ede9fe;--bg-prog:rgba(255,255,255,.55);
  --bg-desc:rgba(255,255,255,.5);--bg-rdtip:rgba(0,0,0,.06);
  --bg-tblhov:rgba(0,0,0,.03);--bg-chart:#fff;
  --bg-glass:rgba(255,255,255,0.45);--bd-glass:rgba(255,255,255,0.6);
  --bd-base:#e0e7ff;--bd-input:#e0e7ff;
  --tx-1:#1e1b4b;--tx-2:#4b5563;--tx-3:#9ca3af;
  --c-p1:#4f46e5;--c-p2:#7c3aed;--c-acc:#a78bfa;
  --dot-clr:#c7d2fe;--scale-op:.22;
  --g-bg:#d1fae5;--g-bd:#6ee7b7;--g-tx:#065f46;--g-pill:#34d399;
  --k-bg:#dbeafe;--k-bd:#93c5fd;--k-tx:#1e40af;--k-pill:#60a5fa;
  --t-bg:#fef9c3;--t-bd:#fde68a;--t-tx:#854d0e;--t-pill:#fbbf24;
  --y-bg:#fee2e2;--y-bd:#fca5a5;--y-tx:#991b1b;--y-pill:#f87171;
  --sh-sm:0 2px 8px rgba(99,102,241,.10);
  --sh-md:0 8px 32px rgba(99,102,241,.16);
  --sh-lg:0 20px 56px rgba(99,102,241,.22);
  --td:.3s;
  --chart-grid:rgba(99,102,241,.15);
  --chart-tick:#9ca3af;--chart-pt-label:#4b5563;
  --shimmer-1:#f0f0ff;--shimmer-2:#e0e0ff;
}
[data-theme="dark"]{
  --bg-page:#0f0e1a;--bg-card:#1a1830;--bg-input:#231f3a;
  --bg-subj:#201d35;--bg-hist:#1e1b30;--bg-histrow:#27243f;
  --bg-soft:#2d2852;--bg-prog:rgba(255,255,255,.04);
  --bg-desc:rgba(255,255,255,.04);--bg-rdtip:rgba(255,255,255,.08);
  --bg-tblhov:rgba(255,255,255,.04);--bg-chart:#1a1830;
  --bg-glass:rgba(30,24,48,0.55);--bd-glass:rgba(100,80,180,0.25);
  --bd-base:#312e57;--bd-input:#3a3666;
  --tx-1:#e8e6ff;--tx-2:#a09ec0;--tx-3:#5c597e;
  --c-p1:#818cf8;--c-p2:#a78bfa;--c-acc:#c4b5fd;
  --dot-clr:#1e1b35;--scale-op:.35;
  --g-bg:#052e16;--g-bd:#065f46;--g-tx:#6ee7b7;--g-pill:#059669;
  --k-bg:#0c1f4a;--k-bd:#1e3a8a;--k-tx:#93c5fd;--k-pill:#1d4ed8;
  --t-bg:#2d1f00;--t-bd:#78350f;--t-tx:#fde68a;--t-pill:#d97706;
  --y-bg:#2d0a0a;--y-bd:#7f1d1d;--y-tx:#fca5a5;--y-pill:#dc2626;
  --sh-sm:0 2px 8px rgba(0,0,0,.4);--sh-md:0 8px 32px rgba(0,0,0,.5);
  --sh-lg:0 20px 56px rgba(0,0,0,.65);
  --chart-grid:rgba(200,200,255,.10);--chart-tick:#5c597e;--chart-pt-label:#a09ec0;
  --shimmer-1:#1a1830;--shimmer-2:#231f3a;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;
  transition:background-color var(--td) ease,border-color var(--td) ease,
  color var(--td) ease,box-shadow var(--td) ease;}
.btn,.spin,.mon-card,.hist-row{transition:background-color var(--td) ease,
  border-color var(--td) ease,color var(--td) ease,box-shadow var(--td) ease,transform .15s ease;}
body{font-family:'Inter',system-ui,sans-serif;background-color:var(--bg-page);
  background-image:radial-gradient(circle,var(--dot-clr) 1px,transparent 1px);
  background-size:28px 28px;min-height:100vh;
  display:flex;flex-direction:column;align-items:center;
  padding:36px 16px 60px;color:var(--tx-1);}
.dm-toggle{position:fixed;top:18px;right:18px;z-index:200;
  width:48px;height:48px;border-radius:50%;border:2px solid var(--bd-base);
  background:var(--bg-card);box-shadow:var(--sh-md);cursor:pointer;
  display:flex;align-items:center;justify-content:center;font-size:1.3rem;}
.dm-toggle:hover{transform:scale(1.1) rotate(15deg);box-shadow:var(--sh-lg);}
.dm-toggle::after{content:attr(data-ico);}
.pg-head{text-align:center;margin-bottom:28px;}
.pg-head .crown{font-size:3.2rem;display:block;margin-bottom:8px;
  animation:float 3s ease-in-out infinite;
  filter:drop-shadow(0 6px 12px rgba(124,58,237,.35));}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
.pg-head h1{font-size:clamp(1.4rem,4vw,2rem);font-weight:900;letter-spacing:-.03em;
  background:linear-gradient(135deg,var(--c-p1),var(--c-p2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.pg-head p{color:var(--tx-2);font-size:.88rem;margin-top:5px;font-weight:500;}
.pro-badge{display:inline-block;font-size:.65rem;font-weight:800;
  background:linear-gradient(135deg,#f59e0b,#f97316);color:#fff;
  padding:2px 8px;border-radius:99px;margin-left:6px;
  vertical-align:middle;letter-spacing:.06em;box-shadow:0 2px 8px rgba(245,158,11,.4);}
.tab-bar{display:flex;gap:0;width:100%;max-width:900px;margin-bottom:-2px;
  position:relative;z-index:10;overflow-x:auto;}
.tab-btn{flex:1;min-width:0;padding:11px 10px;border:2px solid var(--bd-base);
  background:var(--bg-page);border-bottom:none;border-radius:18px 18px 0 0;
  cursor:pointer;font-family:inherit;font-size:.82rem;font-weight:700;
  color:var(--tx-3);display:flex;align-items:center;justify-content:center;
  gap:6px;white-space:nowrap;
  transition:background var(--td),color var(--td),border-color var(--td);}
.tab-btn:not(:last-child){margin-right:4px;}
.tab-btn:hover{background:var(--bg-soft);color:var(--c-p1);}
.tab-btn.active{background:var(--bg-card);color:var(--c-p1);border-color:var(--bd-base);
  box-shadow:0 -4px 16px rgba(99,102,241,.10);}
.card{background:var(--bg-card);border-radius:0 28px 28px 28px;box-shadow:var(--sh-lg);
  width:100%;max-width:900px;overflow:hidden;
  animation:slideUp .5s cubic-bezier(.22,1,.36,1) both;}
@keyframes slideUp{from{opacity:0;transform:translateY(28px)}to{opacity:1;transform:translateY(0)}}
.card-stripe{height:5px;
  background:linear-gradient(90deg,#6366f1,#a78bfa,#7c3aed,#818cf8,#4f46e5);
  background-size:200%;animation:shimmer 3s linear infinite;}
@keyframes shimmer{0%{background-position:0%}100%{background-position:200%}}
.card-body{padding:28px 28px 32px;}
.sec-lbl{display:flex;align-items:center;gap:8px;font-size:.71rem;font-weight:700;
  text-transform:uppercase;letter-spacing:.08em;color:var(--c-p1);margin-bottom:14px;}
.sec-lbl::after{content:'';flex:1;height:1.5px;
  background:linear-gradient(90deg,var(--bd-base),transparent);border-radius:99px;}
.name-field{margin-bottom:24px;}
.fi{position:relative;display:flex;align-items:center;}
.fi .fi-ico{position:absolute;left:13px;font-size:1.05rem;pointer-events:none;}
.fi input{width:100%;padding:11px 13px 11px 40px;border:2px solid var(--bd-input);
  border-radius:14px;font-family:inherit;font-size:.96rem;font-weight:500;
  color:var(--tx-1);background:var(--bg-input);outline:none;}
.fi input:focus{border-color:var(--c-p1);background:var(--bg-card);
  box-shadow:0 0 0 4px rgba(99,102,241,.14);}
.fi input::placeholder{color:var(--tx-3);font-weight:400;}
.mon-list{display:flex;flex-direction:column;gap:14px;margin-bottom:10px;}
.mon-card{background:var(--bg-subj);border:2px solid var(--bd-base);
  border-radius:20px;overflow:hidden;box-shadow:var(--sh-sm);
  transition:box-shadow var(--td) ease,border-color var(--td) ease;}
.mon-card:focus-within{border-color:var(--c-p1);box-shadow:var(--sh-md);}
.mon-card.has-error{border-color:#f87171;}
.mon-header{display:flex;align-items:center;gap:12px;
  padding:13px 16px;cursor:pointer;user-select:none;background:var(--bg-subj);}
.mon-header:hover{background:var(--bg-soft);}
.mon-ico-chip{width:32px;height:32px;border-radius:10px;background:var(--bg-soft);
  display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;}
.mon-title-wrap{flex:1;}
.mon-title{font-size:.9rem;font-weight:800;color:var(--tx-1);}
.mon-subtitle{font-size:.72rem;color:var(--tx-3);margin-top:1px;font-weight:500;}
.mon-tbm-display{font-size:1.1rem;font-weight:900;min-width:48px;text-align:right;}
.mon-tbm-display.sc-g{color:#059669}.mon-tbm-display.sc-k{color:#2563eb}
.mon-tbm-display.sc-t{color:#d97706}.mon-tbm-display.sc-y{color:#dc2626}
[data-theme="dark"] .mon-tbm-display.sc-g{color:#34d399}
[data-theme="dark"] .mon-tbm-display.sc-k{color:#60a5fa}
[data-theme="dark"] .mon-tbm-display.sc-t{color:#fbbf24}
[data-theme="dark"] .mon-tbm-display.sc-y{color:#f87171}
.mon-del-btn{background:none;border:none;cursor:pointer;font-size:.85rem;
  color:var(--tx-3);padding:3px 7px;border-radius:8px;flex-shrink:0;margin-left:4px;
  transition:color .15s,background .15s,transform .1s;}
.mon-del-btn:hover{color:#f87171;background:var(--y-bg);transform:scale(1.1);}
.mon-chevron{font-size:.8rem;color:var(--tx-3);margin-left:4px;
  transition:transform .25s ease;flex-shrink:0;}
.mon-card.open .mon-chevron{transform:rotate(180deg);}
.mon-body{display:none;padding:0 16px 16px;border-top:1.5px solid var(--bd-base);animation:fadeIn .2s ease;}
.mon-card.open .mon-body{display:block;}
.semesters{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px;}
@media(max-width:600px){.semesters{grid-template-columns:1fr;}}
.sem-block{background:var(--bg-prog);border:1px solid rgba(128,128,128,.12);
  border-radius:14px;padding:12px 14px;}
.sem-title{font-size:.72rem;font-weight:800;text-transform:uppercase;letter-spacing:.07em;
  color:var(--c-p1);margin-bottom:10px;display:flex;align-items:center;justify-content:space-between;}
.sem-result{font-size:.82rem;font-weight:700;color:var(--tx-2);
  background:var(--bg-soft);padding:2px 8px;border-radius:99px;}
.inp-row{display:flex;align-items:center;gap:8px;margin-bottom:7px;}
.inp-row:last-child{margin-bottom:0;}
.inp-lbl{font-size:.73rem;font-weight:600;color:var(--tx-2);min-width:72px;flex-shrink:0;}
.tx-row{display:flex;align-items:center;gap:6px;flex:1;flex-wrap:wrap;}
.d-inp{width:52px;padding:6px 8px;border:1.5px solid var(--bd-base);border-radius:9px;
  font-family:inherit;font-size:.88rem;font-weight:700;color:var(--tx-1);
  background:var(--bg-card);outline:none;text-align:center;transition:border-color .2s,box-shadow .2s;}
.d-inp:focus{border-color:var(--c-p1);box-shadow:0 0 0 3px rgba(99,102,241,.13);}
.d-inp.err{border-color:#f87171;background:#fff5f5;}
[data-theme="dark"] .d-inp.err{background:#2d1010;}
.d-inp::placeholder{color:var(--tx-3);font-weight:400;font-size:.8rem;}
.btn-tx-del,.btn-tx-add{width:22px;height:22px;border-radius:6px;border:1.5px solid var(--bd-base);
  background:var(--bg-card);cursor:pointer;font-size:.85rem;font-weight:700;
  display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:background .15s,transform .1s;}
.btn-tx-del{color:#ef4444;}.btn-tx-del:hover{background:#fee2e2;}
.btn-tx-add{color:#059669;}.btn-tx-add:hover{background:#d1fae5;}
.btn-tx-del:active,.btn-tx-add:active{transform:scale(.88);}
.hk-display{margin-top:8px;padding:6px 12px;border-radius:10px;background:var(--bg-rdtip);
  font-size:.78rem;font-weight:700;color:var(--tx-2);display:flex;align-items:center;justify-content:space-between;}
.hk-val{font-size:.92rem;font-weight:900;color:var(--tx-1);}
.year-bar{margin-top:10px;padding:10px 14px;border-radius:12px;background:var(--bg-prog);
  border:1px solid rgba(128,128,128,.1);display:flex;align-items:center;
  justify-content:space-between;gap:8px;flex-wrap:wrap;}
.year-bar .yb-label{font-size:.73rem;font-weight:700;color:var(--tx-2);}
.year-bar .yb-formula{font-size:.68rem;color:var(--tx-3);margin-top:1px;}
.year-bar .yb-val{font-size:1.2rem;font-weight:900;}
.g-err{background:var(--y-bg);border:1.5px solid var(--y-bd);border-radius:11px;
  padding:10px 14px;font-size:.83rem;font-weight:500;color:var(--y-tx);
  margin-top:5px;margin-bottom:2px;display:none;animation:fadeIn .25s ease;}
.actions{display:grid;grid-template-columns:1fr auto auto auto;gap:10px;margin-top:22px;}
.btn{border:none;border-radius:13px;font-family:inherit;font-size:.93rem;font-weight:700;
  cursor:pointer;outline:none;display:flex;align-items:center;
  justify-content:center;gap:7px;padding:13px 16px;}
.btn:active{transform:scale(.96);}
.btn-calc{background:linear-gradient(135deg,var(--c-p1),var(--c-p2));
  color:#fff;box-shadow:0 4px 18px rgba(79,70,229,.38);position:relative;overflow:hidden;}
.btn-calc::after{content:'';position:absolute;inset:0;background:rgba(255,255,255,0);
  transition:background .2s;}
.btn-calc:hover::after{background:rgba(255,255,255,.12);}
.btn-calc:hover{transform:translateY(-2px);box-shadow:0 8px 28px rgba(79,70,229,.45);}
.btn-save{background:linear-gradient(135deg,#059669,#10b981);
  color:#fff;box-shadow:0 4px 14px rgba(5,150,105,.30);white-space:nowrap;}
.btn-save:hover{opacity:.9;transform:translateY(-2px);box-shadow:0 8px 24px rgba(5,150,105,.4);}
.btn-save:disabled{opacity:.35;cursor:not-allowed;transform:none;}
.btn-pdf{background:linear-gradient(135deg,#dc2626,#ef4444);
  color:#fff;box-shadow:0 4px 14px rgba(220,38,38,.30);white-space:nowrap;}
.btn-pdf:hover{opacity:.9;transform:translateY(-2px);}
.btn-pdf:disabled{opacity:.35;cursor:not-allowed;transform:none;}
.btn-reset{background:var(--bg-soft);color:var(--c-p1);}
.btn-reset:hover{background:var(--bd-input);transform:translateY(-1px);}
.btn-add-subj{
  display:flex;align-items:center;justify-content:center;gap:8px;
  width:100%;padding:11px 16px;margin-top:14px;margin-bottom:2px;
  border:2px dashed var(--bd-base);border-radius:16px;
  background:transparent;font-family:inherit;font-size:.88rem;font-weight:700;
  color:var(--c-p1);cursor:pointer;
  transition:background .2s,border-color .2s,transform .15s,box-shadow .2s;}
.btn-add-subj:hover{
  background:var(--bg-soft);border-color:var(--c-p1);
  transform:translateY(-1px);box-shadow:var(--sh-sm);}
.btn-add-subj:active{transform:scale(.97);}
.asModal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);
  z-index:600;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
.asModal-overlay.open{display:flex;}
.asModal{background:var(--bg-card);border-radius:22px;padding:26px;width:340px;
  max-width:calc(100vw - 32px);box-shadow:var(--sh-lg);
  animation:slideUp .3s cubic-bezier(.22,1,.36,1);}
.asModal h3{font-size:.98rem;font-weight:800;color:var(--c-p1);margin-bottom:16px;}
.asModal label{font-size:.72rem;font-weight:700;color:var(--tx-2);
  text-transform:uppercase;letter-spacing:.06em;display:block;margin-bottom:6px;}
.asModal input{width:100%;padding:10px 13px;border:2px solid var(--bd-input);
  border-radius:12px;font-family:inherit;font-size:.94rem;font-weight:600;
  color:var(--tx-1);background:var(--bg-input);outline:none;margin-bottom:6px;}
.asModal input:focus{border-color:var(--c-p1);box-shadow:0 0 0 3px rgba(99,102,241,.13);}
.asModal-err{font-size:.78rem;font-weight:600;color:#f87171;
  min-height:18px;display:block;margin-bottom:10px;}
.asModal-btns{display:flex;gap:10px;justify-content:flex-end;margin-top:4px;}
.asModal-btns .btn-sp-add{padding:10px 20px;font-size:.88rem;}
.asModal-cancel{padding:10px 16px;border-radius:12px;border:1.5px solid var(--bd-base);
  background:var(--bg-soft);color:var(--c-p1);font-family:inherit;font-size:.88rem;
  font-weight:700;cursor:pointer;transition:background .15s;}
.asModal-cancel:hover{background:var(--bd-base);}
.toast{position:fixed;bottom:28px;right:24px;z-index:999;
  background:var(--tx-1);color:var(--bg-card);
  padding:12px 20px;border-radius:14px;font-size:.85rem;font-weight:600;
  box-shadow:0 8px 32px rgba(0,0,0,.3);display:flex;align-items:center;gap:8px;
  opacity:0;pointer-events:none;transform:translateY(12px);transition:opacity .3s,transform .3s;}
.toast.show{opacity:1;pointer-events:auto;transform:translateY(0);}
.result-wrap{display:none;margin-top:26px;}
.result-wrap.visible{display:block !important;animation:fadeSlide .45s cubic-bezier(.22,1,.36,1) both;}
@keyframes fadeSlide{from{opacity:0;transform:translateY(22px) scale(.98)}to{opacity:1;transform:translateY(0) scale(1)}}
.res-card{border-radius:22px;border:2px solid transparent;overflow:hidden;box-shadow:var(--sh-md);}
.res-card:hover{box-shadow:var(--sh-lg);}
.res-card.gioi{background:var(--g-bg);border-color:var(--g-bd)}
.res-card.kha {background:var(--k-bg);border-color:var(--k-bd)}
.res-card.tb  {background:var(--t-bg);border-color:var(--t-bd)}
.res-card.yeu {background:var(--y-bg);border-color:var(--y-bd)}
.res-inner{padding:22px 22px 20px;}
.res-top{display:flex;align-items:flex-start;justify-content:space-between;
  flex-wrap:wrap;gap:10px;margin-bottom:18px;}
.res-student{display:flex;align-items:center;gap:10px;}
.res-avatar{width:42px;height:42px;border-radius:11px;
  display:flex;align-items:center;justify-content:center;font-size:1.3rem;box-shadow:var(--sh-sm);flex-shrink:0;}
.gioi .res-avatar{background:var(--g-pill)}.kha .res-avatar{background:var(--k-pill)}
.tb   .res-avatar{background:var(--t-pill)}.yeu .res-avatar{background:var(--y-pill)}
.r-name{font-size:1.02rem;font-weight:800;color:var(--tx-1);}
.r-sub{font-size:.76rem;font-weight:500;color:var(--tx-2);margin-top:1px;}
.rank-pill{display:flex;align-items:center;gap:5px;padding:6px 14px;
  border-radius:999px;font-size:.86rem;font-weight:800;box-shadow:var(--sh-sm);white-space:nowrap;}
.gioi .rank-pill{background:var(--g-pill);color:#022c22}
.kha  .rank-pill{background:var(--k-pill);color:#1e3a8a}
.tb   .rank-pill{background:var(--t-pill);color:#451a03}
.yeu  .rank-pill{background:var(--y-pill);color:#fff}
.prog-section{margin-bottom:18px;padding:16px 18px 14px;
  border-radius:16px;background:var(--bg-prog);border:1px solid rgba(128,128,128,.12);}
.prog-header{display:flex;align-items:baseline;justify-content:space-between;margin-bottom:10px;}
.p-label{font-size:.76rem;font-weight:700;color:var(--tx-2);
  text-transform:uppercase;letter-spacing:.06em;}
.p-val{font-size:2rem;font-weight:900;line-height:1;}
.gioi .p-val{color:var(--g-tx)}.kha .p-val{color:var(--k-tx)}
.tb   .p-val{color:var(--t-tx)}.yeu .p-val{color:var(--y-tx)}
.scale-bar{position:relative;height:14px;border-radius:99px;margin-bottom:6px;}
.scale-track{position:absolute;inset:0;border-radius:99px;overflow:hidden;
  background:linear-gradient(90deg,#f87171 0%,#fbbf24 32%,#60a5fa 50%,#34d399 70%,#059669 100%);
  opacity:var(--scale-op);}
.scale-fill{position:absolute;top:0;left:0;height:100%;border-radius:99px;
  transition:width .7s cubic-bezier(.22,1,.36,1);box-shadow:0 2px 8px rgba(0,0,0,.18);}
.gioi .scale-fill{background:linear-gradient(90deg,#34d399,#6ee7b7)}
.kha  .scale-fill{background:linear-gradient(90deg,#60a5fa,#93c5fd)}
.tb   .scale-fill{background:linear-gradient(90deg,#fbbf24,#fde68a)}
.yeu  .scale-fill{background:linear-gradient(90deg,#f87171,#fca5a5)}
.scale-needle{position:absolute;top:-4px;width:4px;height:22px;border-radius:2px;
  background:var(--tx-1);box-shadow:0 2px 6px rgba(0,0,0,.25);transform:translateX(-50%);
  transition:left .7s cubic-bezier(.22,1,.36,1);}
.scale-ticks{display:flex;justify-content:space-between;font-size:.66rem;
  font-weight:600;color:var(--tx-3);padding:0 2px;}
.chart-section{margin-bottom:18px;padding:18px 18px 14px;border-radius:16px;
  background:var(--bg-prog);border:1px solid rgba(128,128,128,.12);animation:fadeIn .5s ease;}
.ch-label{font-size:.76rem;font-weight:700;color:var(--tx-2);
  text-transform:uppercase;letter-spacing:.06em;}
.chart-legend{display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin-bottom:12px;}
.leg-chip{display:flex;align-items:center;gap:5px;font-size:.7rem;font-weight:600;
  color:var(--tx-2);padding:3px 9px;border-radius:99px;background:var(--bg-rdtip);}
.leg-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.chart-wrap{position:relative;width:100%;max-width:380px;margin:0 auto;aspect-ratio:1/1;}
.chart-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:14px;}
.cstat{background:var(--bg-rdtip);border-radius:12px;padding:9px 10px;text-align:center;}
.cs-val{font-size:1.15rem;font-weight:900;color:var(--tx-1);}
.cs-lbl{font-size:.68rem;font-weight:600;color:var(--tx-3);margin-top:2px;}
.cs-hi{color:#059669!important;}.cs-lo{color:#dc2626!important;}
[data-theme="dark"] .cs-hi{color:#34d399!important;}
[data-theme="dark"] .cs-lo{color:#f87171!important;}
.rank-desc{border-radius:13px;padding:13px 15px;margin-bottom:16px;
  border:1px solid rgba(128,128,128,.12);background:var(--bg-desc);}
.rd-title{font-size:.76rem;font-weight:700;color:var(--tx-2);
  text-transform:uppercase;letter-spacing:.07em;margin-bottom:5px;}
.rd-text{font-size:.84rem;font-weight:500;line-height:1.55;color:var(--tx-1);}
.rd-tips{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px;}
.rd-tip{font-size:.73rem;font-weight:600;padding:4px 10px;border-radius:99px;
  background:var(--bg-rdtip);color:var(--tx-2);}
.score-tbl{width:100%;border-collapse:collapse;font-size:.84rem;}
.score-tbl th{padding:6px 10px;text-align:left;font-size:.71rem;font-weight:700;
  text-transform:uppercase;letter-spacing:.07em;color:var(--tx-2);
  border-bottom:1.5px solid rgba(128,128,128,.15);}
.score-tbl td{padding:8px 10px;border-bottom:1px solid rgba(128,128,128,.08);
  color:var(--tx-1);font-weight:500;}
.score-tbl td:last-child{text-align:right;font-weight:800;}
.score-tbl tbody tr:hover{background:var(--bg-tblhov);}
.score-tbl tr.ttl-row td{border-bottom:none;font-weight:900;font-size:.98rem;padding-top:11px;}
.sc-g{color:#059669}.sc-k{color:#2563eb}.sc-t{color:#d97706}.sc-y{color:#dc2626}
[data-theme="dark"] .sc-g{color:#34d399}[data-theme="dark"] .sc-k{color:#60a5fa}
[data-theme="dark"] .sc-t{color:#fbbf24}[data-theme="dark"] .sc-y{color:#f87171}
.tbl-ico{display:inline-flex;align-items:center;justify-content:center;
  width:20px;height:20px;border-radius:6px;background:rgba(128,128,128,.12);
  font-size:.72rem;margin-right:5px;}
.history-wrap{background:var(--bg-hist);border:2px solid var(--bd-base);
  border-radius:20px;padding:18px 18px 14px;margin-top:24px;display:none;animation:fadeIn .3s ease;}
.history-wrap.visible{display:block;}
.history-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:13px;}
.history-header h3{font-size:.85rem;font-weight:800;color:var(--c-p1);}
.btn-clear-hist{font-size:.72rem;font-weight:600;color:#f87171;
  background:none;border:none;cursor:pointer;padding:3px 8px;border-radius:7px;}
.btn-clear-hist:hover{background:var(--y-bg);}
.hist-row{display:flex;align-items:center;gap:10px;padding:9px 10px;
  border-radius:11px;background:var(--bg-histrow);border:1.5px solid var(--bd-base);
  margin-bottom:8px;cursor:pointer;}
.hist-row:hover{border-color:var(--c-p1);box-shadow:var(--sh-sm);transform:translateY(-1px);}
.hist-row:last-child{margin-bottom:0;}
.hist-rank-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.dot-gioi{background:#34d399}.dot-kha{background:#60a5fa}
.dot-tb{background:#fbbf24}.dot-yeu{background:#f87171}
.hist-name{font-size:.87rem;font-weight:700;flex:1;color:var(--tx-1);
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.hist-avg{font-size:.87rem;font-weight:800;margin-left:auto;margin-right:4px;}
.hist-lbl{font-size:.72rem;font-weight:700;padding:3px 10px;border-radius:99px;}
.hist-lbl.gioi{background:var(--g-bg);color:var(--g-tx)}
.hist-lbl.kha {background:var(--k-bg);color:var(--k-tx)}
.hist-lbl.tb  {background:var(--t-bg);color:var(--t-tx)}
.hist-lbl.yeu {background:var(--y-bg);color:var(--y-tx)}
.hist-del{background:none;border:none;cursor:pointer;font-size:.85rem;
  color:var(--tx-3);padding:3px 5px;border-radius:6px;flex-shrink:0;}
.hist-del:hover{color:#f87171;background:var(--y-bg);}
.hist-date{font-size:.68rem;color:var(--tx-3);font-weight:500;white-space:nowrap;}
.pg-foot{margin-top:30px;font-size:.72rem;color:var(--tx-3);text-align:center;font-weight:500;}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.sp-section{display:none;animation:fadeIn .3s ease;}
.sp-section.active{display:block;}
.sp-form{
  background:var(--bg-glass);
  backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
  border:1.5px solid var(--bd-glass);
  border-radius:20px;padding:20px;margin-bottom:22px;
  box-shadow:0 4px 24px rgba(99,102,241,.08);}
.sp-form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px;}
@media(max-width:580px){.sp-form-grid{grid-template-columns:1fr;}}
.sp-field{display:flex;flex-direction:column;gap:5px;}
.sp-field label{font-size:.72rem;font-weight:700;color:var(--tx-2);
  text-transform:uppercase;letter-spacing:.06em;}
.sp-inp{width:100%;padding:9px 13px;border:1.5px solid var(--bd-input);
  border-radius:11px;font-family:inherit;font-size:.9rem;font-weight:500;
  color:var(--tx-1);background:var(--bg-card);outline:none;
  transition:border-color .2s,box-shadow .2s;}
.sp-inp:focus{border-color:var(--c-p1);box-shadow:0 0 0 3px rgba(99,102,241,.12);}
.sp-inp::placeholder{color:var(--tx-3);}
.sp-inp option{background:var(--bg-card);color:var(--tx-1);}
.btn-sp-add{
  background:linear-gradient(135deg,var(--c-p1),var(--c-p2));
  color:#fff;border:none;border-radius:12px;padding:11px 22px;
  font-family:inherit;font-size:.9rem;font-weight:700;cursor:pointer;
  display:flex;align-items:center;gap:7px;
  box-shadow:0 4px 14px rgba(79,70,229,.32);
  transition:opacity .2s,transform .15s,box-shadow .2s;}
.btn-sp-add:hover{opacity:.92;transform:translateY(-2px);box-shadow:0 8px 22px rgba(79,70,229,.42);}
.btn-sp-add:active{transform:scale(.96);}
.sp-stats{display:flex;gap:10px;margin-bottom:18px;flex-wrap:wrap;}
.sp-stat{flex:1;min-width:90px;background:var(--bg-subj);border:1.5px solid var(--bd-base);
  border-radius:14px;padding:12px 14px;text-align:center;
  transition:transform .2s,box-shadow .2s;}
.sp-stat:hover{transform:translateY(-2px);box-shadow:var(--sh-sm);}
.sp-stat-val{font-size:1.5rem;font-weight:900;color:var(--c-p1);}
.sp-stat-lbl{font-size:.68rem;font-weight:600;color:var(--tx-3);margin-top:2px;}
.sp-filter{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;}
.sp-filter-btn{padding:5px 14px;border-radius:99px;border:1.5px solid var(--bd-base);
  background:var(--bg-card);font-family:inherit;font-size:.75rem;font-weight:700;
  color:var(--tx-3);cursor:pointer;transition:background .15s,color .15s,border-color .15s,transform .1s;}
.sp-filter-btn:hover{border-color:var(--c-p1);color:var(--c-p1);transform:translateY(-1px);}
.sp-filter-btn.active{background:var(--c-p1);color:#fff;border-color:var(--c-p1);}
.sp-task-list{display:flex;flex-direction:column;gap:10px;}
.sp-empty{text-align:center;padding:36px 20px;color:var(--tx-3);font-size:.88rem;font-weight:500;}
.sp-empty .sp-empty-ico{font-size:2.5rem;display:block;margin-bottom:10px;}
.sp-task{display:flex;align-items:flex-start;gap:12px;padding:14px 16px;
  background:var(--bg-histrow);border:1.5px solid var(--bd-base);
  border-radius:16px;transition:border-color .2s,box-shadow .2s,opacity .25s,transform .2s;}
.sp-task:hover{border-color:var(--c-p1);box-shadow:var(--sh-sm);transform:translateY(-1px);}
.sp-task.done{opacity:.48;}
.sp-task.done .sp-task-title{text-decoration:line-through;color:var(--tx-3);}
.sp-task.task-enter{animation:taskSlideIn .3s cubic-bezier(.22,1,.36,1) both;}
@keyframes taskSlideIn{from{opacity:0;transform:translateY(-10px) scale(.97)}to{opacity:1;transform:none}}
.sp-task.task-exit{animation:taskSlideOut .25s ease both;}
@keyframes taskSlideOut{to{opacity:0;transform:translateX(20px) scale(.95)}}
.sp-cb{width:20px;height:20px;border-radius:6px;border:2px solid var(--bd-base);
  background:var(--bg-card);cursor:pointer;flex-shrink:0;margin-top:1px;
  display:flex;align-items:center;justify-content:center;font-size:.8rem;
  transition:background .15s,border-color .15s,transform .15s;}
.sp-cb:hover{border-color:var(--c-p1);transform:scale(1.1);}
.sp-cb.checked{background:var(--c-p1);border-color:var(--c-p1);color:#fff;
  animation:checkPop .25s cubic-bezier(.22,1,.36,1);}
@keyframes checkPop{0%{transform:scale(0.7)}60%{transform:scale(1.2)}100%{transform:scale(1)}}
.sp-task-body{flex:1;min-width:0;}
.sp-task-top{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:4px;}
.sp-task-subj{font-size:.72rem;font-weight:800;padding:2px 9px;border-radius:99px;
  background:var(--bg-soft);color:var(--c-p1);}
.sp-task-title{font-size:.9rem;font-weight:700;color:var(--tx-1);}
.sp-task-meta{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.sp-deadline{font-size:.72rem;font-weight:600;color:var(--tx-3);display:flex;align-items:center;gap:4px;}
.sp-deadline.overdue{color:#f87171;}
.sp-deadline.today{color:#f59e0b;}
.sp-task-del{background:none;border:none;cursor:pointer;font-size:.85rem;
  color:var(--tx-3);padding:4px 6px;border-radius:7px;flex-shrink:0;transition:color .15s,background .15s,transform .1s;}
.sp-task-del:hover{color:#f87171;background:var(--y-bg);transform:scale(1.1);}
.sp-streak-box{display:flex;align-items:center;justify-content:space-between;
  gap:12px;flex-wrap:wrap;
  background:linear-gradient(135deg,rgba(79,70,229,.10),rgba(124,58,237,.10));
  border:1.5px solid var(--bd-base);border-radius:18px;
  padding:14px 18px;margin-bottom:16px;}
.streak-left{display:flex;align-items:center;gap:10px;}
.streak-flame{font-size:2rem;line-height:1;
  filter:drop-shadow(0 2px 6px rgba(249,115,22,.5));
  animation:pulse-flame 1.8s ease-in-out infinite;}
@keyframes pulse-flame{0%,100%{transform:scale(1)}50%{transform:scale(1.12)}}
.streak-info{}
.streak-label{font-size:.68rem;font-weight:700;text-transform:uppercase;
  letter-spacing:.07em;color:var(--tx-3);margin-bottom:2px;}
.streak-count{font-size:1.6rem;font-weight:900;color:var(--c-p1);line-height:1;}
.streak-count span{font-size:.85rem;font-weight:600;color:var(--tx-2);margin-left:3px;}
.streak-badge{font-size:.73rem;font-weight:700;padding:4px 12px;border-radius:99px;
  background:linear-gradient(135deg,#f97316,#ef4444);color:#fff;
  box-shadow:0 2px 8px rgba(249,115,22,.4);white-space:nowrap;align-self:center;}
.sp-heatmap{background:var(--bg-subj);border:1.5px solid var(--bd-base);
  border-radius:18px;padding:14px 18px;margin-bottom:18px;}
.heatmap-title{font-size:.68rem;font-weight:700;text-transform:uppercase;
  letter-spacing:.07em;color:var(--tx-3);margin-bottom:10px;}
.heatmap-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;}
.hm-day{display:flex;flex-direction:column;align-items:center;gap:4px;}
.hm-label{font-size:.62rem;font-weight:700;color:var(--tx-3);text-transform:uppercase;}
.hm-cell{width:100%;aspect-ratio:1/1;border-radius:8px;
  display:flex;align-items:center;justify-content:center;
  font-size:.65rem;font-weight:800;transition:transform .15s;}
.hm-cell:hover{transform:scale(1.15);}
.hm-cell.hm-empty{background:var(--bg-rdtip);color:var(--tx-3);}
.hm-cell.hm-done{background:linear-gradient(135deg,#34d399,#059669);
  color:#fff;box-shadow:0 2px 6px rgba(5,150,105,.35);}
.hm-cell.hm-today{outline:2px solid var(--c-p1);outline-offset:2px;}
.tt-list{display:flex;flex-direction:column;gap:8px;margin-bottom:10px;}
.tt-item{display:flex;align-items:center;gap:10px;padding:11px 14px;
  background:var(--bg-histrow);border:1.5px solid var(--bd-base);
  border-radius:14px;transition:border-color .2s,box-shadow .2s,transform .2s;}
.tt-item:hover{border-color:var(--c-p1);box-shadow:var(--sh-sm);}
.tt-item.tt-enter{animation:taskSlideIn .3s cubic-bezier(.22,1,.36,1) both;}
.tt-item.tt-exit {animation:taskSlideOut .25s ease both;}
.tt-item.tt-today-item{border-color:var(--c-p1);background:var(--bg-soft);}
.tt-day-badge{font-size:.72rem;font-weight:800;padding:3px 10px;border-radius:99px;
  background:var(--bg-soft);color:var(--c-p1);white-space:nowrap;flex-shrink:0;}
.tt-day-badge.tt-today{background:var(--c-p1);color:#fff;}
.tt-subj{font-size:.88rem;font-weight:700;flex:1;color:var(--tx-1);}
.tt-time{font-size:.78rem;font-weight:600;color:var(--tx-2);white-space:nowrap;}
.tt-conflict{font-size:.65rem;font-weight:700;color:#f87171;
  background:var(--y-bg);border-radius:6px;padding:1px 6px;margin-left:4px;}
.tt-actions-row{display:flex;gap:6px;flex-shrink:0;}
.tt-btn{background:none;border:1.5px solid var(--bd-base);cursor:pointer;
  font-size:.78rem;padding:4px 9px;border-radius:8px;font-family:inherit;
  font-weight:600;color:var(--tx-2);transition:background .15s,color .15s,transform .1s;}
.tt-btn:hover{transform:scale(1.05);}
.tt-btn.edit{color:var(--c-p1);border-color:var(--c-p1);}
.tt-btn.edit:hover{background:var(--bg-soft);}
.tt-btn.del{color:#f87171;border-color:#f87171;}
.tt-btn.del:hover{background:var(--y-bg);}
.tt-empty{text-align:center;padding:20px;color:var(--tx-3);font-size:.85rem;font-weight:500;}
.tt-time-group{display:flex;gap:6px;align-items:center;}
.tt-time-inp{
  width:88px;padding:9px 10px;border:1.5px solid var(--bd-input);
  border-radius:11px;font-family:inherit;font-size:.9rem;font-weight:700;
  color:var(--tx-1);background:var(--bg-card);outline:none;
  text-align:center;letter-spacing:.07em;
  transition:border-color .2s,box-shadow .2s;}
.tt-time-inp:focus{border-color:var(--c-p1);box-shadow:0 0 0 3px rgba(99,102,241,.12);}
.tt-time-inp.err{border-color:#f87171;background:#fff5f5;}
[data-theme="dark"] .tt-time-inp.err{background:#2d1010;}
.tt-time-inp::placeholder{color:var(--tx-3);font-weight:400;}
.tt-modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);
  z-index:500;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
.tt-modal-overlay.open{display:flex;}
.tt-modal{background:var(--bg-card);border-radius:22px;padding:24px;width:360px;
  max-width:calc(100vw - 32px);box-shadow:var(--sh-lg);animation:slideUp .3s cubic-bezier(.22,1,.36,1);}
.tt-modal h3{font-size:.95rem;font-weight:800;color:var(--c-p1);margin-bottom:16px;}
.tt-modal .sp-form-grid{margin-bottom:16px;}
.tt-modal-btns{display:flex;gap:10px;justify-content:flex-end;}
.tt-modal-btns .btn-sp-add{padding:9px 18px;font-size:.85rem;}
.btn-modal-cancel{padding:9px 16px;border-radius:12px;border:1.5px solid var(--bd-base);
  background:var(--bg-soft);color:var(--c-p1);font-family:inherit;font-size:.85rem;
  font-weight:700;cursor:pointer;transition:background .15s;}
.btn-modal-cancel:hover{background:var(--bd-base);}
.pomo-wrap{background:var(--bg-subj);border:2px solid var(--bd-base);
  border-radius:20px;padding:20px;margin-bottom:22px;}
.pomo-config{display:grid;grid-template-columns:2fr 1fr 1fr;gap:12px;margin-bottom:18px;}
@media(max-width:580px){.pomo-config{grid-template-columns:1fr 1fr;}}
.pomo-display{
  display:flex;flex-direction:column;align-items:center;gap:0;
  margin-bottom:18px;position:relative;min-height:180px;}
.pomo-ring-wrap{position:absolute;top:50%;left:50%;
  transform:translate(-50%,-50%);width:140px;height:140px;pointer-events:none;z-index:0;}
.pomo-ring{width:140px;height:140px;transform:rotate(-90deg);}
.pomo-ring-bg{fill:none;stroke:var(--bd-base);stroke-width:6;}
.pomo-ring-fill{fill:none;stroke:var(--c-p1);stroke-width:6;
  stroke-linecap:round;transition:stroke-dashoffset .9s linear,stroke .4s;}
.pomo-phase{font-size:.72rem;font-weight:800;text-transform:uppercase;letter-spacing:.1em;
  color:var(--tx-3);margin-bottom:0;margin-top:8px;z-index:1;position:relative;}
.pomo-clock{font-size:3rem;font-weight:900;color:var(--tx-1);letter-spacing:-.03em;
  font-variant-numeric:tabular-nums;line-height:1;z-index:1;position:relative;
  width:140px;height:140px;display:flex;align-items:center;justify-content:center;margin-top:4px;}
.pomo-btns{display:flex;gap:10px;margin-top:8px;z-index:1;position:relative;}
.pomo-btn{border:none;border-radius:12px;font-family:inherit;font-size:.88rem;font-weight:700;
  cursor:pointer;padding:10px 20px;transition:opacity .2s,transform .15s,box-shadow .2s;}
.pomo-btn:active{transform:scale(.95);}
.pomo-start{background:linear-gradient(135deg,var(--c-p1),var(--c-p2));color:#fff;
  box-shadow:0 4px 14px rgba(79,70,229,.35);}
.pomo-start:hover{box-shadow:0 8px 22px rgba(79,70,229,.5);transform:translateY(-2px);}
.pomo-pause{background:linear-gradient(135deg,#f59e0b,#f97316);color:#fff;
  box-shadow:0 4px 14px rgba(245,158,11,.35);}
.pomo-reset{background:var(--bg-soft);color:var(--c-p1);}
.pomo-btn:hover{opacity:.88;}
.pomo-ring-fill.phase-break{stroke:#34d399;}
.pomo-ring-fill.phase-ready{stroke:var(--c-p1);}
.pomo-sound-bar{display:flex;align-items:center;gap:10px;flex-wrap:wrap;
  margin-bottom:16px;padding:10px 14px;border-radius:12px;
  background:var(--bg-prog);border:1px solid rgba(128,128,128,.1);}
.sound-toggle{display:flex;align-items:center;gap:6px;cursor:pointer;
  font-size:.8rem;font-weight:700;color:var(--tx-2);user-select:none;}
.sound-icon{font-size:1.1rem;}
.sound-select{padding:5px 10px;border:1.5px solid var(--bd-input);
  border-radius:9px;font-family:inherit;font-size:.78rem;font-weight:600;
  color:var(--tx-1);background:var(--bg-card);cursor:pointer;outline:none;}
.sound-select:focus{border-color:var(--c-p1);}
.sound-vol{-webkit-appearance:none;width:90px;height:4px;border-radius:2px;
  background:var(--bd-base);outline:none;cursor:pointer;}
.sound-vol::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;
  border-radius:50%;background:var(--c-p1);cursor:pointer;}
.pomo-stats{display:flex;gap:10px;flex-wrap:wrap;}
.analytics-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;margin-bottom:22px;}
@media(max-width:580px){.analytics-grid{grid-template-columns:1fr;}}
.an-card{background:var(--bg-glass);backdrop-filter:blur(10px);
  border:1.5px solid var(--bd-glass);border-radius:18px;padding:16px 18px;
  box-shadow:var(--sh-sm);transition:transform .2s,box-shadow .2s;}
.an-card:hover{transform:translateY(-2px);box-shadow:var(--sh-md);}
.an-card-wide{grid-column:1/-1;}
.an-title{font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;
  color:var(--tx-3);margin-bottom:10px;}
.an-val{font-size:2rem;font-weight:900;color:var(--c-p1);line-height:1;}
.an-sub{font-size:.75rem;color:var(--tx-2);margin-top:4px;font-weight:500;}
.an-compare{display:flex;align-items:center;gap:5px;font-size:.72rem;font-weight:700;margin-top:6px;}
.an-compare.up{color:#059669;}.an-compare.down{color:#dc2626;}.an-compare.same{color:var(--tx-3);}
.prog-circle-wrap{display:flex;flex-direction:column;align-items:center;gap:8px;}
.prog-circle-svg{transform:rotate(-90deg);}
.prog-circle-bg{fill:none;stroke:var(--bd-base);stroke-width:8;}
.prog-circle-fill{fill:none;stroke:var(--c-p1);stroke-width:8;stroke-linecap:round;
  transition:stroke-dashoffset 1s cubic-bezier(.22,1,.36,1);}
.hm30-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;}
.hm30-cell{width:100%;aspect-ratio:1/1;border-radius:5px;
  background:var(--bg-rdtip);transition:transform .15s;}
.hm30-cell:hover{transform:scale(1.2);}
.hm30-cell.l1{background:rgba(99,102,241,.25);}
.hm30-cell.l2{background:rgba(99,102,241,.50);}
.hm30-cell.l3{background:rgba(99,102,241,.75);}
.hm30-cell.l4{background:rgba(99,102,241,1);}
.hm30-cell.hm-today{outline:2px solid var(--c-acc);outline-offset:1px;}
.an-chart-wrap{position:relative;width:100%;height:160px;}
.shimmer{background:linear-gradient(90deg,var(--shimmer-1) 25%,var(--shimmer-2) 50%,var(--shimmer-1) 75%);
  background-size:200% 100%;animation:shimmerAnim 1.4s infinite;}
@keyframes shimmerAnim{0%{background-position:200% 0}100%{background-position:-200% 0}}
@media(max-width:600px){
  .card-body{padding:18px 14px 24px;}
  .actions{grid-template-columns:1fr 1fr;grid-template-rows:auto auto;}
  .btn-calc{grid-column:1/-1;}
  .dm-toggle{top:12px;right:12px;width:42px;height:42px;font-size:1.1rem;}
  .tab-btn{font-size:.73rem;padding:9px 6px;gap:4px;}
  .analytics-grid{grid-template-columns:1fr;}
  .pomo-config{grid-template-columns:1fr 1fr;}
  .pomo-sound-bar{flex-direction:column;align-items:flex-start;}
}
.ai-block{
  background:var(--bg-glass);
  backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
  border:1.5px solid var(--bd-glass);
  border-radius:20px;padding:20px 22px;margin-bottom:20px;
  box-shadow:0 4px 24px rgba(99,102,241,.08);
  animation:fadeIn .35s ease;}
.ai-block-title{
  display:flex;align-items:center;gap:9px;
  font-size:.88rem;font-weight:800;color:var(--c-p1);
  margin-bottom:16px;padding-bottom:12px;
  border-bottom:1.5px solid var(--bd-base);}
.ai-block-title .ai-ico{font-size:1.3rem;}
.ai-no-data{
  text-align:center;padding:24px 16px;
  background:var(--bg-rdtip);border-radius:14px;
  font-size:.85rem;color:var(--tx-3);font-weight:500;}
.ai-no-data .ai-nd-ico{font-size:2rem;display:block;margin-bottom:8px;}
.ai-stat-row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px;}
@media(max-width:560px){.ai-stat-row{grid-template-columns:1fr 1fr;}}
.ai-stat{
  background:var(--bg-subj);border:1.5px solid var(--bd-base);
  border-radius:14px;padding:11px 13px;text-align:center;
  transition:transform .2s,box-shadow .2s;}
.ai-stat:hover{transform:translateY(-2px);box-shadow:var(--sh-sm);}
.ai-stat-val{font-size:1.3rem;font-weight:900;color:var(--c-p1);}
.ai-stat-lbl{font-size:.66rem;font-weight:600;color:var(--tx-3);margin-top:3px;}
.ai-summary{
  background:var(--bg-prog);border:1px solid rgba(128,128,128,.12);
  border-radius:14px;padding:13px 15px;margin-bottom:14px;
  font-size:.85rem;line-height:1.6;color:var(--tx-1);font-weight:500;}
.ai-tips-list{display:flex;flex-direction:column;gap:9px;}
.ai-tip{
  display:flex;align-items:flex-start;gap:10px;
  background:var(--bg-histrow);border:1.5px solid var(--bd-base);
  border-radius:13px;padding:11px 14px;
  font-size:.84rem;color:var(--tx-1);font-weight:500;line-height:1.5;}
.ai-tip-num{
  width:22px;height:22px;border-radius:7px;flex-shrink:0;
  background:linear-gradient(135deg,var(--c-p1),var(--c-p2));
  color:#fff;font-size:.72rem;font-weight:900;
  display:flex;align-items:center;justify-content:center;margin-top:1px;}
.ai-plan-grid{display:flex;flex-direction:column;gap:8px;margin-bottom:14px;}
.ai-plan-item{
  display:flex;align-items:center;gap:10px;
  padding:10px 14px;background:var(--bg-histrow);
  border:1.5px solid var(--bd-base);border-radius:13px;
  font-size:.84rem;color:var(--tx-1);font-weight:500;
  animation:taskSlideIn .25s ease both;}
.ai-plan-day{
  min-width:52px;font-size:.7rem;font-weight:800;
  color:var(--c-p1);background:var(--bg-soft);
  padding:2px 8px;border-radius:99px;text-align:center;flex-shrink:0;}
.ai-plan-subj{
  font-size:.7rem;font-weight:700;padding:2px 8px;border-radius:99px;
  background:rgba(99,102,241,.12);color:var(--c-p2);flex-shrink:0;}
.ai-plan-title{flex:1;}
.btn-ai-push{
  display:flex;align-items:center;gap:7px;justify-content:center;
  background:linear-gradient(135deg,#059669,#10b981);
  color:#fff;border:none;border-radius:12px;
  padding:11px 22px;font-family:inherit;font-size:.9rem;font-weight:700;
  cursor:pointer;box-shadow:0 4px 14px rgba(5,150,105,.30);
  transition:opacity .2s,transform .15s,box-shadow .2s;}
.btn-ai-push:hover{opacity:.92;transform:translateY(-2px);box-shadow:0 8px 22px rgba(5,150,105,.4);}
.btn-ai-push:disabled{opacity:.35;cursor:not-allowed;transform:none;}
.ai-test-select-row{
  display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:16px;}
.ai-test-select-row select{
  flex:1;min-width:140px;padding:9px 13px;
  border:1.5px solid var(--bd-input);border-radius:11px;
  font-family:inherit;font-size:.9rem;font-weight:500;
  color:var(--tx-1);background:var(--bg-card);outline:none;
  transition:border-color .2s;}
.ai-test-select-row select:focus{border-color:var(--c-p1);}
.btn-ai-gen{
  background:linear-gradient(135deg,var(--c-p1),var(--c-p2));
  color:#fff;border:none;border-radius:12px;padding:10px 20px;
  font-family:inherit;font-size:.88rem;font-weight:700;cursor:pointer;
  box-shadow:0 4px 14px rgba(79,70,229,.32);white-space:nowrap;
  transition:opacity .2s,transform .15s;}
.btn-ai-gen:hover{opacity:.92;transform:translateY(-2px);}
.btn-ai-gen:disabled{opacity:.4;cursor:not-allowed;transform:none;}
.ai-quiz-wrap{display:flex;flex-direction:column;gap:14px;}
.ai-q{
  background:var(--bg-subj);border:1.5px solid var(--bd-base);
  border-radius:16px;padding:14px 16px;
  animation:taskSlideIn .3s cubic-bezier(.22,1,.36,1) both;}
.ai-q-num{font-size:.68rem;font-weight:800;color:var(--tx-3);
  text-transform:uppercase;letter-spacing:.07em;margin-bottom:5px;}
.ai-q-text{font-size:.9rem;font-weight:700;color:var(--tx-1);
  line-height:1.5;margin-bottom:10px;}
.ai-opts{display:flex;flex-direction:column;gap:6px;}
.ai-opt{
  display:flex;align-items:center;gap:9px;padding:8px 12px;
  background:var(--bg-card);border:1.5px solid var(--bd-base);
  border-radius:10px;cursor:pointer;font-size:.84rem;font-weight:500;
  color:var(--tx-1);transition:border-color .2s,background .2s,transform .1s;
  user-select:none;}
.ai-opt:hover{border-color:var(--c-p1);background:var(--bg-soft);}
.ai-opt.selected{border-color:var(--c-p1);background:var(--bg-soft);font-weight:700;}
.ai-opt.correct{border-color:#34d399;background:var(--g-bg);color:var(--g-tx);font-weight:700;}
.ai-opt.wrong{border-color:#f87171;background:var(--y-bg);color:var(--y-tx);}
.ai-opt-dot{
  width:16px;height:16px;border-radius:50%;border:2px solid var(--bd-base);
  flex-shrink:0;transition:background .2s,border-color .2s;}
.ai-opt.selected .ai-opt-dot{background:var(--c-p1);border-color:var(--c-p1);}
.ai-opt.correct .ai-opt-dot{background:#34d399;border-color:#34d399;}
.ai-opt.wrong .ai-opt-dot{background:#f87171;border-color:#f87171;}
.ai-q-explain{
  margin-top:9px;padding:9px 12px;border-radius:10px;
  background:var(--bg-rdtip);font-size:.8rem;
  font-weight:500;color:var(--tx-2);line-height:1.5;display:none;}
.ai-q-explain.show{display:block;animation:fadeIn .25s ease;}
.ai-test-actions{
  display:flex;align-items:center;gap:10px;margin-top:16px;flex-wrap:wrap;}
.btn-ai-submit{
  background:linear-gradient(135deg,#f59e0b,#f97316);
  color:#fff;border:none;border-radius:12px;padding:11px 22px;
  font-family:inherit;font-size:.9rem;font-weight:700;cursor:pointer;
  box-shadow:0 4px 14px rgba(245,158,11,.30);
  transition:opacity .2s,transform .15s;}
.btn-ai-submit:hover{opacity:.92;transform:translateY(-2px);}
.btn-ai-retry{
  background:var(--bg-soft);color:var(--c-p1);border:1.5px solid var(--bd-base);
  border-radius:12px;padding:11px 18px;font-family:inherit;
  font-size:.9rem;font-weight:700;cursor:pointer;
  transition:background .15s,transform .1s;}
.btn-ai-retry:hover{background:var(--bd-base);transform:translateY(-1px);}
.ai-score-banner{
  display:none;background:var(--bg-prog);
  border:1.5px solid var(--bd-base);border-radius:14px;
  padding:14px 18px;text-align:center;
  font-size:1rem;font-weight:700;color:var(--tx-1);}
.ai-score-banner.show{display:block;animation:fadeSlide .4s ease;}
.ai-score-banner .ai-score-big{
  font-size:2.4rem;font-weight:900;color:var(--c-p1);display:block;margin:4px 0;}
.ai-loading{
  display:flex;align-items:center;gap:10px;padding:14px 16px;
  background:var(--bg-soft);border-radius:13px;
  font-size:.85rem;font-weight:600;color:var(--c-p1);}
.ai-loading-dots{display:flex;gap:4px;}
.ai-loading-dots span{width:7px;height:7px;border-radius:50%;background:var(--c-p1);
  animation:dotBounce 1.2s infinite ease-in-out;}
.ai-loading-dots span:nth-child(2){animation-delay:.2s;}
.ai-loading-dots span:nth-child(3){animation-delay:.4s;}
@keyframes dotBounce{0%,80%,100%{transform:scale(.6);opacity:.5}40%{transform:scale(1);opacity:1}}
.ai-gemini-resp{
  background:var(--bg-prog);border:1px solid rgba(128,128,128,.12);
  border-radius:14px;padding:14px 16px;
  font-size:.85rem;line-height:1.7;color:var(--tx-1);font-weight:500;
  white-space:pre-wrap;word-break:break-word;}
.ai-api-key-block{
  background:var(--bg-subj);border:1.5px solid var(--bd-base);
  border-radius:16px;padding:16px 18px;margin-bottom:18px;}
.ai-api-key-block label{
  font-size:.7rem;font-weight:700;text-transform:uppercase;
  letter-spacing:.07em;color:var(--tx-3);display:block;margin-bottom:7px;}
.ai-api-key-row{display:flex;gap:8px;align-items:center;}
.ai-api-key-inp{
  flex:1;padding:9px 13px;border:1.5px solid var(--bd-input);
  border-radius:11px;font-family:inherit;font-size:.85rem;
  color:var(--tx-1);background:var(--bg-card);outline:none;
  transition:border-color .2s;}
.ai-api-key-inp:focus{border-color:var(--c-p1);box-shadow:0 0 0 3px rgba(99,102,241,.12);}
.btn-key-save{
  background:linear-gradient(135deg,var(--c-p1),var(--c-p2));
  color:#fff;border:none;border-radius:10px;padding:9px 16px;
  font-family:inherit;font-size:.82rem;font-weight:700;cursor:pointer;
  white-space:nowrap;transition:opacity .2s,transform .15s;}
.btn-key-save:hover{opacity:.9;transform:translateY(-1px);}
.ai-key-status{font-size:.72rem;font-weight:600;margin-top:6px;}
.ai-key-status.ok{color:#059669;}
.ai-key-status.missing{color:#f87171;}
.ai-profile-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:4px;}
@media(max-width:560px){.ai-profile-grid{grid-template-columns:1fr;}}
.ai-chat-wrap{display:flex;flex-direction:column;gap:0;}
.ai-chat-box{
  min-height:200px;max-height:340px;overflow-y:auto;
  background:var(--bg-subj);border:1.5px solid var(--bd-base);
  border-radius:14px;padding:14px;margin-bottom:10px;
  display:flex;flex-direction:column;gap:10px;}
.chat-msg{display:flex;gap:8px;align-items:flex-start;animation:fadeIn .25s ease;}
.chat-msg.user{flex-direction:row-reverse;}
.chat-bubble{
  max-width:78%;padding:9px 13px;border-radius:14px;
  font-size:.84rem;line-height:1.55;font-weight:500;
  white-space:pre-wrap;word-break:break-word;}
.chat-msg.user .chat-bubble{
  background:linear-gradient(135deg,var(--c-p1),var(--c-p2));
  color:#fff;border-radius:14px 14px 4px 14px;}
.chat-msg.ai .chat-bubble{
  background:var(--bg-prog);color:var(--tx-1);
  border:1px solid var(--bd-base);border-radius:14px 14px 14px 4px;}
.chat-avatar{width:28px;height:28px;border-radius:8px;flex-shrink:0;
  display:flex;align-items:center;justify-content:center;font-size:.9rem;
  background:var(--bg-soft);}
.chat-input-row{display:flex;gap:8px;align-items:flex-end;}
.chat-textarea{
  flex:1;padding:10px 13px;border:1.5px solid var(--bd-input);
  border-radius:12px;font-family:inherit;font-size:.88rem;
  color:var(--tx-1);background:var(--bg-card);outline:none;
  resize:none;min-height:44px;max-height:120px;
  transition:border-color .2s,box-shadow .2s;line-height:1.5;}
.chat-textarea:focus{border-color:var(--c-p1);box-shadow:0 0 0 3px rgba(99,102,241,.12);}
.btn-chat-send{
  background:linear-gradient(135deg,var(--c-p1),var(--c-p2));
  color:#fff;border:none;border-radius:12px;padding:11px 18px;
  font-family:inherit;font-size:.9rem;font-weight:700;cursor:pointer;
  white-space:nowrap;box-shadow:0 4px 14px rgba(79,70,229,.32);
  transition:opacity .2s,transform .15s;}
.btn-chat-send:hover{opacity:.9;transform:translateY(-1px);}
.btn-chat-send:disabled{opacity:.4;cursor:not-allowed;transform:none;}
.btn-chat-clear{
  background:var(--bg-soft);color:var(--tx-3);border:1.5px solid var(--bd-base);
  border-radius:10px;padding:8px 12px;font-family:inherit;font-size:.75rem;
  font-weight:700;cursor:pointer;margin-top:7px;align-self:flex-start;
  transition:background .15s,color .15s;}
.btn-chat-clear:hover{background:var(--y-bg);color:#f87171;}
</style>
</head>
<body>

<button class="dm-toggle" id="dmBtn" data-ico="" onclick="toggleDark()"></button>

<header class="pg-head">
  <span class="crown"></span>
  <h1>Study System <span class="pro-badge">PRO</span></h1>
  <p>Bng im  Study Planner  Analytics  Pomodoro Pro  AI Gemini</p>
</header>

<div class="tab-bar">
  <button class="tab-btn active" id="tab-grade"     onclick="switchTab('grade')"> Hc lc</button>
  <button class="tab-btn"        id="tab-planner"   onclick="switchTab('planner')"> Planner</button>
  <button class="tab-btn"        id="tab-analytics" onclick="switchTab('analytics')"> Analytics</button>
  <button class="tab-btn"        id="tab-ai"        onclick="switchTab('ai')"> AI</button>
</div>

<div class="card">
  <div class="card-stripe"></div>
  <div class="card-body">

    <!-- TAB: GRADE -->
    <div id="sec-grade">
      <p class="sec-lbl"> Thng tin hc sinh</p>
      <div class="name-field">
        <div class="fi">
          <span class="fi-ico"></span>
          <input type="text" id="tenHS" placeholder="Nhp h v tn hc sinh" maxlength="60"/>
        </div>
      </div>
      <p class="sec-lbl"> im cc mn hc</p>
      <div class="mon-list" id="monList"></div>
      <button class="btn-add-subj" onclick="openAddSubjModal()"> Thm mn hc khc</button>
      <div class="g-err" id="gErr"></div>
      <div class="actions">
        <button class="btn btn-calc"  onclick="tinhKQ()"> Tnh kt qu</button>
        <button class="btn btn-save"  id="btnSave" onclick="luuKQ()"   disabled> Lu</button>
        <button class="btn btn-pdf"   id="btnPdf"  onclick="xuatPDF()" disabled> PDF</button>
        <button class="btn btn-reset" onclick="nhapLai()"> Nhp li</button>
      </div>
      <div class="result-wrap" id="resWrap">
        <div class="res-card" id="resCard">
          <div class="res-inner">
            <div class="res-top">
              <div class="res-student">
                <div class="res-avatar" id="rAvatar"></div>
                <div>
                  <div class="r-name" id="rName"></div>
                  <div class="r-sub">Kt qu hc k</div>
                </div>
              </div>
              <div class="rank-pill" id="rPill"></div>
            </div>
            <div class="prog-section">
              <div class="prog-header">
                <span class="p-label"> im trung bnh c nm</span>
                <span class="p-val" id="rAvg"></span>
              </div>
              <div class="scale-bar">
                <div class="scale-track"></div>
                <div class="scale-fill"   id="rScaleFill" style="width:0%"></div>
                <div class="scale-needle" id="rNeedle"    style="left:0%"></div>
              </div>
              <div class="scale-ticks">
                <span>0</span><span>2.5</span><span>5</span>
                <span>6.5</span><span>8</span><span>10</span>
              </div>
            </div>
            <div class="chart-section">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
                <span class="ch-label"> Biu  Radar TBM cc mn</span>
              </div>
              <div class="chart-legend" id="chartLegend"></div>
              <div class="chart-wrap"><canvas id="radarChart"></canvas></div>
              <div class="chart-stats">
                <div class="cstat"><div class="cs-val cs-hi" id="csMax"></div><div class="cs-lbl">Mn cao nht</div></div>
                <div class="cstat"><div class="cs-val cs-lo" id="csMin"></div><div class="cs-lbl">Mn thp nht</div></div>
                <div class="cstat"><div class="cs-val" id="csAvg"></div><div class="cs-lbl">TBM c nm</div></div>
              </div>
            </div>
            <div class="rank-desc">
              <div class="rd-title">  ngha xp loi</div>
              <div class="rd-text" id="rDescText"></div>
              <div class="rd-tips" id="rDescTips"></div>
            </div>
            <table class="score-tbl">
              <thead>
                <tr>
                  <th>Mn hc</th>
                  <th style="text-align:right">TBM HK1</th>
                  <th style="text-align:right">TBM HK2</th>
                  <th style="text-align:right">TBM c nm</th>
                </tr>
              </thead>
              <tbody id="rTbody"></tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="history-wrap" id="histWrap">
        <div class="history-header">
          <h3> Kt qu  lu</h3>
          <button class="btn-clear-hist" onclick="xoaTatCa()"> Xo tt c</button>
        </div>
        <div id="histList"></div>
      </div>
    </div>

    <!-- TAB: PLANNER -->
    <div id="sec-planner" class="sp-section">
      <p class="sec-lbl"> To k hoch hc tp</p>
      <div class="sp-form">
        <div class="sp-form-grid">
          <div class="sp-field">
            <label>Mn hc</label>
            <select class="sp-inp" id="sp-subj"></select>
          </div>
          <div class="sp-field">
            <label>Deadline</label>
            <input type="date" class="sp-inp" id="sp-date"/>
          </div>
          <div class="sp-field" style="grid-column:1/-1;">
            <label>Ni dung hc</label>
            <input type="text" class="sp-inp" id="sp-title" placeholder="VD: Luyn  tch phn, n t vng Unit 5" maxlength="120"/>
          </div>
        </div>
        <button class="btn-sp-add" onclick="spAddTask()"> Thm k hoch</button>
      </div>

      <div class="sp-streak-box" id="sp-streak-box">
        <div class="streak-left">
          <div class="streak-flame"></div>
          <div class="streak-info">
            <div class="streak-label">Chui hc tp</div>
            <div class="streak-count" id="streak-count">0 <span>ngy</span></div>
          </div>
        </div>
        <div class="streak-badge" id="streak-badge" style="display:none"> ang hc rt u n!</div>
      </div>

      <div class="sp-heatmap">
        <div class="heatmap-title"> Lch hc 7 ngy gn nht</div>
        <div class="heatmap-grid" id="heatmap-grid"></div>
      </div>

      <div class="sp-stats">
        <div class="sp-stat"><div class="sp-stat-val" id="sp-total">0</div><div class="sp-stat-lbl">Tng task</div></div>
        <div class="sp-stat"><div class="sp-stat-val" id="sp-done-cnt">0</div><div class="sp-stat-lbl">Hon thnh</div></div>
        <div class="sp-stat"><div class="sp-stat-val" id="sp-pending">0</div><div class="sp-stat-lbl">Cn li</div></div>
        <div class="sp-stat"><div class="sp-stat-val" id="sp-overdue">0</div><div class="sp-stat-lbl" style="color:#f87171">Qu hn</div></div>
      </div>

      <div class="sp-filter">
        <button class="sp-filter-btn active" data-f="all"     onclick="spSetFilter('all',this)">Tt c</button>
        <button class="sp-filter-btn"        data-f="pending" onclick="spSetFilter('pending',this)">Cha xong</button>
        <button class="sp-filter-btn"        data-f="done"    onclick="spSetFilter('done',this)">Hon thnh</button>
        <button class="sp-filter-btn"        data-f="overdue" onclick="spSetFilter('overdue',this)">Qu hn</button>
      </div>
      <div class="sp-task-list" id="sp-list"></div>

      <p class="sec-lbl" style="margin-top:24px;"> Pomodoro Pro</p>
      <div class="pomo-wrap">
        <div class="pomo-config">
          <div class="sp-field">
            <label>Mn hc</label>
            <select class="sp-inp" id="pomo-subj"></select>
          </div>
          <div class="sp-field">
            <label>Pht hc</label>
            <input type="number" class="sp-inp" id="pomo-study" value="25" min="1" max="120"/>
          </div>
          <div class="sp-field">
            <label>Pht ngh</label>
            <input type="number" class="sp-inp" id="pomo-break" value="5" min="1" max="60"/>
          </div>
        </div>
        <div class="pomo-sound-bar">
          <label class="sound-toggle" id="sound-toggle-lbl">
            <span class="sound-icon" id="sound-icon"></span>
            <span id="sound-toggle-txt">m thanh bt</span>
            <input type="checkbox" id="sound-enabled" checked style="display:none" onchange="pomoSoundToggle()"/>
          </label>
          <select class="sound-select" id="sound-type">
            <option value="bell"> Chung</option>
            <option value="chime"> Giai iu</option>
            <option value="digital"> Digital</option>
          </select>
          <span style="font-size:.72rem;color:var(--tx-3);font-weight:600;">Vol:</span>
          <input type="range" class="sound-vol" id="sound-vol" min="0" max="1" step="0.1" value="0.7"/>
        </div>
        <div class="pomo-display">
          <div class="pomo-phase" id="pomo-phase">Sn sng</div>
          <div class="pomo-clock" id="pomo-clock">25:00</div>
          <div class="pomo-ring-wrap">
            <svg class="pomo-ring" viewBox="0 0 120 120">
              <circle class="pomo-ring-bg" cx="60" cy="60" r="52"/>
              <circle class="pomo-ring-fill" id="pomo-ring-fill" cx="60" cy="60" r="52"
                stroke-dasharray="326.7" stroke-dashoffset="326.7"/>
            </svg>
          </div>
          <div class="pomo-btns">
            <button class="pomo-btn pomo-start" id="pomo-btn-start" onclick="pomoStart()"> Start</button>
            <button class="pomo-btn pomo-pause" id="pomo-btn-pause" onclick="pomoPause()" style="display:none"> Pause</button>
            <button class="pomo-btn pomo-reset" onclick="pomoReset()"> Reset</button>
          </div>
        </div>
        <div class="pomo-stats">
          <div class="sp-stat"><div class="sp-stat-val" id="ps-total-min">0</div><div class="sp-stat-lbl">Tng pht hc</div></div>
          <div class="sp-stat"><div class="sp-stat-val" id="ps-sessions">0</div><div class="sp-stat-lbl">Sessions xong</div></div>
          <div class="sp-stat" style="flex:2;min-width:140px;">
            <div class="sp-stat-val" style="font-size:1rem" id="ps-top-subj"></div>
            <div class="sp-stat-lbl">Mn hc nhiu nht</div>
          </div>
        </div>
      </div>

      <p class="sec-lbl" style="margin-top:24px;"> Thi kha biu (24h)</p>
      <div class="sp-form" id="tt-form">
        <div class="sp-form-grid">
          <div class="sp-field">
            <label>Mn hc</label>
            <select class="sp-inp" id="tt-subj"></select>
          </div>
          <div class="sp-field">
            <label>Th trong tun</label>
            <select class="sp-inp" id="tt-day">
              <option value="0">Ch nht</option>
              <option value="1">Th 2</option>
              <option value="2">Th 3</option>
              <option value="3">Th 4</option>
              <option value="4">Th 5</option>
              <option value="5">Th 6</option>
              <option value="6">Th 7</option>
            </select>
          </div>
          <div class="sp-field">
            <label>Gi bt u (24h)</label>
            <div class="tt-time-group">
              <input class="tt-time-inp" type="text" id="tt-start"
                placeholder="07:30" maxlength="5" oninput="ttAutoColon(this)"/>
            </div>
          </div>
          <div class="sp-field">
            <label>Gi kt thc (24h)</label>
            <div class="tt-time-group">
              <input class="tt-time-inp" type="text" id="tt-end"
                placeholder="09:00" maxlength="5" oninput="ttAutoColon(this)"/>
            </div>
          </div>
        </div>
        <button class="btn-sp-add" onclick="ttAdd()"> Thm lch hc</button>
      </div>
      <div class="tt-list" id="tt-list"></div>
    </div>

    <!-- TAB: ANALYTICS -->
    <div id="sec-analytics" class="sp-section">
      <p class="sec-lbl"> Phn tch hc tp</p>
      <div class="analytics-grid">
        <div class="an-card">
          <div class="an-title"> Tng gi tun ny</div>
          <div class="an-val" id="an-week-hrs">0h</div>
          <div class="an-sub" id="an-week-min">0 pht</div>
          <div class="an-compare" id="an-week-compare"> Cha c d liu tun trc</div>
        </div>
        <div class="an-card">
          <div class="an-title"> Mn hc nhiu nht</div>
          <div class="an-val" id="an-top-subj" style="font-size:1.3rem"></div>
          <div class="an-sub" id="an-top-min">0 pht</div>
        </div>
        <div class="an-card">
          <div class="an-title"> % Hon thnh task</div>
          <div class="prog-circle-wrap">
            <svg class="prog-circle-svg" width="80" height="80" viewBox="0 0 80 80">
              <circle class="prog-circle-bg" cx="40" cy="40" r="32"/>
              <circle class="prog-circle-fill" id="an-prog-fill" cx="40" cy="40" r="32"
                stroke-dasharray="201" stroke-dashoffset="201"/>
            </svg>
            <div style="font-size:1.4rem;font-weight:900;color:var(--c-p1)" id="an-prog-pct">0%</div>
          </div>
        </div>
        <div class="an-card">
          <div class="an-title"> Chui Pomodoro</div>
          <div class="an-val" id="an-pomo-streak">0</div>
          <div class="an-sub">ngy lin tip</div>
        </div>
        <div class="an-card an-card-wide">
          <div class="an-title"> Heatmap 30 ngy gn nht</div>
          <div class="hm30-grid" id="hm30-grid"></div>
        </div>
        <div class="an-card an-card-wide">
          <div class="an-title"> Pht hc theo ngy (7 ngy)</div>
          <div class="an-chart-wrap"><canvas id="an-bar-chart"></canvas></div>
        </div>
        <div class="an-card an-card-wide">
          <div class="an-title"> Phn b thi gian theo mn</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:center;">
            <div style="position:relative;height:180px;"><canvas id="an-doughnut-chart"></canvas></div>
            <div id="an-legend" style="display:flex;flex-direction:column;gap:6px;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- TAB: AI MODULE -->
    <div id="sec-ai" class="sp-section">
      <p class="sec-lbl"> AI H tr hc tp  Powered by Gemini</p>

      <div class="ai-api-key-block">
        <label> Gemini API Key</label>
        <div class="ai-api-key-row">
          <input type="password" class="ai-api-key-inp" id="ai-api-key-inp"
            placeholder="Nhp Gemini API Key ca bn"/>
          <button class="btn-key-save" onclick="aiSaveKey()"> Lu</button>
        </div>
        <div class="ai-key-status missing" id="ai-key-status"> Cha c API Key  AI Gemini cha hot ng</div>
        <div style="font-size:.68rem;color:var(--tx-3);margin-top:4px;">Ly key min ph ti <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color:var(--c-p1)">aistudio.google.com</a></div>
      </div>

      <div class="ai-block">
        <div class="ai-block-title">
          <span class="ai-ico"></span>
          <span>H s hc tp</span>
        </div>
        <div class="ai-profile-grid">
          <div class="sp-field">
            <label>Lp</label>
            <select class="sp-inp" id="profile-grade" onchange="aiSaveProfile()">
              <option value="">-- Chn lp --</option>
              <option value="9">Lp 9</option>
              <option value="10">Lp 10</option>
              <option value="11">Lp 11</option>
              <option value="12">Lp 12</option>
            </select>
          </div>
          <div class="sp-field">
            <label>B sch</label>
            <select class="sp-inp" id="profile-textbook" onchange="aiSaveProfile()">
              <option value="">-- Chn sch --</option>
              <option value="Cnh Diu">Cnh Diu</option>
              <option value="KNTT">Kt ni tri thc</option>
              <option value="CTST">Chn tri sng to</option>
            </select>
          </div>
          <div class="sp-field">
            <label>Ban hc</label>
            <select class="sp-inp" id="profile-track" onchange="aiSaveProfile()">
              <option value="">-- Chn ban --</option>
              <option value="T nhin">T nhin</option>
              <option value="X hi">X hi</option>
              <option value="C bn">C bn</option>
            </select>
          </div>
        </div>
        <div style="margin-top:8px;font-size:.72rem;font-weight:600;color:var(--tx-3)" id="profile-status">Cha lu h s</div>
      </div>

      <div class="ai-block" id="ai-block-analysis">
        <div class="ai-block-title">
          <span class="ai-ico"></span>
          <span>AI Phn tch hc lc</span>
        </div>
        <div id="ai-analysis-content">
          <div class="ai-no-data">
            <span class="ai-nd-ico"></span>
            Hy tnh kt qu  tab <strong>Hc lc</strong> trc, ri bm Phn tch  AI Gemini nhn xt.
          </div>
        </div>
        <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;">
          <button class="btn-ai-gen" id="btn-ai-analysis" onclick="aiRunAnalysis()"> Phn tch ngay</button>
        </div>
      </div>

      <div class="ai-block" id="ai-block-plan">
        <div class="ai-block-title">
          <span class="ai-ico"></span>
          <span>AI To k hoch 14 ngy</span>
        </div>
        <div id="ai-plan-content">
          <div class="ai-no-data">
            <span class="ai-nd-ico"></span>
            Cn c kt qu im trc. Bm <strong>"To k hoch"</strong>  AI t ng to 14 ngy n tp da trn cc mn yu nht.
          </div>
        </div>
        <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
          <button class="btn-ai-gen" id="btn-ai-plan" onclick="aiGenPlan()"> To k hoch</button>
          <button class="btn-ai-push" id="ai-push-btn" onclick="aiPushToPlanner()" disabled> Thm vo Planner</button>
        </div>
      </div>

      <div class="ai-block" id="ai-block-test">
        <div class="ai-block-title">
          <span class="ai-ico"></span>
          <span>AI Mini Test  5 cu theo chng trnh</span>
        </div>
        <div class="ai-test-select-row">
          <select id="ai-test-subj"></select>
          <button class="btn-ai-gen" id="btn-ai-test" onclick="aiGenTest()"> To  thi</button>
        </div>
        <div id="ai-test-content">
          <div class="ai-no-data">
            <span class="ai-nd-ico"></span>
            Chn mn hc v bm <strong>"To  thi"</strong>. Gemini s to 5 cu ng chng trnh lp ca bn.
          </div>
        </div>
      </div>

      <div class="ai-block" id="ai-block-chat">
        <div class="ai-block-title">
          <span class="ai-ico"></span>
          <span>AI Chat h tr hc tp</span>
        </div>
        <div class="ai-chat-wrap">
          <div class="ai-chat-box" id="ai-chat-box">
            <div class="chat-msg ai">
              <div class="chat-avatar"></div>
              <div class="chat-bubble">Xin cho! Ti l tr l hc tp AI. Hy hi ti bt c iu g v mn hc, bi tp, hay phng php hc tp nh! </div>
            </div>
          </div>
          <div class="chat-input-row">
            <textarea class="chat-textarea" id="chat-input" rows="1"
              placeholder="Hi v bi hc, gii thch khi nim, luyn tp"
              onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();aiChatSend();}"></textarea>
            <button class="btn-chat-send" id="btn-chat-send" onclick="aiChatSend()"> Gi</button>
          </div>
          <button class="btn-chat-clear" onclick="aiChatClear()"> Xo lch s chat</button>
        </div>
      </div>

    </div>

  </div>
</div>

<!-- Timetable Edit Modal -->
<div class="tt-modal-overlay" id="tt-modal-overlay">
  <div class="tt-modal">
    <h3> Chnh sa lch hc</h3>
    <input type="hidden" id="tt-edit-id"/>
    <div class="sp-form-grid">
      <div class="sp-field">
        <label>Mn hc</label>
        <select class="sp-inp" id="tt-edit-subj"></select>
      </div>
      <div class="sp-field">
        <label>Th</label>
        <select class="sp-inp" id="tt-edit-day">
          <option value="0">Ch nht</option>
          <option value="1">Th 2</option>
          <option value="2">Th 3</option>
          <option value="3">Th 4</option>
          <option value="4">Th 5</option>
          <option value="5">Th 6</option>
          <option value="6">Th 7</option>
        </select>
      </div>
      <div class="sp-field">
        <label>Gi bt u (24h)</label>
        <input class="tt-time-inp" type="text" id="tt-edit-start" placeholder="07:30" maxlength="5" oninput="ttAutoColon(this)"/>
      </div>
      <div class="sp-field">
        <label>Gi kt thc (24h)</label>
        <input class="tt-time-inp" type="text" id="tt-edit-end" placeholder="09:00" maxlength="5" oninput="ttAutoColon(this)"/>
      </div>
    </div>
    <div class="tt-modal-btns">
      <button class="btn-modal-cancel" onclick="ttCloseModal()">Hu</button>
      <button class="btn-sp-add" onclick="ttSaveEdit()"> Lu chnh sa</button>
    </div>
  </div>
</div>

<!-- Add Subject Modal -->
<div class="asModal-overlay" id="asModal-overlay">
  <div class="asModal">
    <h3> Thm mn hc mi</h3>
    <label for="asModal-name">Tn mn hc</label>
    <input type="text" id="asModal-name" placeholder="VD: m nhc, M thut" maxlength="50"
      onkeydown="if(event.key==='Enter')confirmAddSubj()"/>
    <span class="asModal-err" id="asModal-err"></span>
    <div class="asModal-btns">
      <button class="asModal-cancel" onclick="closeAddSubjModal()">Hu</button>
      <button class="btn-sp-add" onclick="confirmAddSubj()"> Thm mn</button>
    </div>
  </div>
</div>

<footer class="pg-foot"> 2025  Study System PRO  Chun hc b Vit Nam</footer>
<div class="toast" id="toast"></div>

<script>
/*  1. D LIU MN HC  */
const MON = [
  {id:'toan', ten:'Ton',             ico:''},
  {id:'van',  ten:'Ng vn',          ico:''},
  {id:'anh',  ten:'Ting Anh',        ico:''},
  {id:'ly',   ten:'Vt l',           ico:''},
  {id:'hoa',  ten:'Ha hc',          ico:''},
  {id:'sinh', ten:'Sinh hc',         ico:''},
  {id:'su',   ten:'Lch s',          ico:''},
  {id:'dia',  ten:'a l',           ico:''},
  {id:'gdcd', ten:'GDKT & Php lut', ico:''},
  {id:'tin',  ten:'Tin hc',          ico:''},
  {id:'gdqp', ten:'GD Quc phng',    ico:''},
  {id:'cn',   ten:'Cng ngh',        ico:''},
];

const RANK = [
  {min:8.0,lbl:'Gii',      cls:'gioi',ico:'',scCls:'sc-g',
   rgb:'52,211,153',pdfColor:[5,150,105],pdfBg:[209,250,229],
   desc:'Hc sinh t thnh tch xut sc, nm vng kin thc ton din, c kh nng t duy c lp v sng to.',
   tips:['Nm vng l thuyt','Lm tt bi tp nng cao','T hc hiu qu','T duy sng to']},
  {min:6.5,lbl:'Kh',       cls:'kha', ico:'',scCls:'sc-k',
   rgb:'96,165,250',pdfColor:[29,78,216],pdfBg:[219,234,254],
   desc:'Hc sinh c kt qu tt, hiu bi v vn dng kin thc  mc kh. Cn c gng thm  t mc Gii.',
   tips:['Hiu bi  mc kh','Cn n luyn thm','C nn tng vng','Tip tc pht huy']},
  {min:5.0,lbl:'Trung bnh',cls:'tb',  ico:'',scCls:'sc-t',
   rgb:'251,191,36',pdfColor:[133,77,14],pdfBg:[254,249,195],
   desc:'Hc sinh t mc c bn, cn ci thin cc mn cn yu v tng cng n luyn u n hn.',
   tips:['Nm kin thc c bn','Cn luyn tp thm','Ch  mn yu','Tng thi gian n bi']},
  {min:0,  lbl:'Yu',       cls:'yeu', ico:'',scCls:'sc-y',
   rgb:'248,113,113',pdfColor:[153,27,27],pdfBg:[254,226,226],
   desc:'Hc sinh cn n lc nhiu hn, nn tm s h tr t thy c v gia nh  ci thin kp thi.',
   tips:['B sung kin thc','Tm h tr thy c','Lp k hoch hc','Khng b cuc!']},
];

let currentResult  = null;
let radarChartInst = null;
let anBarChart     = null;
let anDoughnut     = null;
const txCount = {};
MON.forEach(m => { txCount[m.id] = {1: 4, 2: 4}; });

/*  TAB  */
function switchTab(tab) {
  ['grade','planner','analytics','ai'].forEach(t => {
    const s = document.getElementById('sec-'+t);
    const b = document.getElementById('tab-'+t);
    if (s) s.style.display = 'none';
    if (b) b.classList.remove('active');
  });
  const sec = document.getElementById('sec-'+tab);
  const btn = document.getElementById('tab-'+tab);
  if (sec) { sec.style.display = ''; sec.classList.add('active'); }
  if (btn) btn.classList.add('active');
  if (tab === 'planner')   spRender();
  if (tab === 'analytics') anRender();
  if (tab === 'ai')        { aiInitTestSubjSelect(); aiLoadProfile(); aiLoadKeyStatus(); }
}

/*  DARK MODE  */
const DM_KEY = 'hocLucDarkMode';
function applyTheme(dark) {
  document.documentElement.setAttribute('data-theme', dark ? 'dark' : 'light');
  document.getElementById('dmBtn').setAttribute('data-ico', dark ? '' : '');
  if (radarChartInst) updateRadarTheme();
}
function toggleDark() {
  const d = document.documentElement.getAttribute('data-theme') === 'dark';
  applyTheme(!d);
  try { localStorage.setItem(DM_KEY, !d ? '1' : '0'); } catch(e){}
  showToast(!d ? ' Dark Mode  bt' : ' Light Mode  bt');
}
(function initTheme() {
  let s = null;
  try { s = localStorage.getItem(DM_KEY); } catch(e){}
  if (s !== null) { applyTheme(s === '1'); return; }
  if (window.matchMedia?.('(prefers-color-scheme: dark)').matches) applyTheme(true);
})();

/*  UI MN HC  */
function buildMonUI() {
  const list = document.getElementById('monList');
  list.innerHTML = '';
  MON.forEach(m => {
    if (!txCount[m.id]) txCount[m.id] = {1: 4, 2: 4};
    const card = document.createElement('div');
    card.className = 'mon-card';
    card.id = 'card_' + m.id;
    const isCustom = m._custom === true;
    const delBtn = isCustom
      ? `<button class="mon-del-btn" title="Xo mn ny" onclick="deleteCustomSubj('${m.id}',event)"></button>`
      : '';
    card.innerHTML = `
      <div class="mon-header" onclick="toggleMon('${m.id}')">
        <div class="mon-ico-chip">${m.ico}</div>
        <div class="mon-title-wrap">
          <div class="mon-title">${m.ten}</div>
          <div class="mon-subtitle" id="sub_${m.id}">Cha nhp im</div>
        </div>
        <div class="mon-tbm-display" id="tbm_${m.id}"></div>
        ${delBtn}
        <div class="mon-chevron"></div>
      </div>
      <div class="mon-body">
        <div class="semesters">
          <div class="sem-block">
            <div class="sem-title"> Hc k 1
              <span class="sem-result" id="hk1r_${m.id}">HK1: </span>
            </div>
            <div class="inp-row">
              <span class="inp-lbl">TX (HK1)</span>
              <div class="tx-row" id="tx1_${m.id}"></div>
              <button class="btn-tx-del" onclick="delTX('${m.id}',1)"></button>
              <button class="btn-tx-add" onclick="addTX('${m.id}',1)">+</button>
            </div>
            <div class="inp-row">
              <span class="inp-lbl">Gia k 1</span>
              <input class="d-inp" type="number" id="gk1_${m.id}" min="0" max="10" step="0.1" placeholder="" oninput="recalcMon('${m.id}')"/>
            </div>
            <div class="inp-row">
              <span class="inp-lbl">Cui k 1</span>
              <input class="d-inp" type="number" id="ck1_${m.id}" min="0" max="10" step="0.1" placeholder="" oninput="recalcMon('${m.id}')"/>
            </div>
            <div class="hk-display"><span>im HK1</span><span class="hk-val" id="hk1v_${m.id}"></span></div>
          </div>
          <div class="sem-block">
            <div class="sem-title"> Hc k 2
              <span class="sem-result" id="hk2r_${m.id}">HK2: </span>
            </div>
            <div class="inp-row">
              <span class="inp-lbl">TX (HK2)</span>
              <div class="tx-row" id="tx2_${m.id}"></div>
              <button class="btn-tx-del" onclick="delTX('${m.id}',2)"></button>
              <button class="btn-tx-add" onclick="addTX('${m.id}',2)">+</button>
            </div>
            <div class="inp-row">
              <span class="inp-lbl">Gia k 2</span>
              <input class="d-inp" type="number" id="gk2_${m.id}" min="0" max="10" step="0.1" placeholder="" oninput="recalcMon('${m.id}')"/>
            </div>
            <div class="inp-row">
              <span class="inp-lbl">Cui k 2</span>
              <input class="d-inp" type="number" id="ck2_${m.id}" min="0" max="10" step="0.1" placeholder="" oninput="recalcMon('${m.id}')"/>
            </div>
            <div class="hk-display"><span>im HK2</span><span class="hk-val" id="hk2v_${m.id}"></span></div>
          </div>
        </div>
        <div class="year-bar" id="yearbar_${m.id}">
          <div>
            <div class="yb-label"> TBM c nm</div>
            <div class="yb-formula" id="formula_${m.id}">Cha c d liu</div>
          </div>
          <div class="yb-val" id="tbmYear_${m.id}"></div>
        </div>
      </div>`;
    list.appendChild(card);
    buildTX(m.id, 1);
    buildTX(m.id, 2);
  });
}

function buildTX(mid, hk) {
  const wrap = document.getElementById(`tx${hk}_${mid}`);
  if (!wrap) return;
  const oldVals = Array.from(wrap.querySelectorAll('input')).map(i => i.value);
  wrap.innerHTML = '';
  const n = txCount[mid][hk];
  for (let i = 0; i < n; i++) {
    const inp = document.createElement('input');
    inp.className = 'd-inp'; inp.type = 'number';
    inp.min = '0'; inp.max = '10'; inp.step = '0.1';
    inp.placeholder = `TX${i+1}`;
    inp.id = `tx${hk}_${mid}_${i}`;
    if (oldVals[i] !== undefined) inp.value = oldVals[i];
    inp.setAttribute('oninput', `recalcMon('${mid}')`);
    wrap.appendChild(inp);
  }
}

function toggleMon(mid) { document.getElementById('card_'+mid).classList.toggle('open'); }
function addTX(mid, hk) { if (txCount[mid][hk] >= 6) return; txCount[mid][hk]++; buildTX(mid, hk); recalcMon(mid); }
function delTX(mid, hk) { if (txCount[mid][hk] <= 1) return; txCount[mid][hk]--; buildTX(mid, hk); recalcMon(mid); }

/*  TNH IM  */
function getVal(id) {
  const el = document.getElementById(id);
  if (!el) return null;
  const v = parseFloat(el.value);
  return (!el.value.trim() || isNaN(v) || v < 0 || v > 10) ? null : v;
}
function isInvalid(id) {
  const el = document.getElementById(id);
  if (!el || !el.value.trim()) return false;
  const v = parseFloat(el.value);
  return isNaN(v) || v < 0 || v > 10;
}
function avg(arr) {
  const v = arr.filter(x => x !== null);
  return v.length ? v.reduce((a,b)=>a+b,0)/v.length : null;
}
function tinhHK(txVals, gk, ck) {
  const tbTX = avg(txVals);
  const parts = [];
  if (tbTX !== null) parts.push({v:tbTX, w:2});
  if (gk   !== null) parts.push({v:gk,   w:3});
  if (ck   !== null) parts.push({v:ck,   w:5});
  if (!parts.length) return null;
  const sumW = parts.reduce((s,p)=>s+p.w,0);
  const sumV = parts.reduce((s,p)=>s+p.v*p.w,0);
  return sumV/sumW;
}
function tinhTBMNam(hk1, hk2) {
  if (hk1 !== null && hk2 !== null) return (hk1 + hk2*2)/3;
  if (hk1 !== null) return hk1;
  if (hk2 !== null) return hk2;
  return null;
}
function recalcMon(mid) {
  const n1 = txCount[mid][1], n2 = txCount[mid][2];
  const tx1 = Array.from({length:n1},(_,i)=>getVal(`tx1_${mid}_${i}`));
  const tx2 = Array.from({length:n2},(_,i)=>getVal(`tx2_${mid}_${i}`));
  const hk1 = tinhHK(tx1, getVal(`gk1_${mid}`), getVal(`ck1_${mid}`));
  const hk2 = tinhHK(tx2, getVal(`gk2_${mid}`), getVal(`ck2_${mid}`));
  const tbm = tinhTBMNam(hk1, hk2);
  const fmt = v => v!==null ? v.toFixed(2) : '';
  document.getElementById(`hk1v_${mid}`).textContent = fmt(hk1);
  document.getElementById(`hk2v_${mid}`).textContent = fmt(hk2);
  document.getElementById(`hk1r_${mid}`).textContent = `HK1: ${fmt(hk1)}`;
  document.getElementById(`hk2r_${mid}`).textContent = `HK2: ${fmt(hk2)}`;
  const tbmEl=document.getElementById(`tbmYear_${mid}`);
  const subEl=document.getElementById(`sub_${mid}`);
  const hdrEl=document.getElementById(`tbm_${mid}`);
  const fmlEl=document.getElementById(`formula_${mid}`);
  if (tbm !== null) {
    const r = Math.round(tbm*100)/100, cl = scColor(r);
    tbmEl.textContent = r.toFixed(2); hdrEl.textContent = r.toFixed(2);
    hdrEl.className = 'mon-tbm-display '+cl;
    const pts=[];
    if (hk1!==null) pts.push(`HK1: ${hk1.toFixed(2)}`);
    if (hk2!==null) pts.push(`HK2: ${hk2.toFixed(2)}`);
    subEl.textContent = pts.join(' | ')+` | TBM: ${r.toFixed(2)}`;
    fmlEl.textContent = (hk1!==null&&hk2!==null)
      ? `(HK1 + HK22) / 3 = ${r.toFixed(2)}`
      : hk1!==null ? `Ch c HK1 = ${r.toFixed(2)}` : `Ch c HK2 = ${r.toFixed(2)}`;
  } else {
    tbmEl.textContent=''; hdrEl.textContent=''; hdrEl.className='mon-tbm-display';
    subEl.textContent='Cha nhp im'; fmlEl.textContent='Cha c d liu';
  }
}

/*  HELPERS  */
function rankOf(d)  { return RANK.find(r=>d>=r.min)||RANK[RANK.length-1]; }
function scColor(d) { return d>=8?'sc-g':d>=6.5?'sc-k':d>=5?'sc-t':'sc-y'; }
let toastTimer;
function showToast(msg, ok=true) {
  const t = document.getElementById('toast');
  t.innerHTML = (ok?' ':' ')+msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>t.classList.remove('show'), 2800);
}
function hasInputError(mid) {
  const n1 = txCount[mid][1], n2 = txCount[mid][2];
  const ids = [
    ...Array.from({length:n1},(_,i)=>`tx1_${mid}_${i}`),
    ...Array.from({length:n2},(_,i)=>`tx2_${mid}_${i}`),
    `gk1_${mid}`,`ck1_${mid}`,`gk2_${mid}`,`ck2_${mid}`
  ];
  return ids.some(id=>isInvalid(id));
}
function collectRows() {
  const rows=[];
  MON.forEach(m=>{
    const n1=txCount[m.id][1], n2=txCount[m.id][2];
    const tx1=Array.from({length:n1},(_,i)=>getVal(`tx1_${m.id}_${i}`));
    const tx2=Array.from({length:n2},(_,i)=>getVal(`tx2_${m.id}_${i}`));
    const hk1=tinhHK(tx1,getVal(`gk1_${m.id}`),getVal(`ck1_${m.id}`));
    const hk2=tinhHK(tx2,getVal(`gk2_${m.id}`),getVal(`ck2_${m.id}`));
    const tbmRaw=tinhTBMNam(hk1,hk2);
    const tbm=tbmRaw!==null?Math.round(tbmRaw*100)/100:null;
    if (hk1!==null||hk2!==null) rows.push({m,hk1,hk2,tbm});
  });
  return rows;
}
function todayStr() {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

/*  ADD CUSTOM SUBJECT  */
function openAddSubjModal() {
  document.getElementById('asModal-name').value = '';
  document.getElementById('asModal-err').textContent = '';
  document.getElementById('asModal-overlay').classList.add('open');
  setTimeout(() => document.getElementById('asModal-name').focus(), 80);
}
function closeAddSubjModal() {
  document.getElementById('asModal-overlay').classList.remove('open');
}
function confirmAddSubj() {
  const nameInp = document.getElementById('asModal-name');
  const errEl   = document.getElementById('asModal-err');
  const name    = nameInp.value.trim();
  if (!name) { errEl.textContent = ' Vui lng nhp tn mn hc.'; nameInp.focus(); return; }
  const dup = MON.some(m => m.ten.toLowerCase() === name.toLowerCase());
  if (dup) { errEl.textContent = ' Mn "' + name + '"  tn ti!'; nameInp.select(); return; }
  const slug = name.normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .toLowerCase().replace(/\s+/g,'_').replace(/[^a-z0-9_]/g,'') || 'mon_' + Date.now();
  const id = slug + '_' + Date.now();
  MON.push({ id, ten: name, ico: '', _custom: true });
  txCount[id] = { 1: 4, 2: 4 };
  buildMonUI();
  spBuildSubjSelect();
  aiInitTestSubjSelect();
  closeAddSubjModal();
  showToast(' thm mn: ' + name);
  requestAnimationFrame(() => {
    const newCard = document.getElementById('card_' + id);
    if (newCard) { newCard.scrollIntoView({ behavior: 'smooth', block: 'center' }); newCard.classList.add('open'); }
  });
}
function deleteCustomSubj(mid, e) {
  e.stopPropagation();
  const m = MON.find(x => x.id === mid);
  if (!m || !m._custom) return;
  if (!confirm(`Xo mn "${m.ten}" khi danh sch?`)) return;
  const idx = MON.findIndex(x => x.id === mid);
  if (idx >= 0) MON.splice(idx, 1);
  delete txCount[mid];
  buildMonUI();
  spBuildSubjSelect();
  aiInitTestSubjSelect();
  showToast(' xo mn ' + m.ten, false);
}

/*  TNH KT QU  */
function tinhKQ() {
  const gErr=document.getElementById('gErr');
  gErr.style.display='none';
  const errMons=MON.filter(m=>hasInputError(m.id)).map(m=>m.ten);
  if (errMons.length) {
    gErr.innerHTML=` im khng hp l (ngoi 010) ti: <strong>${errMons.join(', ')}</strong>`;
    gErr.style.display='block'; hideResult(); return;
  }
  const allRows=collectRows();
  if (!allRows.length) {
    gErr.innerHTML=' Hy nhp t nht <strong>1 mn</strong>  tnh kt qu.';
    gErr.style.display='block'; hideResult(); return;
  }
  const tbmChung=Math.round(allRows.reduce((s,r)=>s+r.tbm,0)/allRows.length*100)/100;
  const rnk=rankOf(tbmChung);
  const ten=document.getElementById('tenHS').value.trim()||'Hc sinh';
  currentResult={ten,dtb:tbmChung,rnk:rnk.cls,rows:allRows,ts:Date.now()};
  const card=document.getElementById('resCard');
  ['gioi','kha','tb','yeu'].forEach(c=>card.classList.remove(c));
  card.classList.add(rnk.cls);
  document.getElementById('rAvatar').textContent=rnk.ico;
  document.getElementById('rName').textContent=ten;
  document.getElementById('rPill').textContent=rnk.ico+' '+rnk.lbl;
  document.getElementById('rAvg').textContent=tbmChung.toFixed(2);
  const pct=(tbmChung/10*100).toFixed(1)+'%';
  document.getElementById('rScaleFill').style.width='0%';
  document.getElementById('rNeedle').style.left='0%';
  setTimeout(()=>{
    document.getElementById('rScaleFill').style.width=pct;
    document.getElementById('rNeedle').style.left=pct;
  },120);
  document.getElementById('rDescText').textContent=rnk.desc;
  document.getElementById('rDescTips').innerHTML=rnk.tips.map(t=>`<span class="rd-tip">${t}</span>`).join('');
  const tbody=document.getElementById('rTbody'); tbody.innerHTML='';
  allRows.forEach(({m,hk1,hk2,tbm})=>{
    const tr=document.createElement('tr');
    const cl=tbm!==null?scColor(tbm):'';
    tr.innerHTML=`<td><span class="tbl-ico">${m.ico}</span>${m.ten}</td>
      <td style="text-align:right;color:var(--tx-2)">${hk1!==null?hk1.toFixed(2):''}</td>
      <td style="text-align:right;color:var(--tx-2)">${hk2!==null?hk2.toFixed(2):''}</td>
      <td class="${cl}" style="text-align:right">${tbm!==null?tbm.toFixed(2):''}</td>`;
    tbody.appendChild(tr);
  });
  const tr=document.createElement('tr'); tr.className='ttl-row';
  tr.innerHTML=`<td colspan="3"><span class="tbl-ico"></span>TBM c nm</td>
    <td class="${rnk.scCls}" style="text-align:right">${tbmChung.toFixed(2)}</td>`;
  tbody.appendChild(tr);
  const wrap=document.getElementById('resWrap');
  wrap.style.display=''; wrap.classList.remove('visible');
  void wrap.offsetWidth; wrap.classList.add('visible');
  wrap.scrollIntoView({behavior:'smooth',block:'nearest'});
  setTimeout(()=>drawRadar(allRows,rnk),200);
  document.getElementById('btnSave').disabled=false;
  document.getElementById('btnPdf').disabled=false;
}

function hideResult() {
  const w=document.getElementById('resWrap');
  w.classList.remove('visible'); w.style.display='';
  document.getElementById('rScaleFill').style.width='0%';
  document.getElementById('rNeedle').style.left='0%';
  document.getElementById('btnSave').disabled=true;
  document.getElementById('btnPdf').disabled=true;
  if (radarChartInst){radarChartInst.destroy();radarChartInst=null;}
  currentResult=null;
}

/*  RADAR CHART  */
function getChartTheme() {
  const cs=getComputedStyle(document.documentElement);
  return {grid:cs.getPropertyValue('--chart-grid').trim(),
    tick:cs.getPropertyValue('--chart-tick').trim(),
    label:cs.getPropertyValue('--chart-pt-label').trim()};
}
function drawRadar(rows, rnk) {
  const canvas=document.getElementById('radarChart');
  if (radarChartInst){radarChartInst.destroy();radarChartInst=null;}
  const th=getChartTheme(), rgb=rnk.rgb;
  radarChartInst=new Chart(canvas,{
    type:'radar',
    data:{labels:rows.map(r=>r.m.ten),datasets:[{
      label:'TBM',data:rows.map(r=>r.tbm),
      backgroundColor:`rgba(${rgb},.18)`,borderColor:`rgba(${rgb},.95)`,
      pointBackgroundColor:`rgba(${rgb},1)`,pointBorderColor:'#fff',
      pointHoverBackgroundColor:'#fff',pointHoverBorderColor:`rgba(${rgb},1)`,
      pointRadius:5,pointHoverRadius:7,borderWidth:2.5,fill:true}]},
    options:{responsive:true,maintainAspectRatio:true,
      animation:{duration:700,easing:'easeInOutQuart'},
      scales:{r:{min:0,max:10,
        ticks:{stepSize:2,color:th.tick,font:{size:10,family:'Inter'},backdropColor:'transparent'},
        grid:{color:th.grid},angleLines:{color:th.grid},
        pointLabels:{color:th.label,font:{size:10,weight:'700',family:'Inter'}}}},
      plugins:{legend:{display:false},tooltip:{
        backgroundColor:'rgba(15,14,26,.85)',titleColor:'#e8e6ff',bodyColor:'#a09ec0',
        padding:10,cornerRadius:10,callbacks:{label:ctx=>` TBM: ${ctx.raw.toFixed(2)}`}}}}
  });
  document.getElementById('chartLegend').innerHTML=`
    <div class="leg-chip"><span class="leg-dot" style="background:rgba(${rgb},1)"></span>TBM mn</div>
    <div class="leg-chip"><span class="leg-dot" style="background:rgba(${rgb},.3);border:1.5px solid rgba(${rgb},1)"></span>Vng im</div>`;
  const vals=rows.map(r=>r.tbm);
  document.getElementById('csMax').textContent=Math.max(...vals).toFixed(2);
  document.getElementById('csMin').textContent=Math.min(...vals).toFixed(2);
  document.getElementById('csAvg').textContent=(vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(2);
}
function updateRadarTheme() {
  if (!radarChartInst) return;
  const th=getChartTheme(), sc=radarChartInst.options.scales.r;
  sc.ticks.color=th.tick; sc.grid.color=th.grid;
  sc.angleLines.color=th.grid; sc.pointLabels.color=th.label;
  radarChartInst.update();
}

/*  XUT PDF  */
function xuatPDF() {
  if (!currentResult) return;
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF({unit:'mm',format:'a4',orientation:'portrait'});
  const W=doc.internal.pageSize.getWidth();
  const rnkObj=rankOf(currentResult.dtb);
  const WHITE=[255,255,255],DARK=[30,27,75],GREY=[100,100,120],LGREY=[230,230,240];
  const sf=(sz,w='normal',c=DARK)=>{doc.setFontSize(sz);doc.setFont('helvetica',w);doc.setTextColor(...c);};
  const rc=(x,y,w,h,c,r=0)=>{doc.setFillColor(...c);r>0?doc.roundedRect(x,y,w,h,r,r,'F'):doc.rect(x,y,w,h,'F');};
  rc(0,0,W,36,[79,70,229]);rc(W*.55,0,W*.45,36,[124,58,237]);
  doc.setFillColor(255,255,255);doc.circle(23,18,9,'F');
  sf(13,'bold',DARK);doc.text('HT',23,21.5,{align:'center'});
  sf(15,'bold',WHITE);doc.text('PHIEU XEP LOAI HOC LUC',38,13);
  sf(8,'normal',[200,200,255]);doc.text('Study System PRO - Chuan VN',38,20);
  const now=new Date();
  const ds=`${now.getDate().toString().padStart(2,'0')}/${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getFullYear()}`;
  sf(7,'normal',[180,180,230]);doc.text(`Ngay: ${ds}`,38,27);
  let y=42;
  rc(10,y,W-20,20,[245,245,255],4);
  doc.setDrawColor(...LGREY);doc.setLineWidth(.3);doc.roundedRect(10,y,W-20,20,4,4,'S');
  sf(7,'bold',GREY);doc.text('HOC SINH',16,y+6);
  sf(11,'bold',DARK);doc.text(currentResult.ten||'Hoc sinh',16,y+14);
  rc(W-58,y+3,46,14,rnkObj.pdfBg,6);
  doc.setDrawColor(...rnkObj.pdfColor);doc.roundedRect(W-58,y+3,46,14,6,6,'S');
  sf(9,'bold',rnkObj.pdfColor);doc.text(rnkObj.lbl.toUpperCase(),W-35,y+12,{align:'center'});
  y+=26;
  rc(10,y,W-20,26,rnkObj.pdfBg,5);
  doc.setDrawColor(...rnkObj.pdfColor);doc.setLineWidth(.4);doc.roundedRect(10,y,W-20,26,5,5,'S');
  sf(7,'bold',rnkObj.pdfColor);doc.text('DIEM TRUNG BINH CA NAM',18,y+9);
  sf(20,'bold',rnkObj.pdfColor);doc.text(currentResult.dtb.toFixed(2),W-20,y+20,{align:'right'});
  sf(7,'normal',GREY);doc.text('/ 10.00',W-20,y+25,{align:'right'});
  const bW2=W-72,bX2=18,bY2=y+20,bH2=3;
  rc(bX2,bY2,bW2,bH2,[215,215,235],2);
  doc.setFillColor(...rnkObj.pdfColor);
  doc.roundedRect(bX2,bY2,bW2*currentResult.dtb/10,bH2,1.5,1.5,'F');
  if (radarChartInst) {
    y+=32;
    const img=radarChartInst.toBase64Image('image/png',1);
    rc(10,y,W-20,86,[248,248,255],4);
    doc.setDrawColor(...LGREY);doc.setLineWidth(.3);doc.roundedRect(10,y,W-20,86,4,4,'S');
    sf(7,'bold',[79,70,229]);doc.text('BIEU DO RADAR TBM CAC MON',W/2,y+7,{align:'center'});
    const cs=68,cx=(W-cs)/2;doc.addImage(img,'PNG',cx,y+9,cs,cs);
    y+=90;
  } else { y+=32; }
  rc(10,y,W-20,8,[79,70,229]);
  sf(7.5,'bold',WHITE);doc.text('BANG DIEM CHI TIET TUNG MON',W/2,y+5.5,{align:'center'});
  y+=8;
  rc(10,y,W-20,7,[235,235,250]);
  sf(7,'bold',DARK);doc.text('MON HOC',16,y+5);
  doc.text('TBM HK1',W-60,y+5,{align:'right'});
  doc.text('TBM HK2',W-38,y+5,{align:'right'});
  doc.text('TBM NAM',W-14,y+5,{align:'right'});
  y+=7;
  currentResult.rows.forEach(({m,hk1,hk2,tbm},i)=>{
    rc(10,y,W-20,8,i%2===0?WHITE:[248,248,255]);
    sf(8,'normal',DARK);doc.text(m.ten,16,y+5.5);
    sf(7.5,'normal',GREY);
    doc.text(hk1!==null?Number(hk1).toFixed(2):'',W-60,y+5.5,{align:'right'});
    doc.text(hk2!==null?Number(hk2).toFixed(2):'',W-38,y+5.5,{align:'right'});
    if (tbm!==null) {
      const sc2=tbm>=8?[5,150,105]:tbm>=6.5?[29,78,216]:tbm>=5?[180,100,10]:[185,28,28];
      sf(8.5,'bold',sc2);doc.text(Number(tbm).toFixed(2),W-14,y+5.5,{align:'right'});
    } else { sf(8.5,'normal',GREY);doc.text('',W-14,y+5.5,{align:'right'}); }
    doc.setDrawColor(...LGREY);doc.setLineWidth(.2);doc.line(10,y+8,W-10,y+8);
    y+=8;
  });
  rc(10,y,W-20,9,rnkObj.pdfBg);
  doc.setDrawColor(...rnkObj.pdfColor);doc.setLineWidth(.4);doc.rect(10,y,W-20,9,'S');
  sf(8.5,'bold',rnkObj.pdfColor);doc.text('DIEM TB CA NAM',16,y+6.3);
  sf(10,'bold',rnkObj.pdfColor);doc.text(currentResult.dtb.toFixed(2),W-14,y+6.5,{align:'right'});
  const fY=doc.internal.pageSize.getHeight()-10;
  doc.setDrawColor(...LGREY);doc.setLineWidth(.3);doc.line(10,fY-4,W-10,fY-4);
  sf(6.5,'normal',GREY);doc.text('Study System PRO  Chuan hoc ba Viet Nam',W/2,fY,{align:'center'});
  const safe=(currentResult.ten||'hocsinh').replace(/\s+/g,'-').replace(/[^a-zA-Z0-9\-]/g,'');
  doc.save(`BangDiem_${safe}_${ds.replace(/\//g,'')}.pdf`);
  showToast(' xut PDF bng im chi tit!');
}

/*  LU / LCH S  */
const SK='hocLucHistoryV2';
function docLS()  { try{return JSON.parse(localStorage.getItem(SK))||[];}catch(e){return[];} }
function ghiLS(a) { try{localStorage.setItem(SK,JSON.stringify(a));}catch(e){} }

function luuKQ() {
  if (!currentResult) return;
  const arr=docLS();
  arr.unshift({...currentResult,id:currentResult.ts});
  if (arr.length>20) arr.splice(20);
  ghiLS(arr);
  document.getElementById('btnSave').disabled=true;
  showToast(' lu kt qu ca '+currentResult.ten);
  renderLichSu();
}
function renderLichSu() {
  const arr=docLS(),wrap=document.getElementById('histWrap'),list=document.getElementById('histList');
  if (!arr.length){wrap.classList.remove('visible');return;}
  wrap.classList.add('visible'); list.innerHTML='';
  arr.forEach((rec,idx)=>{
    const ro=RANK.find(r=>rec.rnk===r.cls)||RANK[RANK.length-1];
    const d=new Date(rec.ts);
    const ds=`${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    const row=document.createElement('div');
    row.className='hist-row';row.title='Nhn  xem';
    row.innerHTML=`<div class="hist-rank-dot dot-${rec.rnk}"></div>
      <span class="hist-name">${rec.ten}</span>
      <span class="hist-avg ${ro.scCls}">${Number(rec.dtb).toFixed(2)}</span>
      <span class="hist-lbl ${rec.rnk}">${ro.lbl}</span>
      <span class="hist-date">${ds}</span>
      <button class="hist-del" onclick="xoaRec(${idx},event)"></button>`;
    row.addEventListener('click',()=>napLai(rec));
    list.appendChild(row);
  });
}
function napLai(rec) {
  document.getElementById('tenHS').value=rec.ten;
  currentResult=rec;
  if (rec.rows&&rec.rows.length) {
    const rnk=rankOf(rec.dtb);
    const wrap=document.getElementById('resWrap'),card=document.getElementById('resCard');
    ['gioi','kha','tb','yeu'].forEach(c=>card.classList.remove(c));
    card.classList.add(rnk.cls);
    document.getElementById('rAvatar').textContent=rnk.ico;
    document.getElementById('rName').textContent=rec.ten;
    document.getElementById('rPill').textContent=rnk.ico+' '+rnk.lbl;
    document.getElementById('rAvg').textContent=Number(rec.dtb).toFixed(2);
    document.getElementById('rDescText').textContent=rnk.desc;
    document.getElementById('rDescTips').innerHTML=rnk.tips.map(t=>`<span class="rd-tip">${t}</span>`).join('');
    const tbody=document.getElementById('rTbody'); tbody.innerHTML='';
    rec.rows.forEach(({m,hk1,hk2,tbm})=>{
      const tr=document.createElement('tr');
      const cl=tbm!=null?scColor(Number(tbm)):'';
      tr.innerHTML=`<td><span class="tbl-ico">${m.ico}</span>${m.ten}</td>
        <td style="text-align:right;color:var(--tx-2)">${hk1!=null?Number(hk1).toFixed(2):''}</td>
        <td style="text-align:right;color:var(--tx-2)">${hk2!=null?Number(hk2).toFixed(2):''}</td>
        <td class="${cl}" style="text-align:right">${tbm!=null?Number(tbm).toFixed(2):''}</td>`;
      tbody.appendChild(tr);
    });
    const tr=document.createElement('tr'); tr.className='ttl-row';
    const rnkO=rankOf(rec.dtb);
    tr.innerHTML=`<td colspan="3"><span class="tbl-ico"></span>TBM c nm</td>
      <td class="${rnkO.scCls}" style="text-align:right">${Number(rec.dtb).toFixed(2)}</td>`;
    tbody.appendChild(tr);
    const pct=(rec.dtb/10*100).toFixed(1)+'%';
    wrap.style.display=''; wrap.classList.remove('visible'); void wrap.offsetWidth; wrap.classList.add('visible');
    setTimeout(()=>{
      document.getElementById('rScaleFill').style.width=pct;
      document.getElementById('rNeedle').style.left=pct;
    },120);
    const radarRows=rec.rows.filter(r=>r.tbm!=null);
    if (radarRows.length) setTimeout(()=>drawRadar(radarRows,rnk),200);
    document.getElementById('btnPdf').disabled=false;
  }
  window.scrollTo({top:0,behavior:'smooth'});
  showToast(' np kt qu ca '+rec.ten);
}
function xoaRec(idx,e) {
  e.stopPropagation();
  const arr=docLS(); arr.splice(idx,1); ghiLS(arr); renderLichSu(); showToast(' xo bn ghi',false);
}
function xoaTatCa() {
  if (!confirm('Xo ton b lch s?')) return;
  ghiLS([]); renderLichSu(); showToast(' xo tt c',false);
}

/*  NHP LI  */
function nhapLai() {
  document.getElementById('tenHS').value='';
  MON.forEach(m=>{
    for (let hk=1;hk<=2;hk++) {
      const n=txCount[m.id][hk];
      for (let i=0;i<n;i++) { const el=document.getElementById(`tx${hk}_${m.id}_${i}`); if(el) el.value=''; }
      ['gk','ck'].forEach(p=>{ const el=document.getElementById(`${p}${hk}_${m.id}`); if(el) el.value=''; });
    }
    recalcMon(m.id);
    document.getElementById('card_'+m.id).classList.remove('open','has-error');
  });
  document.getElementById('gErr').style.display='none';
  hideResult();
  window.scrollTo({top:0,behavior:'smooth'});
}

/*  STUDY PLANNER  */
const SP_KEY = 'studyPlannerV1';
let spFilter  = 'all';
function spLoad()  { try{return JSON.parse(localStorage.getItem(SP_KEY))||[];}catch(e){return[];} }
function spSave(a) { try{localStorage.setItem(SP_KEY,JSON.stringify(a));}catch(e){} }

function spBuildSubjSelect() {
  ['sp-subj','pomo-subj','tt-subj','tt-edit-subj'].forEach(id=>{
    const sel=document.getElementById(id);
    if (sel) sel.innerHTML=MON.map(m=>`<option value="${m.id}">${m.ico} ${m.ten}</option>`).join('');
  });
}

function spSetFilter(f, btn) {
  spFilter=f;
  document.querySelectorAll('.sp-filter-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  spRender();
}

function spAddTask() {
  const subj  = document.getElementById('sp-subj').value;
  const title = document.getElementById('sp-title').value.trim();
  const date  = document.getElementById('sp-date').value;
  if (!title) { showToast('Nhp ni dung hc trc nh!',false); return; }
  const tasks=spLoad();
  tasks.unshift({id:Date.now(),subject:subj,title,deadline:date,done:false,createdAt:Date.now()});
  spSave(tasks);
  document.getElementById('sp-title').value='';
  document.getElementById('sp-date').value='';
  spRender();
  showToast(' thm k hoch!');
}

function spToggleDone(id) {
  const tasks=spLoad();
  const t=tasks.find(x=>x.id===id);
  if (t) {
    t.done=!t.done;
    t.doneAt=t.done?Date.now():null;
    spSave(tasks);
    spUpdateStreak();
    spRender();
  }
}

function spDelete(id) {
  const el=document.querySelector(`[data-id="${id}"]`);
  if (el) {
    el.classList.add('task-exit');
    setTimeout(()=>{
      spSave(spLoad().filter(x=>x.id!==id));
      spUpdateStreak();
      spRender();
    }, 240);
  } else {
    spSave(spLoad().filter(x=>x.id!==id));
    spRender();
  }
  showToast(' xo task',false);
}

function spDeadlineLabel(dl) {
  if (!dl) return '';
  const today=new Date(); today.setHours(0,0,0,0);
  const d=new Date(dl+'T00:00:00');
  const diff=Math.round((d-today)/(1000*60*60*24));
  if (diff<0)   return {txt:`Qu hn ${-diff} ngy`,cls:'overdue'};
  if (diff===0) return {txt:'Hm nay!',cls:'today'};
  if (diff===1) return {txt:'Ngy mai',cls:''};
  return {txt:`Cn ${diff} ngy`,cls:''};
}

/*  STREAK  */
const STREAK_KEY='studyPlannerStreakV1';
function streakLoad() {
  try{return JSON.parse(localStorage.getItem(STREAK_KEY))||{current:0,lastDate:null};}
  catch(e){return{current:0,lastDate:null};}
}
function streakSave(s){try{localStorage.setItem(STREAK_KEY,JSON.stringify(s));}catch(e){}}
function dayDiff(a,b){return Math.round((new Date(b)-new Date(a))/86400000);}

function spUpdateStreak() {
  const tasks=spLoad();
  const today=todayStr();
  const doneDays=new Set(tasks.filter(t=>t.done).map(t=>{
    const ts=t.doneAt||t.createdAt;
    const d=new Date(ts);
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }));
  let streak=streakLoad();
  if (doneDays.has(today)) {
    if (!streak.lastDate) streak={current:1,lastDate:today};
    else if (streak.lastDate!==today) {
      const diff=dayDiff(streak.lastDate,today);
      streak={current:diff===1?streak.current+1:1,lastDate:today};
    }
  } else if (streak.lastDate && dayDiff(streak.lastDate,today)>1) {
    streak={current:0,lastDate:null};
  }
  streakSave(streak);
  spRenderStreak(streak);
}

function spRenderStreak(streak) {
  if (!streak) streak=streakLoad();
  document.getElementById('streak-count').innerHTML=`${streak.current} <span>ngy</span>`;
  document.getElementById('streak-badge').style.display=streak.current>=7?'':'none';
}

/*  7-DAY HEATMAP  */
const DAY_LABELS=['CN','T2','T3','T4','T5','T6','T7'];
function spRenderHeatmap() {
  const tasks=spLoad();
  const today=new Date(); today.setHours(0,0,0,0);
  const days=[];
  for (let i=6;i>=0;i--){const d=new Date(today);d.setDate(d.getDate()-i);days.push(d);}
  const doneDaySet=new Set(tasks.filter(t=>t.done).map(t=>{
    const d=new Date(t.doneAt||t.createdAt); d.setHours(0,0,0,0); return d.getTime();
  }));
  const todayTime=today.getTime();
  document.getElementById('heatmap-grid').innerHTML=days.map(d=>{
    const isToday=d.getTime()===todayTime;
    const hasDone=doneDaySet.has(d.getTime());
    const cnt=tasks.filter(t=>{
      if(!t.done)return false;
      const dd=new Date(t.doneAt||t.createdAt);dd.setHours(0,0,0,0);
      return dd.getTime()===d.getTime();
    }).length;
    return `<div class="hm-day">
      <span class="hm-label">${DAY_LABELS[d.getDay()]}</span>
      <div class="hm-cell ${hasDone?'hm-done':'hm-empty'}${isToday?' hm-today':''}"
        title="${d.getDate()}/${d.getMonth()+1}${hasDone?'  '+cnt+' task':''}">${hasDone?cnt:''}</div>
    </div>`;
  }).join('');
}

/*  spRender  */
function spRender() {
  const all=spLoad();
  const today=new Date(); today.setHours(0,0,0,0);
  document.getElementById('sp-total').textContent    = all.length;
  document.getElementById('sp-done-cnt').textContent = all.filter(t=>t.done).length;
  document.getElementById('sp-pending').textContent  = all.filter(t=>!t.done).length;
  document.getElementById('sp-overdue').textContent  = all.filter(t=>!t.done&&t.deadline&&new Date(t.deadline+'T00:00:00')<today).length;
  spUpdateStreak();
  spRenderHeatmap();

  let tasks=all;
  if (spFilter==='done')    tasks=all.filter(t=>t.done);
  if (spFilter==='pending') tasks=all.filter(t=>!t.done);
  if (spFilter==='overdue') tasks=all.filter(t=>!t.done&&t.deadline&&new Date(t.deadline+'T00:00:00')<today);

  const list=document.getElementById('sp-list');
  if (!tasks.length) {
    list.innerHTML=`<div class="sp-empty"><span class="sp-empty-ico"></span>Cha c k hoch no${spFilter!=='all'?' trong mc ny':''}</div>`;
    return;
  }
  list.innerHTML=tasks.map(t=>{
    const mon=MON.find(m=>m.id===t.subject)||MON[0];
    const dl=spDeadlineLabel(t.deadline);
    const dlHtml=t.deadline
      ?`<span class="sp-deadline ${dl.cls}"> ${t.deadline.split('-').reverse().join('/')}  ${dl.txt}</span>`:'';
    return `<div class="sp-task${t.done?' done':''} task-enter" data-id="${t.id}">
      <div class="sp-cb${t.done?' checked':''}" onclick="spToggleDone(${t.id})">${t.done?'':''}</div>
      <div class="sp-task-body">
        <div class="sp-task-top">
          <span class="sp-task-subj">${mon.ico} ${mon.ten}</span>
          <span class="sp-task-title">${t.title}</span>
        </div>
        <div class="sp-task-meta">${dlHtml}</div>
      </div>
      <button class="sp-task-del" onclick="spDelete(${t.id})"></button>
    </div>`;
  }).join('');
}

/*  SOUND ENGINE  */
let audioCtx = null;
function getAudioCtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  return audioCtx;
}
function pomoPlaySound(type) {
  const enabled = document.getElementById('sound-enabled').checked;
  if (!enabled) return;
  const vol = parseFloat(document.getElementById('sound-vol').value);
  try {
    const ctx = getAudioCtx();
    if (ctx.state === 'suspended') ctx.resume();
    const gain = ctx.createGain();
    gain.gain.setValueAtTime(vol, ctx.currentTime);
    gain.connect(ctx.destination);
    if (type === 'bell') {
      const osc = ctx.createOscillator();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(880, ctx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(440, ctx.currentTime+0.8);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+1.2);
      osc.connect(gain); osc.start(); osc.stop(ctx.currentTime+1.2);
    } else if (type === 'chime') {
      [523,659,784].forEach((freq,i)=>{
        const o=ctx.createOscillator(), g=ctx.createGain();
        o.type='triangle'; o.frequency.value=freq;
        g.gain.setValueAtTime(0,ctx.currentTime+i*0.18);
        g.gain.linearRampToValueAtTime(vol,ctx.currentTime+i*0.18+0.05);
        g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+i*0.18+0.5);
        o.connect(g); g.connect(ctx.destination);
        o.start(ctx.currentTime+i*0.18); o.stop(ctx.currentTime+i*0.18+0.5);
      });
    } else {
      const o=ctx.createOscillator();
      o.type='square'; o.frequency.value=1000;
      gain.gain.setValueAtTime(vol*0.4,ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.2);
      o.connect(gain); o.start(); o.stop(ctx.currentTime+0.22);
    }
  } catch(e){ console.warn('Audio error:',e); }
}
function pomoSoundToggle() {
  const on = document.getElementById('sound-enabled').checked;
  document.getElementById('sound-icon').textContent = on ? '' : '';
  document.getElementById('sound-toggle-txt').textContent = on ? 'm thanh bt' : 'm thanh tt';
}
function pomoNotify(msg) {
  if (document.visibilityState === 'visible') return;
  if (!('Notification' in window)) return;
  if (Notification.permission === 'granted') {
    new Notification(' Study System PRO', {body: msg, icon: ''});
  } else if (Notification.permission !== 'denied') {
    Notification.requestPermission().then(p=>{ if(p==='granted') new Notification(' Study System PRO',{body:msg}); });
  }
}

/*  POMODORO  */
const TIMER_LOG_KEY='studyTimerLogsV1';
const CIRC=2*Math.PI*52;
let pomoState={running:false,phase:'ready',remaining:0,total:0,interval:null,subject:'toan'};
let pomoHiddenAt = null;
const MAX_HIDDEN_SEC = 300;

function timerLogLoad(){try{return JSON.parse(localStorage.getItem(TIMER_LOG_KEY))||[];}catch(e){return[];}}
function timerLogSave(a){try{localStorage.setItem(TIMER_LOG_KEY,JSON.stringify(a));}catch(e){}}

function pomoFmt(s){
  return `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
}
function pomoUpdateRing(remaining,total,phase){
  const fill=document.getElementById('pomo-ring-fill'); if(!fill)return;
  fill.style.strokeDashoffset=CIRC*(total>0?remaining/total:1);
  fill.className='pomo-ring-fill'+(phase==='break'?' phase-break':' phase-ready');
}
function pomoSetDisplay(remaining,total,phase){
  const clock=document.getElementById('pomo-clock');
  const phaseEl=document.getElementById('pomo-phase');
  if(clock)clock.textContent=pomoFmt(remaining);
  if(phaseEl)phaseEl.textContent=phase==='study'?' ang hc':phase==='break'?' ang ngh':' Sn sng';
  pomoUpdateRing(remaining,total,phase);
}
function pomoLogSession(subject,minutes){
  const logs=timerLogLoad();
  logs.push({subject,minutes,date:todayStr(),timestamp:Date.now()});
  timerLogSave(logs);
  const today=todayStr();
  const todayMins=logs.filter(l=>l.date===today).reduce((s,l)=>s+l.minutes,0);
  if (todayMins>=30) {
    const tasks=spLoad();
    const already=tasks.some(t=>{
      if(!t.done)return false;
      const d=new Date(t.doneAt||t.createdAt);d.setHours(0,0,0,0);
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`===today;
    });
    if(!already){
      tasks.push({id:Date.now(),subject,title:`[Timer] ${minutes} pht`,deadline:'',
        done:true,createdAt:Date.now(),doneAt:Date.now(),_timerGenerated:true});
      spSave(tasks);spUpdateStreak();spRenderHeatmap();
    }
  }
  pomoRenderStats();
}
function pomoRenderStats(){
  const logs=timerLogLoad();
  document.getElementById('ps-total-min').textContent=logs.reduce((s,l)=>s+l.minutes,0);
  document.getElementById('ps-sessions').textContent=logs.length;
  if(logs.length){
    const bySubj={};
    logs.forEach(l=>{bySubj[l.subject]=(bySubj[l.subject]||0)+l.minutes;});
    const topId=Object.entries(bySubj).sort((a,b)=>b[1]-a[1])[0][0];
    const topMon=MON.find(m=>m.id===topId);
    document.getElementById('ps-top-subj').textContent=topMon?`${topMon.ico} ${topMon.ten}`:'';
  }
}
function pomoStart(){
  if(pomoState.running)return;
  const studyMin=parseInt(document.getElementById('pomo-study').value)||25;
  const subj=document.getElementById('pomo-subj').value;
  if(pomoState.phase==='ready'){
    pomoState.phase='study';
    pomoState.remaining=studyMin*60;
    pomoState.total=studyMin*60;
    pomoState.subject=subj;
  }
  pomoState.running=true;
  document.getElementById('pomo-btn-start').style.display='none';
  document.getElementById('pomo-btn-pause').style.display='';
  pomoSetDisplay(pomoState.remaining,pomoState.total,pomoState.phase);
  pomoState.interval=setInterval(()=>{
    pomoState.remaining--;
    pomoSetDisplay(pomoState.remaining,pomoState.total,pomoState.phase);
    if(pomoState.remaining<=0){
      clearInterval(pomoState.interval);
      pomoState.running=false;
      const soundType=document.getElementById('sound-type').value;
      if(pomoState.phase==='study'){
        pomoPlaySound(soundType);
        pomoNotify('Ht gi hc! Ngh ngi i no ');
        pomoLogSession(pomoState.subject,Math.round(pomoState.total/60));
        const breakMin=parseInt(document.getElementById('pomo-break').value)||5;
        pomoState.phase='break'; pomoState.remaining=breakMin*60; pomoState.total=breakMin*60;
        pomoSetDisplay(pomoState.remaining,pomoState.total,'break');
        setTimeout(pomoStart,300);
      } else {
        pomoPlaySound(soundType);
        pomoNotify('Ht gi ngh! Bt u hc thi ');
        const sm=parseInt(document.getElementById('pomo-study').value)||25;
        pomoState.phase='study'; pomoState.remaining=sm*60; pomoState.total=sm*60;
        pomoSetDisplay(pomoState.remaining,pomoState.total,'study');
        setTimeout(pomoStart,300);
      }
    }
  },1000);
}
function pomoPause(){
  if(!pomoState.running)return;
  clearInterval(pomoState.interval);
  pomoState.running=false;
  const btn=document.getElementById('pomo-btn-start');
  btn.style.display=''; btn.textContent=' Tip tc';
  document.getElementById('pomo-btn-pause').style.display='none';
}
function pomoReset(){
  clearInterval(pomoState.interval);
  pomoState={running:false,phase:'ready',remaining:0,total:0,interval:null,subject:'toan'};
  const studyMin=parseInt(document.getElementById('pomo-study').value)||25;
  document.getElementById('pomo-clock').textContent=pomoFmt(studyMin*60);
  document.getElementById('pomo-phase').textContent=' Sn sng';
  const btn=document.getElementById('pomo-btn-start');
  btn.style.display=''; btn.textContent=' Start';
  document.getElementById('pomo-btn-pause').style.display='none';
  const fill=document.getElementById('pomo-ring-fill');
  if(fill){fill.style.strokeDashoffset=CIRC;fill.className='pomo-ring-fill phase-ready';}
}
document.addEventListener('visibilitychange',()=>{
  if(document.hidden){
    pomoHiddenAt=Date.now();
  } else {
    if(pomoHiddenAt&&pomoState.running){
      const elapsed=Math.floor((Date.now()-pomoHiddenAt)/1000);
      if(elapsed>MAX_HIDDEN_SEC){
        pomoPause();
        showToast(' T ng tm dng do chuyn tab qu lu',false);
      } else {
        pomoState.remaining=Math.max(0,pomoState.remaining-elapsed);
        pomoSetDisplay(pomoState.remaining,pomoState.total,pomoState.phase);
      }
    }
    pomoHiddenAt=null;
  }
});
document.addEventListener('DOMContentLoaded',()=>{
  const inp=document.getElementById('pomo-study');
  if(inp) inp.addEventListener('input',()=>{
    if(pomoState.phase==='ready'){
      document.getElementById('pomo-clock').textContent=pomoFmt((parseInt(inp.value)||25)*60);
    }
  });
  if('Notification' in window && Notification.permission==='default'){
    Notification.requestPermission();
  }
});

/*  TIMETABLE  */
const TT_KEY='studyTimetableV1';
const DAY_NAMES=['CN','T2','T3','T4','T5','T6','T7'];
function ttLoad(){try{return JSON.parse(localStorage.getItem(TT_KEY))||[];}catch(e){return[];}}
function ttSave(a){try{localStorage.setItem(TT_KEY,JSON.stringify(a));}catch(e){}}
function ttAutoColon(inp){
  let v=inp.value.replace(/[^0-9]/g,'');
  if(v.length>4)v=v.slice(0,4);
  if(v.length>=3)v=v.slice(0,2)+':'+v.slice(2);
  inp.value=v;
  inp.classList.remove('err');
}
function ttValidate24h(str){
  if(!str||!/^\d{2}:\d{2}$/.test(str))return false;
  const[hh,mm]=str.split(':').map(Number);
  return hh>=0&&hh<=23&&mm>=0&&mm<=59;
}
function ttHasConflict(items,day,start,end,excludeId=null){
  return items.some(it=>{
    if(it.id===excludeId)return false;
    if(it.day!==day)return false;
    return !(end<=it.start||start>=it.end);
  });
}
function ttAdd(){
  const subj=document.getElementById('tt-subj').value;
  const day=parseInt(document.getElementById('tt-day').value);
  const start=document.getElementById('tt-start').value.trim();
  const end=document.getElementById('tt-end').value.trim();
  let ok=true;
  if(!ttValidate24h(start)){document.getElementById('tt-start').classList.add('err');ok=false;}
  if(!ttValidate24h(end)){document.getElementById('tt-end').classList.add('err');ok=false;}
  if(!ok){showToast('Gi phi ng nh dng HH:MM (00:0023:59)!',false);return;}
  if(start>=end){showToast('Gi kt thc phi sau gi bt u!',false);return;}
  const items=ttLoad();
  if(ttHasConflict(items,day,start,end)){
    showToast(' Trng gi vi lch hc khc trong ngy!',false);return;
  }
  const newItem={id:Date.now(),subject:subj,day,start,end};
  items.push(newItem);
  items.sort((a,b)=>a.day!==b.day?a.day-b.day:a.start.localeCompare(b.start));
  ttSave(items);
  document.getElementById('tt-start').value='';
  document.getElementById('tt-end').value='';
  ttRender(newItem.id);
  showToast(' thm lch hc!');
}
function ttDelete(id){
  const el=document.querySelector(`.tt-item[data-id="${id}"]`);
  if(el){
    el.classList.add('tt-exit');
    setTimeout(()=>{ttSave(ttLoad().filter(x=>x.id!==id));ttRender();},240);
  } else {
    ttSave(ttLoad().filter(x=>x.id!==id));ttRender();
  }
  showToast(' xo lch hc',false);
}
function ttEdit(id){
  const items=ttLoad();
  const it=items.find(x=>x.id===id); if(!it)return;
  document.getElementById('tt-edit-id').value=id;
  document.getElementById('tt-edit-subj').value=it.subject;
  document.getElementById('tt-edit-day').value=it.day;
  document.getElementById('tt-edit-start').value=it.start;
  document.getElementById('tt-edit-end').value=it.end;
  document.getElementById('tt-modal-overlay').classList.add('open');
}
function ttCloseModal(){document.getElementById('tt-modal-overlay').classList.remove('open');}
function ttSaveEdit(){
  const id=parseInt(document.getElementById('tt-edit-id').value);
  const subj=document.getElementById('tt-edit-subj').value;
  const day=parseInt(document.getElementById('tt-edit-day').value);
  const start=document.getElementById('tt-edit-start').value.trim();
  const end=document.getElementById('tt-edit-end').value.trim();
  let ok=true;
  if(!ttValidate24h(start)){document.getElementById('tt-edit-start').classList.add('err');ok=false;}
  if(!ttValidate24h(end)){document.getElementById('tt-edit-end').classList.add('err');ok=false;}
  if(!ok){showToast('Gi khng hp l!',false);return;}
  if(start>=end){showToast('Gi kt thc phi sau bt u!',false);return;}
  const items=ttLoad();
  if(ttHasConflict(items,day,start,end,id)){showToast(' Trng gi!',false);return;}
  const idx=items.findIndex(x=>x.id===id);
  if(idx>=0){items[idx]={id,subject:subj,day,start,end};}
  items.sort((a,b)=>a.day!==b.day?a.day-b.day:a.start.localeCompare(b.start));
  ttSave(items);ttCloseModal();ttRender();showToast(' cp nht lch hc!');
}
function ttRender(newId=null){
  const items=ttLoad();
  const list=document.getElementById('tt-list'); if(!list)return;
  const todayDay=new Date().getDay();
  if(!items.length){list.innerHTML='<div class="tt-empty"> Cha c lch hc no</div>';return;}
  list.innerHTML=items.map(it=>{
    const mon=MON.find(m=>m.id===it.subject)||MON[0];
    const isToday=it.day===todayDay;
    const animate=it.id===newId?' tt-enter':'';
    return `<div class="tt-item${isToday?' tt-today-item':''}${animate}" data-id="${it.id}">
      <span class="tt-day-badge${isToday?' tt-today':''}">${DAY_NAMES[it.day]}</span>
      <span class="tt-subj">${mon.ico} ${mon.ten}</span>
      <span class="tt-time"> ${it.start}  ${it.end}</span>
      <div class="tt-actions-row">
        <button class="tt-btn edit" onclick="ttEdit(${it.id})"> Sa</button>
        <button class="tt-btn del"  onclick="ttDelete(${it.id})"></button>
      </div>
    </div>`;
  }).join('');
}

/*  ANALYTICS  */
function anWeekRange(offset=0){
  const now=new Date(); now.setHours(0,0,0,0);
  const day=now.getDay();
  const monday=new Date(now); monday.setDate(now.getDate()-((day+6)%7)+offset*7);
  const sunday=new Date(monday); sunday.setDate(monday.getDate()+6);
  return{start:monday,end:sunday};
}
function anDateKey(d){
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function anRender(){
  const logs=timerLogLoad();
  const tasks=spLoad();
  const thisWeek=anWeekRange(0);
  const lastWeek=anWeekRange(-1);
  const thisWeekMins=logs.filter(l=>{
    const d=new Date(l.timestamp); d.setHours(0,0,0,0);
    return d>=thisWeek.start&&d<=thisWeek.end;
  }).reduce((s,l)=>s+l.minutes,0);
  const lastWeekMins=logs.filter(l=>{
    const d=new Date(l.timestamp); d.setHours(0,0,0,0);
    return d>=lastWeek.start&&d<=lastWeek.end;
  }).reduce((s,l)=>s+l.minutes,0);
  document.getElementById('an-week-hrs').textContent=`${Math.floor(thisWeekMins/60)}h ${thisWeekMins%60}p`;
  document.getElementById('an-week-min').textContent=`${thisWeekMins} pht hc`;
  const compareEl=document.getElementById('an-week-compare');
  if(lastWeekMins===0){
    compareEl.textContent=' Cha c d liu tun trc';
    compareEl.className='an-compare same';
  } else {
    const diff=thisWeekMins-lastWeekMins;
    const pct=Math.abs(Math.round(diff/lastWeekMins*100));
    compareEl.className='an-compare '+(diff>=0?'up':'down');
    compareEl.textContent=(diff>=0?' Tng ':' Gim ')+pct+'% so vi tun trc';
  }
  const bySubj={};
  logs.forEach(l=>{bySubj[l.subject]=(bySubj[l.subject]||0)+l.minutes;});
  if(Object.keys(bySubj).length){
    const topId=Object.entries(bySubj).sort((a,b)=>b[1]-a[1])[0][0];
    const topMon=MON.find(m=>m.id===topId);
    document.getElementById('an-top-subj').textContent=topMon?`${topMon.ico} ${topMon.ten}`:'';
    document.getElementById('an-top-min').textContent=`${bySubj[topId]} pht tng cng`;
  } else {
    document.getElementById('an-top-subj').textContent='';
    document.getElementById('an-top-min').textContent='Cha c d liu';
  }
  const total=tasks.length, done=tasks.filter(t=>t.done).length;
  const pct=total?Math.round(done/total*100):0;
  const PROG_CIRC=201;
  document.getElementById('an-prog-fill').style.strokeDashoffset=PROG_CIRC*(1-pct/100);
  document.getElementById('an-prog-pct').textContent=pct+'%';
  const streak=streakLoad();
  document.getElementById('an-pomo-streak').textContent=streak.current;
  anRender30Heatmap(logs);
  anRenderBarChart(logs);
  anRenderDoughnut(bySubj);
}
function anRender30Heatmap(logs){
  const grid=document.getElementById('hm30-grid'); if(!grid)return;
  const today=new Date(); today.setHours(0,0,0,0);
  const dayMins={};
  logs.forEach(l=>{dayMins[l.date]=(dayMins[l.date]||0)+l.minutes;});
  const all30=[];
  for(let i=29;i>=0;i--){const d=new Date(today);d.setDate(d.getDate()-i);all30.push(d);}
  const maxMins=Math.max(1,...Object.values(dayMins));
  const todayKey=anDateKey(today);
  grid.innerHTML=all30.map(d=>{
    const key=anDateKey(d);
    const mins=dayMins[key]||0;
    let lvl='';
    if(mins>0) lvl=mins<maxMins*0.25?'l1':mins<maxMins*0.5?'l2':mins<maxMins*0.75?'l3':'l4';
    const isToday=key===todayKey;
    return `<div class="hm30-cell ${lvl}${isToday?' hm-today':''}"
      title="${d.getDate()}/${d.getMonth()+1}: ${mins} pht"></div>`;
  }).join('');
}
function anRenderBarChart(logs){
  const canvas=document.getElementById('an-bar-chart'); if(!canvas)return;
  const today=new Date(); today.setHours(0,0,0,0);
  const labels=[],data=[];
  for(let i=6;i>=0;i--){
    const d=new Date(today);d.setDate(d.getDate()-i);
    labels.push(`${d.getDate()}/${d.getMonth()+1}`);
    const key=anDateKey(d);
    data.push(logs.filter(l=>l.date===key).reduce((s,l)=>s+l.minutes,0));
  }
  if(anBarChart){anBarChart.destroy();anBarChart=null;}
  const isDark=document.documentElement.getAttribute('data-theme')==='dark';
  const gridCol=isDark?'rgba(200,200,255,.1)':'rgba(99,102,241,.12)';
  const tickCol=isDark?'#5c597e':'#9ca3af';
  anBarChart=new Chart(canvas,{
    type:'bar',
    data:{labels,datasets:[{
      label:'Pht hc',data,
      backgroundColor:'rgba(99,102,241,0.65)',
      borderColor:'rgba(99,102,241,1)',
      borderRadius:6,borderWidth:1.5}]},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{display:false},tooltip:{
        backgroundColor:'rgba(15,14,26,.85)',titleColor:'#e8e6ff',bodyColor:'#a09ec0',
        padding:10,cornerRadius:10}},
      scales:{
        y:{grid:{color:gridCol},ticks:{color:tickCol,font:{size:10,family:'Inter'}},
          title:{display:true,text:'Pht',color:tickCol,font:{size:10}}},
        x:{grid:{display:false},ticks:{color:tickCol,font:{size:10,family:'Inter'}}}
      }}
  });
}
function anRenderDoughnut(bySubj){
  const canvas=document.getElementById('an-doughnut-chart'); if(!canvas)return;
  if(anDoughnut){anDoughnut.destroy();anDoughnut=null;}
  const entries=Object.entries(bySubj).sort((a,b)=>b[1]-a[1]).slice(0,6);
  if(!entries.length){
    document.getElementById('an-legend').innerHTML='<span style="font-size:.8rem;color:var(--tx-3)">Cha c d liu</span>';
    return;
  }
  const COLORS=['#6366f1','#34d399','#f59e0b','#f87171','#60a5fa','#a78bfa'];
  const labels=entries.map(([id])=>{const m=MON.find(x=>x.id===id);return m?m.ten:id;});
  const data=entries.map(([,v])=>v);
  anDoughnut=new Chart(canvas,{
    type:'doughnut',
    data:{labels,datasets:[{data,backgroundColor:COLORS.slice(0,entries.length),
      borderColor:'transparent',borderWidth:0,hoverOffset:6}]},
    options:{responsive:true,maintainAspectRatio:false,cutout:'68%',
      plugins:{legend:{display:false},tooltip:{
        backgroundColor:'rgba(15,14,26,.85)',titleColor:'#e8e6ff',bodyColor:'#a09ec0',
        padding:10,cornerRadius:10,callbacks:{
          label:ctx=>`${ctx.label}: ${ctx.raw} pht`}}}}
  });
  document.getElementById('an-legend').innerHTML=entries.map(([id,mins],i)=>{
    const m=MON.find(x=>x.id===id);
    return `<div style="display:flex;align-items:center;gap:7px;">
      <span style="width:10px;height:10px;border-radius:50%;background:${COLORS[i]};flex-shrink:0;display:inline-block;"></span>
      <span style="font-size:.75rem;font-weight:600;color:var(--tx-1)">${m?m.ico+' '+m.ten:id}</span>
      <span style="font-size:.72rem;color:var(--tx-3);margin-left:auto">${mins}p</span>
    </div>`;
  }).join('');
}

/*  AUTO REMINDER  */
function checkReminder(){
  const items=ttLoad();
  const now=new Date();
  const todayDay=now.getDay();
  const nowMin=now.getHours()*60+now.getMinutes();
  const upcoming=items.filter(it=>{
    if(it.day!==todayDay)return false;
    const[h,m]=it.start.split(':').map(Number);
    return(h*60+m)>nowMin;
  });
  if(!upcoming.length)return;
  const next=upcoming[0];
  const mon=MON.find(m=>m.id===next.subject)||MON[0];
  setTimeout(()=>showToast(` Hm nay c lch hc ${mon.ten} lc ${next.start}`),800);
}

/* 
   AI MODULE  GEMINI (FIXED: No AbortController)
 */

const GEMINI_API_KEY_STORAGE = 'geminiApiKey_v1';
const GEMINI_PROFILE_KEY = 'studentProfile_v1';
let _geminiKey = '';
let _studentProfile = { grade: '', textbook: '', track: '' };
let _aiPlanPreview = [];
let _aiTestAnswers = {};
let _aiTestData = [];
let _aiTestSubmitted = false;
let _chatHistory = [];

function aiLoadKeyStatus() {
  try { _geminiKey = localStorage.getItem(GEMINI_API_KEY_STORAGE) || ''; } catch(e) {}
  const inp = document.getElementById('ai-api-key-inp');
  const status = document.getElementById('ai-key-status');
  if (_geminiKey) {
    inp.value = _geminiKey;
    status.textContent = ' API Key  lu  AI Gemini sn sng!';
    status.className = 'ai-key-status ok';
  } else {
    status.textContent = ' Cha c API Key  AI Gemini cha hot ng';
    status.className = 'ai-key-status missing';
  }
}
function aiSaveKey() {
  const v = document.getElementById('ai-api-key-inp').value.trim();
  if (!v) { showToast('Nhp API Key trc!', false); return; }
  _geminiKey = v;
  try { localStorage.setItem(GEMINI_API_KEY_STORAGE, v); } catch(e) {}
  aiLoadKeyStatus();
  showToast(' lu API Key!');
}

function aiLoadProfile() {
  try {
    const p = JSON.parse(localStorage.getItem(GEMINI_PROFILE_KEY));
    if (p) {
      _studentProfile = p;
      if (p.grade)    document.getElementById('profile-grade').value    = p.grade;
      if (p.textbook) document.getElementById('profile-textbook').value = p.textbook;
      if (p.track)    document.getElementById('profile-track').value    = p.track;
      _renderProfileStatus();
    }
  } catch(e) {}
}
function aiSaveProfile() {
  _studentProfile = {
    grade:    document.getElementById('profile-grade').value,
    textbook: document.getElementById('profile-textbook').value,
    track:    document.getElementById('profile-track').value,
  };
  try { localStorage.setItem(GEMINI_PROFILE_KEY, JSON.stringify(_studentProfile)); } catch(e) {}
  _renderProfileStatus();
}
function _renderProfileStatus() {
  const el = document.getElementById('profile-status');
  const { grade, textbook, track } = _studentProfile;
  if (grade && textbook && track) {
    el.textContent = ` Lp ${grade}  ${textbook}  Ban ${track}`;
    el.style.color = '#059669';
  } else {
    el.textContent = ' Hy chn y  lp, b sch v ban hc';
    el.style.color = '#f87171';
  }
}

function _aiLoading(html='ang gi AI Gemini') {
  return `<div class="ai-loading">
    <div class="ai-loading-dots"><span></span><span></span><span></span></div>
    <span>${html}</span>
  </div>`;
}

/*  FIXED callGemini: No AbortController, no signal  */
async function callGemini(prompt) {
  if (!_geminiKey) throw new Error('NO_KEY');
  const url = `https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${_geminiKey}`;
  const body = JSON.stringify({
    contents: [{ parts: [{ text: prompt }] }],
    generationConfig: { temperature: 0.7, maxOutputTokens: 1800 }
  });
  const resp = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: body
  });
  if (!resp.ok) {
    let errMsg = `HTTP ${resp.status}`;
    try {
      const errData = await resp.json();
      errMsg = errData?.error?.message || errMsg;
    } catch(_) {}
    throw new Error(errMsg);
  }
  const data = await resp.json();
  const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || '';
  return text;
}

function _geminiErrMsg(e) {
  if (e.message === 'NO_KEY') return ' Cha c API Key. Hy nhp key  phn u tab AI.';
  if (e.message?.includes('API_KEY_INVALID')) return ' API Key khng hp l. Kim tra li!';
  return ` Li: ${e.message}`;
}

function _setAiBtnsDisabled(flag) {
  ['btn-ai-analysis','btn-ai-plan','btn-ai-test','btn-chat-send'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.disabled=flag;
  });
}

function aiInitTestSubjSelect() {
  const sel = document.getElementById('ai-test-subj');
  if (!sel) return;
  sel.innerHTML = MON.map(m => `<option value="${m.id}">${m.ico} ${m.ten}</option>`).join('');
}

function _addDays(base, n) {
  const d = new Date(base); d.setDate(d.getDate() + n);
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

/*  BLOCK A: Phn tch hc lc  */
async function aiRunAnalysis() {
  const el = document.getElementById('ai-analysis-content');
  if (!currentResult || !currentResult.rows || !currentResult.rows.length) {
    el.innerHTML = `<div class="ai-no-data"><span class="ai-nd-ico"></span>Hy tnh kt qu  tab <strong>Hc lc</strong> trc.</div>`;
    return;
  }
  const rows = currentResult.rows.filter(r => r.tbm !== null);
  if (!rows.length) return;
  el.innerHTML = _aiLoading('ang phn tch hc lc');
  _setAiBtnsDisabled(true);
  const { grade, textbook, track } = _studentProfile;
  const scoreLines = rows.map(r => `- ${r.m.ten}: ${r.tbm.toFixed(2)}`).join('\n');
  const rnkLbl = rankOf(currentResult.dtb).lbl;
  const prompt = `Bn l gio vin ch nhim Vit Nam, chuyn t vn hc sinh THCS/THPT.
Hc sinh: ${currentResult.ten || 'Hc sinh'}
Lp: ${grade || 'Cha xc nh'} | B sch: ${textbook || 'Cha xc nh'} | Ban: ${track || 'Cha xc nh'}
im trung bnh c nm cc mn:
${scoreLines}
TBM chung: ${currentResult.dtb.toFixed(2)}  Xp loi: ${rnkLbl}

YU CU: Hy nhn xt v phn tch hc lc theo 3 phn r rng:
1. NHN XT TNG QUAN (2-3 cu, thc t, khng ngi ni thng nu kt qu km)
2. PHN TCH CC MN YU (lit k v gii thch ti sao cn ci thin)
3. 3 HNH NG C TH (thc t, ng chng trnh lp ${grade||''}, khng ni chung chung)

Lu :
- Nu TBM <5: cnh bo nghim tc, khng an i ho
- Nu TBM <6.5: khng c ni "tip tc pht huy" hay "duy tr phong "
- Tr li bng ting Vit, ngn gn, thn thin nhng thc t
- KHNG dng markdown (**) hay bullet (-)`;
  try {
    const resp = await callGemini(prompt);
    el.innerHTML = `<div class="ai-gemini-resp">${resp.trim()}</div>`;
    showToast('AI Gemini  phn tch xong!');
  } catch(e) {
    el.innerHTML = `<div class="ai-no-data"><span class="ai-nd-ico"></span>${_geminiErrMsg(e)}</div>`;
  } finally {
    _setAiBtnsDisabled(false);
  }
}

/*  BLOCK B: K hoch 14 ngy  */
async function aiGenPlan() {
  const el = document.getElementById('ai-plan-content');
  const pushBtn = document.getElementById('ai-push-btn');
  pushBtn.disabled = true;
  _aiPlanPreview = [];
  if (!currentResult || !currentResult.rows || !currentResult.rows.length) {
    el.innerHTML = `<div class="ai-no-data"><span class="ai-nd-ico"></span>Cn c kt qu im trc.</div>`;
    return;
  }
  const rows = currentResult.rows.filter(r => r.tbm !== null);
  if (!rows.length) return;
  const sorted = [...rows].sort((a,b) => a.tbm - b.tbm);
  const weak = sorted.slice(0, Math.min(3, sorted.length));
  el.innerHTML = _aiLoading('ang to k hoch 14 ngy');
  _setAiBtnsDisabled(true);
  const { grade, textbook, track } = _studentProfile;
  const weakLines = weak.map(w => `${w.m.ten} (${w.tbm.toFixed(2)})`).join(', ');
  const prompt = `Bn l gio vin lp k hoch hc tp cho hc sinh Vit Nam.
Lp: ${grade||'THPT'} | Sch: ${textbook||'chng trnh chun'} | Ban: ${track||'c bn'}
Cc mn yu cn n: ${weakLines}

To k hoch hc 14 ngy lin tip, mi ngy 1 nhim v, xen k cc mn yu.
Tr li CHNH XC theo nh dng JSON sau (khng c markdown, khng gii thch thm):
[
  {"day":1,"subject":"tn mn","task":"ni dung nhim v c th (15-40 t)"},
  {"day":2,"subject":"tn mn","task":"..."},
  ...
  {"day":14,"subject":"tn mn","task":"..."}
]
Ch tr v JSON, khng thm g khc.`;
  try {
    const resp = await callGemini(prompt);
    const clean = resp.replace(/```json|```/g,'').trim();
    let plan;
    try { plan = JSON.parse(clean); } catch(pe) {
      throw new Error('JSON parse failed: ' + pe.message);
    }
    if (!Array.isArray(plan) || !plan.length) throw new Error('K hoch rng');
    const today = new Date(); today.setHours(0,0,0,0);
    _aiPlanPreview = plan.map((p,i) => {
      const matchMon = MON.find(m => m.ten.toLowerCase() === (p.subject||'').toLowerCase()) ||
                       weak[i % weak.length].m;
      return {
        subject: matchMon.id,
        title: `[AI] ${p.task}`,
        deadline: _addDays(today, (p.day||i+1)),
        day: p.day||i+1,
        subjLabel: `${matchMon.ico} ${matchMon.ten}`,
      };
    });
    el.innerHTML = `
      <div style="font-size:.8rem;color:var(--tx-2);font-weight:600;margin-bottom:10px;
        padding:8px 12px;background:var(--bg-rdtip);border-radius:10px;">
         Tp trung: ${weak.map(w=>`<strong>${w.m.ico} ${w.m.ten}</strong>`).join('  ')}
      </div>
      <div class="ai-plan-grid">
        ${_aiPlanPreview.map((t,i)=>`
          <div class="ai-plan-item" style="--i:${i}">
            <span class="ai-plan-day">Ngy ${t.day}</span>
            <span class="ai-plan-subj">${t.subjLabel}</span>
            <span class="ai-plan-title">${t.title.replace('[AI] ','')}</span>
            <span style="font-size:.68rem;color:var(--tx-3);white-space:nowrap"> ${t.deadline.split('-').reverse().join('/')}</span>
          </div>`).join('')}
      </div>`;
    pushBtn.disabled = false;
    showToast('AI  to k hoch 14 ngy!');
  } catch(e) {
    el.innerHTML = `<div class="ai-no-data"><span class="ai-nd-ico"></span>${_geminiErrMsg(e)}</div>`;
  } finally {
    _setAiBtnsDisabled(false);
  }
}

function aiPushToPlanner() {
  if (!_aiPlanPreview.length) { showToast('Cha c k hoch  thm!', false); return; }
  const tasks = spLoad();
  const now = Date.now();
  _aiPlanPreview.forEach((t, i) => {
    tasks.push({ id: now+i, subject: t.subject, title: t.title,
      deadline: t.deadline, done: false, createdAt: now+i });
  });
  spSave(tasks);
  document.getElementById('ai-push-btn').disabled = true;
  _aiPlanPreview = [];
  showToast(' thm 14 task vo Planner!');
}

/*  BLOCK C: Mini Test  */
async function aiGenTest() {
  const subjId = document.getElementById('ai-test-subj').value;
  const mon = MON.find(m => m.id === subjId) || MON[0];
  const el = document.getElementById('ai-test-content');
  const { grade, textbook, track } = _studentProfile;
  if (!grade) {
    el.innerHTML = `<div class="ai-no-data"><span class="ai-nd-ico"></span>Hy chn lp trong <strong>H s hc tp</strong> trc!</div>`;
    return;
  }
  el.innerHTML = _aiLoading(`Gemini ang to  ${mon.ten} lp ${grade}`);
  _setAiBtnsDisabled(true);
  _aiTestAnswers = {};
  _aiTestData = [];
  _aiTestSubmitted = false;
  const prompt = `Bn l gio vin mn ${mon.ten}, lp ${grade}, b sch ${textbook||'chun'}, ban ${track||'c bn'} Vit Nam.
To NG 5 cu hi trc nghim 4 p n ph hp chng trnh, khng qu kh hoc qu d.
Tr li CHNH XC theo JSON sau (khng markdown, khng gii thch):
[
  {
    "q": "Cu hi 1?",
    "opts": ["A. ...", "B. ...", "C. ...", "D. ..."],
    "ans": 0,
    "exp": "Gii thch ngn gn"
  },
  ...
]
"ans" l ch s 0-3 ca p n ng. Ch tr v JSON.`;
  try {
    const resp = await callGemini(prompt);
    const clean = resp.replace(/```json|```/g,'').trim();
    let qs;
    try { qs = JSON.parse(clean); } catch(pe) { throw new Error('Khng parse c JSON'); }
    if (!Array.isArray(qs) || qs.length < 3) throw new Error(' thi khng  cu');
    _aiTestData = qs.slice(0,5);
    _aiTestSubmitted = false;
    el.innerHTML = `
      <div class="ai-quiz-wrap" id="ai-quiz-wrap">
        ${_aiTestData.map((q,qi)=>`
          <div class="ai-q" id="ai-q-${qi}">
            <div class="ai-q-num">Cu ${qi+1} / ${_aiTestData.length}  ${mon.ico} ${mon.ten}  Lp ${grade}</div>
            <div class="ai-q-text">${q.q}</div>
            <div class="ai-opts">
              ${q.opts.map((opt,oi)=>`
                <div class="ai-opt" id="ai-opt-${qi}-${oi}" onclick="aiSelectOpt(${qi},${oi})">
                  <div class="ai-opt-dot"></div>
                  <span>${opt}</span>
                </div>`).join('')}
            </div>
            <div class="ai-q-explain" id="ai-explain-${qi}"> ${q.exp||''}</div>
          </div>`).join('')}
      </div>
      <div class="ai-score-banner" id="ai-score-banner">
        <span>Kt qu mini test</span>
        <span class="ai-score-big" id="ai-score-val"></span>
        <span id="ai-score-msg" style="font-size:.85rem;color:var(--tx-2)"></span>
      </div>
      <div class="ai-test-actions">
        <button class="btn-ai-submit" onclick="aiSubmitTest()"> Np bi</button>
        <button class="btn-ai-retry"  onclick="aiGenTest()">  mi</button>
      </div>`;
    showToast(` to ${_aiTestData.length} cu ${mon.ten} lp ${grade}!`);
  } catch(e) {
    el.innerHTML = `<div class="ai-no-data"><span class="ai-nd-ico"></span>${_geminiErrMsg(e)}</div>`;
  } finally {
    _setAiBtnsDisabled(false);
  }
}

function aiSelectOpt(qi, oi) {
  if (_aiTestSubmitted) return;
  const prev = _aiTestAnswers[qi];
  if (prev !== undefined) document.getElementById(`ai-opt-${qi}-${prev}`)?.classList.remove('selected');
  _aiTestAnswers[qi] = oi;
  document.getElementById(`ai-opt-${qi}-${oi}`)?.classList.add('selected');
}

function aiSubmitTest() {
  if (_aiTestSubmitted) return;
  const answered = Object.keys(_aiTestAnswers).length;
  if (answered < _aiTestData.length && !confirm(`Cn ${_aiTestData.length - answered} cu cha tr li. Np bi ngay?`)) return;
  _aiTestSubmitted = true;
  let correct = 0;
  _aiTestData.forEach((q, qi) => {
    const chosen = _aiTestAnswers[qi];
    q.opts.forEach((_, oi) => {
      const el = document.getElementById(`ai-opt-${qi}-${oi}`);
      if (!el) return;
      if (oi === q.ans) el.classList.add('correct');
      else if (oi === chosen && oi !== q.ans) el.classList.add('wrong');
      el.onclick = null;
    });
    if (chosen === q.ans) correct++;
    const exp = document.getElementById(`ai-explain-${qi}`);
    if (exp) exp.classList.add('show');
  });
  const pct = Math.round(correct / _aiTestData.length * 100);
  const msgs = ['Cn c gng thm nhiu!','Vn cn nhiu im cn n!','Kh n, tip tc luyn tp!','Rt tt! Gn hon ho!','Tuyt vi! Hon ho!'];
  const mIdx = correct === _aiTestData.length ? 4 : correct >= 4 ? 3 : correct >= 3 ? 2 : correct >= 1 ? 1 : 0;
  document.getElementById('ai-score-val').textContent = `${correct} / ${_aiTestData.length} ng (${pct}%)`;
  document.getElementById('ai-score-msg').textContent = msgs[mIdx];
  const banner = document.getElementById('ai-score-banner');
  banner.classList.add('show');
  banner.scrollIntoView({ behavior:'smooth', block:'nearest' });
}

/*  BLOCK D: AI Chat  */
async function aiChatSend() {
  const inp = document.getElementById('chat-input');
  const msg = inp.value.trim();
  if (!msg) return;
  inp.value = '';
  _chatAppendMsg('user', msg);
  _chatHistory.push({ role: 'user', text: msg });
  const sendBtn = document.getElementById('btn-chat-send');
  sendBtn.disabled = true;
  const { grade, textbook, track } = _studentProfile;
  const profileCtx = grade ? `Hc sinh lp ${grade}, sch ${textbook||'chun'}, ban ${track||'c bn'}.` : '';
  const scoreCtx = currentResult
    ? `TBM chung: ${currentResult.dtb.toFixed(2)} (${rankOf(currentResult.dtb).lbl}).` : '';
  const historyCtx = _chatHistory.slice(-6).map(h=>`${h.role==='user'?'Hc sinh':'AI'}: ${h.text}`).join('\n');
  const prompt = `Bn l tr l hc tp AI thng minh, thn thin cho hc sinh Vit Nam.
${profileCtx} ${scoreCtx}
Quy tc:
- Tr li ph hp cp lp${grade?' '+grade:''}
- Khng ging dy vt qu chng trnh ph thng
- Gii thch r rng, dng v d thc t Vit Nam
- Khuyn khch t hc v t duy c lp
- Ngn gn, thc dng (di 200 t tr khi cn gii thch k)

Lch s hi thoi:
${historyCtx}

Cu hi mi: ${msg}`;
  const thinkEl = _chatAppendLoading();
  try {
    const resp = await callGemini(prompt);
    thinkEl.remove();
    _chatAppendMsg('ai', resp.trim());
    _chatHistory.push({ role: 'ai', text: resp.trim() });
    if (_chatHistory.length > 20) _chatHistory.splice(0, 2);
  } catch(e) {
    thinkEl.remove();
    _chatAppendMsg('ai', _geminiErrMsg(e));
  } finally {
    sendBtn.disabled = false;
    inp.focus();
  }
}

function _chatAppendMsg(role, text) {
  const box = document.getElementById('ai-chat-box');
  const div = document.createElement('div');
  div.className = `chat-msg ${role}`;
  div.innerHTML = `
    <div class="chat-avatar">${role==='user'?'':''}</div>
    <div class="chat-bubble">${text}</div>`;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
  return div;
}

function _chatAppendLoading() {
  const box = document.getElementById('ai-chat-box');
  const div = document.createElement('div');
  div.className = 'chat-msg ai';
  div.innerHTML = `
    <div class="chat-avatar"></div>
    <div class="chat-bubble">
      <div style="display:flex;gap:4px;padding:2px 0;">
        <span style="width:7px;height:7px;border-radius:50%;background:var(--c-p1);animation:dotBounce 1.2s infinite ease-in-out;display:inline-block;"></span>
        <span style="width:7px;height:7px;border-radius:50%;background:var(--c-p1);animation:dotBounce 1.2s infinite ease-in-out .2s;display:inline-block;"></span>
        <span style="width:7px;height:7px;border-radius:50%;background:var(--c-p1);animation:dotBounce 1.2s infinite ease-in-out .4s;display:inline-block;"></span>
      </div>
    </div>`;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
  return div;
}

function aiChatClear() {
  _chatHistory = [];
  const box = document.getElementById('ai-chat-box');
  box.innerHTML = `<div class="chat-msg ai">
    <div class="chat-avatar"></div>
    <div class="chat-bubble">Xin cho! Ti l tr l hc tp AI. Hy hi ti bt c iu g v mn hc, bi tp, hay phng php hc tp nh! </div>
  </div>`;
  showToast(' xo lch s chat', false);
}

/*  INIT  */
buildMonUI();
renderLichSu();
spBuildSubjSelect();
aiInitTestSubjSelect();
pomoRenderStats();
spRender();
ttRender();
checkReminder();
switchTab('grade');
</script>
</body>
</html>
