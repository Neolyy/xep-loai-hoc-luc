<!DOCTYPE html>
<html lang="vi" data-theme="light">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>X·∫øp Lo·∫°i H·ªçc L·ª±c H·ªçc Sinh</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root{
  --bg-page:#eef2ff;--bg-card:#fff;--bg-input:#f8f9ff;
  --bg-subj:#f8f9ff;--bg-hist:#f8f9ff;--bg-histrow:#fff;
  --bg-soft:#ede9fe;--bg-prog:rgba(255,255,255,.55);
  --bg-desc:rgba(255,255,255,.5);--bg-rdtip:rgba(0,0,0,.06);
  --bg-tblhov:rgba(0,0,0,.03);--bg-chart:#fff;
  --bd-base:#e0e7ff;--bd-input:#e0e7ff;
  --tx-1:#1e1b4b;--tx-2:#4b5563;--tx-3:#9ca3af;
  --c-p1:#4f46e5;--c-p2:#7c3aed;--c-acc:#a78bfa;
  --dot-clr:#c7d2fe;--scale-op:.22;
  --g-bg:#d1fae5;--g-bd:#6ee7b7;--g-tx:#065f46;--g-pill:#34d399;
  --k-bg:#dbeafe;--k-bd:#93c5fd;--k-tx:#1e40af;--k-pill:#60a5fa;
  --t-bg:#fef9c3;--t-bd:#fde68a;--t-tx:#854d0e;--t-pill:#fbbf24;
  --y-bg:#fee2e2;--y-bd:#fca5a5;--y-tx:#991b1b;--y-pill:#f87171;
  --sh-sm:0 2px 8px rgba(99,102,241,.10);
  --sh-md:0 8px 32px rgba(99,102,241,.16);
  --sh-lg:0 20px 56px rgba(99,102,241,.22);
  --td:.3s;
  --chart-grid:rgba(99,102,241,.15);
  --chart-tick:#9ca3af;--chart-pt-label:#4b5563;
}
[data-theme="dark"]{
  --bg-page:#0f0e1a;--bg-card:#1a1830;--bg-input:#231f3a;
  --bg-subj:#201d35;--bg-hist:#1e1b30;--bg-histrow:#27243f;
  --bg-soft:#2d2852;--bg-prog:rgba(255,255,255,.04);
  --bg-desc:rgba(255,255,255,.04);--bg-rdtip:rgba(255,255,255,.08);
  --bg-tblhov:rgba(255,255,255,.04);--bg-chart:#1a1830;
  --bd-base:#312e57;--bd-input:#3a3666;
  --tx-1:#e8e6ff;--tx-2:#a09ec0;--tx-3:#5c597e;
  --c-p1:#818cf8;--c-p2:#a78bfa;--c-acc:#c4b5fd;
  --dot-clr:#1e1b35;--scale-op:.35;
  --g-bg:#052e16;--g-bd:#065f46;--g-tx:#6ee7b7;--g-pill:#059669;
  --k-bg:#0c1f4a;--k-bd:#1e3a8a;--k-tx:#93c5fd;--k-pill:#1d4ed8;
  --t-bg:#2d1f00;--t-bd:#78350f;--t-tx:#fde68a;--t-pill:#d97706;
  --y-bg:#2d0a0a;--y-bd:#7f1d1d;--y-tx:#fca5a5;--y-pill:#dc2626;
  --sh-sm:0 2px 8px rgba(0,0,0,.4);--sh-md:0 8px 32px rgba(0,0,0,.5);
  --sh-lg:0 20px 56px rgba(0,0,0,.65);
  --chart-grid:rgba(200,200,255,.10);--chart-tick:#5c597e;--chart-pt-label:#a09ec0;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;
  transition:background-color var(--td) ease,border-color var(--td) ease,
  color var(--td) ease,box-shadow var(--td) ease;}
.btn,.spin,.mon-card,.hist-row{transition:background-color var(--td) ease,
  border-color var(--td) ease,color var(--td) ease,box-shadow var(--td) ease,transform .15s ease;}
body{font-family:'Inter',system-ui,sans-serif;background-color:var(--bg-page);
  background-image:radial-gradient(circle,var(--dot-clr) 1px,transparent 1px);
  background-size:28px 28px;min-height:100vh;
  display:flex;flex-direction:column;align-items:center;
  padding:36px 16px 60px;color:var(--tx-1);}
.dm-toggle{position:fixed;top:18px;right:18px;z-index:200;
  width:48px;height:48px;border-radius:50%;border:2px solid var(--bd-base);
  background:var(--bg-card);box-shadow:var(--sh-md);cursor:pointer;
  display:flex;align-items:center;justify-content:center;font-size:1.3rem;}
.dm-toggle:hover{transform:scale(1.1) rotate(15deg);box-shadow:var(--sh-lg);}
.dm-toggle::after{content:attr(data-ico);}
.pg-head{text-align:center;margin-bottom:28px;}
.pg-head .crown{font-size:3.2rem;display:block;margin-bottom:8px;
  animation:float 3s ease-in-out infinite;
  filter:drop-shadow(0 6px 12px rgba(124,58,237,.35));}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
.pg-head h1{font-size:clamp(1.4rem,4vw,2rem);font-weight:900;letter-spacing:-.03em;
  background:linear-gradient(135deg,var(--c-p1),var(--c-p2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.pg-head p{color:var(--tx-2);font-size:.88rem;margin-top:5px;font-weight:500;}
.card{background:var(--bg-card);border-radius:28px;box-shadow:var(--sh-lg);
  width:100%;max-width:900px;overflow:hidden;
  animation:slideUp .5s cubic-bezier(.22,1,.36,1) both;}
@keyframes slideUp{from{opacity:0;transform:translateY(28px)}to{opacity:1;transform:translateY(0)}}
.card-stripe{height:5px;transition:none;
  background:linear-gradient(90deg,#6366f1,#a78bfa,#7c3aed,#818cf8,#4f46e5);
  background-size:200%;animation:shimmer 3s linear infinite;}
@keyframes shimmer{0%{background-position:0%}100%{background-position:200%}}
.card-body{padding:28px 28px 32px;}
.sec-lbl{display:flex;align-items:center;gap:8px;font-size:.71rem;font-weight:700;
  text-transform:uppercase;letter-spacing:.08em;color:var(--c-p1);margin-bottom:14px;}
.sec-lbl::after{content:'';flex:1;height:1.5px;
  background:linear-gradient(90deg,var(--bd-base),transparent);border-radius:99px;}
.name-field{margin-bottom:24px;}
.fi{position:relative;display:flex;align-items:center;}
.fi .fi-ico{position:absolute;left:13px;font-size:1.05rem;pointer-events:none;}
.fi input{width:100%;padding:11px 13px 11px 40px;border:2px solid var(--bd-input);
  border-radius:14px;font-family:inherit;font-size:.96rem;font-weight:500;
  color:var(--tx-1);background:var(--bg-input);outline:none;}
.fi input:focus{border-color:var(--c-p1);background:var(--bg-card);
  box-shadow:0 0 0 4px rgba(99,102,241,.14);}
.fi input::placeholder{color:var(--tx-3);font-weight:400;}
.mon-list{display:flex;flex-direction:column;gap:14px;margin-bottom:10px;}
.mon-card{
  background:var(--bg-subj);border:2px solid var(--bd-base);
  border-radius:20px;overflow:hidden;box-shadow:var(--sh-sm);
  transition:box-shadow var(--td) ease,border-color var(--td) ease;
}
.mon-card:focus-within{border-color:var(--c-p1);box-shadow:var(--sh-md);}
.mon-card.has-error{border-color:#f87171;}
.mon-header{
  display:flex;align-items:center;gap:12px;
  padding:13px 16px;cursor:pointer;user-select:none;
  background:var(--bg-subj);
}
.mon-header:hover{background:var(--bg-soft);}
.mon-ico-chip{
  width:32px;height:32px;border-radius:10px;background:var(--bg-soft);
  display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;
}
.mon-title-wrap{flex:1;}
.mon-title{font-size:.9rem;font-weight:800;color:var(--tx-1);}
.mon-subtitle{font-size:.72rem;color:var(--tx-3);margin-top:1px;font-weight:500;}
.mon-tbm-display{
  font-size:1.1rem;font-weight:900;
  min-width:48px;text-align:right;
}
.mon-tbm-display.sc-g{color:#059669}
.mon-tbm-display.sc-k{color:#2563eb}
.mon-tbm-display.sc-t{color:#d97706}
.mon-tbm-display.sc-y{color:#dc2626}
[data-theme="dark"] .mon-tbm-display.sc-g{color:#34d399}
[data-theme="dark"] .mon-tbm-display.sc-k{color:#60a5fa}
[data-theme="dark"] .mon-tbm-display.sc-t{color:#fbbf24}
[data-theme="dark"] .mon-tbm-display.sc-y{color:#f87171}
.mon-chevron{font-size:.8rem;color:var(--tx-3);margin-left:4px;
  transition:transform .25s ease;flex-shrink:0;}
.mon-card.open .mon-chevron{transform:rotate(180deg);}
.mon-body{
  display:none;padding:0 16px 16px;
  border-top:1.5px solid var(--bd-base);
  animation:fadeIn .2s ease;
}
.mon-card.open .mon-body{display:block;}
.semesters{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px;}
@media(max-width:600px){.semesters{grid-template-columns:1fr;}}
.sem-block{
  background:var(--bg-prog);border:1px solid rgba(128,128,128,.12);
  border-radius:14px;padding:12px 14px;
}
.sem-title{
  font-size:.72rem;font-weight:800;text-transform:uppercase;letter-spacing:.07em;
  color:var(--c-p1);margin-bottom:10px;
  display:flex;align-items:center;justify-content:space-between;
}
.sem-result{
  font-size:.82rem;font-weight:700;color:var(--tx-2);
  background:var(--bg-soft);padding:2px 8px;border-radius:99px;
}
.inp-row{display:flex;align-items:center;gap:8px;margin-bottom:7px;}
.inp-row:last-child{margin-bottom:0;}
.inp-lbl{
  font-size:.73rem;font-weight:600;color:var(--tx-2);
  min-width:72px;flex-shrink:0;
}
.tx-row{display:flex;align-items:center;gap:6px;flex:1;flex-wrap:wrap;}
.tx-inp-wrap{position:relative;display:flex;align-items:center;}
.d-inp{
  width:52px;padding:6px 8px;
  border:1.5px solid var(--bd-base);border-radius:9px;
  font-family:inherit;font-size:.88rem;font-weight:700;
  color:var(--tx-1);background:var(--bg-card);outline:none;
  text-align:center;
  transition:border-color .2s,box-shadow .2s;
}
.d-inp:focus{border-color:var(--c-p1);box-shadow:0 0 0 3px rgba(99,102,241,.13);}
.d-inp.err{border-color:#f87171;background:#fff5f5;}
[data-theme="dark"] .d-inp.err{background:#2d1010;}
.d-inp::placeholder{color:var(--tx-3);font-weight:400;font-size:.8rem;}
.btn-tx-del,.btn-tx-add{
  width:22px;height:22px;border-radius:6px;border:1.5px solid var(--bd-base);
  background:var(--bg-card);cursor:pointer;font-size:.85rem;font-weight:700;
  display:flex;align-items:center;justify-content:center;flex-shrink:0;
  transition:background .15s,transform .1s;
}
.btn-tx-del{color:#ef4444;}.btn-tx-del:hover{background:#fee2e2;}
.btn-tx-add{color:#059669;}.btn-tx-add:hover{background:#d1fae5;}
.btn-tx-del:active,.btn-tx-add:active{transform:scale(.88);}
.hk-display{
  margin-top:8px;padding:6px 12px;border-radius:10px;
  background:var(--bg-rdtip);font-size:.78rem;font-weight:700;
  color:var(--tx-2);display:flex;align-items:center;justify-content:space-between;
}
.hk-val{font-size:.92rem;font-weight:900;color:var(--tx-1);}
.year-bar{
  margin-top:10px;padding:10px 14px;border-radius:12px;
  background:var(--bg-prog);border:1px solid rgba(128,128,128,.1);
  display:flex;align-items:center;justify-content:space-between;gap:8px;
  flex-wrap:wrap;
}
.year-bar .yb-label{font-size:.73rem;font-weight:700;color:var(--tx-2);}
.year-bar .yb-formula{font-size:.68rem;color:var(--tx-3);margin-top:1px;}
.year-bar .yb-val{font-size:1.2rem;font-weight:900;}
.g-err{background:var(--y-bg);border:1.5px solid var(--y-bd);border-radius:11px;
  padding:10px 14px;font-size:.83rem;font-weight:500;color:var(--y-tx);
  margin-top:5px;margin-bottom:2px;display:none;animation:fadeIn .25s ease;}
.actions{display:grid;grid-template-columns:1fr auto auto auto;gap:10px;margin-top:22px;}
.btn{border:none;border-radius:13px;font-family:inherit;font-size:.93rem;font-weight:700;
  cursor:pointer;outline:none;display:flex;align-items:center;
  justify-content:center;gap:7px;padding:13px 16px;}
.btn:active{transform:scale(.96);}
.btn-calc{background:linear-gradient(135deg,var(--c-p1),var(--c-p2));
  color:#fff;box-shadow:0 4px 18px rgba(79,70,229,.38);}
.btn-calc:hover{opacity:.9;transform:translateY(-1px);}
.btn-save{background:linear-gradient(135deg,#059669,#10b981);
  color:#fff;box-shadow:0 4px 14px rgba(5,150,105,.30);white-space:nowrap;}
.btn-save:hover{opacity:.9;transform:translateY(-1px);}
.btn-save:disabled{opacity:.35;cursor:not-allowed;transform:none;}
.btn-pdf{background:linear-gradient(135deg,#dc2626,#ef4444);
  color:#fff;box-shadow:0 4px 14px rgba(220,38,38,.30);white-space:nowrap;}
.btn-pdf:hover{opacity:.9;transform:translateY(-1px);}
.btn-pdf:disabled{opacity:.35;cursor:not-allowed;transform:none;}
.btn-reset{background:var(--bg-soft);color:var(--c-p1);}
.btn-reset:hover{background:var(--bd-input);transform:translateY(-1px);}
.toast{position:fixed;bottom:28px;right:24px;z-index:999;
  background:var(--tx-1);color:var(--bg-card);
  padding:12px 20px;border-radius:14px;font-size:.85rem;font-weight:600;
  box-shadow:0 8px 32px rgba(0,0,0,.3);display:flex;align-items:center;gap:8px;
  opacity:0;pointer-events:none;transform:translateY(12px);
  transition:opacity .3s,transform .3s;}
.toast.show{opacity:1;pointer-events:auto;transform:translateY(0);}
.result-wrap{display:none;margin-top:26px;}
.result-wrap.visible{display:block !important;
  animation:fadeSlide .45s cubic-bezier(.22,1,.36,1) both;}
@keyframes fadeSlide{
  from{opacity:0;transform:translateY(22px) scale(.98)}
  to  {opacity:1;transform:translateY(0)    scale(1)}}
.res-card{border-radius:22px;border:2px solid transparent;overflow:hidden;box-shadow:var(--sh-md);}
.res-card:hover{box-shadow:var(--sh-lg);}
.res-card.gioi{background:var(--g-bg);border-color:var(--g-bd)}
.res-card.kha {background:var(--k-bg);border-color:var(--k-bd)}
.res-card.tb  {background:var(--t-bg);border-color:var(--t-bd)}
.res-card.yeu {background:var(--y-bg);border-color:var(--y-bd)}
.res-inner{padding:22px 22px 20px;}
.res-top{display:flex;align-items:flex-start;justify-content:space-between;
  flex-wrap:wrap;gap:10px;margin-bottom:18px;}
.res-student{display:flex;align-items:center;gap:10px;}
.res-avatar{width:42px;height:42px;border-radius:11px;
  display:flex;align-items:center;justify-content:center;
  font-size:1.3rem;box-shadow:var(--sh-sm);flex-shrink:0;}
.gioi .res-avatar{background:var(--g-pill)}.kha .res-avatar{background:var(--k-pill)}
.tb   .res-avatar{background:var(--t-pill)}.yeu .res-avatar{background:var(--y-pill)}
.r-name{font-size:1.02rem;font-weight:800;color:var(--tx-1);}
.r-sub{font-size:.76rem;font-weight:500;color:var(--tx-2);margin-top:1px;}
.rank-pill{display:flex;align-items:center;gap:5px;padding:6px 14px;
  border-radius:999px;font-size:.86rem;font-weight:800;
  box-shadow:var(--sh-sm);white-space:nowrap;}
.gioi .rank-pill{background:var(--g-pill);color:#022c22}
.kha  .rank-pill{background:var(--k-pill);color:#1e3a8a}
.tb   .rank-pill{background:var(--t-pill);color:#451a03}
.yeu  .rank-pill{background:var(--y-pill);color:#fff}
.prog-section{margin-bottom:18px;padding:16px 18px 14px;
  border-radius:16px;background:var(--bg-prog);border:1px solid rgba(128,128,128,.12);}
.prog-header{display:flex;align-items:baseline;justify-content:space-between;margin-bottom:10px;}
.p-label{font-size:.76rem;font-weight:700;color:var(--tx-2);
  text-transform:uppercase;letter-spacing:.06em;}
.p-val{font-size:2rem;font-weight:900;line-height:1;}
.gioi .p-val{color:var(--g-tx)}.kha .p-val{color:var(--k-tx)}
.tb   .p-val{color:var(--t-tx)}.yeu .p-val{color:var(--y-tx)}
.scale-bar{position:relative;height:14px;border-radius:99px;margin-bottom:6px;}
.scale-track{position:absolute;inset:0;border-radius:99px;overflow:hidden;
  background:linear-gradient(90deg,#f87171 0%,#fbbf24 32%,#60a5fa 50%,#34d399 70%,#059669 100%);
  opacity:var(--scale-op);}
.scale-fill{position:absolute;top:0;left:0;height:100%;border-radius:99px;
  transition:width .7s cubic-bezier(.22,1,.36,1);box-shadow:0 2px 8px rgba(0,0,0,.18);}
.gioi .scale-fill{background:linear-gradient(90deg,#34d399,#6ee7b7)}
.kha  .scale-fill{background:linear-gradient(90deg,#60a5fa,#93c5fd)}
.tb   .scale-fill{background:linear-gradient(90deg,#fbbf24,#fde68a)}
.yeu  .scale-fill{background:linear-gradient(90deg,#f87171,#fca5a5)}
.scale-needle{position:absolute;top:-4px;width:4px;height:22px;border-radius:2px;
  background:var(--tx-1);box-shadow:0 2px 6px rgba(0,0,0,.25);transform:translateX(-50%);
  transition:left .7s cubic-bezier(.22,1,.36,1);}
.scale-ticks{display:flex;justify-content:space-between;font-size:.66rem;
  font-weight:600;color:var(--tx-3);padding:0 2px;}
.chart-section{margin-bottom:18px;padding:18px 18px 14px;border-radius:16px;
  background:var(--bg-prog);border:1px solid rgba(128,128,128,.12);animation:fadeIn .5s ease;}
.ch-label{font-size:.76rem;font-weight:700;color:var(--tx-2);
  text-transform:uppercase;letter-spacing:.06em;}
.chart-legend{display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin-bottom:12px;}
.leg-chip{display:flex;align-items:center;gap:5px;font-size:.7rem;font-weight:600;
  color:var(--tx-2);padding:3px 9px;border-radius:99px;background:var(--bg-rdtip);}
.leg-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.chart-wrap{position:relative;width:100%;max-width:380px;margin:0 auto;aspect-ratio:1/1;}
.chart-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:14px;}
.cstat{background:var(--bg-rdtip);border-radius:12px;padding:9px 10px;text-align:center;}
.cs-val{font-size:1.15rem;font-weight:900;color:var(--tx-1);}
.cs-lbl{font-size:.68rem;font-weight:600;color:var(--tx-3);margin-top:2px;}
.cs-hi{color:#059669!important;}
.cs-lo{color:#dc2626!important;}
[data-theme="dark"] .cs-hi{color:#34d399!important;}
[data-theme="dark"] .cs-lo{color:#f87171!important;}
.rank-desc{border-radius:13px;padding:13px 15px;margin-bottom:16px;
  border:1px solid rgba(128,128,128,.12);background:var(--bg-desc);}
.rd-title{font-size:.76rem;font-weight:700;color:var(--tx-2);
  text-transform:uppercase;letter-spacing:.07em;margin-bottom:5px;}
.rd-text{font-size:.84rem;font-weight:500;line-height:1.55;color:var(--tx-1);}
.rd-tips{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px;}
.rd-tip{font-size:.73rem;font-weight:600;padding:4px 10px;border-radius:99px;
  background:var(--bg-rdtip);color:var(--tx-2);}
.score-tbl{width:100%;border-collapse:collapse;font-size:.84rem;}
.score-tbl th{padding:6px 10px;text-align:left;font-size:.71rem;font-weight:700;
  text-transform:uppercase;letter-spacing:.07em;color:var(--tx-2);
  border-bottom:1.5px solid rgba(128,128,128,.15);}
.score-tbl td{padding:8px 10px;border-bottom:1px solid rgba(128,128,128,.08);
  color:var(--tx-1);font-weight:500;}
.score-tbl td:last-child{text-align:right;font-weight:800;}
.score-tbl tbody tr:hover{background:var(--bg-tblhov);}
.score-tbl tr.ttl-row td{border-bottom:none;font-weight:900;font-size:.98rem;padding-top:11px;}
.sc-g{color:#059669}.sc-k{color:#2563eb}.sc-t{color:#d97706}.sc-y{color:#dc2626}
[data-theme="dark"] .sc-g{color:#34d399}[data-theme="dark"] .sc-k{color:#60a5fa}
[data-theme="dark"] .sc-t{color:#fbbf24}[data-theme="dark"] .sc-y{color:#f87171}
.tbl-ico{display:inline-flex;align-items:center;justify-content:center;
  width:20px;height:20px;border-radius:6px;background:rgba(128,128,128,.12);
  font-size:.72rem;margin-right:5px;}
.history-wrap{background:var(--bg-hist);border:2px solid var(--bd-base);
  border-radius:20px;padding:18px 18px 14px;margin-top:24px;display:none;animation:fadeIn .3s ease;}
.history-wrap.visible{display:block;}
.history-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:13px;}
.history-header h3{font-size:.85rem;font-weight:800;color:var(--c-p1);}
.btn-clear-hist{font-size:.72rem;font-weight:600;color:#f87171;
  background:none;border:none;cursor:pointer;padding:3px 8px;border-radius:7px;}
.btn-clear-hist:hover{background:var(--y-bg);}
.hist-row{display:flex;align-items:center;gap:10px;padding:9px 10px;
  border-radius:11px;background:var(--bg-histrow);border:1.5px solid var(--bd-base);
  margin-bottom:8px;cursor:pointer;}
.hist-row:hover{border-color:var(--c-p1);box-shadow:var(--sh-sm);transform:translateY(-1px);}
.hist-row:last-child{margin-bottom:0;}
.hist-rank-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.dot-gioi{background:#34d399}.dot-kha{background:#60a5fa}
.dot-tb{background:#fbbf24}.dot-yeu{background:#f87171}
.hist-name{font-size:.87rem;font-weight:700;flex:1;color:var(--tx-1);
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.hist-avg{font-size:.87rem;font-weight:800;margin-left:auto;margin-right:4px;}
.hist-lbl{font-size:.72rem;font-weight:700;padding:3px 10px;border-radius:99px;}
.hist-lbl.gioi{background:var(--g-bg);color:var(--g-tx)}
.hist-lbl.kha {background:var(--k-bg);color:var(--k-tx)}
.hist-lbl.tb  {background:var(--t-bg);color:var(--t-tx)}
.hist-lbl.yeu {background:var(--y-bg);color:var(--y-tx)}
.hist-del{background:none;border:none;cursor:pointer;font-size:.85rem;
  color:var(--tx-3);padding:3px 5px;border-radius:6px;flex-shrink:0;}
.hist-del:hover{color:#f87171;background:var(--y-bg);}
.hist-date{font-size:.68rem;color:var(--tx-3);font-weight:500;white-space:nowrap;}
.pg-foot{margin-top:30px;font-size:.72rem;color:var(--tx-3);text-align:center;font-weight:500;}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@media(max-width:600px){
  .card-body{padding:18px 14px 24px;}
  .actions{grid-template-columns:1fr 1fr;grid-template-rows:auto auto;}
  .btn-calc{grid-column:1/-1;}
  .dm-toggle{top:12px;right:12px;width:42px;height:42px;font-size:1.1rem;}
}
</style>
</head>
<body>

<button class="dm-toggle" id="dmBtn" data-ico="üåô" onclick="toggleDark()"></button>

<header class="pg-head">
  <span class="crown">üéì</span>
  <h1>X·∫øp Lo·∫°i H·ªçc L·ª±c H·ªçc Sinh</h1>
  <p>B·∫£ng ƒëi·ªÉm chi ti·∫øt theo chu·∫©n h·ªçc b·∫° Vi·ªát Nam</p>
</header>

<div class="card">
  <div class="card-stripe"></div>
  <div class="card-body">

    <p class="sec-lbl">üë§ Th√¥ng tin h·ªçc sinh</p>
    <div class="name-field">
      <div class="fi">
        <span class="fi-ico">üßë‚Äçüéì</span>
        <input type="text" id="tenHS" placeholder="Nh·∫≠p h·ªç v√† t√™n h·ªçc sinh‚Ä¶" maxlength="60"/>
      </div>
    </div>

    <p class="sec-lbl">üìö ƒêi·ªÉm c√°c m√¥n h·ªçc</p>
    <div class="mon-list" id="monList"></div>
    <div class="g-err" id="gErr"></div>

    <div class="actions">
      <button class="btn btn-calc"  onclick="tinhKQ()">‚ú® T√≠nh k·∫øt qu·∫£</button>
      <button class="btn btn-save"  id="btnSave" onclick="luuKQ()"   disabled>üíæ L∆∞u</button>
      <button class="btn btn-pdf"   id="btnPdf"  onclick="xuatPDF()" disabled>üìÑ PDF</button>
      <button class="btn btn-reset" onclick="nhapLai()">üîÑ Nh·∫≠p l·∫°i</button>
    </div>

    <div class="result-wrap" id="resWrap">
      <div class="res-card" id="resCard">
        <div class="res-inner">
          <div class="res-top">
            <div class="res-student">
              <div class="res-avatar" id="rAvatar">üèÜ</div>
              <div>
                <div class="r-name" id="rName">‚Äî</div>
                <div class="r-sub">K·∫øt qu·∫£ h·ªçc k·ª≥</div>
              </div>
            </div>
            <div class="rank-pill" id="rPill">‚Äî</div>
          </div>
          <div class="prog-section">
            <div class="prog-header">
              <span class="p-label">üìä ƒêi·ªÉm trung b√¨nh c·∫£ nƒÉm</span>
              <span class="p-val" id="rAvg">‚Äî</span>
            </div>
            <div class="scale-bar">
              <div class="scale-track"></div>
              <div class="scale-fill"   id="rScaleFill" style="width:0%"></div>
              <div class="scale-needle" id="rNeedle"    style="left:0%"></div>
            </div>
            <div class="scale-ticks">
              <span>0</span><span>2.5</span><span>5</span>
              <span>6.5</span><span>8</span><span>10</span>
            </div>
          </div>
          <div class="chart-section">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
              <span class="ch-label">üì° Bi·ªÉu ƒë·ªì Radar TBM c√°c m√¥n</span>
            </div>
            <div class="chart-legend" id="chartLegend"></div>
            <div class="chart-wrap"><canvas id="radarChart"></canvas></div>
            <div class="chart-stats">
              <div class="cstat"><div class="cs-val cs-hi" id="csMax">‚Äî</div><div class="cs-lbl">M√¥n cao nh·∫•t</div></div>
              <div class="cstat"><div class="cs-val cs-lo" id="csMin">‚Äî</div><div class="cs-lbl">M√¥n th·∫•p nh·∫•t</div></div>
              <div class="cstat"><div class="cs-val" id="csAvg">‚Äî</div><div class="cs-lbl">TBM c·∫£ nƒÉm</div></div>
            </div>
          </div>
          <div class="rank-desc">
            <div class="rd-title">üìå √ù nghƒ©a x·∫øp lo·∫°i</div>
            <div class="rd-text" id="rDescText">‚Äî</div>
            <div class="rd-tips" id="rDescTips"></div>
          </div>
          <table class="score-tbl">
            <thead>
              <tr>
                <th>M√¥n h·ªçc</th>
                <th style="text-align:right">TBM HK1</th>
                <th style="text-align:right">TBM HK2</th>
                <th style="text-align:right">TBM c·∫£ nƒÉm</th>
              </tr>
            </thead>
            <tbody id="rTbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="history-wrap" id="histWrap">
      <div class="history-header">
        <h3>üìã K·∫øt qu·∫£ ƒë√£ l∆∞u</h3>
        <button class="btn-clear-hist" onclick="xoaTatCa()">üóë Xo√° t·∫•t c·∫£</button>
      </div>
      <div id="histList"></div>
    </div>

  </div>
</div>

<footer class="pg-foot">¬© 2025 ¬∑ H·ªá Th·ªëng X·∫øp Lo·∫°i H·ªçc L·ª±c ¬∑ Chu·∫©n h·ªçc b·∫° Vi·ªát Nam</footer>
<div class="toast" id="toast"></div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   1. D·ªÆ LI·ªÜU M√îN H·ªåC
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const MON = [
  {id:'toan',  ten:'To√°n',                    ico:'‚ûï'},
  {id:'van',   ten:'Ng·ªØ vƒÉn',                  ico:'üìñ'},
  {id:'anh',   ten:'Ti·∫øng Anh',               ico:'üî§'},
  {id:'ly',    ten:'V·∫≠t l√Ω',                   ico:'‚ö°'},
  {id:'hoa',   ten:'H√≥a h·ªçc',                  ico:'üß™'},
  {id:'sinh',  ten:'Sinh h·ªçc',                 ico:'üåø'},
  {id:'su',    ten:'L·ªãch s·ª≠',                  ico:'üèõÔ∏è'},
  {id:'dia',   ten:'ƒê·ªãa l√Ω',                   ico:'üåç'},
  {id:'gdcd',  ten:'GDKT & Ph√°p lu·∫≠t',         ico:'‚öñÔ∏è'},
  {id:'tin',   ten:'Tin h·ªçc',                  ico:'üíª'},
  {id:'gdqp',  ten:'GD Qu·ªëc ph√≤ng',            ico:'üõ°Ô∏è'},
  {id:'cn',    ten:'C√¥ng ngh·ªá',                ico:'üõ†Ô∏è'},
];

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   2. X·∫æP LO·∫†I
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const RANK = [
  {min:8.0,lbl:'Gi·ªèi',      cls:'gioi',ico:'üèÜ',scCls:'sc-g',
   rgb:'52,211,153',pdfColor:[5,150,105],pdfBg:[209,250,229],
   desc:'H·ªçc sinh ƒë·∫°t th√†nh t√≠ch xu·∫•t s·∫Øc, n·∫Øm v·ªØng ki·∫øn th·ª©c to√†n di·ªán, c√≥ kh·∫£ nƒÉng t∆∞ duy ƒë·ªôc l·∫≠p v√† s√°ng t·∫°o.',
   tips:['N·∫Øm v·ªØng l√Ω thuy·∫øt','L√†m t·ªët b√†i t·∫≠p n√¢ng cao','T·ª± h·ªçc hi·ªáu qu·∫£','T∆∞ duy s√°ng t·∫°o']},
  {min:6.5,lbl:'Kh√°',       cls:'kha', ico:'ü•à',scCls:'sc-k',
   rgb:'96,165,250',pdfColor:[29,78,216],pdfBg:[219,234,254],
   desc:'H·ªçc sinh c√≥ k·∫øt qu·∫£ t·ªët, hi·ªÉu b√†i v√† v·∫≠n d·ª•ng ki·∫øn th·ª©c ·ªü m·ª©c kh√°. C·∫ßn c·ªë g·∫Øng th√™m ƒë·ªÉ ƒë·∫°t m·ª©c Gi·ªèi.',
   tips:['Hi·ªÉu b√†i ·ªü m·ª©c kh√°','C·∫ßn √¥n luy·ªán th√™m','C√≥ n·ªÅn t·∫£ng v·ªØng','Ti·∫øp t·ª•c ph√°t huy']},
  {min:5.0,lbl:'Trung b√¨nh',cls:'tb',  ico:'üìò',scCls:'sc-t',
   rgb:'251,191,36',pdfColor:[133,77,14],pdfBg:[254,249,195],
   desc:'H·ªçc sinh ƒë·∫°t m·ª©c c∆° b·∫£n, c·∫ßn c·∫£i thi·ªán c√°c m√¥n c√≤n y·∫øu v√† tƒÉng c∆∞·ªùng √¥n luy·ªán ƒë·ªÅu ƒë·∫∑n h∆°n.',
   tips:['N·∫Øm ki·∫øn th·ª©c c∆° b·∫£n','C·∫ßn luy·ªán t·∫≠p th√™m','Ch√∫ √Ω m√¥n y·∫øu','TƒÉng th·ªùi gian √¥n b√†i']},
  {min:0,  lbl:'Y·∫øu',       cls:'yeu', ico:'‚ö†Ô∏è',scCls:'sc-y',
   rgb:'248,113,113',pdfColor:[153,27,27],pdfBg:[254,226,226],
   desc:'H·ªçc sinh c·∫ßn n·ªó l·ª±c nhi·ªÅu h∆°n, n√™n t√¨m s·ª± h·ªó tr·ª£ t·ª´ th·∫ßy c√¥ v√† gia ƒë√¨nh ƒë·ªÉ c·∫£i thi·ªán k·ªãp th·ªùi.',
   tips:['B·ªï sung ki·∫øn th·ª©c','T√¨m h·ªó tr·ª£ th·∫ßy c√¥','L·∫≠p k·∫ø ho·∫°ch h·ªçc','Kh√¥ng b·ªè cu·ªôc!']},
];

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   3. STATE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let currentResult  = null;
let radarChartInst = null;
const txCount = {};
MON.forEach(m => txCount[m.id] = 4);

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   4. DARK MODE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const DM_KEY = 'hocLucDarkMode';
function applyTheme(dark) {
  document.documentElement.setAttribute('data-theme', dark ? 'dark' : 'light');
  const btn = document.getElementById('dmBtn');
  btn.setAttribute('data-ico', dark ? '‚òÄÔ∏è' : 'üåô');
  if (radarChartInst) updateRadarTheme();
}
function toggleDark() {
  const d = document.documentElement.getAttribute('data-theme') === 'dark';
  applyTheme(!d);
  try { localStorage.setItem(DM_KEY, !d ? '1' : '0'); } catch(e){}
  showToast(!d ? 'üåô Dark Mode ƒë√£ b·∫≠t' : '‚òÄÔ∏è Light Mode ƒë√£ b·∫≠t');
}
(function initTheme() {
  let s = null;
  try { s = localStorage.getItem(DM_KEY); } catch(e){}
  if (s !== null) { applyTheme(s === '1'); return; }
  if (window.matchMedia?.('(prefers-color-scheme: dark)').matches) applyTheme(true);
})();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   5. X√ÇY D·ª∞NG UI M√îN H·ªåC
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function buildMonUI() {
  const list = document.getElementById('monList');
  list.innerHTML = '';
  MON.forEach(m => {
    const card = document.createElement('div');
    card.className = 'mon-card';
    card.id = 'card_' + m.id;
    card.innerHTML = `
      <div class="mon-header" onclick="toggleMon('${m.id}')">
        <div class="mon-ico-chip">${m.ico}</div>
        <div class="mon-title-wrap">
          <div class="mon-title">${m.ten}</div>
          <div class="mon-subtitle" id="sub_${m.id}">Ch∆∞a nh·∫≠p ƒëi·ªÉm</div>
        </div>
        <div class="mon-tbm-display" id="tbm_${m.id}">‚Äî</div>
        <div class="mon-chevron">‚ñº</div>
      </div>
      <div class="mon-body">
        <div class="semesters">
          <div class="sem-block">
            <div class="sem-title">
              üìò H·ªçc k·ª≥ 1
              <span class="sem-result" id="hk1r_${m.id}">HK1: ‚Äî</span>
            </div>
            <div class="inp-row">
              <span class="inp-lbl">TX (HK1)</span>
              <div class="tx-row" id="tx1_${m.id}"></div>
              <button class="btn-tx-del" onclick="delTX('${m.id}',1)" title="Xo√° 1 c·ªôt TX">‚àí</button>
              <button class="btn-tx-add" onclick="addTX('${m.id}',1)" title="Th√™m 1 c·ªôt TX">+</button>
            </div>
            <div class="inp-row">
              <span class="inp-lbl">Gi·ªØa k·ª≥ 1</span>
              <input class="d-inp" type="number" id="gk1_${m.id}"
                     min="0" max="10" step="0.1" placeholder="‚Äî"
                     oninput="recalcMon('${m.id}')"/>
            </div>
            <div class="inp-row">
              <span class="inp-lbl">Cu·ªëi k·ª≥ 1</span>
              <input class="d-inp" type="number" id="ck1_${m.id}"
                     min="0" max="10" step="0.1" placeholder="‚Äî"
                     oninput="recalcMon('${m.id}')"/>
            </div>
            <div class="hk-display">
              <span>ƒêi·ªÉm HK1</span>
              <span class="hk-val" id="hk1v_${m.id}">‚Äî</span>
            </div>
          </div>
          <div class="sem-block">
            <div class="sem-title">
              üìó H·ªçc k·ª≥ 2
              <span class="sem-result" id="hk2r_${m.id}">HK2: ‚Äî</span>
            </div>
            <div class="inp-row">
              <span class="inp-lbl">TX (HK2)</span>
              <div class="tx-row" id="tx2_${m.id}"></div>
              <button class="btn-tx-del" onclick="delTX('${m.id}',2)" title="Xo√° 1 c·ªôt TX">‚àí</button>
              <button class="btn-tx-add" onclick="addTX('${m.id}',2)" title="Th√™m 1 c·ªôt TX">+</button>
            </div>
            <div class="inp-row">
              <span class="inp-lbl">Gi·ªØa k·ª≥ 2</span>
              <input class="d-inp" type="number" id="gk2_${m.id}"
                     min="0" max="10" step="0.1" placeholder="‚Äî"
                     oninput="recalcMon('${m.id}')"/>
            </div>
            <div class="inp-row">
              <span class="inp-lbl">Cu·ªëi k·ª≥ 2</span>
              <input class="d-inp" type="number" id="ck2_${m.id}"
                     min="0" max="10" step="0.1" placeholder="‚Äî"
                     oninput="recalcMon('${m.id}')"/>
            </div>
            <div class="hk-display">
              <span>ƒêi·ªÉm HK2</span>
              <span class="hk-val" id="hk2v_${m.id}">‚Äî</span>
            </div>
          </div>
        </div>
        <div class="year-bar" id="yearbar_${m.id}">
          <div>
            <div class="yb-label">üìä TBM c·∫£ nƒÉm</div>
            <div class="yb-formula" id="formula_${m.id}">Ch∆∞a c√≥ d·ªØ li·ªáu</div>
          </div>
          <div class="yb-val" id="tbmYear_${m.id}">‚Äî</div>
        </div>
      </div>`;
    list.appendChild(card);
    buildTX(m.id, 1);
    buildTX(m.id, 2);
  });
}

function buildTX(mid, hk) {
  const wrap = document.getElementById(`tx${hk}_${mid}`);
  wrap.innerHTML = '';
  const n = txCount[mid];
  for (let i = 0; i < n; i++) {
    const inp = document.createElement('input');
    inp.className = 'd-inp';
    inp.type = 'number';
    inp.min = '0'; inp.max = '10'; inp.step = '0.1';
    inp.placeholder = `TX${i+1}`;
    inp.id = `tx${hk}_${mid}_${i}`;
    inp.setAttribute('oninput', `recalcMon('${mid}')`);
    wrap.appendChild(inp);
  }
}

function toggleMon(mid) {
  document.getElementById('card_' + mid).classList.toggle('open');
}

function addTX(mid, hk) {
  if (txCount[mid] >= 6) return;
  txCount[mid]++;
  buildTX(mid, 1); buildTX(mid, 2);
  recalcMon(mid);
}
function delTX(mid, hk) {
  if (txCount[mid] <= 1) return;
  txCount[mid]--;
  buildTX(mid, 1); buildTX(mid, 2);
  recalcMon(mid);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   6. LOGIC T√çNH ƒêI·ªÇM
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function getVal(id) {
  const el = document.getElementById(id);
  if (!el) return null;
  const v = parseFloat(el.value);
  return (!el.value.trim() || isNaN(v) || v < 0 || v > 10) ? null : v;
}

function isInvalid(id) {
  const el = document.getElementById(id);
  if (!el || !el.value.trim()) return false;
  const v = parseFloat(el.value);
  return isNaN(v) || v < 0 || v > 10;
}

function avg(arr) {
  const v = arr.filter(x => x !== null);
  return v.length ? v.reduce((a,b)=>a+b,0)/v.length : null;
}

function tinhHK(txVals, gk, ck) {
  const tbTX = avg(txVals);
  const parts = [];
  if (tbTX !== null) parts.push({v: tbTX, w: 2});
  if (gk    !== null) parts.push({v: gk,   w: 3});
  if (ck    !== null) parts.push({v: ck,   w: 5});
  if (!parts.length) return null;
  const sumW = parts.reduce((s,p)=>s+p.w, 0);
  const sumV = parts.reduce((s,p)=>s+p.v*p.w, 0);
  return sumV / sumW;
}

function tinhTBMNam(hk1, hk2) {
  if (hk1 !== null && hk2 !== null) return (hk1 + hk2 * 2) / 3;
  if (hk1 !== null) return hk1;
  if (hk2 !== null) return hk2;
  return null;
}

function recalcMon(mid) {
  const n = txCount[mid];
  const tx1 = Array.from({length:n}, (_,i) => getVal(`tx1_${mid}_${i}`));
  const tx2 = Array.from({length:n}, (_,i) => getVal(`tx2_${mid}_${i}`));
  const gk1 = getVal(`gk1_${mid}`), ck1 = getVal(`ck1_${mid}`);
  const gk2 = getVal(`gk2_${mid}`), ck2 = getVal(`ck2_${mid}`);

  const hk1 = tinhHK(tx1, gk1, ck1);
  const hk2 = tinhHK(tx2, gk2, ck2);
  const tbm = tinhTBMNam(hk1, hk2);

  const fmt = v => v !== null ? v.toFixed(2) : '‚Äî';
  document.getElementById(`hk1v_${mid}`).textContent = fmt(hk1);
  document.getElementById(`hk2v_${mid}`).textContent = fmt(hk2);
  document.getElementById(`hk1r_${mid}`).textContent = `HK1: ${fmt(hk1)}`;
  document.getElementById(`hk2r_${mid}`).textContent = `HK2: ${fmt(hk2)}`;

  const tbmEl = document.getElementById(`tbmYear_${mid}`);
  const subEl = document.getElementById(`sub_${mid}`);
  const hdrEl = document.getElementById(`tbm_${mid}`);
  const fmlEl = document.getElementById(`formula_${mid}`);

  if (tbm !== null) {
    const r = Math.round(tbm*100)/100;
    const cl = scColor(r);
    tbmEl.textContent = r.toFixed(2);
    hdrEl.textContent = r.toFixed(2);
    hdrEl.className   = 'mon-tbm-display ' + cl;
    const parts = [];
    if (hk1 !== null) parts.push(`HK1: ${hk1.toFixed(2)}`);
    if (hk2 !== null) parts.push(`HK2: ${hk2.toFixed(2)}`);
    subEl.textContent = parts.join(' | ') + ` | TBM: ${r.toFixed(2)}`;
    if (hk1 !== null && hk2 !== null)
      fmlEl.textContent = `(HK1 + HK2√ó2) / 3 = ${r.toFixed(2)}`;
    else if (hk1 !== null)
      fmlEl.textContent = `Ch·ªâ c√≥ HK1 = ${r.toFixed(2)}`;
    else
      fmlEl.textContent = `Ch·ªâ c√≥ HK2 = ${r.toFixed(2)}`;
  } else {
    tbmEl.textContent = '‚Äî';
    hdrEl.textContent = '‚Äî';
    hdrEl.className   = 'mon-tbm-display';
    subEl.textContent = 'Ch∆∞a nh·∫≠p ƒëi·ªÉm';
    fmlEl.textContent = 'Ch∆∞a c√≥ d·ªØ li·ªáu';
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   7. HELPERS CHUNG
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function rankOf(d)  { return RANK.find(r => d >= r.min) || RANK[RANK.length-1]; }
function scColor(d) { return d>=8?'sc-g':d>=6.5?'sc-k':d>=5?'sc-t':'sc-y'; }

let toastTimer;
function showToast(msg, ok=true) {
  const t = document.getElementById('toast');
  t.innerHTML = (ok?'‚úÖ ':'‚ùå ') + msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>t.classList.remove('show'), 2800);
}

function hasInputError(mid) {
  const n = txCount[mid];
  const ids = [
    ...Array.from({length:n},(_,i)=>`tx1_${mid}_${i}`),
    ...Array.from({length:n},(_,i)=>`tx2_${mid}_${i}`),
    `gk1_${mid}`,`ck1_${mid}`,`gk2_${mid}`,`ck2_${mid}`
  ];
  return ids.some(id => isInvalid(id));
}

/* FIX 2: collectRows tr·∫£ v·ªÅ t·∫•t c·∫£ m√¥n c√≥ √≠t nh·∫•t 1 HK;
   tbm c√≥ th·ªÉ null n·∫øu thi·∫øu 1 h·ªçc k·ª≥ */
function collectRows() {
  const rows = [];
  MON.forEach(m => {
    const n = txCount[m.id];
    const tx1 = Array.from({length:n},(_,i)=>getVal(`tx1_${m.id}_${i}`));
    const tx2 = Array.from({length:n},(_,i)=>getVal(`tx2_${m.id}_${i}`));
    const hk1 = tinhHK(tx1, getVal(`gk1_${m.id}`), getVal(`ck1_${m.id}`));
    const hk2 = tinhHK(tx2, getVal(`gk2_${m.id}`), getVal(`ck2_${m.id}`));
    const tbmRaw = tinhTBMNam(hk1, hk2);
    const tbm = tbmRaw !== null ? Math.round(tbmRaw*100)/100 : null;
    if (hk1 !== null || hk2 !== null) {
      rows.push({m, hk1, hk2, tbm});
    }
  });
  return rows;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   8. T√çNH K·∫æT QU·∫¢
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function tinhKQ() {
  const gErr = document.getElementById('gErr');
  gErr.style.display = 'none';

  const errMons = MON.filter(m => hasInputError(m.id)).map(m=>m.ten);
  if (errMons.length) {
    gErr.innerHTML = `‚ö†Ô∏è ƒêi·ªÉm kh√¥ng h·ª£p l·ªá (ngo√†i 0‚Äì10) t·∫°i: <strong>${errMons.join(', ')}</strong>`;
    gErr.style.display = 'block'; hideResult(); return;
  }

  /* allRows = m√¥n c√≥ √≠t nh·∫•t 1 HK; tbm lu√¥n kh√°c null n·∫øu c√≥ b·∫•t k·ª≥ HK n√†o */
  const allRows = collectRows();
  const rows = allRows; // t·∫•t c·∫£ ƒë·ªÅu h·ª£p l·ªá v√¨ tinhTBMNam ƒë√£ fallback

  if (!rows.length) {
    gErr.innerHTML = '‚ö†Ô∏è H√£y nh·∫≠p √≠t nh·∫•t <strong>1 m√¥n</strong> ƒë·ªÉ t√≠nh k·∫øt qu·∫£.';
    gErr.style.display = 'block'; hideResult(); return;
  }

  const tbmChung = Math.round(
    rows.reduce((s,r)=>s+r.tbm,0)/rows.length * 100
  ) / 100;

  const rnk = rankOf(tbmChung);
  const ten = document.getElementById('tenHS').value.trim() || 'H·ªçc sinh';
  currentResult = {ten, dtb:tbmChung, rnk:rnk.cls, rows:allRows, ts:Date.now()};

  const card = document.getElementById('resCard');
  ['gioi','kha','tb','yeu'].forEach(c=>card.classList.remove(c));
  card.classList.add(rnk.cls);
  document.getElementById('rAvatar').textContent = rnk.ico;
  document.getElementById('rName').textContent   = ten;
  document.getElementById('rPill').textContent   = rnk.ico+' '+rnk.lbl;
  document.getElementById('rAvg').textContent    = tbmChung.toFixed(2);

  const pct = (tbmChung/10*100).toFixed(1)+'%';
  document.getElementById('rScaleFill').style.width = '0%';
  document.getElementById('rNeedle').style.left     = '0%';
  setTimeout(()=>{
    document.getElementById('rScaleFill').style.width = pct;
    document.getElementById('rNeedle').style.left     = pct;
  }, 120);

  document.getElementById('rDescText').textContent = rnk.desc;
  document.getElementById('rDescTips').innerHTML   =
    rnk.tips.map(t=>`<span class="rd-tip">${t}</span>`).join('');

  /* FIX 4: Render b·∫£ng ‚Äî d√πng allRows, TBM nƒÉm hi·ªÉn th·ªã "‚Äî" n·∫øu null */
  const tbody = document.getElementById('rTbody');
  tbody.innerHTML = '';
  allRows.forEach(({m,hk1,hk2,tbm}) => {
    const tr = document.createElement('tr');
    const cl = tbm !== null ? scColor(tbm) : '';
    tr.innerHTML = `
      <td><span class="tbl-ico">${m.ico}</span>${m.ten}</td>
      <td style="text-align:right;color:var(--tx-2)">${hk1!==null?hk1.toFixed(2):'‚Äî'}</td>
      <td style="text-align:right;color:var(--tx-2)">${hk2!==null?hk2.toFixed(2):'‚Äî'}</td>
      <td class="${cl}" style="text-align:right">${tbm!==null?tbm.toFixed(2):'‚Äî'}</td>`;
    tbody.appendChild(tr);
  });
  const tr = document.createElement('tr'); tr.className='ttl-row';
  tr.innerHTML = `<td colspan="3"><span class="tbl-ico">üìä</span>TBM c·∫£ nƒÉm</td>
                  <td class="${rnk.scCls}" style="text-align:right">${tbmChung.toFixed(2)}</td>`;
  tbody.appendChild(tr);

  const wrap = document.getElementById('resWrap');
  wrap.style.display = '';
  wrap.classList.remove('visible');
  void wrap.offsetWidth;
  wrap.classList.add('visible');
  wrap.scrollIntoView({behavior:'smooth', block:'nearest'});

  /* Radar d√πng t·∫•t c·∫£ m√¥n h·ª£p l·ªá */
  setTimeout(() => drawRadar(rows, rnk), 200);

  document.getElementById('btnSave').disabled = false;
  document.getElementById('btnPdf').disabled  = false;
}

function hideResult() {
  const w = document.getElementById('resWrap');
  w.classList.remove('visible'); w.style.display = '';
  document.getElementById('rScaleFill').style.width = '0%';
  document.getElementById('rNeedle').style.left     = '0%';
  document.getElementById('btnSave').disabled = true;
  document.getElementById('btnPdf').disabled  = true;
  if (radarChartInst) { radarChartInst.destroy(); radarChartInst = null; }
  currentResult = null;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   9. RADAR CHART
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function getChartTheme() {
  const cs = getComputedStyle(document.documentElement);
  return {
    grid:  cs.getPropertyValue('--chart-grid').trim(),
    tick:  cs.getPropertyValue('--chart-tick').trim(),
    label: cs.getPropertyValue('--chart-pt-label').trim(),
  };
}

function drawRadar(rows, rnk) {
  const canvas = document.getElementById('radarChart');
  if (radarChartInst) { radarChartInst.destroy(); radarChartInst = null; }
  const th  = getChartTheme();
  const rgb = rnk.rgb;

  radarChartInst = new Chart(canvas, {
    type:'radar',
    data:{
      labels: rows.map(r => r.m.ten),
      datasets:[{
        label:'TBM',
        data: rows.map(r => r.tbm),
        backgroundColor:      `rgba(${rgb},.18)`,
        borderColor:          `rgba(${rgb},.95)`,
        pointBackgroundColor: `rgba(${rgb},1)`,
        pointBorderColor:     '#fff',
        pointHoverBackgroundColor:'#fff',
        pointHoverBorderColor:`rgba(${rgb},1)`,
        pointRadius:5, pointHoverRadius:7, borderWidth:2.5, fill:true,
      }]
    },
    options:{
      responsive:true, maintainAspectRatio:true,
      animation:{duration:700,easing:'easeInOutQuart'},
      scales:{r:{
        min:0, max:10,
        ticks:{stepSize:2,color:th.tick,font:{size:10,family:'Inter'},backdropColor:'transparent'},
        grid:{color:th.grid}, angleLines:{color:th.grid},
        pointLabels:{color:th.label,font:{size:10,weight:'700',family:'Inter'}},
      }},
      plugins:{
        legend:{display:false},
        tooltip:{
          backgroundColor:'rgba(15,14,26,.85)',titleColor:'#e8e6ff',bodyColor:'#a09ec0',
          padding:10,cornerRadius:10,
          callbacks:{label:ctx=>` TBM: ${ctx.raw.toFixed(2)}`}
        }
      }
    }
  });

  document.getElementById('chartLegend').innerHTML = `
    <div class="leg-chip"><span class="leg-dot" style="background:rgba(${rgb},1)"></span>TBM m√¥n</div>
    <div class="leg-chip"><span class="leg-dot" style="background:rgba(${rgb},.3);border:1.5px solid rgba(${rgb},1)"></span>V√πng ƒëi·ªÉm</div>`;

  const vals = rows.map(r=>r.tbm);
  const mx=Math.max(...vals), mn=Math.min(...vals), av=vals.reduce((a,b)=>a+b,0)/vals.length;
  document.getElementById('csMax').textContent = mx.toFixed(2);
  document.getElementById('csMin').textContent = mn.toFixed(2);
  document.getElementById('csAvg').textContent = av.toFixed(2);
  document.getElementById('csMax').title = `Cao nh·∫•t: ${rows[vals.indexOf(mx)].m.ten}`;
  document.getElementById('csMin').title = `Th·∫•p nh·∫•t: ${rows[vals.indexOf(mn)].m.ten}`;
}

function updateRadarTheme() {
  if (!radarChartInst) return;
  const th = getChartTheme();
  const sc = radarChartInst.options.scales.r;
  sc.ticks.color = th.tick; sc.grid.color = th.grid;
  sc.angleLines.color = th.grid; sc.pointLabels.color = th.label;
  radarChartInst.update();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   10. XU·∫§T PDF
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function xuatPDF() {
  if (!currentResult) return;
  const {jsPDF} = window.jspdf;
  const doc = new jsPDF({unit:'mm',format:'a4',orientation:'portrait'});
  const W = doc.internal.pageSize.getWidth();
  const rnkObj = rankOf(currentResult.dtb);
  const WHITE=[255,255,255],DARK=[30,27,75],GREY=[100,100,120],LGREY=[230,230,240];
  const sf=(sz,w='normal',c=DARK)=>{doc.setFontSize(sz);doc.setFont('helvetica',w);doc.setTextColor(...c);};
  const rc=(x,y,w,h,c,r=0)=>{doc.setFillColor(...c);r>0?doc.roundedRect(x,y,w,h,r,r,'F'):doc.rect(x,y,w,h,'F');};

  rc(0,0,W,36,[79,70,229]);rc(W*.55,0,W*.45,36,[124,58,237]);
  doc.setFillColor(255,255,255);doc.circle(23,18,9,'F');
  sf(13,'bold',DARK);doc.text('HT',23,21.5,{align:'center'});
  sf(15,'bold',WHITE);doc.text('PHIEU XEP LOAI HOC LUC',38,13);
  sf(8,'normal',[200,200,255]);doc.text('He Thong Xep Loai Hoc Luc - Chuan VN',38,20);
  const now=new Date();
  const ds=`${now.getDate().toString().padStart(2,'0')}/${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getFullYear()}`;
  sf(7,'normal',[180,180,230]);doc.text(`Ngay: ${ds}`,38,27);

  let y=42;
  rc(10,y,W-20,20,[245,245,255],4);
  doc.setDrawColor(...LGREY);doc.setLineWidth(.3);doc.roundedRect(10,y,W-20,20,4,4,'S');
  sf(7,'bold',GREY);doc.text('HOC SINH',16,y+6);
  sf(11,'bold',DARK);doc.text(currentResult.ten||'Hoc sinh',16,y+14);
  rc(W-58,y+3,46,14,rnkObj.pdfBg,6);
  doc.setDrawColor(...rnkObj.pdfColor);doc.roundedRect(W-58,y+3,46,14,6,6,'S');
  sf(9,'bold',rnkObj.pdfColor);doc.text(rnkObj.lbl.toUpperCase(),W-35,y+12,{align:'center'});

  y+=26;
  rc(10,y,W-20,26,rnkObj.pdfBg,5);
  doc.setDrawColor(...rnkObj.pdfColor);doc.setLineWidth(.4);doc.roundedRect(10,y,W-20,26,5,5,'S');
  sf(7,'bold',rnkObj.pdfColor);doc.text('DIEM TRUNG BINH CA NAM',18,y+9);
  sf(20,'bold',rnkObj.pdfColor);doc.text(currentResult.dtb.toFixed(2),W-20,y+20,{align:'right'});
  sf(7,'normal',GREY);doc.text('/ 10.00',W-20,y+25,{align:'right'});
  const bW2=W-72,bX2=18,bY2=y+20,bH2=3;
  rc(bX2,bY2,bW2,bH2,[215,215,235],2);
  doc.setFillColor(...rnkObj.pdfColor);
  doc.roundedRect(bX2,bY2,bW2*currentResult.dtb/10,bH2,1.5,1.5,'F');

  if (radarChartInst) {
    y+=32;
    const img=radarChartInst.toBase64Image('image/png',1);
    rc(10,y,W-20,86,[248,248,255],4);
    doc.setDrawColor(...LGREY);doc.setLineWidth(.3);doc.roundedRect(10,y,W-20,86,4,4,'S');
    sf(7,'bold',[79,70,229]);doc.text('BIEU DO RADAR TBM CAC MON',W/2,y+7,{align:'center'});
    const cs=68,cx=(W-cs)/2;doc.addImage(img,'PNG',cx,y+9,cs,cs);
    y+=86+4;
  } else { y+=32; }

  rc(10,y,W-20,8,[79,70,229]);
  sf(7.5,'bold',WHITE);doc.text('BANG DIEM CHI TIET TUNG MON',W/2,y+5.5,{align:'center'});
  y+=8;
  rc(10,y,W-20,7,[235,235,250]);
  sf(7,'bold',DARK);doc.text('MON HOC',16,y+5);
  doc.text('TBM HK1',W-60,y+5,{align:'right'});
  doc.text('TBM HK2',W-38,y+5,{align:'right'});
  doc.text('TBM NAM',W-14,y+5,{align:'right'});
  y+=7;
  currentResult.rows.forEach(({m,hk1,hk2,tbm},i)=>{
    rc(10,y,W-20,8,i%2===0?WHITE:[248,248,255]);
    sf(8,'normal',DARK);doc.text(m.ten,16,y+5.5);
    sf(7.5,'normal',GREY);
    doc.text(hk1!==null?Number(hk1).toFixed(2):'‚Äî',W-60,y+5.5,{align:'right'});
    doc.text(hk2!==null?Number(hk2).toFixed(2):'‚Äî',W-38,y+5.5,{align:'right'});
    if (tbm !== null) {
      const sc2=tbm>=8?[5,150,105]:tbm>=6.5?[29,78,216]:tbm>=5?[180,100,10]:[185,28,28];
      sf(8.5,'bold',sc2);doc.text(Number(tbm).toFixed(2),W-14,y+5.5,{align:'right'});
    } else {
      sf(8.5,'normal',GREY);doc.text('‚Äî',W-14,y+5.5,{align:'right'});
    }
    doc.setDrawColor(...LGREY);doc.setLineWidth(.2);doc.line(10,y+8,W-10,y+8);
    y+=8;
  });
  rc(10,y,W-20,9,rnkObj.pdfBg);
  doc.setDrawColor(...rnkObj.pdfColor);doc.setLineWidth(.4);doc.rect(10,y,W-20,9,'S');
  sf(8.5,'bold',rnkObj.pdfColor);doc.text('DIEM TB CA NAM',16,y+6.3);
  sf(10,'bold',rnkObj.pdfColor);doc.text(currentResult.dtb.toFixed(2),W-14,y+6.5,{align:'right'});
  y+=9;

  const fY=doc.internal.pageSize.getHeight()-10;
  doc.setDrawColor(...LGREY);doc.setLineWidth(.3);doc.line(10,fY-4,W-10,fY-4);
  sf(6.5,'normal',GREY);doc.text('He Thong Xep Loai Hoc Luc ¬∑ Chuan hoc ba Viet Nam',W/2,fY,{align:'center'});

  const safe=(currentResult.ten||'hocsinh').replace(/\s+/g,'-').replace(/[^a-zA-Z0-9\-]/g,'');
  doc.save(`BangDiem_${safe}_${ds.replace(/\//g,'')}.pdf`);
  showToast('ƒê√£ xu·∫•t PDF b·∫£ng ƒëi·ªÉm chi ti·∫øt!');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   11. L∆ØU / L·ªäCH S·ª¨
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const SK = 'hocLucHistoryV2';
function docLS()  { try{return JSON.parse(localStorage.getItem(SK))||[];}catch(e){return[];} }
function ghiLS(a) { try{localStorage.setItem(SK,JSON.stringify(a));}catch(e){} }

function luuKQ() {
  if (!currentResult) return;
  const arr = docLS();
  arr.unshift({...currentResult, id:currentResult.ts});
  if (arr.length > 20) arr.splice(20);
  ghiLS(arr);
  document.getElementById('btnSave').disabled = true;
  showToast('ƒê√£ l∆∞u k·∫øt qu·∫£ c·ªßa ' + currentResult.ten);
  renderLichSu();
}

function renderLichSu() {
  const arr=docLS(), wrap=document.getElementById('histWrap'), list=document.getElementById('histList');
  if (!arr.length) { wrap.classList.remove('visible'); return; }
  wrap.classList.add('visible'); list.innerHTML = '';
  arr.forEach((rec,idx) => {
    const ro = RANK.find(r=>rec.rnk===r.cls)||RANK[RANK.length-1];
    const d  = new Date(rec.ts);
    const ds = `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    const row = document.createElement('div');
    row.className = 'hist-row'; row.title = 'Nh·∫•n ƒë·ªÉ xem';
    row.innerHTML = `
      <div class="hist-rank-dot dot-${rec.rnk}"></div>
      <span class="hist-name">${rec.ten}</span>
      <span class="hist-avg ${ro.scCls}">${Number(rec.dtb).toFixed(2)}</span>
      <span class="hist-lbl ${rec.rnk}">${ro.lbl}</span>
      <span class="hist-date">${ds}</span>
      <button class="hist-del" onclick="xoaRec(${idx},event)" title="Xo√°">‚úï</button>`;
    row.addEventListener('click', ()=>napLai(rec));
    list.appendChild(row);
  });
}

function napLai(rec) {
  document.getElementById('tenHS').value = rec.ten;
  currentResult = rec;
  if (rec.rows && rec.rows.length) {
    const rnk = rankOf(rec.dtb);
    const wrap = document.getElementById('resWrap');
    const card = document.getElementById('resCard');
    ['gioi','kha','tb','yeu'].forEach(c=>card.classList.remove(c));
    card.classList.add(rnk.cls);
    document.getElementById('rAvatar').textContent = rnk.ico;
    document.getElementById('rName').textContent   = rec.ten;
    document.getElementById('rPill').textContent   = rnk.ico+' '+rnk.lbl;
    document.getElementById('rAvg').textContent    = Number(rec.dtb).toFixed(2);
    document.getElementById('rDescText').textContent = rnk.desc;
    document.getElementById('rDescTips').innerHTML   = rnk.tips.map(t=>`<span class="rd-tip">${t}</span>`).join('');

    const tbody = document.getElementById('rTbody'); tbody.innerHTML='';
    rec.rows.forEach(({m,hk1,hk2,tbm})=>{
      const tr=document.createElement('tr');
      const cl=tbm!=null?scColor(Number(tbm)):'';
      tr.innerHTML=`<td><span class="tbl-ico">${m.ico}</span>${m.ten}</td>
        <td style="text-align:right;color:var(--tx-2)">${hk1!=null?Number(hk1).toFixed(2):'‚Äî'}</td>
        <td style="text-align:right;color:var(--tx-2)">${hk2!=null?Number(hk2).toFixed(2):'‚Äî'}</td>
        <td class="${cl}" style="text-align:right">${tbm!=null?Number(tbm).toFixed(2):'‚Äî'}</td>`;
      tbody.appendChild(tr);
    });
    const tr=document.createElement('tr');tr.className='ttl-row';
    const rnkO=rankOf(rec.dtb);
    tr.innerHTML=`<td colspan="3"><span class="tbl-ico">üìä</span>TBM c·∫£ nƒÉm</td>
      <td class="${rnkO.scCls}" style="text-align:right">${Number(rec.dtb).toFixed(2)}</td>`;
    tbody.appendChild(tr);

    const pct=(rec.dtb/10*100).toFixed(1)+'%';
    wrap.style.display=''; wrap.classList.remove('visible'); void wrap.offsetWidth; wrap.classList.add('visible');
    setTimeout(()=>{ document.getElementById('rScaleFill').style.width=pct; document.getElementById('rNeedle').style.left=pct; },120);

    /* Radar ch·ªâ d√πng m√¥n c√≥ tbm kh√°c null */
    const radarRows = rec.rows.filter(r => r.tbm != null);
    if (radarRows.length) setTimeout(()=>drawRadar(radarRows, rnk), 200);
    document.getElementById('btnPdf').disabled=false;
  }
  window.scrollTo({top:0,behavior:'smooth'});
  showToast('ƒê√£ n·∫°p k·∫øt qu·∫£ c·ªßa '+rec.ten);
}

function xoaRec(idx,e) {
  e.stopPropagation();
  const arr=docLS(); arr.splice(idx,1); ghiLS(arr); renderLichSu(); showToast('ƒê√£ xo√° b·∫£n ghi',false);
}
function xoaTatCa() {
  if(!confirm('Xo√° to√†n b·ªô l·ªãch s·ª≠?'))return; ghiLS([]); renderLichSu(); showToast('ƒê√£ xo√° t·∫•t c·∫£',false);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   12. NH·∫¨P L·∫†I
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function nhapLai() {
  document.getElementById('tenHS').value = '';
  MON.forEach(m => {
    const n = txCount[m.id];
    for(let hk=1;hk<=2;hk++){
      for(let i=0;i<n;i++){
        const el=document.getElementById(`tx${hk}_${m.id}_${i}`);
        if(el) el.value='';
      }
      ['gk','ck'].forEach(p=>{
        const el=document.getElementById(`${p}${hk}_${m.id}`);
        if(el) el.value='';
      });
    }
    recalcMon(m.id);
    document.getElementById('card_'+m.id).classList.remove('open','has-error');
  });
  document.getElementById('gErr').style.display = 'none';
  hideResult();
  window.scrollTo({top:0,behavior:'smooth'});
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   13. INIT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
buildMonUI();
renderLichSu();
</script>
</body>
</html>
