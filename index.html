<!DOCTYPE html>
<html lang="vi" data-theme="light">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Xáº¿p Loáº¡i Há»c Lá»±c Há»c Sinh</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
/* â•â• TOKENS LIGHT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root{
  --bg-page:#eef2ff;--bg-card:#fff;--bg-input:#f8f9ff;
  --bg-subj:#f8f9ff;--bg-hist:#f8f9ff;--bg-histrow:#fff;
  --bg-soft:#ede9fe;--bg-prog:rgba(255,255,255,.55);
  --bg-desc:rgba(255,255,255,.5);--bg-rdtip:rgba(0,0,0,.06);
  --bg-tblhov:rgba(0,0,0,.03);--bg-chart:#fff;
  --bd-base:#e0e7ff;--bd-input:#e0e7ff;
  --tx-1:#1e1b4b;--tx-2:#4b5563;--tx-3:#9ca3af;
  --c-p1:#4f46e5;--c-p2:#7c3aed;--c-acc:#a78bfa;
  --dot-clr:#c7d2fe;--scale-op:.22;
  --g-bg:#d1fae5;--g-bd:#6ee7b7;--g-tx:#065f46;--g-pill:#34d399;
  --k-bg:#dbeafe;--k-bd:#93c5fd;--k-tx:#1e40af;--k-pill:#60a5fa;
  --t-bg:#fef9c3;--t-bd:#fde68a;--t-tx:#854d0e;--t-pill:#fbbf24;
  --y-bg:#fee2e2;--y-bd:#fca5a5;--y-tx:#991b1b;--y-pill:#f87171;
  --sh-sm:0 2px 8px rgba(99,102,241,.10);
  --sh-md:0 8px 32px rgba(99,102,241,.16);
  --sh-lg:0 20px 56px rgba(99,102,241,.22);
  --td:.3s;
  --chart-grid:rgba(99,102,241,.15);
  --chart-tick:#9ca3af;--chart-pt-label:#4b5563;
}
/* â•â• TOKENS DARK â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
[data-theme="dark"]{
  --bg-page:#0f0e1a;--bg-card:#1a1830;--bg-input:#231f3a;
  --bg-subj:#201d35;--bg-hist:#1e1b30;--bg-histrow:#27243f;
  --bg-soft:#2d2852;--bg-prog:rgba(255,255,255,.04);
  --bg-desc:rgba(255,255,255,.04);--bg-rdtip:rgba(255,255,255,.08);
  --bg-tblhov:rgba(255,255,255,.04);--bg-chart:#1a1830;
  --bd-base:#312e57;--bd-input:#3a3666;
  --tx-1:#e8e6ff;--tx-2:#a09ec0;--tx-3:#5c597e;
  --c-p1:#818cf8;--c-p2:#a78bfa;--c-acc:#c4b5fd;
  --dot-clr:#1e1b35;--scale-op:.35;
  --g-bg:#052e16;--g-bd:#065f46;--g-tx:#6ee7b7;--g-pill:#059669;
  --k-bg:#0c1f4a;--k-bd:#1e3a8a;--k-tx:#93c5fd;--k-pill:#1d4ed8;
  --t-bg:#2d1f00;--t-bd:#78350f;--t-tx:#fde68a;--t-pill:#d97706;
  --y-bg:#2d0a0a;--y-bd:#7f1d1d;--y-tx:#fca5a5;--y-pill:#dc2626;
  --sh-sm:0 2px 8px rgba(0,0,0,.4);--sh-md:0 8px 32px rgba(0,0,0,.5);
  --sh-lg:0 20px 56px rgba(0,0,0,.65);
  --chart-grid:rgba(200,200,255,.10);--chart-tick:#5c597e;--chart-pt-label:#a09ec0;
}

/* â•â• RESET & BASE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;
  transition:background-color var(--td) ease,border-color var(--td) ease,
  color var(--td) ease,box-shadow var(--td) ease;}
.btn,.spin,.mon-card,.hist-row{transition:background-color var(--td) ease,
  border-color var(--td) ease,color var(--td) ease,box-shadow var(--td) ease,transform .15s ease;}

body{font-family:'Inter',system-ui,sans-serif;background-color:var(--bg-page);
  background-image:radial-gradient(circle,var(--dot-clr) 1px,transparent 1px);
  background-size:28px 28px;min-height:100vh;
  display:flex;flex-direction:column;align-items:center;
  padding:36px 16px 60px;color:var(--tx-1);}

/* â•â• DARK TOGGLE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.dm-toggle{position:fixed;top:18px;right:18px;z-index:200;
  width:48px;height:48px;border-radius:50%;border:2px solid var(--bd-base);
  background:var(--bg-card);box-shadow:var(--sh-md);cursor:pointer;
  display:flex;align-items:center;justify-content:center;font-size:1.3rem;}
.dm-toggle:hover{transform:scale(1.1) rotate(15deg);box-shadow:var(--sh-lg);}
.dm-toggle::after{content:attr(data-ico);}

/* â•â• HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.pg-head{text-align:center;margin-bottom:28px;}
.pg-head .crown{font-size:3.2rem;display:block;margin-bottom:8px;
  animation:float 3s ease-in-out infinite;
  filter:drop-shadow(0 6px 12px rgba(124,58,237,.35));}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
.pg-head h1{font-size:clamp(1.4rem,4vw,2rem);font-weight:900;letter-spacing:-.03em;
  background:linear-gradient(135deg,var(--c-p1),var(--c-p2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.pg-head p{color:var(--tx-2);font-size:.88rem;margin-top:5px;font-weight:500;}

/* â•â• CARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.card{background:var(--bg-card);border-radius:28px;box-shadow:var(--sh-lg);
  width:100%;max-width:900px;overflow:hidden;
  animation:slideUp .5s cubic-bezier(.22,1,.36,1) both;}
@keyframes slideUp{from{opacity:0;transform:translateY(28px)}to{opacity:1;transform:translateY(0)}}
.card-stripe{height:5px;transition:none;
  background:linear-gradient(90deg,#6366f1,#a78bfa,#7c3aed,#818cf8,#4f46e5);
  background-size:200%;animation:shimmer 3s linear infinite;}
@keyframes shimmer{0%{background-position:0%}100%{background-position:200%}}
.card-body{padding:28px 28px 32px;}

/* â•â• SECTION LABEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sec-lbl{display:flex;align-items:center;gap:8px;font-size:.71rem;font-weight:700;
  text-transform:uppercase;letter-spacing:.08em;color:var(--c-p1);margin-bottom:14px;}
.sec-lbl::after{content:'';flex:1;height:1.5px;
  background:linear-gradient(90deg,var(--bd-base),transparent);border-radius:99px;}

/* â•â• NAME FIELD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.name-field{margin-bottom:24px;}
.fi{position:relative;display:flex;align-items:center;}
.fi .fi-ico{position:absolute;left:13px;font-size:1.05rem;pointer-events:none;}
.fi input{width:100%;padding:11px 13px 11px 40px;border:2px solid var(--bd-input);
  border-radius:14px;font-family:inherit;font-size:.96rem;font-weight:500;
  color:var(--tx-1);background:var(--bg-input);outline:none;}
.fi input:focus{border-color:var(--c-p1);background:var(--bg-card);
  box-shadow:0 0 0 4px rgba(99,102,241,.14);}
.fi input::placeholder{color:var(--tx-3);font-weight:400;}

/* â•â• MÃ”N Há»ŒC CARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.mon-list{display:flex;flex-direction:column;gap:14px;margin-bottom:10px;}

.mon-card{
  background:var(--bg-subj);border:2px solid var(--bd-base);
  border-radius:20px;overflow:hidden;box-shadow:var(--sh-sm);
  transition:box-shadow var(--td) ease,border-color var(--td) ease;
}
.mon-card:focus-within{border-color:var(--c-p1);box-shadow:var(--sh-md);}
.mon-card.has-error{border-color:#f87171;}

/* Card header (click to expand) */
.mon-header{
  display:flex;align-items:center;gap:12px;
  padding:13px 16px;cursor:pointer;user-select:none;
  background:var(--bg-subj);
}
.mon-header:hover{background:var(--bg-soft);}
.mon-ico-chip{
  width:32px;height:32px;border-radius:10px;background:var(--bg-soft);
  display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;
}
.mon-title-wrap{flex:1;}
.mon-title{font-size:.9rem;font-weight:800;color:var(--tx-1);}
.mon-subtitle{font-size:.72rem;color:var(--tx-3);margin-top:1px;font-weight:500;}
.mon-tbm-display{
  font-size:1.1rem;font-weight:900;
  min-width:48px;text-align:right;
}
.mon-tbm-display.sc-g{color:#059669}
.mon-tbm-display.sc-k{color:#2563eb}
.mon-tbm-display.sc-t{color:#d97706}
.mon-tbm-display.sc-y{color:#dc2626}
[data-theme="dark"] .mon-tbm-display.sc-g{color:#34d399}
[data-theme="dark"] .mon-tbm-display.sc-k{color:#60a5fa}
[data-theme="dark"] .mon-tbm-display.sc-t{color:#fbbf24}
[data-theme="dark"] .mon-tbm-display.sc-y{color:#f87171}

.mon-chevron{font-size:.8rem;color:var(--tx-3);margin-left:4px;
  transition:transform .25s ease;flex-shrink:0;}
.mon-card.open .mon-chevron{transform:rotate(180deg);}

/* Card body (collapsible) */
.mon-body{
  display:none;padding:0 16px 16px;
  border-top:1.5px solid var(--bd-base);
  animation:fadeIn .2s ease;
}
.mon-card.open .mon-body{display:block;}

/* Semester layout */
.semesters{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px;}
@media(max-width:600px){.semesters{grid-template-columns:1fr;}}

.sem-block{
  background:var(--bg-prog);border:1px solid rgba(128,128,128,.12);
  border-radius:14px;padding:12px 14px;
}
.sem-title{
  font-size:.72rem;font-weight:800;text-transform:uppercase;letter-spacing:.07em;
  color:var(--c-p1);margin-bottom:10px;
  display:flex;align-items:center;justify-content:space-between;
}
.sem-result{
  font-size:.82rem;font-weight:700;color:var(--tx-2);
  background:var(--bg-soft);padding:2px 8px;border-radius:99px;
}

/* Input rows inside semester */
.inp-row{display:flex;align-items:center;gap:8px;margin-bottom:7px;}
.inp-row:last-child{margin-bottom:0;}
.inp-lbl{
  font-size:.73rem;font-weight:600;color:var(--tx-2);
  min-width:72px;flex-shrink:0;
}
/* TX row */
.tx-row{display:flex;align-items:center;gap:6px;flex:1;flex-wrap:wrap;}
.tx-inp-wrap{position:relative;display:flex;align-items:center;}

/* Shared input style */
.d-inp{
  width:52px;padding:6px 8px;
  border:1.5px solid var(--bd-base);border-radius:9px;
  font-family:inherit;font-size:.88rem;font-weight:700;
  color:var(--tx-1);background:var(--bg-card);outline:none;
  text-align:center;
  transition:border-color .2s,box-shadow .2s;
}
.d-inp:focus{border-color:var(--c-p1);box-shadow:0 0 0 3px rgba(99,102,241,.13);}
.d-inp.err{border-color:#f87171;background:#fff5f5;}
[data-theme="dark"] .d-inp.err{background:#2d1010;}
.d-inp::placeholder{color:var(--tx-3);font-weight:400;font-size:.8rem;}

/* TX buttons */
.btn-tx-del,.btn-tx-add{
  width:22px;height:22px;border-radius:6px;border:1.5px solid var(--bd-base);
  background:var(--bg-card);cursor:pointer;font-size:.85rem;font-weight:700;
  display:flex;align-items:center;justify-content:center;flex-shrink:0;
  transition:background .15s,transform .1s;
}
.btn-tx-del{color:#ef4444;}.btn-tx-del:hover{background:#fee2e2;}
.btn-tx-add{color:#059669;}.btn-tx-add:hover{background:#d1fae5;}
.btn-tx-del:active,.btn-tx-add:active{transform:scale(.88);}

/* HK display pill inside sem */
.hk-display{
  margin-top:8px;padding:6px 12px;border-radius:10px;
  background:var(--bg-rdtip);font-size:.78rem;font-weight:700;
  color:var(--tx-2);display:flex;align-items:center;justify-content:space-between;
}
.hk-val{font-size:.92rem;font-weight:900;color:var(--tx-1);}

/* â•â• YEAR SUMMARY BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.year-bar{
  margin-top:10px;padding:10px 14px;border-radius:12px;
  background:var(--bg-prog);border:1px solid rgba(128,128,128,.1);
  display:flex;align-items:center;justify-content:space-between;gap:8px;
  flex-wrap:wrap;
}
.year-bar .yb-label{font-size:.73rem;font-weight:700;color:var(--tx-2);}
.year-bar .yb-formula{font-size:.68rem;color:var(--tx-3);margin-top:1px;}
.year-bar .yb-val{font-size:1.2rem;font-weight:900;}

/* â•â• GLOBAL ERROR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.g-err{background:var(--y-bg);border:1.5px solid var(--y-bd);border-radius:11px;
  padding:10px 14px;font-size:.83rem;font-weight:500;color:var(--y-tx);
  margin-top:5px;margin-bottom:2px;display:none;animation:fadeIn .25s ease;}

/* â•â• ACTION BUTTONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.actions{display:grid;grid-template-columns:1fr auto auto auto;gap:10px;margin-top:22px;}
.btn{border:none;border-radius:13px;font-family:inherit;font-size:.93rem;font-weight:700;
  cursor:pointer;outline:none;display:flex;align-items:center;
  justify-content:center;gap:7px;padding:13px 16px;}
.btn:active{transform:scale(.96);}
.btn-calc{background:linear-gradient(135deg,var(--c-p1),var(--c-p2));
  color:#fff;box-shadow:0 4px 18px rgba(79,70,229,.38);}
.btn-calc:hover{opacity:.9;transform:translateY(-1px);}
.btn-save{background:linear-gradient(135deg,#059669,#10b981);
  color:#fff;box-shadow:0 4px 14px rgba(5,150,105,.30);white-space:nowrap;}
.btn-save:hover{opacity:.9;transform:translateY(-1px);}
.btn-save:disabled{opacity:.35;cursor:not-allowed;transform:none;}
.btn-pdf{background:linear-gradient(135deg,#dc2626,#ef4444);
  color:#fff;box-shadow:0 4px 14px rgba(220,38,38,.30);white-space:nowrap;}
.btn-pdf:hover{opacity:.9;transform:translateY(-1px);}
.btn-pdf:disabled{opacity:.35;cursor:not-allowed;transform:none;}
.btn-reset{background:var(--bg-soft);color:var(--c-p1);}
.btn-reset:hover{background:var(--bd-input);transform:translateY(-1px);}

/* â•â• TOAST â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.toast{position:fixed;bottom:28px;right:24px;z-index:999;
  background:var(--tx-1);color:var(--bg-card);
  padding:12px 20px;border-radius:14px;font-size:.85rem;font-weight:600;
  box-shadow:0 8px 32px rgba(0,0,0,.3);display:flex;align-items:center;gap:8px;
  opacity:0;pointer-events:none;transform:translateY(12px);
  transition:opacity .3s,transform .3s;}
.toast.show{opacity:1;pointer-events:auto;transform:translateY(0);}

/* â•â• RESULT WRAP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.result-wrap{display:none;margin-top:26px;}
.result-wrap.visible{display:block !important;
  animation:fadeSlide .45s cubic-bezier(.22,1,.36,1) both;}
@keyframes fadeSlide{
  from{opacity:0;transform:translateY(22px) scale(.98)}
  to  {opacity:1;transform:translateY(0)    scale(1)}}
.res-card{border-radius:22px;border:2px solid transparent;overflow:hidden;box-shadow:var(--sh-md);}
.res-card:hover{box-shadow:var(--sh-lg);}
.res-card.gioi{background:var(--g-bg);border-color:var(--g-bd)}
.res-card.kha {background:var(--k-bg);border-color:var(--k-bd)}
.res-card.tb  {background:var(--t-bg);border-color:var(--t-bd)}
.res-card.yeu {background:var(--y-bg);border-color:var(--y-bd)}
.res-inner{padding:22px 22px 20px;}
.res-top{display:flex;align-items:flex-start;justify-content:space-between;
  flex-wrap:wrap;gap:10px;margin-bottom:18px;}
.res-student{display:flex;align-items:center;gap:10px;}
.res-avatar{width:42px;height:42px;border-radius:11px;
  display:flex;align-items:center;justify-content:center;
  font-size:1.3rem;box-shadow:var(--sh-sm);flex-shrink:0;}
.gioi .res-avatar{background:var(--g-pill)}.kha .res-avatar{background:var(--k-pill)}
.tb   .res-avatar{background:var(--t-pill)}.yeu .res-avatar{background:var(--y-pill)}
.r-name{font-size:1.02rem;font-weight:800;color:var(--tx-1);}
.r-sub{font-size:.76rem;font-weight:500;color:var(--tx-2);margin-top:1px;}
.rank-pill{display:flex;align-items:center;gap:5px;padding:6px 14px;
  border-radius:999px;font-size:.86rem;font-weight:800;
  box-shadow:var(--sh-sm);white-space:nowrap;}
.gioi .rank-pill{background:var(--g-pill);color:#022c22}
.kha  .rank-pill{background:var(--k-pill);color:#1e3a8a}
.tb   .rank-pill{background:var(--t-pill);color:#451a03}
.yeu  .rank-pill{background:var(--y-pill);color:#fff}

/* Progress bar */
.prog-section{margin-bottom:18px;padding:16px 18px 14px;
  border-radius:16px;background:var(--bg-prog);border:1px solid rgba(128,128,128,.12);}
.prog-header{display:flex;align-items:baseline;justify-content:space-between;margin-bottom:10px;}
.p-label{font-size:.76rem;font-weight:700;color:var(--tx-2);
  text-transform:uppercase;letter-spacing:.06em;}
.p-val{font-size:2rem;font-weight:900;line-height:1;}
.gioi .p-val{color:var(--g-tx)}.kha .p-val{color:var(--k-tx)}
.tb   .p-val{color:var(--t-tx)}.yeu .p-val{color:var(--y-tx)}
.scale-bar{position:relative;height:14px;border-radius:99px;margin-bottom:6px;}
.scale-track{position:absolute;inset:0;border-radius:99px;overflow:hidden;
  background:linear-gradient(90deg,#f87171 0%,#fbbf24 32%,#60a5fa 50%,#34d399 70%,#059669 100%);
  opacity:var(--scale-op);}
.scale-fill{position:absolute;top:0;left:0;height:100%;border-radius:99px;
  transition:width .7s cubic-bezier(.22,1,.36,1);box-shadow:0 2px 8px rgba(0,0,0,.18);}
.gioi .scale-fill{background:linear-gradient(90deg,#34d399,#6ee7b7)}
.kha  .scale-fill{background:linear-gradient(90deg,#60a5fa,#93c5fd)}
.tb   .scale-fill{background:linear-gradient(90deg,#fbbf24,#fde68a)}
.yeu  .scale-fill{background:linear-gradient(90deg,#f87171,#fca5a5)}
.scale-needle{position:absolute;top:-4px;width:4px;height:22px;border-radius:2px;
  background:var(--tx-1);box-shadow:0 2px 6px rgba(0,0,0,.25);transform:translateX(-50%);
  transition:left .7s cubic-bezier(.22,1,.36,1);}
.scale-ticks{display:flex;justify-content:space-between;font-size:.66rem;
  font-weight:600;color:var(--tx-3);padding:0 2px;}

/* Radar chart */
.chart-section{margin-bottom:18px;padding:18px 18px 14px;border-radius:16px;
  background:var(--bg-prog);border:1px solid rgba(128,128,128,.12);animation:fadeIn .5s ease;}
.ch-label{font-size:.76rem;font-weight:700;color:var(--tx-2);
  text-transform:uppercase;letter-spacing:.06em;}
.chart-legend{display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin-bottom:12px;}
.leg-chip{display:flex;align-items:center;gap:5px;font-size:.7rem;font-weight:600;
  color:var(--tx-2);padding:3px 9px;border-radius:99px;background:var(--bg-rdtip);}
.leg-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.chart-wrap{position:relative;width:100%;max-width:380px;margin:0 auto;aspect-ratio:1/1;}
.chart-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:14px;}
.cstat{background:var(--bg-rdtip);border-radius:12px;padding:9px 10px;text-align:center;}
.cs-val{font-size:1.15rem;font-weight:900;color:var(--tx-1);}
.cs-lbl{font-size:.68rem;font-weight:600;color:var(--tx-3);margin-top:2px;}
.cs-hi{color:#059669!important;}
.cs-lo{color:#dc2626!important;}
[data-theme="dark"] .cs-hi{color:#34d399!important;}
[data-theme="dark"] .cs-lo{color:#f87171!important;}

/* Rank desc */
.rank-desc{border-radius:13px;padding:13px 15px;margin-bottom:16px;
  border:1px solid rgba(128,128,128,.12);background:var(--bg-desc);}
.rd-title{font-size:.76rem;font-weight:700;color:var(--tx-2);
  text-transform:uppercase;letter-spacing:.07em;margin-bottom:5px;}
.rd-text{font-size:.84rem;font-weight:500;line-height:1.55;color:var(--tx-1);}
.rd-tips{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px;}
.rd-tip{font-size:.73rem;font-weight:600;padding:4px 10px;border-radius:99px;
  background:var(--bg-rdtip);color:var(--tx-2);}

/* Score table */
.score-tbl{width:100%;border-collapse:collapse;font-size:.84rem;}
.score-tbl th{padding:6px 10px;text-align:left;font-size:.71rem;font-weight:700;
  text-transform:uppercase;letter-spacing:.07em;color:var(--tx-2);
  border-bottom:1.5px solid rgba(128,128,128,.15);}
.score-tbl td{padding:8px 10px;border-bottom:1px solid rgba(128,128,128,.08);
  color:var(--tx-1);font-weight:500;}
.score-tbl td:last-child{text-align:right;font-weight:800;}
.score-tbl tbody tr:hover{background:var(--bg-tblhov);}
.score-tbl tr.ttl-row td{border-bottom:none;font-weight:900;font-size:.98rem;padding-top:11px;}
.sc-g{color:#059669}.sc-k{color:#2563eb}.sc-t{color:#d97706}.sc-y{color:#dc2626}
[data-theme="dark"] .sc-g{color:#34d399}[data-theme="dark"] .sc-k{color:#60a5fa}
[data-theme="dark"] .sc-t{color:#fbbf24}[data-theme="dark"] .sc-y{color:#f87171}
.tbl-ico{display:inline-flex;align-items:center;justify-content:center;
  width:20px;height:20px;border-radius:6px;background:rgba(128,128,128,.12);
  font-size:.72rem;margin-right:5px;}

/* History */
.history-wrap{background:var(--bg-hist);border:2px solid var(--bd-base);
  border-radius:20px;padding:18px 18px 14px;margin-top:24px;display:none;animation:fadeIn .3s ease;}
.history-wrap.visible{display:block;}
.history-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:13px;}
.history-header h3{font-size:.85rem;font-weight:800;color:var(--c-p1);}
.btn-clear-hist{font-size:.72rem;font-weight:600;color:#f87171;
  background:none;border:none;cursor:pointer;padding:3px 8px;border-radius:7px;}
.btn-clear-hist:hover{background:var(--y-bg);}
.hist-row{display:flex;align-items:center;gap:10px;padding:9px 10px;
  border-radius:11px;background:var(--bg-histrow);border:1.5px solid var(--bd-base);
  margin-bottom:8px;cursor:pointer;}
.hist-row:hover{border-color:var(--c-p1);box-shadow:var(--sh-sm);transform:translateY(-1px);}
.hist-row:last-child{margin-bottom:0;}
.hist-rank-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.dot-gioi{background:#34d399}.dot-kha{background:#60a5fa}
.dot-tb{background:#fbbf24}.dot-yeu{background:#f87171}
.hist-name{font-size:.87rem;font-weight:700;flex:1;color:var(--tx-1);
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.hist-avg{font-size:.87rem;font-weight:800;margin-left:auto;margin-right:4px;}
.hist-lbl{font-size:.72rem;font-weight:700;padding:3px 10px;border-radius:99px;}
.hist-lbl.gioi{background:var(--g-bg);color:var(--g-tx)}
.hist-lbl.kha {background:var(--k-bg);color:var(--k-tx)}
.hist-lbl.tb  {background:var(--t-bg);color:var(--t-tx)}
.hist-lbl.yeu {background:var(--y-bg);color:var(--y-tx)}
.hist-del{background:none;border:none;cursor:pointer;font-size:.85rem;
  color:var(--tx-3);padding:3px 5px;border-radius:6px;flex-shrink:0;}
.hist-del:hover{color:#f87171;background:var(--y-bg);}
.hist-date{font-size:.68rem;color:var(--tx-3);font-weight:500;white-space:nowrap;}

.pg-foot{margin-top:30px;font-size:.72rem;color:var(--tx-3);text-align:center;font-weight:500;}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}

@media(max-width:600px){
  .card-body{padding:18px 14px 24px;}
  .actions{grid-template-columns:1fr 1fr;grid-template-rows:auto auto;}
  .btn-calc{grid-column:1/-1;}
  .dm-toggle{top:12px;right:12px;width:42px;height:42px;font-size:1.1rem;}
}
</style>
</head>
<body>

<button class="dm-toggle" id="dmBtn" data-ico="ğŸŒ™" onclick="toggleDark()"></button>

<header class="pg-head">
  <span class="crown">ğŸ“</span>
  <h1>Xáº¿p Loáº¡i Há»c Lá»±c Há»c Sinh</h1>
  <p>Báº£ng Ä‘iá»ƒm chi tiáº¿t theo chuáº©n há»c báº¡ Viá»‡t Nam</p>
</header>

<div class="card">
  <div class="card-stripe"></div>
  <div class="card-body">

    <p class="sec-lbl">ğŸ‘¤ ThÃ´ng tin há»c sinh</p>
    <div class="name-field">
      <div class="fi">
        <span class="fi-ico">ğŸ§‘â€ğŸ“</span>
        <input type="text" id="tenHS" placeholder="Nháº­p há» vÃ  tÃªn há»c sinhâ€¦" maxlength="60"/>
      </div>
    </div>

    <p class="sec-lbl">ğŸ“š Äiá»ƒm cÃ¡c mÃ´n há»c</p>
    <div class="mon-list" id="monList"></div>
    <div class="g-err" id="gErr"></div>

    <div class="actions">
      <button class="btn btn-calc"  onclick="tinhKQ()">âœ¨ TÃ­nh káº¿t quáº£</button>
      <button class="btn btn-save"  id="btnSave" onclick="luuKQ()"   disabled>ğŸ’¾ LÆ°u</button>
      <button class="btn btn-pdf"   id="btnPdf"  onclick="xuatPDF()" disabled>ğŸ“„ PDF</button>
      <button class="btn btn-reset" onclick="nhapLai()">ğŸ”„ Nháº­p láº¡i</button>
    </div>

    <!-- Káº¾T QUáº¢ -->
    <div class="result-wrap" id="resWrap">
      <div class="res-card" id="resCard">
        <div class="res-inner">
          <div class="res-top">
            <div class="res-student">
              <div class="res-avatar" id="rAvatar">ğŸ†</div>
              <div>
                <div class="r-name" id="rName">â€”</div>
                <div class="r-sub">Káº¿t quáº£ há»c ká»³</div>
              </div>
            </div>
            <div class="rank-pill" id="rPill">â€”</div>
          </div>
          <div class="prog-section">
            <div class="prog-header">
              <span class="p-label">ğŸ“Š Äiá»ƒm trung bÃ¬nh cáº£ nÄƒm</span>
              <span class="p-val" id="rAvg">â€”</span>
            </div>
            <div class="scale-bar">
              <div class="scale-track"></div>
              <div class="scale-fill"   id="rScaleFill" style="width:0%"></div>
              <div class="scale-needle" id="rNeedle"    style="left:0%"></div>
            </div>
            <div class="scale-ticks">
              <span>0</span><span>2.5</span><span>5</span>
              <span>6.5</span><span>8</span><span>10</span>
            </div>
          </div>
          <div class="chart-section">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
              <span class="ch-label">ğŸ“¡ Biá»ƒu Ä‘á»“ Radar TBM cÃ¡c mÃ´n</span>
            </div>
            <div class="chart-legend" id="chartLegend"></div>
            <div class="chart-wrap"><canvas id="radarChart"></canvas></div>
            <div class="chart-stats">
              <div class="cstat"><div class="cs-val cs-hi" id="csMax">â€”</div><div class="cs-lbl">MÃ´n cao nháº¥t</div></div>
              <div class="cstat"><div class="cs-val cs-lo" id="csMin">â€”</div><div class="cs-lbl">MÃ´n tháº¥p nháº¥t</div></div>
              <div class="cstat"><div class="cs-val" id="csAvg">â€”</div><div class="cs-lbl">TBM cáº£ nÄƒm</div></div>
            </div>
          </div>
          <div class="rank-desc">
            <div class="rd-title">ğŸ“Œ Ã nghÄ©a xáº¿p loáº¡i</div>
            <div class="rd-text" id="rDescText">â€”</div>
            <div class="rd-tips" id="rDescTips"></div>
          </div>
          <table class="score-tbl">
            <thead>
              <tr>
                <th>MÃ´n há»c</th>
                <th style="text-align:right">HK1</th>
                <th style="text-align:right">HK2</th>
                <th style="text-align:right">TBM nÄƒm</th>
              </tr>
            </thead>
            <tbody id="rTbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Lá»ŠCH Sá»¬ -->
    <div class="history-wrap" id="histWrap">
      <div class="history-header">
        <h3>ğŸ“‹ Káº¿t quáº£ Ä‘Ã£ lÆ°u</h3>
        <button class="btn-clear-hist" onclick="xoaTatCa()">ğŸ—‘ XoÃ¡ táº¥t cáº£</button>
      </div>
      <div id="histList"></div>
    </div>

  </div>
</div>

<footer class="pg-foot">Â© 2025 Â· Há»‡ Thá»‘ng Xáº¿p Loáº¡i Há»c Lá»±c Â· Chuáº©n há»c báº¡ Viá»‡t Nam</footer>
<div class="toast" id="toast"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   1. Dá»® LIá»†U MÃ”N Há»ŒC
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const MON = [
  {id:'toan',  ten:'ToÃ¡n',                    ico:'â•'},
  {id:'van',   ten:'Ngá»¯ vÄƒn',                  ico:'ğŸ“–'},
  {id:'anh',   ten:'Tiáº¿ng Anh',               ico:'ğŸ”¤'},
  {id:'ly',    ten:'Váº­t lÃ½',                   ico:'âš¡'},
  {id:'hoa',   ten:'HÃ³a há»c',                  ico:'ğŸ§ª'},
  {id:'sinh',  ten:'Sinh há»c',                 ico:'ğŸŒ¿'},
  {id:'su',    ten:'Lá»‹ch sá»­',                  ico:'ğŸ›ï¸'},
  {id:'dia',   ten:'Äá»‹a lÃ½',                   ico:'ğŸŒ'},
  {id:'gdcd',  ten:'GDKT & PhÃ¡p luáº­t',         ico:'âš–ï¸'},
  {id:'tin',   ten:'Tin há»c',                  ico:'ğŸ’»'},
  {id:'gdqp',  ten:'GD Quá»‘c phÃ²ng',            ico:'ğŸ›¡ï¸'},
  {id:'cn',    ten:'CÃ´ng nghá»‡',                ico:'ğŸ› ï¸'},
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   2. Xáº¾P LOáº I
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const RANK = [
  {min:8.0,lbl:'Giá»i',      cls:'gioi',ico:'ğŸ†',scCls:'sc-g',
   rgb:'52,211,153',pdfColor:[5,150,105],pdfBg:[209,250,229],
   desc:'Há»c sinh Ä‘áº¡t thÃ nh tÃ­ch xuáº¥t sáº¯c, náº¯m vá»¯ng kiáº¿n thá»©c toÃ n diá»‡n, cÃ³ kháº£ nÄƒng tÆ° duy Ä‘á»™c láº­p vÃ  sÃ¡ng táº¡o.',
   tips:['Náº¯m vá»¯ng lÃ½ thuyáº¿t','LÃ m tá»‘t bÃ i táº­p nÃ¢ng cao','Tá»± há»c hiá»‡u quáº£','TÆ° duy sÃ¡ng táº¡o']},
  {min:6.5,lbl:'KhÃ¡',       cls:'kha', ico:'ğŸ¥ˆ',scCls:'sc-k',
   rgb:'96,165,250',pdfColor:[29,78,216],pdfBg:[219,234,254],
   desc:'Há»c sinh cÃ³ káº¿t quáº£ tá»‘t, hiá»ƒu bÃ i vÃ  váº­n dá»¥ng kiáº¿n thá»©c á»Ÿ má»©c khÃ¡. Cáº§n cá»‘ gáº¯ng thÃªm Ä‘á»ƒ Ä‘áº¡t má»©c Giá»i.',
   tips:['Hiá»ƒu bÃ i á»Ÿ má»©c khÃ¡','Cáº§n Ã´n luyá»‡n thÃªm','CÃ³ ná»n táº£ng vá»¯ng','Tiáº¿p tá»¥c phÃ¡t huy']},
  {min:5.0,lbl:'Trung bÃ¬nh',cls:'tb',  ico:'ğŸ“˜',scCls:'sc-t',
   rgb:'251,191,36',pdfColor:[133,77,14],pdfBg:[254,249,195],
   desc:'Há»c sinh Ä‘áº¡t má»©c cÆ¡ báº£n, cáº§n cáº£i thiá»‡n cÃ¡c mÃ´n cÃ²n yáº¿u vÃ  tÄƒng cÆ°á»ng Ã´n luyá»‡n Ä‘á»u Ä‘áº·n hÆ¡n.',
   tips:['Náº¯m kiáº¿n thá»©c cÆ¡ báº£n','Cáº§n luyá»‡n táº­p thÃªm','ChÃº Ã½ mÃ´n yáº¿u','TÄƒng thá»i gian Ã´n bÃ i']},
  {min:0,  lbl:'Yáº¿u',       cls:'yeu', ico:'âš ï¸',scCls:'sc-y',
   rgb:'248,113,113',pdfColor:[153,27,27],pdfBg:[254,226,226],
   desc:'Há»c sinh cáº§n ná»— lá»±c nhiá»u hÆ¡n, nÃªn tÃ¬m sá»± há»— trá»£ tá»« tháº§y cÃ´ vÃ  gia Ä‘Ã¬nh Ä‘á»ƒ cáº£i thiá»‡n ká»‹p thá»i.',
   tips:['Bá»• sung kiáº¿n thá»©c','TÃ¬m há»— trá»£ tháº§y cÃ´','Láº­p káº¿ hoáº¡ch há»c','KhÃ´ng bá» cuá»™c!']},
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   3. STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let currentResult  = null;
let radarChartInst = null;
// LÆ°u sá»‘ lÆ°á»£ng cá»™t TX hiá»‡n táº¡i cá»§a tá»«ng mÃ´n (máº·c Ä‘á»‹nh 4)
const txCount = {};
MON.forEach(m => txCount[m.id] = 4);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   4. DARK MODE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const DM_KEY = 'hocLucDarkMode';
function applyTheme(dark) {
  document.documentElement.setAttribute('data-theme', dark ? 'dark' : 'light');
  const btn = document.getElementById('dmBtn');
  btn.setAttribute('data-ico', dark ? 'â˜€ï¸' : 'ğŸŒ™');
  if (radarChartInst) updateRadarTheme();
}
function toggleDark() {
  const d = document.documentElement.getAttribute('data-theme') === 'dark';
  applyTheme(!d);
  try { localStorage.setItem(DM_KEY, !d ? '1' : '0'); } catch(e){}
  showToast(!d ? 'ğŸŒ™ Dark Mode Ä‘Ã£ báº­t' : 'â˜€ï¸ Light Mode Ä‘Ã£ báº­t');
}
(function initTheme() {
  let s = null;
  try { s = localStorage.getItem(DM_KEY); } catch(e){}
  if (s !== null) { applyTheme(s === '1'); return; }
  if (window.matchMedia?.('(prefers-color-scheme: dark)').matches) applyTheme(true);
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   5. XÃ‚Y Dá»°NG UI MÃ”N Há»ŒC
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildMonUI() {
  const list = document.getElementById('monList');
  list.innerHTML = '';
  MON.forEach(m => {
    const card = document.createElement('div');
    card.className = 'mon-card';
    card.id = 'card_' + m.id;
    card.innerHTML = `
      <!-- HEADER (click toggle) -->
      <div class="mon-header" onclick="toggleMon('${m.id}')">
        <div class="mon-ico-chip">${m.ico}</div>
        <div class="mon-title-wrap">
          <div class="mon-title">${m.ten}</div>
          <div class="mon-subtitle" id="sub_${m.id}">ChÆ°a nháº­p Ä‘iá»ƒm</div>
        </div>
        <div class="mon-tbm-display" id="tbm_${m.id}">â€”</div>
        <div class="mon-chevron">â–¼</div>
      </div>

      <!-- BODY (collapsible) -->
      <div class="mon-body">
        <div class="semesters">
          <!-- Há»ŒC Ká»² 1 -->
          <div class="sem-block">
            <div class="sem-title">
              ğŸ“˜ Há»c ká»³ 1
              <span class="sem-result" id="hk1r_${m.id}">HK1: â€”</span>
            </div>
            <!-- TX HK1 -->
            <div class="inp-row">
              <span class="inp-lbl">TX (HK1)</span>
              <div class="tx-row" id="tx1_${m.id}"></div>
              <button class="btn-tx-del" onclick="delTX('${m.id}',1)" title="XoÃ¡ 1 cá»™t TX">âˆ’</button>
              <button class="btn-tx-add" onclick="addTX('${m.id}',1)" title="ThÃªm 1 cá»™t TX">+</button>
            </div>
            <!-- GK1 -->
            <div class="inp-row">
              <span class="inp-lbl">Giá»¯a ká»³ 1</span>
              <input class="d-inp" type="number" id="gk1_${m.id}"
                     min="0" max="10" step="0.1" placeholder="â€”"
                     oninput="recalcMon('${m.id}')"/>
            </div>
            <!-- CK1 -->
            <div class="inp-row">
              <span class="inp-lbl">Cuá»‘i ká»³ 1</span>
              <input class="d-inp" type="number" id="ck1_${m.id}"
                     min="0" max="10" step="0.1" placeholder="â€”"
                     oninput="recalcMon('${m.id}')"/>
            </div>
            <div class="hk-display">
              <span>Äiá»ƒm HK1</span>
              <span class="hk-val" id="hk1v_${m.id}">â€”</span>
            </div>
          </div>

          <!-- Há»ŒC Ká»² 2 -->
          <div class="sem-block">
            <div class="sem-title">
              ğŸ“— Há»c ká»³ 2
              <span class="sem-result" id="hk2r_${m.id}">HK2: â€”</span>
            </div>
            <!-- TX HK2 -->
            <div class="inp-row">
              <span class="inp-lbl">TX (HK2)</span>
              <div class="tx-row" id="tx2_${m.id}"></div>
              <button class="btn-tx-del" onclick="delTX('${m.id}',2)" title="XoÃ¡ 1 cá»™t TX">âˆ’</button>
              <button class="btn-tx-add" onclick="addTX('${m.id}',2)" title="ThÃªm 1 cá»™t TX">+</button>
            </div>
            <!-- GK2 -->
            <div class="inp-row">
              <span class="inp-lbl">Giá»¯a ká»³ 2</span>
              <input class="d-inp" type="number" id="gk2_${m.id}"
                     min="0" max="10" step="0.1" placeholder="â€”"
                     oninput="recalcMon('${m.id}')"/>
            </div>
            <!-- CK2 -->
            <div class="inp-row">
              <span class="inp-lbl">Cuá»‘i ká»³ 2</span>
              <input class="d-inp" type="number" id="ck2_${m.id}"
                     min="0" max="10" step="0.1" placeholder="â€”"
                     oninput="recalcMon('${m.id}')"/>
            </div>
            <div class="hk-display">
              <span>Äiá»ƒm HK2</span>
              <span class="hk-val" id="hk2v_${m.id}">â€”</span>
            </div>
          </div>
        </div>

        <!-- TBM Cáº¢ NÄ‚M -->
        <div class="year-bar" id="yearbar_${m.id}">
          <div>
            <div class="yb-label">ğŸ“Š TBM cáº£ nÄƒm</div>
            <div class="yb-formula" id="formula_${m.id}">ChÆ°a cÃ³ dá»¯ liá»‡u</div>
          </div>
          <div class="yb-val" id="tbmYear_${m.id}">â€”</div>
        </div>
      </div>`;
    list.appendChild(card);
    // Build TX inputs
    buildTX(m.id, 1);
    buildTX(m.id, 2);
  });
}

/* â”€â”€ Build TX inputs cho 1 há»c ká»³ â”€â”€ */
function buildTX(mid, hk) {
  const wrap = document.getElementById(`tx${hk}_${mid}`);
  wrap.innerHTML = '';
  const n = txCount[mid];
  for (let i = 0; i < n; i++) {
    const inp = document.createElement('input');
    inp.className = 'd-inp';
    inp.type = 'number';
    inp.min = '0'; inp.max = '10'; inp.step = '0.1';
    inp.placeholder = `TX${i+1}`;
    inp.id = `tx${hk}_${mid}_${i}`;
    inp.setAttribute('oninput', `recalcMon('${mid}')`);
    wrap.appendChild(inp);
  }
}

/* â”€â”€ Toggle má»Ÿ/Ä‘Ã³ng card â”€â”€ */
function toggleMon(mid) {
  const card = document.getElementById('card_' + mid);
  card.classList.toggle('open');
}

/* â”€â”€ ThÃªm / xoÃ¡ cá»™t TX â”€â”€ */
function addTX(mid, hk) {
  if (txCount[mid] >= 6) return;
  txCount[mid]++;
  buildTX(mid, 1); buildTX(mid, 2);
  recalcMon(mid);
}
function delTX(mid, hk) {
  if (txCount[mid] <= 1) return;
  txCount[mid]--;
  buildTX(mid, 1); buildTX(mid, 2);
  recalcMon(mid);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   6. LOGIC TÃNH ÄIá»‚M THEO CHUáº¨N VN
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   TB_TX = trung bÃ¬nh cÃ¡c Ã´ TX cÃ³ giÃ¡ trá»‹
   HK    = (TB_TXÃ—2 + GKÃ—3 + CKÃ—5) / 10   [náº¿u Ä‘á»§]
   Náº¿u thiáº¿u: bá» qua há»‡ sá»‘, láº¥y trung bÃ¬nh bÃ¬nh thÆ°á»ng

   TBM nÄƒm:
   - Chá»‰ HK1       â†’ TBM = HK1
   - Chá»‰ HK2       â†’ TBM = HK2
   - Cáº£ HK1 + HK2  â†’ TBM = (HK1 + HK2Ã—2) / 3
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* Láº¥y sá»‘ tá»« input, tráº£ vá» null náº¿u trá»‘ng/invalid */
function getVal(id) {
  const el = document.getElementById(id);
  if (!el) return null;
  const v = parseFloat(el.value);
  return (!el.value.trim() || isNaN(v) || v < 0 || v > 10) ? null : v;
}

/* Kiá»ƒm tra input cÃ³ lá»—i (nháº­p nhÆ°ng khÃ´ng há»£p lá»‡) */
function isInvalid(id) {
  const el = document.getElementById(id);
  if (!el || !el.value.trim()) return false; // trá»‘ng â†’ OK
  const v = parseFloat(el.value);
  return isNaN(v) || v < 0 || v > 10;
}

/* Trung bÃ¬nh cÃ¡c giÃ¡ trá»‹ khÃ´ng null */
function avg(arr) {
  const v = arr.filter(x => x !== null);
  return v.length ? v.reduce((a,b)=>a+b,0)/v.length : null;
}

/* TÃ­nh Ä‘iá»ƒm HK theo cÃ´ng thá»©c VN */
function tinhHK(txVals, gk, ck) {
  const tbTX = avg(txVals);
  // XÃ¢y máº£ng cÃ³ há»‡ sá»‘
  const parts = [];
  if (tbTX !== null) parts.push({v: tbTX, w: 2});
  if (gk    !== null) parts.push({v: gk,   w: 3});
  if (ck    !== null) parts.push({v: ck,   w: 5});
  if (!parts.length) return null;
  const sumW = parts.reduce((s,p)=>s+p.w, 0);
  const sumV = parts.reduce((s,p)=>s+p.v*p.w, 0);
  return sumV / sumW;
}

/* TÃ­nh TBM nÄƒm */
function tinhTBMNam(hk1, hk2) {
  if (hk1 !== null && hk2 !== null) return (hk1 + hk2*2) / 3;
  if (hk1 !== null) return hk1;
  if (hk2 !== null) return hk2;
  return null;
}

/* TÃ­nh vÃ  hiá»ƒn thá»‹ realtime cho 1 mÃ´n */
function recalcMon(mid) {
  const n = txCount[mid];
  // Láº¥y TX HK1 & HK2
  const tx1 = Array.from({length:n}, (_,i) => getVal(`tx1_${mid}_${i}`));
  const tx2 = Array.from({length:n}, (_,i) => getVal(`tx2_${mid}_${i}`));
  const gk1 = getVal(`gk1_${mid}`), ck1 = getVal(`ck1_${mid}`);
  const gk2 = getVal(`gk2_${mid}`), ck2 = getVal(`ck2_${mid}`);

  const hk1 = tinhHK(tx1, gk1, ck1);
  const hk2 = tinhHK(tx2, gk2, ck2);
  const tbm = tinhTBMNam(hk1, hk2);

  // Cáº­p nháº­t HK hiá»ƒn thá»‹
  const fmt = v => v !== null ? v.toFixed(2) : 'â€”';
  document.getElementById(`hk1v_${mid}`).textContent = fmt(hk1);
  document.getElementById(`hk2v_${mid}`).textContent = fmt(hk2);
  document.getElementById(`hk1r_${mid}`).textContent = `HK1: ${fmt(hk1)}`;
  document.getElementById(`hk2r_${mid}`).textContent = `HK2: ${fmt(hk2)}`;

  // TBM nÄƒm
  const tbmEl  = document.getElementById(`tbmYear_${mid}`);
  const subEl  = document.getElementById(`sub_${mid}`);
  const hdrEl  = document.getElementById(`tbm_${mid}`);
  const fmlEl  = document.getElementById(`formula_${mid}`);

  if (tbm !== null) {
    const r = Math.round(tbm*100)/100;
    const cl = scColor(r);
    tbmEl.textContent  = r.toFixed(2);
    hdrEl.textContent  = r.toFixed(2);
    hdrEl.className    = 'mon-tbm-display ' + cl;
    subEl.textContent  =
      hk1!==null && hk2!==null
        ? `HK1: ${hk1.toFixed(2)} | HK2: ${hk2.toFixed(2)} | TBM: ${r.toFixed(2)}`
        : hk1!==null
          ? `HK1: ${hk1.toFixed(2)} | TBM: ${r.toFixed(2)}`
          : `HK2: ${hk2.toFixed(2)} | TBM: ${r.toFixed(2)}`;
    fmlEl.textContent  =
      hk1!==null && hk2!==null
        ? `(HK1 + HK2Ã—2) / 3 = ${r.toFixed(2)}`
        : hk1!==null ? `Chá»‰ cÃ³ HK1 = ${r.toFixed(2)}`
                     : `Chá»‰ cÃ³ HK2 = ${r.toFixed(2)}`;
  } else {
    tbmEl.textContent  = 'â€”';
    hdrEl.textContent  = 'â€”';
    hdrEl.className    = 'mon-tbm-display';
    subEl.textContent  = 'ChÆ°a nháº­p Ä‘iá»ƒm';
    fmlEl.textContent  = 'ChÆ°a cÃ³ dá»¯ liá»‡u';
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   7. HELPERS CHUNG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function rankOf(d)  { return RANK.find(r => d >= r.min) || RANK[RANK.length-1]; }
function scColor(d) { return d>=8?'sc-g':d>=6.5?'sc-k':d>=5?'sc-t':'sc-y'; }

let toastTimer;
function showToast(msg, ok=true) {
  const t = document.getElementById('toast');
  t.innerHTML = (ok?'âœ… ':'âŒ ') + msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>t.classList.remove('show'), 2800);
}

/* Kiá»ƒm tra cÃ³ Ã´ nháº­p sai dá»¯ liá»‡u */
function hasInputError(mid) {
  const n = txCount[mid];
  const ids = [
    ...Array.from({length:n},(_,i)=>`tx1_${mid}_${i}`),
    ...Array.from({length:n},(_,i)=>`tx2_${mid}_${i}`),
    `gk1_${mid}`,`ck1_${mid}`,`gk2_${mid}`,`ck2_${mid}`
  ];
  return ids.some(id => isInvalid(id));
}

/* Thu tháº­p TBM tá»«ng mÃ´n */
function collectRows() {
  const rows = [];
  MON.forEach(m => {
    const n = txCount[m.id];
    const tx1 = Array.from({length:n},(_,i)=>getVal(`tx1_${m.id}_${i}`));
    const tx2 = Array.from({length:n},(_,i)=>getVal(`tx2_${m.id}_${i}`));
    const hk1 = tinhHK(tx1, getVal(`gk1_${m.id}`), getVal(`ck1_${m.id}`));
    const hk2 = tinhHK(tx2, getVal(`gk2_${m.id}`), getVal(`ck2_${m.id}`));
    const tbm = tinhTBMNam(hk1, hk2);
    if (tbm !== null) rows.push({m, hk1, hk2, tbm: Math.round(tbm*100)/100});
  });
  return rows;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   8. TÃNH Káº¾T QUáº¢
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function tinhKQ() {
  const gErr = document.getElementById('gErr');
  gErr.style.display = 'none';

  // Kiá»ƒm tra lá»—i nháº­p liá»‡u
  const errMons = MON.filter(m => hasInputError(m.id)).map(m=>m.ten);
  if (errMons.length) {
    gErr.innerHTML = `âš ï¸ Äiá»ƒm khÃ´ng há»£p lá»‡ (ngoÃ i 0â€“10) táº¡i: <strong>${errMons.join(', ')}</strong>`;
    gErr.style.display = 'block'; hideResult(); return;
  }

  const rows = collectRows();
  if (!rows.length) {
    gErr.innerHTML = 'âš ï¸ HÃ£y nháº­p Ã­t nháº¥t <strong>1 mÃ´n</strong> Ä‘á»ƒ tÃ­nh Ä‘iá»ƒm trung bÃ¬nh.';
    gErr.style.display = 'block'; hideResult(); return;
  }

  // TBM chung = trung bÃ¬nh TBM cÃ¡c mÃ´n
  const tbmChung = Math.round(
    rows.reduce((s,r)=>s+r.tbm,0)/rows.length * 100
  ) / 100;

  const rnk = rankOf(tbmChung);
  const ten = document.getElementById('tenHS').value.trim() || 'Há»c sinh';
  currentResult = {ten, dtb:tbmChung, rnk:rnk.cls, rows, ts:Date.now()};

  // Fill card
  const card = document.getElementById('resCard');
  ['gioi','kha','tb','yeu'].forEach(c=>card.classList.remove(c));
  card.classList.add(rnk.cls);
  document.getElementById('rAvatar').textContent = rnk.ico;
  document.getElementById('rName').textContent   = ten;
  document.getElementById('rPill').textContent   = rnk.ico+' '+rnk.lbl;
  document.getElementById('rAvg').textContent    = tbmChung.toFixed(2);

  const pct = (tbmChung/10*100).toFixed(1)+'%';
  document.getElementById('rScaleFill').style.width = '0%';
  document.getElementById('rNeedle').style.left     = '0%';
  setTimeout(()=>{
    document.getElementById('rScaleFill').style.width = pct;
    document.getElementById('rNeedle').style.left     = pct;
  }, 120);

  document.getElementById('rDescText').textContent = rnk.desc;
  document.getElementById('rDescTips').innerHTML   =
    rnk.tips.map(t=>`<span class="rd-tip">${t}</span>`).join('');

  // Báº£ng Ä‘iá»ƒm
  const tbody = document.getElementById('rTbody');
  tbody.innerHTML = '';
  rows.forEach(({m,hk1,hk2,tbm}) => {
    const tr = document.createElement('tr');
    const cl = scColor(tbm);
    tr.innerHTML = `
      <td><span class="tbl-ico">${m.ico}</span>${m.ten}</td>
      <td style="text-align:right;color:var(--tx-2)">${hk1!==null?hk1.toFixed(2):'â€”'}</td>
      <td style="text-align:right;color:var(--tx-2)">${hk2!==null?hk2.toFixed(2):'â€”'}</td>
      <td class="${cl}" style="text-align:right">${tbm.toFixed(2)}</td>`;
    tbody.appendChild(tr);
  });
  const tr = document.createElement('tr'); tr.className='ttl-row';
  tr.innerHTML = `<td colspan="3"><span class="tbl-ico">ğŸ“Š</span>TBM cáº£ nÄƒm</td>
                  <td class="${rnk.scCls}" style="text-align:right">${tbmChung.toFixed(2)}</td>`;
  tbody.appendChild(tr);

  // Show result
  const wrap = document.getElementById('resWrap');
  wrap.style.display = '';
  wrap.classList.remove('visible');
  void wrap.offsetWidth;
  wrap.classList.add('visible');
  wrap.scrollIntoView({behavior:'smooth', block:'nearest'});

  setTimeout(() => drawRadar(rows, rnk), 200);

  document.getElementById('btnSave').disabled = false;
  document.getElementById('btnPdf').disabled  = false;
}

function hideResult() {
  const w = document.getElementById('resWrap');
  w.classList.remove('visible'); w.style.display = '';
  document.getElementById('rScaleFill').style.width = '0%';
  document.getElementById('rNeedle').style.left     = '0%';
  document.getElementById('btnSave').disabled = true;
  document.getElementById('btnPdf').disabled  = true;
  if (radarChartInst) { radarChartInst.destroy(); radarChartInst = null; }
  currentResult = null;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   9. RADAR CHART
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getChartTheme() {
  const cs = getComputedStyle(document.documentElement);
  return {
    grid:  cs.getPropertyValue('--chart-grid').trim(),
    tick:  cs.getPropertyValue('--chart-tick').trim(),
    label: cs.getPropertyValue('--chart-pt-label').trim(),
  };
}

function drawRadar(rows, rnk) {
  const canvas = document.getElementById('radarChart');
  if (radarChartInst) { radarChartInst.destroy(); radarChartInst = null; }
  const th  = getChartTheme();
  const rgb = rnk.rgb;

  radarChartInst = new Chart(canvas, {
    type:'radar',
    data:{
      labels: rows.map(r => r.m.ten),
      datasets:[{
        label:'TBM',
        data: rows.map(r => r.tbm),
        backgroundColor:      `rgba(${rgb},.18)`,
        borderColor:          `rgba(${rgb},.95)`,
        pointBackgroundColor: `rgba(${rgb},1)`,
        pointBorderColor:     '#fff',
        pointHoverBackgroundColor:'#fff',
        pointHoverBorderColor:`rgba(${rgb},1)`,
        pointRadius:5, pointHoverRadius:7, borderWidth:2.5, fill:true,
      }]
    },
    options:{
      responsive:true, maintainAspectRatio:true,
      animation:{duration:700,easing:'easeInOutQuart'},
      scales:{r:{
        min:0, max:10,
        ticks:{stepSize:2,color:th.tick,font:{size:10,family:'Inter'},backdropColor:'transparent'},
        grid:{color:th.grid}, angleLines:{color:th.grid},
        pointLabels:{color:th.label,font:{size:10,weight:'700',family:'Inter'}},
      }},
      plugins:{
        legend:{display:false},
        tooltip:{
          backgroundColor:'rgba(15,14,26,.85)',titleColor:'#e8e6ff',bodyColor:'#a09ec0',
          padding:10,cornerRadius:10,
          callbacks:{label:ctx=>` TBM: ${ctx.raw.toFixed(2)}`}
        }
      }
    }
  });

  document.getElementById('chartLegend').innerHTML = `
    <div class="leg-chip"><span class="leg-dot" style="background:rgba(${rgb},1)"></span>TBM mÃ´n</div>
    <div class="leg-chip"><span class="leg-dot" style="background:rgba(${rgb},.3);border:1.5px solid rgba(${rgb},1)"></span>VÃ¹ng Ä‘iá»ƒm</div>`;

  const vals = rows.map(r=>r.tbm);
  const mx=Math.max(...vals), mn=Math.min(...vals), av=vals.reduce((a,b)=>a+b,0)/vals.length;
  document.getElementById('csMax').textContent = mx.toFixed(2);
  document.getElementById('csMin').textContent = mn.toFixed(2);
  document.getElementById('csAvg').textContent = av.toFixed(2);
  document.getElementById('csMax').title = `Cao nháº¥t: ${rows[vals.indexOf(mx)].m.ten}`;
  document.getElementById('csMin').title = `Tháº¥p nháº¥t: ${rows[vals.indexOf(mn)].m.ten}`;
}

function updateRadarTheme() {
  if (!radarChartInst) return;
  const th = getChartTheme();
  const sc = radarChartInst.options.scales.r;
  sc.ticks.color = th.tick; sc.grid.color = th.grid;
  sc.angleLines.color = th.grid; sc.pointLabels.color = th.label;
  radarChartInst.update();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   10. XUáº¤T PDF
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function xuatPDF() {
  if (!currentResult) return;
  const {jsPDF} = window.jspdf;
  const doc = new jsPDF({unit:'mm',format:'a4',orientation:'portrait'});
  const W = doc.internal.pageSize.getWidth();
  const rnkObj = rankOf(currentResult.dtb);
  const WHITE=[255,255,255],DARK=[30,27,75],GREY=[100,100,120],LGREY=[230,230,240];
  const sf=(sz,w='normal',c=DARK)=>{doc.setFontSize(sz);doc.setFont('helvetica',w);doc.setTextColor(...c);};
  const rc=(x,y,w,h,c,r=0)=>{doc.setFillColor(...c);r>0?doc.roundedRect(x,y,w,h,r,r,'F'):doc.rect(x,y,w,h,'F');};

  // Header
  rc(0,0,W,36,[79,70,229]);rc(W*.55,0,W*.45,36,[124,58,237]);
  doc.setFillColor(255,255,255);doc.circle(23,18,9,'F');
  sf(13,'bold',DARK);doc.text('HT',23,21.5,{align:'center'});
  sf(15,'bold',WHITE);doc.text('PHIEU XEP LOAI HOC LUC',38,13);
  sf(8,'normal',[200,200,255]);doc.text('He Thong Xep Loai Hoc Luc - Chuan VN',38,20);
  const now=new Date();
  const ds=`${now.getDate().toString().padStart(2,'0')}/${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getFullYear()}`;
  sf(7,'normal',[180,180,230]);doc.text(`Ngay: ${ds}`,38,27);

  // Student
  let y=42;
  rc(10,y,W-20,20,[245,245,255],4);
  doc.setDrawColor(...LGREY);doc.setLineWidth(.3);doc.roundedRect(10,y,W-20,20,4,4,'S');
  sf(7,'bold',GREY);doc.text('HOC SINH',16,y+6);
  sf(11,'bold',DARK);doc.text(currentResult.ten||'Hoc sinh',16,y+14);
  rc(W-58,y+3,46,14,rnkObj.pdfBg,6);
  doc.setDrawColor(...rnkObj.pdfColor);doc.roundedRect(W-58,y+3,46,14,6,6,'S');
  sf(9,'bold',rnkObj.pdfColor);doc.text(rnkObj.lbl.toUpperCase(),W-35,y+12,{align:'center'});

  // Avg
  y+=26;
  rc(10,y,W-20,26,rnkObj.pdfBg,5);
  doc.setDrawColor(...rnkObj.pdfColor);doc.setLineWidth(.4);doc.roundedRect(10,y,W-20,26,5,5,'S');
  sf(7,'bold',rnkObj.pdfColor);doc.text('DIEM TRUNG BINH CA NAM',18,y+9);
  sf(20,'bold',rnkObj.pdfColor);doc.text(currentResult.dtb.toFixed(2),W-20,y+20,{align:'right'});
  sf(7,'normal',GREY);doc.text('/ 10.00',W-20,y+25,{align:'right'});
  const bW2=W-72,bX2=18,bY2=y+20,bH2=3;
  rc(bX2,bY2,bW2,bH2,[215,215,235],2);
  doc.setFillColor(...rnkObj.pdfColor);
  doc.roundedRect(bX2,bY2,bW2*currentResult.dtb/10,bH2,1.5,1.5,'F');

  // Radar image
  if (radarChartInst) {
    y+=32;
    const img=radarChartInst.toBase64Image('image/png',1);
    rc(10,y,W-20,86,[248,248,255],4);
    doc.setDrawColor(...LGREY);doc.setLineWidth(.3);doc.roundedRect(10,y,W-20,86,4,4,'S');
    sf(7,'bold',[79,70,229]);doc.text('BIEU DO RADAR TBM CAC MON',W/2,y+7,{align:'center'});
    const cs=68,cx=(W-cs)/2;doc.addImage(img,'PNG',cx,y+9,cs,cs);
    y+=86+4;
  } else { y+=32; }

  // Score table
  rc(10,y,W-20,8,[79,70,229]);
  sf(7.5,'bold',WHITE);doc.text('BANG DIEM CHI TIET TUNG MON',W/2,y+5.5,{align:'center'});
  y+=8;
  rc(10,y,W-20,7,[235,235,250]);
  sf(7,'bold',DARK);doc.text('MON HOC',16,y+5);
  doc.text('HK1',W-60,y+5,{align:'right'});
  doc.text('HK2',W-38,y+5,{align:'right'});
  doc.text('TBM NAM',W-14,y+5,{align:'right'});
  y+=7;
  currentResult.rows.forEach(({m,hk1,hk2,tbm},i)=>{
    rc(10,y,W-20,8,i%2===0?WHITE:[248,248,255]);
    sf(8,'normal',DARK);doc.text(m.ten,16,y+5.5);
    sf(7.5,'normal',GREY);
    doc.text(hk1!==null?hk1.toFixed(2):'â€”',W-60,y+5.5,{align:'right'});
    doc.text(hk2!==null?hk2.toFixed(2):'â€”',W-38,y+5.5,{align:'right'});
    const sc2=tbm>=8?[5,150,105]:tbm>=6.5?[29,78,216]:tbm>=5?[180,100,10]:[185,28,28];
    sf(8.5,'bold',sc2);doc.text(tbm.toFixed(2),W-14,y+5.5,{align:'right'});
    doc.setDrawColor(...LGREY);doc.setLineWidth(.2);doc.line(10,y+8,W-10,y+8);
    y+=8;
  });
  rc(10,y,W-20,9,rnkObj.pdfBg);
  doc.setDrawColor(...rnkObj.pdfColor);doc.setLineWidth(.4);doc.rect(10,y,W-20,9,'S');
  sf(8.5,'bold',rnkObj.pdfColor);doc.text('DIEM TB CA NAM',16,y+6.3);
  sf(10,'bold',rnkObj.pdfColor);doc.text(currentResult.dtb.toFixed(2),W-14,y+6.5,{align:'right'});
  y+=9;

  // Footer
  const fY=doc.internal.pageSize.getHeight()-10;
  doc.setDrawColor(...LGREY);doc.setLineWidth(.3);doc.line(10,fY-4,W-10,fY-4);
  sf(6.5,'normal',GREY);doc.text('He Thong Xep Loai Hoc Luc Â· Chuan hoc ba Viet Nam',W/2,fY,{align:'center'});

  const safe=(currentResult.ten||'hocsinh').replace(/\s+/g,'-').replace(/[^a-zA-Z0-9\-]/g,'');
  doc.save(`BangDiem_${safe}_${ds.replace(/\//g,'')}.pdf`);
  showToast('ÄÃ£ xuáº¥t PDF báº£ng Ä‘iá»ƒm chi tiáº¿t!');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   11. LÆ¯U / Lá»ŠCH Sá»¬
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SK = 'hocLucHistoryV2';
function docLS()  { try{return JSON.parse(localStorage.getItem(SK))||[];}catch(e){return[];} }
function ghiLS(a) { try{localStorage.setItem(SK,JSON.stringify(a));}catch(e){} }

function luuKQ() {
  if (!currentResult) return;
  const arr = docLS();
  arr.unshift({...currentResult, id:currentResult.ts});
  if (arr.length > 20) arr.splice(20);
  ghiLS(arr);
  document.getElementById('btnSave').disabled = true;
  showToast('ÄÃ£ lÆ°u káº¿t quáº£ cá»§a ' + currentResult.ten);
  renderLichSu();
}

function renderLichSu() {
  const arr=docLS(), wrap=document.getElementById('histWrap'), list=document.getElementById('histList');
  if (!arr.length) { wrap.classList.remove('visible'); return; }
  wrap.classList.add('visible'); list.innerHTML = '';
  arr.forEach((rec,idx) => {
    const ro = RANK.find(r=>rec.rnk===r.cls)||RANK[RANK.length-1];
    const d  = new Date(rec.ts);
    const ds = `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    const row = document.createElement('div');
    row.className = 'hist-row'; row.title = 'Nháº¥n Ä‘á»ƒ xem';
    row.innerHTML = `
      <div class="hist-rank-dot dot-${rec.rnk}"></div>
      <span class="hist-name">${rec.ten}</span>
      <span class="hist-avg ${ro.scCls}">${Number(rec.dtb).toFixed(2)}</span>
      <span class="hist-lbl ${rec.rnk}">${ro.lbl}</span>
      <span class="hist-date">${ds}</span>
      <button class="hist-del" onclick="xoaRec(${idx},event)" title="XoÃ¡">âœ•</button>`;
    row.addEventListener('click', ()=>napLai(rec));
    list.appendChild(row);
  });
}

function napLai(rec) {
  document.getElementById('tenHS').value = rec.ten;
  // Chá»‰ hiá»ƒn thá»‹ káº¿t quáº£, khÃ´ng restore tá»«ng Ã´ (dá»¯ liá»‡u chi tiáº¿t phá»©c táº¡p)
  currentResult = rec;
  if (rec.rows && rec.rows.length) {
    const rnk = rankOf(rec.dtb);
    const wrap = document.getElementById('resWrap');
    const card = document.getElementById('resCard');
    ['gioi','kha','tb','yeu'].forEach(c=>card.classList.remove(c));
    card.classList.add(rnk.cls);
    document.getElementById('rAvatar').textContent = rnk.ico;
    document.getElementById('rName').textContent   = rec.ten;
    document.getElementById('rPill').textContent   = rnk.ico+' '+rnk.lbl;
    document.getElementById('rAvg').textContent    = Number(rec.dtb).toFixed(2);
    document.getElementById('rDescText').textContent = rnk.desc;
    document.getElementById('rDescTips').innerHTML   = rnk.tips.map(t=>`<span class="rd-tip">${t}</span>`).join('');
    const tbody = document.getElementById('rTbody'); tbody.innerHTML='';
    rec.rows.forEach(({m,hk1,hk2,tbm})=>{
      const tr=document.createElement('tr');
      const cl=scColor(tbm);
      tr.innerHTML=`<td><span class="tbl-ico">${m.ico}</span>${m.ten}</td>
        <td style="text-align:right;color:var(--tx-2)">${hk1!=null?Number(hk1).toFixed(2):'â€”'}</td>
        <td style="text-align:right;color:var(--tx-2)">${hk2!=null?Number(hk2).toFixed(2):'â€”'}</td>
        <td class="${cl}" style="text-align:right">${Number(tbm).toFixed(2)}</td>`;
      tbody.appendChild(tr);
    });
    const tr=document.createElement('tr');tr.className='ttl-row';
    const rnkO=rankOf(rec.dtb);
    tr.innerHTML=`<td colspan="3"><span class="tbl-ico">ğŸ“Š</span>TBM cáº£ nÄƒm</td>
      <td class="${rnkO.scCls}" style="text-align:right">${Number(rec.dtb).toFixed(2)}</td>`;
    tbody.appendChild(tr);
    const pct=(rec.dtb/10*100).toFixed(1)+'%';
    wrap.style.display=''; wrap.classList.remove('visible'); void wrap.offsetWidth; wrap.classList.add('visible');
    setTimeout(()=>{ document.getElementById('rScaleFill').style.width=pct; document.getElementById('rNeedle').style.left=pct; },120);
    setTimeout(()=>drawRadar(rec.rows,rnk),200);
    document.getElementById('btnPdf').disabled=false;
  }
  window.scrollTo({top:0,behavior:'smooth'});
  showToast('ÄÃ£ náº¡p káº¿t quáº£ cá»§a '+rec.ten);
}

function xoaRec(idx,e) {
  e.stopPropagation();
  const arr=docLS(); arr.splice(idx,1); ghiLS(arr); renderLichSu(); showToast('ÄÃ£ xoÃ¡ báº£n ghi',false);
}
function xoaTatCa() {
  if(!confirm('XoÃ¡ toÃ n bá»™ lá»‹ch sá»­?'))return; ghiLS([]); renderLichSu(); showToast('ÄÃ£ xoÃ¡ táº¥t cáº£',false);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   12. NHáº¬P Láº I
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function nhapLai() {
  document.getElementById('tenHS').value = '';
  MON.forEach(m => {
    const n = txCount[m.id];
    for(let hk=1;hk<=2;hk++){
      for(let i=0;i<n;i++){
        const el=document.getElementById(`tx${hk}_${m.id}_${i}`);
        if(el) el.value='';
      }
      ['gk','ck'].forEach(p=>{
        const el=document.getElementById(`${p}${hk}_${m.id}`);
        if(el) el.value='';
      });
    }
    recalcMon(m.id);
    document.getElementById('card_'+m.id).classList.remove('open','has-error');
  });
  document.getElementById('gErr').style.display = 'none';
  hideResult();
  window.scrollTo({top:0,behavior:'smooth'});
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   13. INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
buildMonUI();
renderLichSu();
</script>
</body>
</html>
